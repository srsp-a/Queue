<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDB QUEUE - Redesigned</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f7f5fa;
        }
        .main-container {
            max-width: 1200px;
            background: #fff;
            border-radius: 2rem;
            border: 1px solid #e9e4f5;
            box-shadow: 0 10px 40px rgba(100, 80, 150, 0.1);
        }
        .pink-gradient-btn {
            background-image: linear-gradient(to right, #ff758c 0%, #ff7eb3 100%);
            color: white;
            border-radius: 0.75rem;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 126, 179, 0.4);
        }
        .job-tab {
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            white-space: nowrap;
        }
        .job-tab.active {
            color: #8338ec;
            background-color: #f0eaff;
            border-color: #d8c3ff;
        }
        .check-icon {
            color: #2ecc71;
            font-size: 1.75rem;
        }
        .cross-icon {
            color: #e74c3c;
            font-size: 1.75rem;
        }
        .daily-rate-input {
            width: 60px;
            font-size: 0.75rem;
            padding: 1px 3px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            text-align: center;
            margin-top: 4px;
            background-color: #fafafa;
            color: #666;
            font-weight: 400;
            -moz-appearance: textfield;
        }
        .daily-rate-input::-webkit-outer-spin-button,
        .daily-rate-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .daily-rate-input:focus {
            outline: none;
            border-color: #8338ec;
            box-shadow: 0 0 0 2px rgba(131, 56, 236, 0.2);
        }
        .summary-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 1rem;
            padding: 1.5rem;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal-backdrop.visible {
            opacity: 1;
            pointer-events: all;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
            transform: scale(0.95) translateY(20px);
        }
        .modal-backdrop.visible .modal-content {
            transform: scale(1) translateY(0);
        }
        #total-budget-input {
            -moz-appearance: textfield;
        }
        #total-budget-input::-webkit-outer-spin-button,
        #total-budget-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        [contenteditable="true"] {
            outline: none;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        [contenteditable="true"]:focus {
            background-color: #f0eaff;
            box-shadow: 0 0 0 2px #d8c3ff;
        }
        /* Toast Notification Styles */
        #toast-notification {
            transition: transform 0.5s ease-in-out;
            transform: translateX(110%);
        }
        #toast-notification.show {
            transform: translateX(0);
        }
        #toast-notification.success {
            background-color: #2ecc71;
        }
        #toast-notification.error {
            background-color: #e74c3c;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-10">

    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="max-w-md mx-auto mt-10 p-8 border rounded-lg shadow-lg bg-white">
            <div id="login-view">
                <h2 class="text-2xl font-bold text-center mb-6">เข้าสู่ระบบ</h2>
                <div class="space-y-4">
                    <input id="login-user" type="text" placeholder="ชื่อผู้ใช้" class="w-full p-3 border rounded-lg">
                    <input id="login-pass" type="password" placeholder="รหัสผ่าน" class="w-full p-3 border rounded-lg">
                    <button id="login-btn" class="w-full p-3 bg-violet-600 text-white rounded-lg font-semibold hover:bg-violet-700">เข้าสู่ระบบ</button>
                    <p class="text-center text-sm">ยังไม่มีบัญชี? <a href="#" id="show-register-view" class="text-violet-600 hover:underline">สมัครสมาชิก</a></p>
                </div>
            </div>
            <div id="register-view" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6">สมัครสมาชิก</h2>
                <div class="space-y-4">
                    <input id="register-user" type="text" placeholder="ชื่อผู้ใช้ (สำหรับ Login)" class="w-full p-3 border rounded-lg">
                    <input id="register-nickname" type="text" placeholder="ชื่อเล่น (สำหรับแสดงผล)" class="w-full p-3 border rounded-lg">
                    <input id="register-pass" type="password" placeholder="รหัสผ่าน" class="w-full p-3 border rounded-lg">
                    <input id="register-phone" type="tel" placeholder="เบอร์โทร (10 หลัก)" class="w-full p-3 border rounded-lg" maxlength="10">
                    <button id="register-btn" class="w-full p-3 bg-violet-600 text-white rounded-lg font-semibold hover:bg-violet-700">สมัครสมาชิก</button>
                    <p class="text-center text-sm">มีบัญชีอยู่แล้ว? <a href="#" id="show-login-view" class="text-violet-600 hover:underline">เข้าสู่ระบบ</a></p>
                </div>
            </div>
        </div>
    </div>


    <!-- Main App Screen -->
    <div id="app-container" class="main-container mx-auto p-5 sm:p-8 hidden">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-4">
                <img src="https://placehold.co/60x60/8338EC/FFFFFF?text=LDB" class="rounded-full">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800 tracking-tight">LDB QUEUE</h1>
            </div>
            <div class="flex items-center space-x-4">
                 <span id="sync-status" class="text-sm text-gray-400 flex items-center space-x-2">
                    <i class="fa-solid fa-cloud"></i>
                    <span>บันทึกแล้ว</span>
                </span>
                <button id="logout-btn" class="pink-gradient-btn flex items-center space-x-2">
                    <i class="fa-solid fa-sign-out-alt"></i>
                    <span id="current-user-display"></span>
                </button>
            </div>
        </header>

        <!-- Job Tabs -->
        <nav id="job-tabs-container" class="flex items-center space-x-2 mb-6 overflow-x-auto pb-2">
            <!-- Job tabs will be injected by JS -->
        </nav>

        <!-- Main Content: Hidden until a job is selected -->
        <div id="main-content" class="hidden">
            <main class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <!-- Left Column: Team Table -->
                <div class="lg:col-span-3">
                    <section id="job-details" class="mb-6">
                        <h2 id="job-name" contenteditable="true" class="text-2xl font-bold text-gray-800"></h2>
                        <p class="text-gray-500"><i class="fa-solid fa-calendar-alt mr-2"></i><span id="job-daterange" contenteditable="true"></span></p>
                        <p class="text-gray-500"><i class="fa-solid fa-map-marker-alt mr-2"></i><span id="job-location" contenteditable="true"></span></p>
                    </section>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead id="table-header">
                                <!-- Header row will be injected by JS -->
                            </thead>
                            <tbody id="team-list" class="divide-y">
                                <!-- Team members injected here -->
                            </tbody>
                        </table>
                    </div>
                    <button id="add-person-btn" class="mt-4 text-gray-500 hover:text-blue-600 transition text-2xl admin-only">
                        <i class="fa-solid fa-plus-circle"></i>
                    </button>
                </div>

                <!-- Right Column: BG & Other Costs -->
                <div class="lg:col-span-2">
                    <section class="bg-violet-600 text-white p-6 rounded-2xl text-right mb-6 shadow-lg admin-only">
                        <p class="text-lg opacity-80">BG</p>
                        <p id="bg-amount" class="text-5xl font-bold">0 <span class="text-3xl font-medium">บาท</span></p>
                    </section>

                    <div class="summary-box">
                        <h3 class="font-bold text-lg mb-3 border-b pb-2">ค่าใช้จ่ายอื่น</h3>
                        <table class="w-full text-sm">
                            <thead>
                                <tr>
                                    <th class="text-left py-1">ตำแหน่ง</th>
                                    <th class="text-right py-1">ค่าใช้จ่าย</th>
                                    <th class="text-center py-1 admin-only">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="other-costs-list">
                                <!-- Other costs injected here -->
                            </tbody>
                        </table>
                        <button id="add-expense-btn" class="mt-3 w-full text-sm text-green-600 hover:bg-green-50 p-2 rounded-lg border border-dashed border-green-400 flex items-center justify-center space-x-2 admin-only">
                            <i class="fa-solid fa-plus"></i>
                            <span>เพิ่มรายการ</span>
                        </button>
                    </div>
                </div>
            </main>

            <!-- Footer Summary -->
            <footer class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6 admin-only">
                <!-- Left: Cost Breakdown -->
                <div class="summary-box">
                    <h3 class="font-bold text-lg mb-4">ค่าใช้จ่าย</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between"><span>ค่าทีมงานรวม</span> <span id="summary-team-cost" class="font-semibold">0</span></div>
                        <div class="flex justify-between"><span>ค่าใช้จ่ายอื่นรวม</span> <span id="summary-other-cost" class="font-semibold">0</span></div>
                    </div>
                    <hr class="my-4">
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <input type="checkbox" id="wht-toggle" class="mr-2 h-4 w-4 rounded accent-violet-500" />
                                <label for="wht-toggle">หัก ณ ที่จ่าย</label>
                                (<input type="number" id="wht-percent" value="3" class="w-12 text-right mx-1 p-0.5 border rounded" />)
                            </div>
                            <span id="summary-wht" class="font-semibold text-red-500">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                             <div class="flex items-center">
                                <input type="checkbox" id="vat-toggle" class="mr-2 h-4 w-4 rounded accent-violet-500" checked />
                                <label for="vat-toggle">VAT (7%)</label>
                            </div>
                            <span id="summary-vat" class="font-semibold text-green-500">0</span>
                        </div>
                    </div>
                    <hr class="my-4">
                    <div class="flex justify-between font-bold text-xl text-blue-700">
                       <span>รวมทั้งสิ้น</span>
                       <span id="summary-grand-total">0</span>
                    </div>
                </div>
                <!-- Right: Budget & Profit/Loss -->
                <div class="summary-box flex flex-col justify-between">
                     <div>
                        <h3 class="font-bold text-lg mb-2">งบประมาณ</h3>
                        <!-- Editable Budget Input -->
                        <div class="relative">
                            <input type="number" id="total-budget-input" class="text-5xl font-bold text-gray-800 bg-transparent w-full pr-24 focus:outline-none focus:bg-gray-100 rounded-lg p-2" value="0" />
                            <span class="absolute right-4 top-1/2 -translate-y-1/2 text-3xl font-medium text-gray-500 pointer-events-none">บาท</span>
                        </div>
                    </div>
                    <div id="profit-loss-container" class="p-4 rounded-lg text-center my-4">
                        <!-- Profit/Loss display here -->
                    </div>
                    <button id="delete-job-btn" class="w-full p-3 bg-red-500 text-white font-bold rounded-lg shadow-lg hover:bg-red-600 transition transform hover:scale-105 flex items-center justify-center space-x-2">
                        <i class="fa-solid fa-trash-alt"></i>
                        <span>ลบคิวงานนี้</span>
                    </button>
                </div>
            </footer>
        </div>
    </div>

    <!-- Modals -->
    <div id="add-person-modal" class="fixed inset-0 modal-backdrop items-center justify-center flex z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal-content">
            <h3 class="text-xl font-bold mb-4">เลือกทีมงาน</h3>
            <div id="modal-member-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-add-person" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">ยกเลิก</button>
            </div>
        </div>
    </div>
    
    <div id="add-date-modal" class="fixed inset-0 modal-backdrop items-center justify-center flex z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm modal-content">
            <h3 class="text-xl font-bold mb-4">เพิ่มวันที่ใหม่</h3>
            <div>
                <label for="new-date-input" class="block text-sm font-medium text-gray-700">วันที่ (เช่น 2 ส.ค.)</label>
                <input type="text" id="new-date-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-violet-500 focus:border-violet-500 sm:text-sm">
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-add-date" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                <button id="confirm-add-date" class="px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700">เพิ่ม</button>
            </div>
        </div>
    </div>

    <div id="add-job-modal" class="fixed inset-0 modal-backdrop items-center justify-center flex z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm modal-content">
            <h3 class="text-xl font-bold mb-4">สร้างคิวงานใหม่</h3>
            <div>
                <label for="new-job-name-input" class="block text-sm font-medium text-gray-700">ชื่องาน</label>
                <input type="text" id="new-job-name-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-violet-500 focus:border-violet-500 sm:text-sm">
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-add-job" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                <button id="confirm-add-job" class="px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700">สร้าง</button>
            </div>
        </div>
    </div>

    <div id="user-profile-modal" class="fixed inset-0 modal-backdrop items-center justify-center flex z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal-content">
            <h3 class="text-xl font-bold mb-4">ข้อมูลส่วนตัว</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ชื่อผู้ใช้ (Username)</label>
                    <input type="text" id="profile-user" class="mt-1 block w-full p-2 bg-gray-100 border border-gray-300 rounded-md" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ชื่อเล่น</label>
                    <input type="text" id="profile-nickname" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <hr>
                <h4 class="font-semibold">เปลี่ยนรหัสผ่าน</h4>
                <div>
                    <label class="block text-sm font-medium text-gray-700">รหัสผ่านเดิม</label>
                    <input type="password" id="profile-old-pass" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">รหัสผ่านใหม่</label>
                    <input type="password" id="profile-new-pass" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                 <hr>
                <h4 class="font-semibold">ข้อมูลบัญชีธนาคาร</h4>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ธนาคาร</label>
                    <select id="profile-bank-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <option>กรุณาเลือกธนาคาร</option>
                        <option>กสิกรไทย</option>
                        <option>กรุงเทพ</option>
                        <option>กรุงไทย</option>
                        <option>ไทยพาณิชย์</option>
                        <option>ทหารไทยธนชาต</option>
                        <option>กรุงศรีอยุธยา</option>
                        <option>ออมสิน</option>
                        <option>อื่นๆ</option>
                    </select>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">ชื่อบัญชี</label>
                    <input type="text" id="profile-account-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">เลขที่บัญชี</label>
                    <input type="text" id="profile-account-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-update-profile" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                <button id="confirm-update-profile" class="px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed top-5 right-5 text-white py-3 px-5 rounded-lg shadow-lg z-50">
        <span id="toast-message"></span>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG & STATE ---
        const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzbL9M-vJen0URX_4hk21IgSPCcpFpZAMfBQT_L9TGh7VAPYBPa9m1J7gQXSTkpnAmKMw/exec';

        let appState = {
            jobs: [],
            currentJobId: null,
            users: [],
            loggedInUser: null
        };

        function createNewJob(name) {
            return {
                id: Date.now(),
                name: name,
                dateRange: '(dd mmm - dd mmm)',
                location: 'ระบุสถานที่',
                budget: 0,
                bg: 0,
                dates: ['วันแรก'],
                team: [],
                otherCosts: [],
                whtEnabled: false,
                vatEnabled: true,
            };
        }

        // --- DOM ELEMENTS ---
        const authScreen = document.getElementById('auth-screen');
        const appContainer = document.getElementById('app-container');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const mainContent = document.getElementById('main-content');
        const jobTabsContainer = document.getElementById('job-tabs-container');
        const jobNameEl = document.getElementById('job-name');
        const jobDateRangeEl = document.getElementById('job-daterange');
        const jobLocationEl = document.getElementById('job-location');
        const tableHeader = document.getElementById('table-header');
        const teamList = document.getElementById('team-list');
        const otherCostsList = document.getElementById('other-costs-list');
        const bgAmountEl = document.getElementById('bg-amount');
        const addPersonModal = document.getElementById('add-person-modal');
        const modalMemberList = document.getElementById('modal-member-list');
        const addDateModal = document.getElementById('add-date-modal');
        const newDateInput = document.getElementById('new-date-input');
        const addJobModal = document.getElementById('add-job-modal');
        const newJobNameInput = document.getElementById('new-job-name-input');
        const budgetInput = document.getElementById('total-budget-input');
        const whtToggle = document.getElementById('wht-toggle');
        const vatToggle = document.getElementById('vat-toggle');
        const syncStatusEl = document.getElementById('sync-status');
        const userProfileModal = document.getElementById('user-profile-modal');

        // --- DATA PERSISTENCE & SYNC ---
        async function syncWithSheet(action, payload = {}) {
            if (GOOGLE_APP_SCRIPT_URL === 'YOUR_NEW_GOOGLE_APP_SCRIPT_URL_HERE') {
                showNotification('กรุณาตั้งค่า Google App Script URL ก่อน', 'error');
                return { status: 'error', message: 'URL not configured' };
            }

            try {
                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action, payload }),
                    headers: { 'Content-Type': 'text/plain;charset=UTF-8' }, // Use text/plain to avoid CORS preflight
                    mode: 'cors'
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Action [${action}] failed:`, error);
                showNotification(`การเชื่อมต่อกับ Sheet ผิดพลาด`, 'error');
                return { status: 'error', message: error.toString() };
            }
        }

        async function saveAllData() {
            syncStatusEl.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> <span>กำลังบันทึก...</span>`;
            const payload = { users: appState.users, jobs: appState.jobs, currentJobId: appState.currentJobId };
            const result = await syncWithSheet('saveAllData', payload);
            if (result.status === 'success') {
                syncStatusEl.innerHTML = `<i class="fa-solid fa-cloud"></i> <span>บันทึกแล้ว</span>`;
            } else {
                syncStatusEl.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> <span>ผิดพลาด</span>`;
            }
        }
        
        async function loadAllData() {
            if (GOOGLE_APP_SCRIPT_URL === 'YOUR_NEW_GOOGLE_APP_SCRIPT_URL_HERE') {
                showNotification('กรุณาตั้งค่า Google App Script URL ในโค้ด', 'error');
                const defaultJob = createNewJob('ตัวอย่างงาน (ยังไม่ได้เชื่อมต่อ Sheet)');
                appState.jobs.push(defaultJob);
                appState.currentJobId = defaultJob.id;
                return;
            }

            const result = await syncWithSheet('loadAllData');
            if (result.status === 'success' && result.data) {
                appState.users = result.data.users || [];
                appState.jobs = result.data.jobs || [];
                appState.currentJobId = result.data.currentJobId || null;

                if (appState.jobs.length === 0) {
                    const defaultJob = createNewJob('ตัวอย่างงาน');
                    appState.jobs.push(defaultJob);
                    appState.currentJobId = defaultJob.id;
                }
                 if (!appState.currentJobId && appState.jobs.length > 0) {
                    appState.currentJobId = appState.jobs[0].id;
                }
            } else {
                 const defaultJob = createNewJob('ตัวอย่าง (โหลดไม่สำเร็จ)');
                 appState.jobs.push(defaultJob);
                 appState.currentJobId = defaultJob.id;
            }
        }


        // --- HELPER FUNCTIONS ---
        function getCurrentJob() {
            return appState.jobs.find(job => job.id === appState.currentJobId);
        }

        // --- RENDER FUNCTIONS ---
        function renderJobTabs() {
            const currentUser = appState.users.find(u => u.user === appState.loggedInUser);
            let jobsToDisplay = appState.jobs;

            if (currentUser && currentUser.role !== 'Admin') {
                jobsToDisplay = appState.jobs.filter(job => 
                    job.team.some(member => member.user === appState.loggedInUser)
                );
            }

            const tabsHtml = jobsToDisplay.map(job => `
                <div class="job-tab ${job.id === appState.currentJobId ? 'active' : ''}" data-job-id="${job.id}">
                    <i class="fa-solid fa-video"></i>
                    <span>${job.name}</span>
                </div>
            `).join('');
            
            jobTabsContainer.innerHTML = tabsHtml + `
                <button id="add-job-btn" class="text-gray-400 hover:text-gray-600 ml-2 admin-only">
                    <i class="fa-solid fa-plus-circle text-2xl"></i>
                </button>
            `;
        }

        function renderTableHeader() {
            const job = getCurrentJob();
            if (!job) return;

            const dateHeaders = job.dates.map((date, index) => 
                `<th class="py-2 text-center font-semibold text-gray-700">
                    <div class="date-header-item p-1" contenteditable="true" data-date-index="${index}">${date}</div>
                </th>`
            ).join('');
            
            tableHeader.innerHTML = `
                <tr class="border-b-2">
                    <th class="py-2 w-2/5">ชื่อ</th>
                    ${dateHeaders}
                    <th class="py-2 text-center w-16 admin-only">
                        <button id="add-date-btn" class="text-gray-400 hover:text-blue-500 text-lg">
                            <i class="fa-solid fa-plus-circle"></i>
                        </button>
                    </th>
                </tr>
            `;
        }

        function renderTeam() {
            const job = getCurrentJob();
            if (!job) return;

            teamList.innerHTML = job.team.map(member => {
                const nickname = member.nickname || member.user; // Fallback to username
                const avatarChar = nickname ? nickname.charAt(0).toUpperCase() : '?';
                const dateCells = job.dates.map(date => `
                    <td class="py-2 text-center">
                        <div class="flex flex-col items-center">
                            ${(member.dailyPay[date] || 0) > 0 ? '<i class="check-icon fa-solid fa-circle-check"></i>' : '<i class="cross-icon fa-solid fa-circle-xmark"></i>'}
                            <input type="number" class="daily-rate-input" value="${member.dailyPay[date] || 0}" data-date="${date}" data-member-id="${member.user}">
                        </div>
                    </td>
                `).join('');

                return `
                    <tr data-id="${member.user}">
                        <td class="py-2">
                            <div class="flex items-center space-x-3">
                                <img src="https://placehold.co/60x60/E2E8F0/4A5568?text=${avatarChar}" alt="${nickname}" class="w-10 h-10 rounded-full">
                                <div>
                                    <div class="font-bold text-gray-800 flex items-center">
                                        ${nickname}
                                        ${member.isLeader ? '<i class="fas fa-crown text-yellow-500 ml-2"></i>' : ''}
                                    </div>
                                    <div class="team-member-role text-sm text-gray-500" contenteditable="true" data-member-id="${member.user}">${member.role}</div>
                                </div>
                            </div>
                        </td>
                        ${dateCells}
                        <td class="py-2 text-center admin-only">
                            <button class="remove-member-btn text-gray-400 hover:text-red-500" data-id="${member.user}">
                                <i class="fa-solid fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderOtherCosts() {
            const job = getCurrentJob();
            if (!job) return;

            otherCostsList.innerHTML = job.otherCosts.map((item, index) => `
                <tr data-index="${index}">
                    <td class="py-1"><input type="text" value="${item.position}" class="cost-position-input p-1 border rounded w-full bg-gray-50"></td>
                    <td class="py-1"><input type="number" value="${item.cost}" class="cost-amount-input p-1 border rounded w-24 text-right bg-gray-50"></td>
                    <td class="py-1 text-center admin-only"><button class="remove-cost-btn text-red-500 hover:text-red-700"><i class="fa-solid fa-trash-alt"></i></button></td>
                </tr>
            `).join('');
        }
        
        function renderUIByRole() {
            const currentUser = appState.users.find(u => u.user === appState.loggedInUser);
            if (currentUser && currentUser.role === 'Admin') {
                appContainer.classList.add('is-admin');
            } else {
                appContainer.classList.remove('is-admin');
            }
        }

        function renderAll() {
            renderJobTabs();
            const job = getCurrentJob();

            if (job) {
                mainContent.classList.remove('hidden');
                
                jobNameEl.textContent = job.name;
                jobDateRangeEl.textContent = job.dateRange;
                jobLocationEl.textContent = job.location;
                bgAmountEl.innerHTML = `${job.bg.toLocaleString()} <span class="text-3xl font-medium">บาท</span>`;
                budgetInput.value = job.budget;
                whtToggle.checked = job.whtEnabled;
                vatToggle.checked = job.vatEnabled;

                renderTableHeader();
                renderTeam();
                renderOtherCosts();
                calculateAndRenderSummary();
            } else {
                mainContent.classList.add('hidden');
            }
            renderUIByRole();
        }

        // --- CALCULATION & SUMMARY ---
        function calculateAndRenderSummary() {
            const job = getCurrentJob();
            if (!job) return;

            let teamCost = 0;
            job.team.forEach(member => {
                teamCost += Object.values(member.dailyPay).reduce((sum, pay) => sum + (pay || 0), 0);
            });
            document.getElementById('summary-team-cost').textContent = teamCost.toLocaleString();

            let otherCostsTotal = job.otherCosts.reduce((sum, item) => sum + Number(item.cost), 0);
            document.getElementById('summary-other-cost').textContent = otherCostsTotal.toLocaleString();

            const subtotal = teamCost + otherCostsTotal;
            const whtEnabled = whtToggle.checked;
            const vatEnabled = vatToggle.checked;
            const whtPercent = Number(document.getElementById('wht-percent').value) || 0;

            const whtAmount = whtEnabled ? (subtotal * whtPercent / 100) : 0;
            const vatAmount = vatEnabled ? (subtotal * 7 / 100) : 0;
            const grandTotal = subtotal - whtAmount + vatAmount;

            document.getElementById('summary-wht').textContent = `-${whtAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('summary-vat').textContent = `+${vatAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('summary-grand-total').textContent = grandTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            const profitLoss = job.budget - grandTotal;
            const profitLossContainer = document.getElementById('profit-loss-container');
            if (profitLoss >= 0) {
                profitLossContainer.innerHTML = `<p class="text-sm text-green-600">กำไร</p><p class="text-4xl font-bold text-green-600">${profitLoss.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>`;
                profitLossContainer.className = 'p-4 rounded-lg text-center bg-green-50 border border-green-200';
            } else {
                profitLossContainer.innerHTML = `<p class="text-sm text-red-600">ขาดทุน</p><p class="text-4xl font-bold text-red-600">${Math.abs(profitLoss).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>`;
                profitLossContainer.className = 'p-4 rounded-lg text-center bg-red-50 border border-red-200';
            }
        }
        
        // --- EVENT HANDLERS ---
        function showNotification(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');

            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white py-3 px-5 rounded-lg shadow-lg z-50 ${type}`;
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function toggleModal(modal, show) {
            if (show) modal.classList.add('visible');
            else modal.classList.remove('visible');
        }

        function handleDateHeaderChange(e) {
            const job = getCurrentJob();
            if (!job) return;

            const newDate = e.target.textContent.trim();
            const index = parseInt(e.target.dataset.dateIndex);
            const oldDate = job.dates[index];

            if (newDate && newDate !== oldDate) {
                if (job.dates.includes(newDate)) {
                    alert("วันที่นี้มีอยู่แล้ว");
                    e.target.textContent = oldDate;
                    return;
                }
                job.dates[index] = newDate;
                job.team.forEach(member => {
                    if (Object.prototype.hasOwnProperty.call(member.dailyPay, oldDate)) {
                        member.dailyPay[newDate] = member.dailyPay[oldDate];
                        delete member.dailyPay[oldDate];
                    }
                });
                renderTeam();
                saveAllData();
            } else {
                e.target.textContent = oldDate;
            }
        }

        function handleAddDate() {
            const job = getCurrentJob();
            if (!job) return;
            const newDateStr = newDateInput.value;
            if (newDateStr && newDateStr.trim() !== '') {
                const trimmedDate = newDateStr.trim();
                if (job.dates.includes(trimmedDate)) {
                    alert("วันที่นี้มีอยู่แล้ว");
                    return;
                }
                job.dates.push(trimmedDate);
                job.team.forEach(member => {
                    member.dailyPay[trimmedDate] = 0;
                });
                newDateInput.value = '';
                toggleModal(addDateModal, false);
                renderAll();
            }
        }

        function handleRemoveMember(memberId) {
            const job = getCurrentJob();
            if (!job) return;
            const memberIndex = job.team.findIndex(m => m.user === memberId);
            if (memberIndex > -1) {
                const wasLeader = job.team[memberIndex].isLeader;
                job.team.splice(memberIndex, 1);
                
                if (wasLeader && job.team.length > 0) {
                    job.team[0].isLeader = true;
                }
                renderAll();
            }
        }

        function handleBudgetChange(e) {
            const job = getCurrentJob();
            if (job) {
                job.budget = parseFloat(e.target.value) || 0;
                calculateAndRenderSummary();
                saveAllData();
            }
        }
        
        function handleRoleChange(e) {
            const job = getCurrentJob();
            if (!job) return;
            const memberId = e.target.dataset.memberId;
            const newRole = e.target.textContent;
            const member = job.team.find(m => m.user === memberId);
            if (member) {
                member.role = newRole;
                saveAllData();
            }
        }

        function handleDailyRateChange(e) {
            const job = getCurrentJob();
            if (!job) return;
            const inputElement = e.target;
            const memberId = inputElement.dataset.memberId;
            const date = inputElement.dataset.date;
            const newPay = parseFloat(inputElement.value) || 0;
            
            const member = job.team.find(m => m.user === memberId);
            if (member) {
                member.dailyPay[date] = newPay;
                
                const iconElement = inputElement.parentElement.querySelector('i');
                if (newPay > 0) {
                    iconElement.className = 'check-icon fa-solid fa-circle-check';
                } else {
                    iconElement.className = 'cross-icon fa-solid fa-circle-xmark';
                }
                
                calculateAndRenderSummary();
                saveAllData();
            }
        }
        
        function handleCostChange(e) {
            const job = getCurrentJob();
            if (!job) return;
            const index = parseInt(e.target.closest('[data-index]').dataset.index);
            if (e.target.classList.contains('cost-position-input')) job.otherCosts[index].position = e.target.value;
            if (e.target.classList.contains('cost-amount-input')) job.otherCosts[index].cost = parseFloat(e.target.value) || 0;
            calculateAndRenderSummary();
            saveAllData();
        }

        function handleRemoveCost(e) {
            const job = getCurrentJob();
            if (!job) return;
            const index = parseInt(e.target.closest('[data-index]').dataset.index);
            job.otherCosts.splice(index, 1);
            renderAll();
        }

        function handleAddExpense() {
            const job = getCurrentJob();
            if (job) {
                job.otherCosts.push({ position: 'รายการใหม่', cost: 0 });
                renderAll();
            }
        }

        function openAddPersonModal() {
            const job = getCurrentJob();
            if (!job) return;
            const teamUsernames = job.team.map(m => m.user);
            const availableUsers = appState.users.filter(u => !teamUsernames.includes(u.user));
            
            modalMemberList.innerHTML = availableUsers.map(user => {
                const nickname = user.nickname || user.user;
                const avatarChar = nickname ? nickname.charAt(0).toUpperCase() : '?';
                return `
                <div class="flex justify-between items-center p-2 rounded-lg hover:bg-gray-100 cursor-pointer" data-id="${user.user}">
                    <div class="flex items-center space-x-3"><img src="https://placehold.co/60x60/E2E8F0/4A5568?text=${avatarChar}" class="w-10 h-10 rounded-full"><div><p class="font-semibold">${nickname}</p><p class="text-sm text-gray-500">${user.user}</p></div></div>
                    <button class="add-member-action bg-blue-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-600">เพิ่ม</button>
                </div>`
            }).join('');
            toggleModal(addPersonModal, true);
        }

        function handleAddMember(e) {
            const job = getCurrentJob();
            if (!job) return;
            const username = e.target.closest('[data-id]').dataset.id;
            const userToAdd = appState.users.find(u => u.user === username);
            
            if (userToAdd) {
                const newMember = {
                    user: userToAdd.user,
                    nickname: userToAdd.nickname,
                    role: "ทีมงาน",
                    dailyPay: {}
                };

                if (job.team.length === 0) {
                    newMember.isLeader = true;
                }

                job.dates.forEach(d => newMember.dailyPay[d] = 0);
                job.team.push(newMember);
                toggleModal(addPersonModal, false);
                renderAll();
            }
        }
        
        function handleJobDetailsChange(e) {
            const job = getCurrentJob();
            if (job) {
                job.name = jobNameEl.textContent;
                job.dateRange = jobDateRangeEl.textContent;
                job.location = jobLocationEl.textContent;
                renderJobTabs();
                saveAllData();
            }
        }

        function handleAddNewJob() {
            const name = newJobNameInput.value.trim();
            if (name) {
                const newJob = createNewJob(name);
                appState.jobs.push(newJob);
                appState.currentJobId = newJob.id;
                newJobNameInput.value = '';
                toggleModal(addJobModal, false);
                renderAll();
            }
        }

        function handleSwitchJob(jobId) {
            appState.currentJobId = jobId;
            renderAll();
        }

        // --- AUTH FUNCTIONS ---
        async function handleRegister() {
            const user = document.getElementById('register-user').value.trim();
            const nickname = document.getElementById('register-nickname').value.trim();
            const pass = document.getElementById('register-pass').value.trim();
            const phone = document.getElementById('register-phone').value.trim();

            if (!user || !pass || !phone || !nickname) {
                showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
                return;
            }

            if (appState.users.find(u => u.user === user)) {
                showNotification('ชื่อผู้ใช้นี้มีอยู่แล้ว', 'error');
                return;
            }

            const role = appState.users.length === 0 ? 'Admin' : 'User';
            appState.users.push({ user, pass, phone, nickname, role, bankName: '', accountName: '', accountNumber: '' });
            await saveAllData();
            showNotification('สมัครสมาชิกสำเร็จ!', 'success');
            registerView.classList.add('hidden');
            loginView.classList.remove('hidden');
        }

        async function handleLogin() {
            const user = document.getElementById('login-user').value.trim();
            const pass = document.getElementById('login-pass').value.trim();

            const foundUser = appState.users.find(u => u.user === user && u.pass === pass);
            if (foundUser) {
                appState.loggedInUser = user;
                sessionStorage.setItem('ldbQueueUser', user);
                
                authScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.getElementById('current-user-display').textContent = foundUser.nickname || user;

                renderAll();
            } else {
                showNotification('ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง', 'error');
            }
        }

        function handleLogout() {
            appState.loggedInUser = null;
            sessionStorage.removeItem('ldbQueueUser');
            authScreen.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }

        function openUserProfile() {
            const user = appState.users.find(u => u.user === appState.loggedInUser);
            if (!user) return;

            document.getElementById('profile-user').value = user.user;
            document.getElementById('profile-nickname').value = user.nickname;
            document.getElementById('profile-bank-name').value = user.bankName || '';
            document.getElementById('profile-account-name').value = user.accountName || '';
            document.getElementById('profile-account-number').value = user.accountNumber || '';
            document.getElementById('profile-old-pass').value = '';
            document.getElementById('profile-new-pass').value = '';

            toggleModal(userProfileModal, true);
        }

        async function handleUpdateProfile() {
            const user = appState.users.find(u => u.user === appState.loggedInUser);
            if (!user) return;

            const newNickname = document.getElementById('profile-nickname').value.trim();
            const oldPass = document.getElementById('profile-old-pass').value;
            const newPass = document.getElementById('profile-new-pass').value;
            
            user.nickname = newNickname;
            user.bankName = document.getElementById('profile-bank-name').value;
            user.accountName = document.getElementById('profile-account-name').value.trim();
            user.accountNumber = document.getElementById('profile-account-number').value.trim();

            if (oldPass && newPass) {
                if (oldPass !== user.pass) {
                    showNotification('รหัสผ่านเดิมไม่ถูกต้อง', 'error');
                    return;
                }
                user.pass = newPass;
            }

            await saveAllData();
            showNotification('บันทึกข้อมูลส่วนตัวสำเร็จ', 'success');
            toggleModal(userProfileModal, false);
            document.getElementById('current-user-display').textContent = newNickname || user.user;
        }

        // --- EVENT LISTENERS ---
        document.body.addEventListener('click', (e) => {
            const target = e.target;
            // Auth buttons
            if (target.id === 'show-register-view') {
                e.preventDefault();
                loginView.classList.add('hidden');
                registerView.classList.remove('hidden');
            }
            if (target.id === 'show-login-view') {
                e.preventDefault();
                registerView.classList.add('hidden');
                loginView.classList.remove('hidden');
            }
            if (target.id === 'register-btn') handleRegister();
            if (target.id === 'login-btn') handleLogin();
            if (target.closest('#logout-btn')) handleLogout();
            if (target.closest('#profile-btn')) openUserProfile();
            if (target.id === 'confirm-update-profile') handleUpdateProfile();
            if (target.id === 'cancel-update-profile') toggleModal(userProfileModal, false);


            // App buttons
            const jobTab = target.closest('.job-tab');
            const addJobBtn = target.closest('#add-job-btn');
            const confirmAddJobBtn = target.closest('#confirm-add-job');
            const cancelAddJobBtn = target.closest('#cancel-add-job');
            const addDateBtn = target.closest('#add-date-btn');
            const addPersonBtn = target.closest('#add-person-btn');
            const addExpenseBtn = target.closest('#add-expense-btn');
            const removeCostBtn = target.closest('.remove-cost-btn');
            const addMemberAction = target.closest('.add-member-action');
            const confirmAddDateBtn = target.closest('#confirm-add-date');
            const cancelAddDateBtn = target.closest('#cancel-add-date');
            const cancelAddPersonBtn = target.closest('#cancel-add-person');
            const removeMemberBtn = target.closest('.remove-member-btn');
            const deleteJobBtn = target.closest('#delete-job-btn');

            if (jobTab) handleSwitchJob(parseInt(jobTab.dataset.jobId));
            else if (addJobBtn) toggleModal(addJobModal, true);
            else if (confirmAddJobBtn) handleAddNewJob();
            else if (cancelAddJobBtn) toggleModal(addJobModal, false);
            else if (addDateBtn) toggleModal(addDateModal, true);
            else if (addPersonBtn) openAddPersonModal();
            else if (addExpenseBtn) handleAddExpense();
            else if (removeCostBtn) handleRemoveCost(e);
            else if (addMemberAction) handleAddMember(e);
            else if (confirmAddDateBtn) handleAddDate();
            else if (cancelAddDateBtn) toggleModal(addDateModal, false);
            else if (cancelAddPersonBtn) toggleModal(addPersonModal, false);
            else if (removeMemberBtn) handleRemoveMember(removeMemberBtn.dataset.id);
        });

        document.body.addEventListener('blur', (e) => {
            if (e.target.classList.contains('team-member-role')) handleRoleChange(e);
            else if (e.target.classList.contains('date-header-item')) handleDateHeaderChange(e);
            else if (e.target.id === 'job-name' || e.target.id === 'job-daterange' || e.target.id === 'job-location') handleJobDetailsChange(e);
        }, true);

        document.body.addEventListener('change', (e) => {
            if (e.target.classList.contains('daily-rate-input')) handleDailyRateChange(e);
            else if (e.target.id === 'wht-toggle' || e.target.id === 'vat-toggle' || e.target.id === 'wht-percent') {
                const job = getCurrentJob();
                if (job) {
                    job.whtEnabled = whtToggle.checked;
                    job.vatEnabled = vatToggle.checked;
                    calculateAndRenderSummary();
                    saveAllData();
                }
            }
        });
        
        document.body.addEventListener('input', (e) => {
            if (e.target.classList.contains('cost-position-input') || e.target.classList.contains('cost-amount-input')) handleCostChange(e);
            else if (e.target.id === 'total-budget-input') handleBudgetChange(e);
        });

        // --- INITIALIZATION ---
        async function init() {
            const loggedInUser = sessionStorage.getItem('ldbQueueUser');
            await loadAllData(); 
            
            if (loggedInUser && appState.users.some(u => u.user === loggedInUser)) {
                appState.loggedInUser = loggedInUser;
                authScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                const user = appState.users.find(u => u.user === loggedInUser);
                document.getElementById('current-user-display').textContent = user.nickname || user.user;
                renderAll();
            } else {
                authScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        }

        init();
    });
    </script>
</body>
</html>
