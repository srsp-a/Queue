<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDB QUEUE - Job Management (v4)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Kanit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- html2canvas for image capture -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f0f2f5;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #ef4444 0%, #ec4899 100%);
        }
        .main-gradient-text {
            background: linear-gradient(90deg, #ef4444, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .profit-text {
            color: #22c55e; /* green-500 */
        }
        .loss-text {
            color: #ef4444; /* red-500 */
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        .hidden {
            display: none;
        }
        .date-header:hover .date-action-btn {
            opacity: 1;
        }
        .custom-checkbox {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #d1d5db; /* gray-300 */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #f9fafb; /* gray-50 */
        }
        .custom-checkbox.checked {
            background-color: #22c55e; /* green-500 */
            border-color: #22c55e;
        }
        .custom-checkbox .ph-check {
            color: white;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .custom-checkbox.checked .ph-check {
            opacity: 1;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .dragging {
            opacity: 0.5;
            background: #fef9c3; /* yellow-100 */
        }
        .drag-over {
            border-top: 2px solid #ef4444;
        }
        #financial-filter-buttons .active, #show-custom-range-btn.active {
            background-color: #ec4899;
            color: white;
        }
        .drag-handle {
            cursor: grab;
            opacity: 0.2;
            transition: opacity 0.2s;
        }
        tr:hover .drag-handle {
            opacity: 1;
        }
        .job-card-title {
            height: 3rem; /* Height for 2 lines */
            line-height: 1.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Impersonation Banner -->
    <div id="impersonation-banner" class="hidden fixed top-0 left-0 right-0 bg-yellow-400 text-black p-2 text-center z-50 shadow-lg">
        กำลังดูในฐานะ: <span id="impersonated-user-name" class="font-bold"></span>
        <button id="return-to-admin-btn" class="ml-4 bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 text-sm">กลับสู่มุมมองแอดมิน</button>
    </div>

    <!-- Main Container -->
    <div id="app-container" class="min-h-screen">

        <!-- Public View (Visible to everyone) -->
        <div id="public-view" class="p-4 sm:p-6 lg:p-8">
            <header class="flex flex-wrap items-center justify-between pb-6 mb-6 border-b-2 border-gray-200">
                <div>
                    <h1 class="text-4xl font-bold main-gradient-text">LDB QUEUE</h1>
                    <p class="mt-1 text-gray-500">คิวงานทั้งหมด</p>
                </div>
                <div class="flex items-center space-x-2 md:space-x-4 mt-4 sm:mt-0">
                    <p class="text-sm text-gray-500">คลิกที่คิวงานเพื่อดูรายละเอียดและลงชื่อเข้าใช้</p>
                </div>
            </header>
            <section class="max-w-7xl mx-auto">
                <div class="flex flex-wrap items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold">รายการคิวงาน</h2>
                </div>
                <div id="public-job-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <!-- Public job list will be rendered here -->
                </div>
            </section>
        </div>

        <!-- Login Modal (was a screen) -->
        <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-xl modal-content">
                <div class="text-center">
                    <h1 class="text-4xl font-bold main-gradient-text">LDB QUEUE</h1>
                    <p class="mt-2 text-gray-500">ลงชื่อเข้าใช้เพื่อจัดการคิวงาน</p>
                </div>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-identifier" class="text-sm font-medium text-gray-700">อีเมล หรือ Username</label>
                        <input id="login-identifier" name="loginIdentifier" type="text" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="อีเมล หรือ username">
                    </div>
                    <div>
                        <label for="password" class="text-sm font-medium text-gray-700">รหัสผ่าน</label>
                        <div class="relative mt-1">
                            <input id="password" name="password" type="password" required class="w-full px-4 py-2 pr-28 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="••••••••">
                            <a href="#" id="forgot-password-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 text-sm font-medium text-red-600 hover:text-red-500">ลืมรหัสผ่าน?</a>
                        </div>
                    </div>
                    <p id="login-error" class="text-sm text-red-500 hidden"></p>
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white gradient-bg rounded-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-300 disabled:opacity-75">
                        ลงชื่อเข้าใช้
                    </button>
                </form>
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-400 text-sm">หรือเข้าสู่ระบบด้วย</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>
                <div class="grid grid-cols-1 gap-4">
                     <button id="line-login-btn" class="w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-500 hover:bg-green-600">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M21.43,11.3,17.5,6.5a1,1,0,0,0-1.41,0,1,1,0,0,0,0,1.41L18.59,10H15a1,1,0,0,0,0,2h3.59l-2.5,2.59a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0L21.43,12.7A1,1,0,0,0,21.43,11.3ZM12,2A10,10,0,1,0,22,12,10,10,0,0,0,12,2Zm0,18a8,8,0,1,1,8-8A8,8,0,0,1,12,20ZM7,11H4a1,1,0,0,0,0,2H7a1,1,0,0,0,0-2Z"/></svg>
                        เข้าสู่ระบบด้วย LINE
                    </button>
                </div>
                <p class="text-center text-sm text-gray-600">
                    ยังไม่มีบัญชี? <a href="#" id="show-signup-modal-btn" class="font-medium text-red-600 hover:text-red-500">สมัครสมาชิกที่นี่</a>
                </p>
                 <button id="close-login-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
        </div>
        
        <!-- Sign Up Modal -->
        <div id="signup-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 m-4 modal-content">
                <h2 class="text-2xl font-bold text-center">สร้างบัญชีใหม่</h2>
                <form id="signup-form" class="mt-6 space-y-4">
                    <div>
                        <label for="signup-username" class="text-sm font-medium text-gray-700">Username (สำหรับล็อกอิน, ไม่สามารถเปลี่ยนได้)</label>
                        <input type="text" id="signup-username" name="username" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label for="signup-email" class="text-sm font-medium text-gray-700">อีเมล</label>
                        <input type="email" id="signup-email" name="email" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label for="signup-password" class="text-sm font-medium text-gray-700">รหัสผ่าน</label>
                        <input type="password" id="signup-password" name="password" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label for="signup-confirm-password" class="text-sm font-medium text-gray-700">ยืนยันรหัสผ่าน</label>
                        <input type="password" id="signup-confirm-password" name="confirmPassword" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                    </div>
                    <p id="signup-error" class="text-sm text-red-500 hidden"></p>
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white gradient-bg rounded-lg hover:opacity-90 disabled:opacity-75">สมัครสมาชิก</button>
                </form>
                 <p class="text-center text-sm text-gray-600 mt-4">
                    มีบัญชีอยู่แล้ว? <a href="#" id="show-login-modal-btn" class="font-medium text-red-600 hover:text-red-500">กลับไปล็อกอิน</a>
                </p>
                 <button id="close-signup-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
        </div>

        <!-- Change Password Modal -->
        <div id="change-password-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 m-4 modal-content">
                <h2 class="text-2xl font-bold text-center">เปลี่ยนรหัสผ่านใหม่</h2>
                <p class="text-center text-gray-500 mt-2">เพื่อความปลอดภัย กรุณาตั้งรหัสผ่านใหม่สำหรับใช้งานครั้งแรก</p>
                <form id="change-password-form" class="mt-6 space-y-4">
                    <div>
                        <label for="new-password" class="text-sm font-medium text-gray-700">รหัสผ่านใหม่</label>
                        <input type="password" id="new-password" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                    </div>
                    <p id="password-error" class="text-sm text-red-500 hidden"></p>
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white gradient-bg rounded-lg hover:opacity-90">
                        ยืนยันและเข้าสู่ระบบ
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App Screen (For logged-in users) -->
        <div id="main-app" class="hidden p-4 sm:p-6 lg:p-8">
            <header class="flex flex-wrap items-center justify-between pb-6 mb-6 border-b-2 border-gray-200">
                <div>
                    <h1 class="text-4xl font-bold main-gradient-text">LDB QUEUE</h1>
                    <p id="user-info" class="mt-1 text-gray-500">สวัสดี, <span id="user-name-display" class="font-medium"></span> (<span id="user-role" class="font-medium"></span>)</p>
                    <p class="text-xs text-gray-400">User ID: <span id="user-id-display"></span></p>
                </div>
                <div class="flex items-center space-x-2 md:space-x-4 mt-4 sm:mt-0">
                    <button id="notifications-button" class="relative p-2 text-gray-600 bg-gray-200 rounded-full hover:bg-gray-300 focus:outline-none">
                        <i class="ph ph-bell text-xl"></i>
                        <span id="notification-badge" class="absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-500 hidden"></span>
                    </button>
                    <button id="system-settings-button" class="px-4 py-2 font-semibold text-white bg-gray-600 rounded-lg hover:bg-gray-700 transition-colors admin-only">
                        <i class="ph ph-wrench mr-1"></i> ตั้งค่าระบบ
                    </button>
                    <button id="manage-all-users-button" class="px-4 py-2 font-semibold text-white bg-indigo-500 rounded-lg hover:bg-indigo-600 transition-colors admin-only">
                        <i class="ph ph-users-three mr-1"></i> จัดการทีมงาน
                    </button>
                     <button id="financial-summary-button" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                        <i class="ph ph-chart-bar mr-1"></i> สรุปบัญชีการเงิน
                    </button>
                    <button id="manage-profile-button" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                        <i class="ph ph-gear mr-1"></i> จัดการโปรไฟล์
                    </button>
                    <button id="logout-button" class="px-4 py-2 font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="ph ph-sign-out mr-1"></i> Logout
                    </button>
                </div>
            </header>

            <!-- Job List -->
            <section class="max-w-7xl mx-auto">
                <div class="flex flex-wrap items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold">รายการคิวงาน</h2>
                    <div class="flex items-center space-x-2 mt-2 md:mt-0">
                        <button id="add-job-button" class="px-4 py-2 font-semibold text-white gradient-bg rounded-lg hover:opacity-90 admin-only">
                            <i class="ph ph-plus-circle mr-1"></i> เพิ่มคิวงานใหม่
                        </button>
                        <div id="member-job-filters" class="hidden items-center space-x-2">
                            <button id="filter-my-jobs" class="px-4 py-2 text-sm font-semibold rounded-lg">คิวงานของฉัน</button>
                            <button id="filter-all-jobs" class="px-4 py-2 text-sm font-semibold rounded-lg">คิวงานทั้งหมด</button>
                        </div>
                    </div>
                </div>
                <div id="job-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
            </section>

            <!-- Selected Job Details -->
            <section id="job-details-section" class="mt-8 hidden">
                <div class="p-6 bg-white rounded-2xl shadow-lg">
                    <!-- This div is the main container for the image capture -->
                    <div id="capture-area">
                        <div class="flex flex-wrap items-start justify-between pb-4 mb-4 border-b">
                            <div>
                                <div class="flex items-center">
                                    <h3 id="job-title" class="text-3xl font-bold text-gray-800"></h3>
                                    <button id="edit-job-details-btn" class="ml-3 text-gray-400 hover:text-red-600 admin-only"><i class="ph ph-pencil-simple"></i></button>
                                </div>
                                <p id="job-dates" class="text-gray-500"></p>
                                <p id="job-location" class="flex items-center mt-1 text-gray-500"><i class="ph ph-map-pin mr-2"></i><span id="job-location-text"></span></p>
                            </div>
                            <div class="text-right mt-4 sm:mt-0">
                                <p id="budget-label" class="text-gray-500 font-bold text-lg">งบประมาณ</p>
                                <div class="flex items-center justify-end">
                                    <div id="member-wage-container" class="text-right">
                                        <p id="job-income" class="text-3xl font-bold"></p>
                                        <p id="member-paid-status" class="text-sm text-green-600 font-medium hidden"></p>
                                    </div>
                                    <button id="edit-budget-btn" class="ml-2 text-gray-400 hover:text-red-600 admin-only"><i class="ph ph-pencil-simple"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-2">
                                <h4 class="text-xl font-semibold mb-4">ทีมงาน</h4>
                                <div class="overflow-x-auto"><table class="min-w-full bg-white"><thead id="schedule-head"></thead><tbody id="schedule-body"></tbody></table></div>
                                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="admin-only">
                                        <label for="admin-notes-textarea" class="block text-xl font-semibold mb-2">หมายเหตุ (แอดมิน):</label>
                                        <textarea id="admin-notes-textarea" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="หมายเหตุสำหรับแอดมินเท่านั้น..."></textarea>
                                    </div>
                                    <div id="team-notes-container">
                                        <label for="team-notes-textarea" class="block text-xl font-semibold mb-2">โน้ต:</label>
                                        <textarea id="team-notes-textarea" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="โน้ตสำหรับทีมงานทุกคน..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="admin-only">
                                <div class="flex justify-between items-center mb-4"><h4 class="text-xl font-semibold">ค่าใช้จ่ายอื่นๆ</h4><button id="add-expense-button" class="px-3 py-2 text-sm font-semibold text-white bg-orange-500 rounded-lg hover:bg-orange-600 admin-only"><i class="ph ph-plus mr-1"></i> เพิ่ม</button></div>
                                <div id="expense-list" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Buttons are now outside the capture area -->
                     <div class="mt-4 flex space-x-2">
                        <button id="add-member-button" class="px-3 py-2 text-sm font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 admin-only"><i class="ph ph-user-plus mr-1"></i> เพิ่มทีมงาน</button>
                        <button id="add-day-button" class="px-3 py-2 text-sm font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 admin-only"><i class="ph ph-calendar-plus mr-1"></i> เพิ่มวันทำงาน</button>
                        <button id="save-image-btn" class="px-3 py-2 text-sm font-semibold text-white bg-purple-500 rounded-lg hover:bg-purple-600 admin-only"><i class="ph ph-image mr-1"></i> บันทึกรูปภาพ</button>
                    </div>
                    <div class="mt-8 pt-6 border-t-2 border-dashed admin-only">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="text-xl font-semibold mb-4">สรุปค่าใช้จ่าย</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center"><p>ค่าทีมงานรวม</p><p id="summary-team-cost" class="font-semibold">0 บาท</p></div>
                                    <div class="flex justify-between items-center"><p>ค่าใช้จ่ายอื่นๆ รวม</p><p id="summary-other-expenses" class="font-semibold">0 บาท</p></div>
                                    <hr>
                                    <div class="flex justify-between items-center"><div class="flex items-center"><input type="checkbox" id="wht-toggle" class="h-4 w-4 rounded border-gray-300 text-red-600 focus:ring-red-500"><label for="wht-toggle" class="ml-2">หัก ณ ที่จ่าย (<input type="number" id="wht-percent" value="3" class="w-12 text-center bg-gray-100 rounded">%)</label></div><p id="summary-wht" class="font-semibold">0 บาท</p></div>
                                    <div class="flex justify-between items-center"><div class="flex items-center"><input type="checkbox" id="vat-toggle" class="h-4 w-4 rounded border-gray-300 text-red-600 focus:ring-red-500"><label for="vat-toggle" class="ml-2">VAT (7%)</label></div><p id="summary-vat" class="font-semibold">0 บาท</p></div>
                                    <hr>
                                    <div class="flex justify-between items-center text-lg font-bold"><p>รวมค่าใช้จ่ายทั้งหมด</p><p id="summary-total-cost" class="text-red-500">0 บาท</p></div>
                                </div>
                            </div>
                            <div class="flex flex-col items-center justify-center p-6 rounded-2xl bg-gray-50">
                                <p id="profit-loss-label" class="text-2xl font-semibold">กำไร</p>
                                <p id="summary-profit-loss" class="font-bold mt-2">0.00 บาท</p>
                                <div id="payment-summary-container" class="mt-4 text-center">
                                    <p id="payment-summary" class="text-gray-600"></p>
                                    <button id="pay-all-btn" class="mt-2 px-4 py-2 font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 text-sm disabled:opacity-50 disabled:cursor-not-allowed">จ่ายค่าแรงครบแล้ว</button>
                                </div>
                                <button id="complete-job-btn" class="mt-4 px-6 py-2 font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors admin-only">
                                    <i class="ph ph-check-circle mr-1"></i> เสร็จงานแล้ว
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Financial Summary View -->
        <div id="financial-summary-view" class="hidden p-4 sm:p-6 lg:p-8">
            <!-- Header -->
            <header class="flex items-center justify-between pb-6 mb-6 border-b-2 border-gray-200">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">สรุปบัญชีและการเงิน</h1>
                    <p class="mt-1 text-gray-500">รายงานรายรับ-รายจ่าย และค่าแรงทีมงาน</p>
                </div>
                <button id="back-to-main-app-btn" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                    <i class="ph ph-arrow-left mr-1"></i> กลับหน้าหลัก
                </button>
            </header>

            <!-- Date Filter -->
            <section class="p-4 mb-6 bg-white rounded-2xl shadow-lg">
                <div class="flex flex-wrap items-center gap-4">
                    <div id="financial-filter-buttons" class="flex items-center p-1 bg-gray-200 rounded-lg">
                        <button data-period="1m" class="px-4 py-1 text-sm font-semibold rounded-md">1 เดือน</button>
                        <button data-period="2m" class="px-4 py-1 text-sm font-semibold rounded-md">2 เดือน</button>
                        <button data-period="3m" class="px-4 py-1 text-sm font-semibold rounded-md">3 เดือน</button>
                        <button data-period="6m" class="px-4 py-1 text-sm font-semibold rounded-md">6 เดือน</button>
                        <button data-period="1y" class="px-4 py-1 text-sm font-semibold rounded-md">1 ปี</button>
                    </div>
                    <div id="month-year-selector" class="flex items-center gap-2">
                        <select id="summary-month" class="p-2 border rounded-lg"></select>
                        <select id="summary-year" class="p-2 border rounded-lg"></select>
                    </div>
                    <button id="show-custom-range-btn" class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-200 hover:bg-gray-300">
                        ค้นหาตามช่วงเวลา
                    </button>
                </div>
                <div id="custom-date-range-selector" class="hidden flex-wrap items-end gap-4 mt-4">
                    <div class="flex items-end gap-4">
                        <div>
                            <label for="summary-start-date" class="text-sm font-medium text-gray-700">ตั้งแต่</label>
                            <input type="date" id="summary-start-date" class="p-2 border rounded-lg">
                        </div>
                        <div>
                            <label for="summary-end-date" class="text-sm font-medium text-gray-700">ถึง</label>
                            <input type="date" id="summary-end-date" class="p-2 border rounded-lg">
                        </div>
                        <button id="summary-search-button" class="px-6 py-2 font-semibold text-white gradient-bg rounded-lg hover:opacity-90">
                            ค้นหา
                        </button>
                    </div>
                </div>
            </section>

            <!-- Admin Summary -->
            <div id="admin-summary-container" class="hidden space-y-8">
                 <!-- Charts and Stats -->
                <section>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h2 class="text-2xl font-semibold mb-4">สรุปภาพรวม</h2>
                            <div class="p-4 bg-white rounded-2xl shadow-lg">
                                <canvas id="financial-chart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h2 class="text-2xl font-semibold mb-4">สถิติ</h2>
                            <div class="space-y-4">
                                <div class="p-4 bg-white rounded-2xl shadow-lg">
                                    <h3 class="font-semibold mb-2">ค่าแรงทีมงาน</h3>
                                    <p>จ่ายแล้ว: <span id="stat-paid-wages" class="font-bold profit-text">0</span> บาท</p>
                                    <p>ยังไม่จ่าย: <span id="stat-unpaid-wages" class="font-bold loss-text">0</span> บาท</p>
                                </div>
                                <div class="p-4 bg-white rounded-2xl shadow-lg">
                                    <h3 class="font-semibold mb-2">ทีมงานที่ได้รับเงินสูงสุด</h3>
                                    <div id="stat-top-earners" class="space-y-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Income/Expense Summary -->
                <section>
                    <h2 class="text-2xl font-semibold mb-4">สรุปรายรับ-รายจ่าย</h2>
                    <div class="overflow-x-auto bg-white rounded-2xl shadow-lg">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่องาน</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">รายรับ</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">รายจ่ายทั้งหมด</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">กำไร/ขาดทุน</th>
                                </tr>
                            </thead>
                            <tbody id="job-summary-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                            <tfoot class="bg-gray-100 font-bold">
                                <tr>
                                    <td class="px-6 py-4 text-left">รวมทั้งหมด</td>
                                    <td id="total-income-summary" class="px-6 py-4 text-right">0</td>
                                    <td id="total-expense-summary" class="px-6 py-4 text-right">0</td>
                                    <td id="total-profit-summary" class="px-6 py-4 text-right">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </section>

                <!-- Team Wage Summary -->
                <section>
                    <h2 class="text-2xl font-semibold mb-4">สรุปค่าแรงทีมงาน</h2>
                    <div class="overflow-x-auto bg-white rounded-2xl shadow-lg">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อทีมงาน</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ค่าแรงรวม</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">รับเงินแล้ว</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ยังไม่ได้รับเงิน</th>
                                </tr>
                            </thead>
                            <tbody id="team-wage-summary-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                            <tfoot class="bg-gray-100 font-bold">
                                <tr>
                                    <td class="px-6 py-4 text-left">รวมทั้งหมด</td>
                                    <td id="total-wage-summary" class="px-6 py-4 text-right">0</td>
                                    <td id="total-paid-wage-summary" class="px-6 py-4 text-right">0</td>
                                    <td id="total-unpaid-wage-summary" class="px-6 py-4 text-right">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </section>
            </div>

            <!-- Member Summary -->
            <div id="member-summary-container" class="hidden">
                <section>
                    <h2 class="text-2xl font-semibold mb-4">สรุปรายรับ</h2>
                    <div class="overflow-x-auto bg-white rounded-2xl shadow-lg">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่องาน</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">BG ที่ได้รับ</th>
                                </tr>
                            </thead>
                            <tbody id="member-wage-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                             <tfoot class="bg-gray-100 font-bold">
                                <tr>
                                    <td class="px-6 py-4 text-left">รวมทั้งหมด</td>
                                    <td id="member-total-wage-summary" class="px-6 py-4 text-right">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </section>
            </div>
        </div>

        <!-- System Settings View -->
        <div id="settings-view" class="hidden p-4 sm:p-6 lg:p-8">
            <!-- Header -->
            <header class="flex items-center justify-between pb-6 mb-6 border-b-2 border-gray-200">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">ตั้งค่าระบบ</h1>
                    <p class="mt-1 text-gray-500">จัดการการตั้งค่าทั่วไปของแอปพลิเคชัน</p>
                </div>
                <button id="back-to-main-from-settings-btn" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                    <i class="ph ph-arrow-left mr-1"></i> กลับหน้าหลัก
                </button>
            </header>
            <!-- Settings Form -->
            <section class="max-w-2xl mx-auto p-6 bg-white rounded-2xl shadow-lg">
                <form id="settings-form" class="space-y-6">
                    <div>
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Cloudinary (สำหรับอัปโหลดรูป)</h3>
                         <div class="mt-4 grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-4">
                            <div>
                                <label for="setting-cloudinary-name" class="block text-sm font-medium text-gray-700">Cloud Name</label>
                                <input type="text" name="cloudinaryName" id="setting-cloudinary-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                             <div>
                                <label for="setting-cloudinary-preset" class="block text-sm font-medium text-gray-700">Upload Preset</label>
                                <input type="text" name="cloudinaryPreset" id="setting-cloudinary-preset" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                        </div>
                    </div>
                     <div>
                        <h3 class="text-lg font-medium leading-6 text-gray-900">LINE Login</h3>
                        <p class="mt-1 text-sm text-gray-500">ตั้งค่าสำหรับการเข้าสู่ระบบด้วย LINE</p>
                        <div class="mt-4 grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-4">
                            <div>
                                <label for="setting-line-channel-id" class="block text-sm font-medium text-gray-700">Channel ID (App ID)</label>
                                <input type="text" name="lineChannelId" id="setting-line-channel-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="setting-line-channel-secret" class="block text-sm font-medium text-gray-700">
                                    Channel Secret 
                                    <span class="tooltip inline-block">
                                        <i class="ph ph-info text-gray-400"></i>
                                        <span class="tooltiptext">เพื่อความปลอดภัยสูงสุด Channel Secret ควรถูกจัดเก็บเป็น Environment Variable ใน Cloud Function เท่านั้น ไม่ควรเก็บในฐานข้อมูลโดยตรง</span>
                                    </span>
                                </label>
                                <input type="text" name="lineChannelSecret" id="setting-line-channel-secret" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                        </div>
                    </div>
                     <div>
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Facebook Login</h3>
                        <p class="mt-1 text-sm text-gray-500">ตั้งค่าสำหรับการเข้าสู่ระบบด้วย Facebook</p>
                        <div class="mt-4 grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-4">
                            <div>
                                <label for="setting-facebook-app-id" class="block text-sm font-medium text-gray-700">App ID</label>
                                <input type="text" name="facebookAppId" id="setting-facebook-app-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="setting-facebook-app-secret" class="block text-sm font-medium text-gray-700">
                                    App Secret
                                    <span class="tooltip inline-block">
                                        <i class="ph ph-info text-gray-400"></i>
                                        <span class="tooltiptext">เพื่อความปลอดภัยสูงสุด App Secret ควรถูกจัดเก็บเป็น Environment Variable ใน Cloud Function เท่านั้น ไม่ควรเก็บในฐานข้อมูลโดยตรง</span>
                                    </span>
                                </label>
                                <input type="text" name="facebookAppSecret" id="setting-facebook-app-secret" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="px-6 py-2 font-semibold text-white gradient-bg rounded-lg hover:opacity-90">
                            บันทึกการตั้งค่า
                        </button>
                    </div>
                </form>
            </section>
        </div>

    </div>

    <!-- Modals Container -->
    <div id="modals-container"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, sendPasswordResetEmail, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, query, where, getDocs, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAedyGR43aEAO_BFufGmplJVuGkmIEYgG0",
          authDomain: "job-queue-app.firebaseapp.com",
          projectId: "job-queue-app",
          storageBucket: "job-queue-app.appspot.com",
          messagingSenderId: "247047529613",
          appId: "1:247047529613:web:d27a980d1de33c22052ec4"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, currentUserData = null, currentUserRole = null;
        let currentJobId = null, currentJobData = null;
        let jobUnsubscribe = null, usersUnsubscribe = null, notificationsUnsubscribe = null;
        let allUsers = [];
        let allJobs = [];
        let allActiveJobs = []; // For filtering
        let allCompletedJobs = []; // For financial summary
        let allNotifications = [];
        let originalAdminData = null;
        let memberJobFilter = 'my_jobs'; // 'my_jobs' or 'all'
        let financialChart = null;
        let financialFilter = '1m'; // '1m', '2m', '3m', '6m', '1y', 'all'
        let draggedItem = null;
        let appSettings = {
            whtPercent: 3,
            cloudinaryName: "dzs7zbikj",
            cloudinaryPreset: "UploadpresetsQ",
            lineChannelId: "",
            lineChannelSecret: "",
            facebookAppId: "",
            facebookAppSecret: ""
        };

        const publicView = document.getElementById('public-view');
        const mainApp = document.getElementById('main-app');
        const loginModal = document.getElementById('login-modal');
        const signupModal = document.getElementById('signup-modal');
        
        onAuthStateChanged(auth, async (user) => {
            if (user && !originalAdminData) { // Only run if not in impersonation mode
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    currentUserData = userDocSnap.data();
                    currentUserRole = currentUserData.role;
                    if (currentUserData.forcePasswordChange) showLoginScreen(null, true);
                    else await initializeAppUI();
                } else {
                    const newUserDoc = { email: user.email, name: user.email.split('@')[0], nickname: '', role: 'member', forcePasswordChange: false, profilePic: '', bankAccount: { name: '', bank: '', number: '' }, phone: '' };
                    try {
                        await setDoc(userDocRef, newUserDoc);
                        currentUserData = newUserDoc;
                        currentUserRole = 'member';
                        await initializeAppUI();
                    } catch (error) { showLoginScreen("เกิดข้อผิดพลาดในการตั้งค่าบัญชีผู้ใช้"); }
                }
            } else if (!user) {
                currentUser = null; currentUserData = null; currentUserRole = null;
                originalAdminData = null; // Clear impersonation on logout
                showPublicUI();
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = 'กำลังเข้าสู่ระบบ...';

            const identifier = e.target.loginIdentifier.value;
            const password = e.target.password.value;
            const loginError = document.getElementById('login-error');
            loginError.classList.add('hidden');
            let emailToLogin = identifier;

            if (!identifier.includes('@')) {
                const q = query(collection(db, "users"), where("name", "==", identifier));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    loginError.textContent = "Username นี้ไม่มีอยู่ในระบบ";
                    loginError.classList.remove('hidden');
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'ลงชื่อเข้าใช้';
                    return;
                }
                emailToLogin = querySnapshot.docs[0].data().email;
            }

            signInWithEmailAndPassword(auth, emailToLogin, password)
                .catch(error => {
                    loginError.textContent = "ข้อมูลเข้าระบบไม่ถูกต้อง";
                    loginError.classList.remove('hidden');
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'ลงชื่อเข้าใช้';
                });
        });
        
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = 'กรุณารอสักครู่...';

            const signupError = document.getElementById('signup-error');
            signupError.classList.add('hidden');

            const username = e.target.username.value;
            const email = e.target.email.value;
            const password = e.target.password.value;
            const confirmPassword = e.target.confirmPassword.value;

            const resetSubmitButton = () => {
                submitButton.disabled = false;
                submitButton.innerHTML = 'สมัครสมาชิก';
            };

            if (password !== confirmPassword) {
                signupError.textContent = "รหัสผ่านและการยืนยันไม่ตรงกัน";
                signupError.classList.remove('hidden');
                resetSubmitButton();
                return;
            }
            if (password.length < 6) {
                signupError.textContent = "รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร";
                signupError.classList.remove('hidden');
                resetSubmitButton();
                return;
            }

            const q = query(collection(db, "users"), where("name", "==", username));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                signupError.textContent = "Username นี้ถูกใช้งานแล้ว";
                signupError.classList.remove('hidden');
                resetSubmitButton();
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const newUserDoc = { email: user.email, name: username, nickname: '', role: 'member', forcePasswordChange: false, profilePic: '', bankAccount: { name: '', bank: '', number: '' }, phone: '' };
                await setDoc(doc(db, "users", user.uid), newUserDoc);
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    signupError.textContent = "อีเมลนี้ถูกใช้งานแล้ว";
                } else {
                    signupError.textContent = "เกิดข้อผิดพลาดในการสมัคร: " + error.message;
                }
                signupError.classList.remove('hidden');
                resetSubmitButton();
            }
        });

        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const passwordError = document.getElementById('password-error');
            if (newPassword.length < 6) {
                passwordError.textContent = "รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร";
                passwordError.classList.remove('hidden');
                return;
            }
            try {
                await updatePassword(currentUser, newPassword);
                await updateDoc(doc(db, "users", currentUser.uid), { forcePasswordChange: false });
                document.getElementById('change-password-modal').classList.add('hidden');
                await initializeAppUI();
            } catch (error) {
                passwordError.textContent = "ไม่สามารถเปลี่ยนรหัสผ่านได้: " + error.message;
                passwordError.classList.remove('hidden');
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            if (jobUnsubscribe) jobUnsubscribe();
            if (usersUnsubscribe) usersUnsubscribe();
            if (notificationsUnsubscribe) notificationsUnsubscribe();
            signOut(auth);
        });

        document.getElementById('show-signup-modal-btn').addEventListener('click', (e) => {
            e.preventDefault();
            loginModal.classList.add('hidden');
            signupModal.classList.remove('hidden');
        });

        document.getElementById('show-login-modal-btn').addEventListener('click', (e) => {
            e.preventDefault();
            signupModal.classList.add('hidden');
            loginModal.classList.remove('hidden');
        });
        
        document.getElementById('close-login-modal-btn').addEventListener('click', () => loginModal.classList.add('hidden'));
        document.getElementById('close-signup-modal-btn').addEventListener('click', () => signupModal.classList.add('hidden'));
        document.getElementById('forgot-password-btn').addEventListener('click', (e) => {
            e.preventDefault();
            showForgotPasswordModal();
        });
        document.getElementById('return-to-admin-btn').addEventListener('click', returnToAdminView);


        function showLoginScreen(errorMsg = null, showChangePassword = false) {
            publicView.classList.add('hidden');
            loginModal.classList.toggle('hidden', showChangePassword);
            signupModal.classList.add('hidden');
            mainApp.classList.add('hidden');
            document.getElementById('change-password-modal').classList.toggle('hidden', !showChangePassword);
            if(errorMsg) {
                const loginError = document.getElementById('login-error');
                loginError.textContent = errorMsg;
                loginError.classList.remove('hidden');
            }
        }

        function showPublicUI() {
            publicView.classList.remove('hidden');
            mainApp.classList.add('hidden');
            loginModal.classList.add('hidden');
            signupModal.classList.add('hidden');
            listenForJobs();
        }

        async function initializeAppUI() {
            publicView.classList.add('hidden');
            loginModal.classList.add('hidden');
            signupModal.classList.add('hidden');
            mainApp.classList.remove('hidden');
            document.getElementById('financial-summary-view').classList.add('hidden');
            document.getElementById('settings-view').classList.add('hidden');


            const banner = document.getElementById('impersonation-banner');
            if (originalAdminData) {
                banner.classList.remove('hidden');
                document.getElementById('impersonated-user-name').textContent = currentUserData.nickname || currentUserData.name;
                mainApp.style.paddingTop = '3rem';
            } else {
                banner.classList.add('hidden');
                mainApp.style.paddingTop = '';
            }

            document.getElementById('user-name-display').textContent = currentUserData.nickname || currentUserData.name;
            document.getElementById('user-role').textContent = currentUserRole;
            document.getElementById('user-id-display').textContent = currentUser.uid;
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = currentUserRole === 'admin' ? '' : 'none';
            });
            document.getElementById('member-job-filters').style.display = currentUserRole === 'member' ? 'flex' : 'none';
            
            if (currentUserRole === 'admin') {
                await loadAppSettings();
            }

            listenForJobs();
            listenForUsers();
            listenForNotifications();
        }

        function listenForJobs() {
            const q = collection(db, "jobs");
            onSnapshot(q, (snapshot) => {
                allJobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                allActiveJobs = allJobs
                    .filter(job => job.status !== "completed")
                    .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                    
                allCompletedJobs = allJobs
                    .filter(job => job.status === "completed")
                    .sort((a, b) => new Date(b.endDate) - new Date(a.endDate));
                
                if (currentUser) {
                    applyFiltersAndRenderJobs();
                } else {
                    renderPublicJobs();
                }
            }, (error) => {
                console.error("Error fetching jobs: ", error);
                const jobListContainer = document.getElementById(currentUser ? 'job-list' : 'public-job-list');
                if(jobListContainer) {
                    jobListContainer.innerHTML = `<p class="text-red-500 col-span-full">เกิดข้อผิดพลาดในการโหลดข้อมูลคิวงาน อาจเกิดจากปัญหาการเชื่อมต่อหรือการตั้งค่าสิทธิ์การเข้าถึงข้อมูล</p>`;
                }
            });
        }
        
        function renderPublicJobs() {
            const jobListContainer = document.getElementById('public-job-list');
            jobListContainer.innerHTML = '';
            allActiveJobs.forEach(job => {
                jobListContainer.innerHTML += `<div class="job-card cursor-pointer p-4 rounded-2xl shadow-md hover:shadow-xl transition-shadow bg-white" data-id="${job.id}"><div class="w-full h-16 flex items-center justify-center rounded-lg bg-gray-100 mb-2"><i class="ph-fill ph-video-camera text-3xl text-gray-500"></i></div><h5 class="font-semibold job-card-title">${job.name}</h5><p class="text-xs text-gray-500 text-center">${formatDateRange(job.startDate, job.endDate)}</p></div>`;
            });
            jobListContainer.querySelectorAll('.job-card').forEach(card => card.addEventListener('click', () => loginModal.classList.remove('hidden')));
        }

        function applyFiltersAndRenderJobs() {
            let filteredJobs = allActiveJobs;

            if (currentUserRole === 'member') {
                document.getElementById('member-job-filters').style.display = 'flex';
                document.getElementById('filter-my-jobs').classList.toggle('gradient-bg', memberJobFilter === 'my_jobs');
                document.getElementById('filter-my-jobs').classList.toggle('text-white', memberJobFilter === 'my_jobs');
                document.getElementById('filter-all-jobs').classList.toggle('gradient-bg', memberJobFilter === 'all');
                document.getElementById('filter-all-jobs').classList.toggle('text-white', memberJobFilter === 'all');
                if (memberJobFilter === 'my_jobs') {
                    filteredJobs = allActiveJobs.filter(job => 
                        job.team.some(member => member.userId === currentUser.uid)
                    );
                }
            } else { // Admin filters
                document.getElementById('member-job-filters').style.display = 'none';
            }

            const jobList = document.getElementById('job-list');
            jobList.innerHTML = '';
            filteredJobs.forEach(job => {
                const isMyJob = job.team.some(m => m.userId === currentUser.uid);
                const iconColorClass = isMyJob ? 'main-gradient-text' : 'text-gray-500';
                const cardHTML = `
                    <div class="job-card cursor-pointer p-4 rounded-2xl shadow-md hover:shadow-xl transition-shadow bg-white relative" data-id="${job.id}" data-name="${job.name}">
                        <div class="w-full h-16 flex items-center justify-center rounded-lg bg-gray-100 mb-2">
                            <i class="ph-fill ph-video-camera text-3xl ${iconColorClass}"></i>
                        </div>
                        <h5 class="font-semibold job-card-title">${job.name}</h5>
                        <p class="text-xs text-gray-500 text-center">${formatDateRange(job.startDate, job.endDate)}</p>
                    </div>`;
                jobList.innerHTML += cardHTML;
            });
            
            document.querySelectorAll('#job-list .job-card').forEach(card => {
                card.addEventListener('click', () => {
                    const jobId = card.dataset.id;
                    const jobName = card.dataset.name;
                    const job = allJobs.find(j => j.id === jobId);
                    const isMyJob = job.team.some(m => m.userId === currentUser.uid);

                    if (currentUserRole === 'admin' || isMyJob) {
                        selectJob(jobId);
                    } else {
                        showRequestToJoinModal(jobId, jobName);
                    }
                });
            });
        }
        
        function listenForUsers() {
            if (usersUnsubscribe) usersUnsubscribe();
            usersUnsubscribe = onSnapshot(collection(db, "users"), (snapshot) => {
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });
        }
        
        function selectJob(jobId) {
            currentJobId = jobId;
            
            // Always unsubscribe from the previous listener
            if (jobUnsubscribe) jobUnsubscribe();

            // Handle deselection
            if (!jobId) {
                document.getElementById('job-details-section').classList.add('hidden');
                currentJobData = null;
                // Untoggle all cards
                document.querySelectorAll('#job-list .job-card').forEach(card => {
                    card.classList.remove('gradient-bg');
                    card.classList.add('bg-white');
                    card.querySelector('h5').classList.remove('text-white');
                    const dateP = card.querySelector('p');
                    if(dateP) {
                        dateP.classList.remove('text-white');
                        dateP.classList.add('text-gray-500');
                    }
                });
                return; // Stop execution here
            }

            // Handle selection
            document.getElementById('job-details-section').classList.remove('hidden');
            document.querySelectorAll('#job-list .job-card').forEach(card => {
                const isSelected = card.dataset.id === jobId;
                card.classList.toggle('gradient-bg', isSelected);
                card.classList.toggle('bg-white', !isSelected);
                card.querySelector('h5').classList.toggle('text-white', isSelected);
                const dateP = card.querySelector('p');
                if(dateP) {
                    dateP.classList.toggle('text-white', isSelected);
                    dateP.classList.toggle('text-gray-500', !isSelected);
                }
            });
            
            // Set up the new listener
            jobUnsubscribe = onSnapshot(doc(db, "jobs", jobId), (docSnap) => {
                if (docSnap.exists()) {
                    currentJobData = docSnap.data();
                    renderJobDetails(currentJobData);
                } else {
                    // This case handles if the job is deleted while being viewed
                    document.getElementById('job-details-section').classList.add('hidden');
                    currentJobId = null;
                    currentJobData = null;
                }
            }, (error) => {
                console.error("Error fetching job details:", error);
                document.getElementById('job-details-section').classList.add('hidden');
            });
        }

        function renderJobDetails(job) {
            document.getElementById('job-title').textContent = job.name;
            document.getElementById('job-dates').textContent = `${formatDateRange(job.startDate, job.endDate)} (${job.workdays.length} วัน)`;
            document.getElementById('job-location-text').textContent = job.location;
            
            const budgetLabel = document.getElementById('budget-label');
            const jobIncomeEl = document.getElementById('job-income');
            const memberPaidStatusEl = document.getElementById('member-paid-status');

            jobIncomeEl.classList.remove('profit-text', 'text-blue-600');

            if (currentUserRole === 'member') {
                budgetLabel.textContent = 'BG';
                const myTeamData = job.team.find(m => m.userId === currentUser.uid);
                let myTotalWage = 0;
                if (myTeamData) {
                    myTotalWage = calculateTeamCostForMember(myTeamData, job.workdays);
                    if (myTeamData.isPaid) {
                        jobIncomeEl.classList.add('profit-text');
                        memberPaidStatusEl.textContent = `ได้รับเงินแล้ว (${formatShortDateWithBEYear(myTeamData.paymentDate)})`;
                    } else {
                        jobIncomeEl.classList.add('text-blue-600');
                        memberPaidStatusEl.textContent = 'ยังไม่ได้รับเงิน';
                    }
                    memberPaidStatusEl.classList.toggle('hidden', !myTeamData.isPaid);
                } else {
                    jobIncomeEl.classList.add('text-blue-600');
                }
                jobIncomeEl.textContent = `${myTotalWage.toLocaleString()} บาท`;
            } else { // admin
                budgetLabel.textContent = 'งบประมาณ';
                jobIncomeEl.textContent = `${job.income.toLocaleString()} บาท`;
                jobIncomeEl.classList.add('text-blue-600');
                memberPaidStatusEl.classList.add('hidden');
            }

            let headHTML = '<tr><th class="py-2 px-3 border-b text-left">ชื่อ</th>';
            job.workdays.forEach(day => {
                headHTML += `<th class="py-2 px-3 border-b text-center relative date-header">${formatShortDate(day)}<div class="absolute top-0 right-0 flex date-action-btn opacity-0 transition-opacity admin-only"><button class="edit-day-btn text-blue-500 hover:text-blue-700" data-day="${day}"><i class="ph-bold ph-pencil-simple text-xs"></i></button><button class="delete-day-btn text-red-500 hover:text-red-700" data-day="${day}"><i class="ph-bold ph-x-circle text-xs"></i></button></div></th>`;
            });
            headHTML += '<th class="py-2 px-3 border-b text-center admin-only">รวม</th><th class="py-2 px-3 border-b text-center admin-only">จัดการ</th></tr>';
            document.getElementById('schedule-head').innerHTML = headHTML;
            
            const scheduleBody = document.getElementById('schedule-body');
            scheduleBody.innerHTML = '';
            job.team.forEach((member) => {
                const memberData = allUsers.find(u => u.id === member.userId);
                if (!memberData) return; // Skip rendering if user data not found
                const displayName = memberData.nickname || memberData.name;
                const isTeamLeader = job.teamLeaderId === member.userId;
                const draggableClass = currentUserRole === 'admin' ? 'draggable-row' : '';
                let rowHTML = `<tr class="${draggableClass}" draggable="${currentUserRole === 'admin'}" data-userid="${member.userId}"><td class="py-2 px-3 border-b"><div class="flex items-center"><i class="ph ph-dots-six-vertical drag-handle text-gray-400 mr-2 admin-only"></i><img src="${memberData.profilePic || 'https://placehold.co/40x40/E2E8F0/4A5568?text=??'}" class="w-8 h-8 rounded-full mr-3 object-cover"><div><p class="font-medium flex items-center">${displayName} ${isTeamLeader ? '<i class="ph-fill ph-crown text-yellow-500 ml-1"></i>' : ''}</p><p class="text-xs text-gray-500">${member.position}</p></div></div></td>`;
                
                job.workdays.forEach(day => {
                    const isWorking = member.workdays.includes(day);
                    const dailyRate = (member.dailyOverrides && member.dailyOverrides[day] !== undefined) ? member.dailyOverrides[day] : member.dailyRate;
                    const canViewRate = (currentUserRole === 'admin' || currentUser.uid === member.userId || (job.teamLeaderId && currentUser.uid === job.teamLeaderId));
                    let rateDisplayHTML = `<span class="text-xs text-gray-400">-</span>`; 
                    if (canViewRate) {
                        const canEditRate = (currentUserRole === 'admin');
                        rateDisplayHTML = `<span class="text-xs text-gray-500 ${canEditRate ? 'hover:text-blue-600 cursor-pointer edit-daily-rate-btn' : ''}" data-userid="${member.userId}" data-day="${day}">${dailyRate.toLocaleString()}</span>`;
                    }
                    const isDisabled = (currentUserRole !== 'admin');
                    const disabledClass = isDisabled ? 'cursor-not-allowed' + (isWorking ? '' : ' opacity-50') : '';
                    rowHTML += `<td class="py-2 px-3 border-b text-center"><div class="flex flex-col items-center justify-center space-y-1"><button class="custom-checkbox schedule-checkbox ${isWorking ? 'checked' : ''} ${disabledClass}" data-userid="${member.userId}" data-day="${day}" ${isDisabled ? 'disabled' : ''}><i class="ph-bold ph-check text-lg"></i></button>${rateDisplayHTML}</div></td>`;
                });

                // Total wage column
                const totalWage = calculateTeamCostForMember(member, job.workdays);
                rowHTML += `<td class="py-2 px-3 border-b text-center admin-only">
                                <div class="${member.isPaid ? 'profit-text' : ''} font-semibold">${totalWage.toLocaleString()}</div>
                                ${member.isPaid ? `<div class="text-xs text-gray-500">จ่ายเมื่อ ${formatShortDate(member.paymentDate)}</div>` : ''}
                            </td>`;

                // Management column
                const payButtonIcon = member.isPaid ? 'ph-arrow-counter-clockwise' : 'ph-currency-dollar';
                const payButtonColor = member.isPaid ? 'text-orange-500 hover:text-orange-700' : 'text-green-500 hover:text-green-700';
                rowHTML += `<td class="py-2 px-3 border-b text-center admin-only">
                                <button class="text-blue-500 hover:text-blue-700 mr-2 edit-member-btn" data-userid="${member.userId}"><i class="ph ph-pencil-simple"></i></button>
                                <button class="text-red-500 hover:text-red-700 mr-2 remove-member-btn" data-userid="${member.userId}"><i class="ph ph-trash"></i></button>
                                <button class="pay-member-btn ${payButtonColor}" data-userid="${member.userId}"><i class="ph ${payButtonIcon}"></i></button>
                            </td></tr>`;
                scheduleBody.innerHTML += rowHTML;
            });

            const expenseList = document.getElementById('expense-list');
            expenseList.innerHTML = '';
            job.expenses.forEach((expense, index) => {
                expenseList.innerHTML += `<div class="flex justify-between items-center p-2 rounded-lg hover:bg-gray-100"><div><p>${expense.name}</p></div><div class="flex items-center space-x-3"><p class="font-semibold">${expense.amount.toLocaleString()}</p><button class="text-blue-500 hover:text-blue-700 edit-expense-btn admin-only" data-index="${index}"><i class="ph ph-pencil-simple"></i></button><button class="text-red-500 hover:text-red-700 remove-expense-btn admin-only" data-index="${index}"><i class="ph ph-x-circle"></i></button></div></div>`;
            });
            
            document.getElementById('wht-toggle').checked = job.whtEnabled || false;
            document.getElementById('vat-toggle').checked = job.vatEnabled || false;
            document.getElementById('wht-percent').value = job.whtPercent === undefined ? appSettings.whtPercent : job.whtPercent;
            
            document.getElementById('admin-notes-textarea').value = job.notes || '';
            
            const teamNotesContainer = document.getElementById('team-notes-container');
            const teamNotesTextarea = document.getElementById('team-notes-textarea');
            teamNotesTextarea.value = job.teamNotes || '';
            const isTeamLeader = job.teamLeaderId === currentUser.uid;
            const canEditTeamNotes = currentUserRole === 'admin' || isTeamLeader;
            teamNotesTextarea.disabled = !canEditTeamNotes;
            teamNotesTextarea.classList.toggle('bg-gray-100', !canEditTeamNotes);
            
            if (!job.teamNotes && !canEditTeamNotes) {
                teamNotesContainer.classList.add('hidden');
            } else {
                teamNotesContainer.classList.remove('hidden');
            }

            updateCalculations(job);
            renderPaymentSummary(job);
            
            const completeJobBtn = document.getElementById('complete-job-btn');
            if (job.status === 'completed') {
                completeJobBtn.innerHTML = `<i class="ph ph-arrow-u-left-up mr-1"></i> ย้อนคืนคิวงาน`;
                completeJobBtn.className = 'mt-4 px-6 py-2 font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors admin-only';
                completeJobBtn.onclick = () => revertJobStatus(currentJobId);
            } else {
                completeJobBtn.innerHTML = `<i class="ph ph-check-circle mr-1"></i> เสร็จงานแล้ว`;
                completeJobBtn.className = 'mt-4 px-6 py-2 font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors admin-only';
                completeJobBtn.onclick = () => completeJob(currentJobId);
            }

            document.querySelectorAll('.admin-only').forEach(el => { el.style.display = currentUserRole === 'admin' ? '' : 'none'; });
            addDynamicEventListeners(job);
        }

        function renderPaymentSummary(job) {
            if (currentUserRole !== 'admin') return;

            const paidMembers = job.team.filter(m => m.isPaid);
            const unpaidMembers = job.team.filter(m => !m.isPaid);
            const paidCount = paidMembers.length;
            const paidAmount = paidMembers.reduce((total, member) => total + calculateTeamCostForMember(member, job.workdays), 0);
            
            const summaryEl = document.getElementById('payment-summary');
            summaryEl.textContent = `จ่ายแล้ว: ${paidAmount.toLocaleString()} บาท / ${paidCount} คน`;

            const payAllBtn = document.getElementById('pay-all-btn');
            payAllBtn.disabled = unpaidMembers.length === 0;
            
            const completeJobBtn = document.getElementById('complete-job-btn');
            if (job.status !== 'completed') {
                completeJobBtn.disabled = unpaidMembers.length > 0;
                completeJobBtn.classList.toggle('opacity-50', unpaidMembers.length > 0);
                completeJobBtn.classList.toggle('cursor-not-allowed', unpaidMembers.length > 0);
            } else {
                 completeJobBtn.disabled = false;
                 completeJobBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        function updateCalculations(job) {
            const teamTotalCost = job.team.reduce((total, member) => total + calculateTeamCostForMember(member, job.workdays), 0);
            const otherExpensesTotal = job.expenses.reduce((total, expense) => total + expense.amount, 0);
            document.getElementById('summary-team-cost').textContent = `${teamTotalCost.toLocaleString()} บาท`;
            document.getElementById('summary-other-expenses').textContent = `${otherExpensesTotal.toLocaleString()} บาท`;
            
            const whtPercentValue = job.whtPercent === undefined ? appSettings.whtPercent : job.whtPercent;
            const subtotal = teamTotalCost + otherExpensesTotal;
            const whtAmount = job.whtEnabled ? (job.income * whtPercentValue / 100) : 0;
            const vatAmount = job.vatEnabled ? (subtotal * 0.07) : 0;
            
            const totalCost = subtotal + vatAmount;
            const profitLoss = job.income - totalCost - whtAmount;
            document.getElementById('summary-wht').textContent = `${whtAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท`;
            document.getElementById('summary-vat').textContent = `${vatAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท`;
            document.getElementById('summary-total-cost').textContent = `${totalCost.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท`;
            const profitLossEl = document.getElementById('summary-profit-loss');
            profitLossEl.textContent = `${profitLoss.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท`;
            profitLossEl.className = `font-bold mt-2 ${profitLoss >= 0 ? 'text-5xl profit-text' : 'text-4xl loss-text'}`;
            document.getElementById('profit-loss-label').textContent = profitLoss >= 0 ? 'กำไร' : 'ขาดทุน';
        }

        async function handleTaxSettingsChange() {
            if (!currentJobId || !currentJobData) return;

            const whtEnabled = document.getElementById('wht-toggle').checked;
            const vatEnabled = document.getElementById('vat-toggle').checked;
            const whtPercent = parseFloat(document.getElementById('wht-percent').value) || 0;

            const updatedJobForCalc = { ...currentJobData, whtEnabled, vatEnabled, whtPercent };
            updateCalculations(updatedJobForCalc);

            try {
                await updateDoc(doc(db, "jobs", currentJobId), { whtEnabled, vatEnabled, whtPercent });
            } catch (error) { console.error("Failed to save tax settings:", error); }
        }

        function addDynamicEventListeners(job) {
            ['wht-toggle', 'wht-percent', 'vat-toggle'].forEach(id => { document.getElementById(id).oninput = handleTaxSettingsChange; });
            
            const adminNotesTextarea = document.getElementById('admin-notes-textarea');
            if (adminNotesTextarea) {
                adminNotesTextarea.onblur = async (e) => {
                    const newNotes = e.target.value;
                    if (currentJobData.notes !== newNotes) {
                        await updateDoc(doc(db, "jobs", currentJobId), { notes: newNotes });
                    }
                };
            }
            
            const teamNotesTextarea = document.getElementById('team-notes-textarea');
            if (teamNotesTextarea) {
                teamNotesTextarea.onblur = async (e) => {
                    const newTeamNotes = e.target.value;
                    if (currentJobData.teamNotes !== newTeamNotes) {
                        await updateDoc(doc(db, "jobs", currentJobId), { teamNotes: newTeamNotes });
                    }
                };
            }

            document.querySelectorAll('.schedule-checkbox').forEach(box => {
                box.onclick = async (e) => {
                    const button = e.currentTarget;
                    const { userid, day } = button.dataset;
                    const updatedTeam = currentJobData.team.map(m => {
                        if (m.userId === userid) {
                            const isWorking = m.workdays.includes(day);
                            if (isWorking) {
                                m.workdays = m.workdays.filter(d => d !== day);
                            } else {
                                m.workdays.push(day);
                            }
                        }
                        return m;
                    });
                    await updateDoc(doc(db, "jobs", currentJobId), { team: updatedTeam });
                };
            });
            
            document.querySelectorAll('.pay-member-btn').forEach(btn => btn.onclick = (e) => {
                const userIdToToggle = e.currentTarget.dataset.userid;
                const memberInfo = currentJobData.team.find(m => m.userId === userIdToToggle);
                const memberUser = allUsers.find(u => u.id === userIdToToggle);
                const memberName = memberUser.nickname || memberUser.name;
                
                if (memberInfo.isPaid) {
                    showConfirmModal('ยืนยันการยกเลิกจ่ายค่าแรง', `คุณต้องการยกเลิกสถานะ "ได้รับเงินแล้ว" ของ ${memberName} ใช่หรือไม่?`, async () => {
                        const updatedTeam = currentJobData.team.map(m => {
                            if (m.userId === userIdToToggle) {
                                const { paymentDate, ...rest } = m;
                                return { ...rest, isPaid: false };
                            }
                            return m;
                        });
                        await updateDoc(doc(db, "jobs", currentJobId), { team: updatedTeam });
                    });
                } else {
                    showPaymentConfirmModal(memberName, async (paymentDate) => {
                        const updatedTeam = currentJobData.team.map(m => {
                            if (m.userId === userIdToToggle) {
                                return { ...m, isPaid: true, paymentDate: paymentDate };
                            }
                            return m;
                        });
                        await updateDoc(doc(db, "jobs", currentJobId), { team: updatedTeam });
                    });
                }
            });

            document.getElementById('pay-all-btn').onclick = () => {
                 showPaymentConfirmModal('ทีมงานที่เหลือทั้งหมด', async (paymentDate) => {
                    const updatedTeam = currentJobData.team.map(m => {
                        if (!m.isPaid) {
                            return { ...m, isPaid: true, paymentDate: paymentDate };
                        }
                        return m;
                    });
                    await updateDoc(doc(db, "jobs", currentJobId), { team: updatedTeam });
                });
            };

            document.querySelectorAll('.edit-member-btn').forEach(btn => btn.onclick = (e) => showEditMemberModal(job.team.find(m => m.userId === e.currentTarget.dataset.userid)));
            document.querySelectorAll('.remove-member-btn').forEach(btn => btn.onclick = (e) => {
                const userIdToRemove = e.currentTarget.dataset.userid;
                const memberToRemove = currentJobData.team.find(m => m.userId === userIdToRemove);
                if (memberToRemove) {
                    showConfirmModal('ยืนยันการลบ', 'คุณต้องการลบทีมงานคนนี้ออกจากคิวงานนี้หรือไม่?', async () => {
                        await updateDoc(doc(db, "jobs", currentJobId), { team: arrayRemove(memberToRemove) });
                    });
                }
            });
            document.querySelectorAll('.remove-expense-btn').forEach(btn => btn.onclick = (e) => showConfirmModal('ยืนยันการลบ', 'คุณต้องการลบค่าใช้จ่ายรายการนี้หรือไม่?', async () => {
                currentJobData.expenses.splice(parseInt(e.currentTarget.dataset.index), 1);
                await updateDoc(doc(db, "jobs", currentJobId), { expenses: currentJobData.expenses });
            }));
            document.querySelectorAll('.edit-expense-btn').forEach(btn => btn.onclick = (e) => {
                const index = parseInt(e.currentTarget.dataset.index);
                showEditExpenseModal(currentJobData.expenses[index], index);
            });
            document.querySelectorAll('.delete-day-btn').forEach(btn => btn.onclick = (e) => {
                const dayToDelete = e.currentTarget.dataset.day;
                showConfirmModal('ยืนยันการลบวัน', `คุณต้องการลบวันที่ ${formatShortDate(dayToDelete)} หรือไม่?`, async () => {
                    currentJobData.workdays = currentJobData.workdays.filter(d => d !== dayToDelete);
                    currentJobData.team.forEach(member => {
                        member.workdays = member.workdays.filter(d => d !== dayToDelete);
                        if (member.dailyOverrides) delete member.dailyOverrides[dayToDelete];
                    });
                    await updateDoc(doc(db, "jobs", currentJobId), { workdays: currentJobData.workdays, team: currentJobData.team });
                });
            });
            document.querySelectorAll('.edit-daily-rate-btn').forEach(btn => btn.onclick = (e) => showEditDailyRateModal(e.currentTarget.dataset.userid, e.currentTarget.dataset.day));
            document.querySelectorAll('.edit-day-btn').forEach(btn => btn.onclick = (e) => showEditWorkdayModal(e.currentTarget.dataset.day));
            
            // Drag and Drop Event Listeners
            const scheduleBody = document.getElementById('schedule-body');
            scheduleBody.addEventListener('dragstart', e => {
                if (currentUserRole !== 'admin') return;
                draggedItem = e.target;
                setTimeout(() => e.target.classList.add('dragging'), 0);
            });

            scheduleBody.addEventListener('dragend', e => {
                 if (currentUserRole !== 'admin') return;
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            });

            scheduleBody.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(scheduleBody, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (afterElement == null) {
                    scheduleBody.appendChild(draggable);
                } else {
                    scheduleBody.insertBefore(draggable, afterElement);
                }
            });
            
            scheduleBody.addEventListener('drop', async e => {
                e.preventDefault();
                if (currentUserRole !== 'admin') return;
                const newOrderedIds = [...scheduleBody.querySelectorAll('tr')].map(tr => tr.dataset.userid);
                const newTeamOrder = newOrderedIds.map(id => currentJobData.team.find(m => m.userId === id));
                await updateDoc(doc(db, "jobs", currentJobId), { team: newTeamOrder });
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('tr:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        ['add-job-button', 'add-member-button', 'add-day-button', 'add-expense-button', 'edit-budget-btn', 'edit-job-details-btn', 'manage-profile-button', 'manage-all-users-button', 'save-image-btn', 'financial-summary-button', 'back-to-main-app-btn', 'notifications-button', 'filter-my-jobs', 'filter-all-jobs', 'system-settings-button'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                if (id === 'filter-my-jobs') {
                    el.addEventListener('click', () => { memberJobFilter = 'my_jobs'; applyFiltersAndRenderJobs(); });
                } else if (id === 'filter-all-jobs') {
                    el.addEventListener('click', () => { memberJobFilter = 'all'; applyFiltersAndRenderJobs(); });
                } else if (id === 'financial-summary-button') {
                    el.addEventListener('click', showFinancialSummaryView);
                } else if (id === 'back-to-main-app-btn') {
                    el.addEventListener('click', () => {
                        mainApp.classList.remove('hidden');
                        document.getElementById('financial-summary-view').classList.add('hidden');
                    });
                } else {
                     el.addEventListener('click', () => {
                        switch(id) {
                            case 'add-job-button': showJobModal(); break;
                            case 'add-member-button': showAddMemberModal(); break;
                            case 'add-day-button': showAddDayModal(); break;
                            case 'add-expense-button': showExpenseModal(); break;
                            case 'edit-budget-btn': showEditBudgetModal(currentJobData.income); break;
                            case 'edit-job-details-btn': showEditJobDetailsModal(currentJobData); break;
                            case 'manage-profile-button': showManageProfileModal(); break;
                            case 'manage-all-users-button': showUserManagementModal(); break;
                            case 'system-settings-button': showSettingsView(); break;
                            case 'save-image-btn': 
                                const captureArea = document.getElementById('capture-area');
                                if (captureArea) {
                                    html2canvas(captureArea, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                                        const link = document.createElement('a');
                                        link.download = `job-summary-${currentJobId}.png`;
                                        link.href = canvas.toDataURL();
                                        link.click();
                                    });
                                }
                                break;
                            case 'notifications-button':
                                showNotificationsModal();
                                break;
                        }
                    });
                }
            }
        });

        document.getElementById('back-to-main-from-settings-btn').addEventListener('click', () => {
            document.getElementById('settings-view').classList.add('hidden');
            mainApp.classList.remove('hidden');
        });

        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'กำลังบันทึก...';
            const formData = new FormData(e.target);
            const newSettings = {
                cloudinaryName: formData.get('cloudinaryName'),
                cloudinaryPreset: formData.get('cloudinaryPreset'),
                lineChannelId: formData.get('lineChannelId'),
                lineChannelSecret: formData.get('lineChannelSecret'),
                facebookAppId: formData.get('facebookAppId'),
                facebookAppSecret: formData.get('facebookAppSecret')
            };

            try {
                await setDoc(doc(db, "settings", "app-config"), newSettings, { merge: true });
                appSettings = { ...appSettings, ...newSettings }; // Update local settings object
                alert('บันทึกการตั้งค่าเรียบร้อยแล้ว');
            } catch (error) {
                console.error("Error saving settings:", error);
                alert('เกิดข้อผิดพลาดในการบันทึกการตั้งค่า');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'บันทึกการตั้งค่า';
            }
        });


        function completeJob(jobId) {
            showConfirmModal('ยืนยันการจบงาน', 'คุณต้องการย้ายงานนี้ออกจากคิวงานปัจจุบันใช่หรือไม่?', async () => {
                for (const member of currentJobData.team) {
                    await createNotification(member.userId, `คิวงาน <b>${currentJobData.name}</b> เสร็จสิ้นแล้ว`, jobId, currentJobData.name);
                }
                await updateDoc(doc(db, "jobs", jobId), { status: "completed" });
                document.getElementById('job-details-section').classList.add('hidden');
                selectJob(null); // Deselect job
            });
        }

        function revertJobStatus(jobId) {
            showConfirmModal('ยืนยันการย้อนคืนคิวงาน', 'คุณต้องการย้ายงานนี้กลับไปที่คิวงานปัจจุบันใช่หรือไม่?', async () => {
                await updateDoc(doc(db, "jobs", jobId), { status: "active" });
                await createNotification(currentJobData.team.map(m => m.userId), `คิวงาน <b>${currentJobData.name}</b> ถูกย้ายกลับมายังคิวงานปัจจุบัน`, jobId, currentJobData.name);
            });
        }

        function showFinancialSummaryView() {
            mainApp.classList.add('hidden');
            document.getElementById('settings-view').classList.add('hidden');
            document.getElementById('financial-summary-view').classList.remove('hidden');

            if (currentUserRole === 'admin') {
                document.getElementById('admin-summary-container').classList.remove('hidden');
                document.getElementById('member-summary-container').classList.add('hidden');
                setupFinancialFilters();
                generateFinancialReport();
            } else {
                document.getElementById('admin-summary-container').classList.add('hidden');
                document.getElementById('member-summary-container').classList.remove('hidden');
                setupFinancialFilters(); // Also setup for members
                generateFinancialReport();
            }
        }
        
        function setupFinancialFilters() {
            const monthSelect = document.getElementById('summary-month');
            const yearSelect = document.getElementById('summary-year');
            const filterButtons = document.getElementById('financial-filter-buttons');
            const showCustomRangeBtn = document.getElementById('show-custom-range-btn'); // New button
            const customDateSelector = document.getElementById('custom-date-range-selector');
            const searchButton = document.getElementById('summary-search-button');
            const monthYearSelector = document.getElementById('month-year-selector');

            // Populate Months
            monthSelect.innerHTML = '';
            const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                monthSelect.appendChild(option);
            });

            // Populate Years
            yearSelect.innerHTML = '';
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= currentYear - 5; i--) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + 543; // Display in B.E.
                yearSelect.appendChild(option);
            }

            // Set default to current month and year
            const today = new Date();
            monthSelect.value = today.getMonth();
            yearSelect.value = today.getFullYear();

            // Add event listeners for the pre-defined period buttons
            filterButtons.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    financialFilter = e.target.dataset.period;
                    
                    // Update active state
                    filterButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    showCustomRangeBtn.classList.remove('active');
                    e.target.classList.add('active');

                    // Hide custom selector, show/hide month selector
                    customDateSelector.classList.add('hidden');
                    monthYearSelector.classList.toggle('hidden', financialFilter !== '1m');
                    
                    // Generate report immediately
                    generateFinancialReport();
                });
            });

            // Add event listener for the new "custom range" button
            showCustomRangeBtn.addEventListener('click', () => {
                // Update active state
                filterButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                showCustomRangeBtn.classList.add('active');

                // Show the custom date selector
                customDateSelector.classList.toggle('hidden');
                monthYearSelector.classList.add('hidden');
            });

            // The search button within the custom range selector
            searchButton.addEventListener('click', () => {
                financialFilter = 'all'; // This tells generateFinancialReport to use the date pickers
                generateFinancialReport();
            });
            
            monthSelect.addEventListener('change', generateFinancialReport);
            yearSelect.addEventListener('change', generateFinancialReport);
        }

        function generateFinancialReport() {
            const monthYearSelector = document.getElementById('month-year-selector');
            
            let startDate, endDate = new Date();
            const today = new Date();
            
            switch (financialFilter) {
                case '1m':
                    const selectedYear = parseInt(document.getElementById('summary-year').value);
                    const selectedMonth = parseInt(document.getElementById('summary-month').value);
                    startDate = new Date(selectedYear, selectedMonth, 1);
                    endDate = new Date(selectedYear, selectedMonth + 1, 0, 23, 59, 59);
                    break;
                case '2m':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    break;
                case '3m':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
                    break;
                case '6m':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 5, 1);
                    break;
                case '1y':
                    startDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
                    break;
                case 'all':
                    const customStartDate = document.getElementById('summary-start-date').value;
                    const customEndDate = document.getElementById('summary-end-date').value;
                    if (customStartDate && customEndDate) {
                        startDate = new Date(customStartDate);
                        endDate = new Date(customEndDate);
                        endDate.setHours(23, 59, 59);
                    } else {
                        // If 'all' is clicked but no dates are set, show all time
                        startDate = new Date(2000, 0, 1); 
                        endDate = new Date();
                    }
                    break;
            }

            const filteredJobs = allJobs.filter(job => {
                const jobStart = new Date(job.startDate);
                const jobEnd = new Date(job.endDate);
                return jobStart <= endDate && jobEnd >= startDate;
            });

            if (currentUserRole === 'admin') {
                generateAdminReport(filteredJobs, startDate, endDate);
            } else {
                generateMemberReport(filteredJobs);
            }
        }

        function generateAdminReport(jobs, reportStartDate, reportEndDate) {
            const jobSummaryBody = document.getElementById('job-summary-table-body');
            const teamWageBody = document.getElementById('team-wage-summary-table-body');
            const statTopEarners = document.getElementById('stat-top-earners');
            jobSummaryBody.innerHTML = '';
            teamWageBody.innerHTML = '';
            statTopEarners.innerHTML = '';

            let totalIncome = 0, totalExpenses = 0, totalProfit = 0;
            let totalPaidWages = 0, totalUnpaidWages = 0;
            const userWages = {};

            jobs.forEach(job => {
                const teamCost = job.team.reduce((total, member) => total + calculateTeamCostForMember(member, job.workdays), 0);
                const otherExpenses = job.expenses.reduce((total, expense) => total + expense.amount, 0);
                const jobTotalExpenses = teamCost + otherExpenses;
                const profit = job.income - jobTotalExpenses;
                const jobMonth = new Date(job.startDate).toLocaleDateString('th-TH', { month: 'short' });
                const statusHTML = job.status === 'completed' ? `<i class="text-xs text-green-500"> (เสร็จงานแล้ว)</i>` : '';

                totalIncome += job.income;
                totalExpenses += jobTotalExpenses;
                totalProfit += profit;

                jobSummaryBody.innerHTML += `
                    <tr class="cursor-pointer hover:bg-gray-100 job-summary-row" data-id="${job.id}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${job.name} <span class="text-xs text-gray-400">(${jobMonth})</span>${statusHTML}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${job.income.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-red-500">${jobTotalExpenses.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right ${profit >= 0 ? 'profit-text' : 'loss-text'}">${profit.toLocaleString()}</td>
                    </tr>
                `;

                job.team.forEach(member => {
                    if (!allUsers.find(u => u.id === member.userId)) return; // Skip if user doesn't exist
                    const wage = calculateTeamCostForMember(member, job.workdays);
                    if (!userWages[member.userId]) {
                        userWages[member.userId] = { total: 0, unpaid: 0 };
                    }
                    userWages[member.userId].total += wage;

                    if (!member.isPaid) {
                        userWages[member.userId].unpaid += wage;
                        totalUnpaidWages += wage;
                    } else {
                        totalPaidWages += wage;
                    }
                });
            });
            
            document.querySelectorAll('.job-summary-row').forEach(row => {
                row.addEventListener('click', () => {
                    const jobId = row.dataset.id;
                    document.getElementById('financial-summary-view').classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    selectJob(jobId);
                });
            });

            document.getElementById('total-income-summary').textContent = totalIncome.toLocaleString();
            document.getElementById('total-expense-summary').textContent = totalExpenses.toLocaleString();
            document.getElementById('total-profit-summary').textContent = totalProfit.toLocaleString();
            document.getElementById('total-profit-summary').className = `px-6 py-4 text-right font-bold ${totalProfit >= 0 ? 'profit-text' : 'loss-text'}`;

            let totalWages = 0;
            const sortedUsers = Object.keys(userWages).sort((a,b) => userWages[b].total - userWages[a].total);

            sortedUsers.forEach(userId => {
                const user = allUsers.find(u => u.id === userId);
                if (!user) return; // Double check to prevent errors
                const userName = user.nickname || user.name;
                const wageData = userWages[userId];
                const paidAmount = wageData.total - wageData.unpaid;
                totalWages += wageData.total;
                teamWageBody.innerHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${userName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right font-semibold">${wageData.total.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right profit-text">${paidAmount.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right loss-text">${wageData.unpaid > 0 ? wageData.unpaid.toLocaleString() : '-'}</td>
                    </tr>
                `;
            });
            document.getElementById('total-wage-summary').textContent = totalWages.toLocaleString();
            document.getElementById('total-paid-wage-summary').textContent = totalPaidWages.toLocaleString();
            document.getElementById('total-unpaid-wage-summary').textContent = totalUnpaidWages.toLocaleString();
            
            // Update stats
            document.getElementById('stat-paid-wages').textContent = totalPaidWages.toLocaleString();
            document.getElementById('stat-unpaid-wages').textContent = totalUnpaidWages.toLocaleString();
            document.querySelector('#stat-top-earners').previousElementSibling.textContent = "ทีมงานที่ได้รับเงินสูงสุด";

            sortedUsers.slice(0, 3).forEach((userId, index) => {
                 const user = allUsers.find(u => u.id === userId);
                 if (user) {
                    const topEarnerClass = index === 0 ? 'border-4 border-yellow-400' : '';
                    statTopEarners.innerHTML += `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <img src="${user.profilePic || 'https://placehold.co/40x40/E2E8F0/4A5568?text=??'}" class="w-10 h-10 rounded-full object-cover mr-3 ${topEarnerClass}">
                            <span class="${index === 0 ? 'text-lg' : ''}">${user.nickname || user.name}</span>
                        </div>
                        <span class="font-bold ${index === 0 ? 'text-lg' : ''}">${userWages[userId].total.toLocaleString()} บาท</span>
                    </div>`;
                 }
            });
            
            // Update Chart
            updateFinancialChart(jobs, reportStartDate, reportEndDate);
        }
        
        function updateFinancialChart(jobs, startDate, endDate) {
            const ctx = document.getElementById('financial-chart').getContext('2d');
            const data = {
                labels: [],
                datasets: [
                    { label: 'รายรับ', data: [], backgroundColor: 'rgba(54, 162, 235, 0.5)', borderColor: 'rgb(54, 162, 235)', borderWidth: 1 },
                    { label: 'รายจ่าย', data: [], backgroundColor: 'rgba(255, 99, 132, 0.5)', borderColor: 'rgb(255, 99, 132)', borderWidth: 1 },
                    { label: 'กำไร', data: [], backgroundColor: 'rgba(75, 192, 192, 0.5)', borderColor: 'rgb(75, 192, 192)', borderWidth: 1 }
                ]
            };

            const monthlyData = {};
            const monthFormatter = new Intl.DateTimeFormat('th-TH', { month: 'short', year: '2-digit' });

            // Initialize months in the range
            let current = new Date(startDate);
            while (current <= endDate) {
                const monthKey = monthFormatter.format(current);
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { income: 0, expense: 0, profit: 0 };
                }
                current.setMonth(current.getMonth() + 1);
            }
            
            jobs.forEach(job => {
                const monthKey = monthFormatter.format(new Date(job.startDate));
                if (monthlyData[monthKey]) {
                    const teamCost = job.team.reduce((total, member) => total + calculateTeamCostForMember(member, job.workdays), 0);
                    const otherExpenses = job.expenses.reduce((total, expense) => total + expense.amount, 0);
                    const totalExpense = teamCost + otherExpenses;
                    const profit = job.income - totalExpense;

                    monthlyData[monthKey].income += job.income;
                    monthlyData[monthKey].expense += totalExpense;
                    monthlyData[monthKey].profit += profit;
                }
            });

            for (const monthKey in monthlyData) {
                data.labels.push(monthKey);
                data.datasets[0].data.push(monthlyData[monthKey].income);
                data.datasets[1].data.push(monthlyData[monthKey].expense);
                data.datasets[2].data.push(monthlyData[monthKey].profit);
            }

            if (financialChart) financialChart.destroy();
            financialChart = new Chart(ctx, { type: 'bar', data: data, options: { scales: { y: { beginAtZero: true } } } });
        }


        function generateMemberReport(jobs) {
            const memberWageBody = document.getElementById('member-wage-table-body');
            memberWageBody.innerHTML = '';
            let totalWage = 0;

            const memberJobs = jobs.filter(job => job.team.some(m => m.userId === currentUser.uid));

            memberJobs.forEach(job => {
                const myTeamData = job.team.find(m => m.userId === currentUser.uid);
                if (myTeamData) {
                    const wage = calculateTeamCostForMember(myTeamData, job.workdays);
                    totalWage += wage;
                    const jobMonth = new Date(job.startDate).toLocaleDateString('th-TH', { month: 'short' });
                    let statusHTML = '';
                    if (job.status === 'completed' && myTeamData.isPaid && myTeamData.paymentDate) {
                        statusHTML = `<br><i class="text-xs text-green-500">เสร็จงานแล้ว ได้รับเงินเมื่อ ${formatShortDateWithBEYear(myTeamData.paymentDate)}</i>`;
                    }

                    memberWageBody.innerHTML += `
                        <tr class="cursor-pointer hover:bg-gray-100 member-job-summary-row" data-id="${job.id}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                ${job.name} <span class="text-xs text-gray-400">(${jobMonth})</span>
                                ${statusHTML}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right font-semibold">${wage.toLocaleString()}</td>
                        </tr>
                    `;
                }
            });

            document.getElementById('member-total-wage-summary').textContent = totalWage.toLocaleString();
            
            document.querySelectorAll('.member-job-summary-row').forEach(row => {
                row.addEventListener('click', () => {
                    const jobId = row.dataset.id;
                    document.getElementById('financial-summary-view').classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    selectJob(jobId);
                });
            });
        }

        function calculateTeamCostForMember(member, workdays) {
            return member.workdays.reduce((total, day) => {
                if (workdays.includes(day)) {
                    const rate = (member.dailyOverrides && member.dailyOverrides[day] !== undefined) ? member.dailyOverrides[day] : member.dailyRate;
                    return total + rate;
                }
                return total;
            }, 0);
        }
        function formatDateRange(start, end) {
            if (!start || !end) return 'N/A';
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            const startDate = new Date(start).toLocaleDateString('th-TH', options);
            const endDate = new Date(end).toLocaleDateString('th-TH', options);
            if (startDate === endDate) {
                return startDate;
            }
            return `${startDate} - ${endDate}`;
        }
        function formatShortDate(dateString) { 
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }); 
        }
        function formatShortDateWithBEYear(dateString) { 
            if (!dateString) return '';
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('th-TH', options); 
        }
        
        function showModal(title, contentHTML, onSave, showSaveButton = true, onReady = null, saveButtonText = 'บันทึก') {
            const modalId = `modal-${Date.now()}`;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `<div id="${modalId}" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop"><div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 m-4 modal-content"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">${title}</h3><button class="text-gray-400 hover:text-gray-600 text-2xl close-modal-btn">&times;</button></div><form class="modal-form space-y-4">${contentHTML}<div class="flex justify-end space-x-3 pt-4"><button type="button" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 close-modal-btn">ยกเลิก</button>${showSaveButton ? `<button type="submit" class="px-4 py-2 text-white gradient-bg rounded-lg hover:opacity-90">${saveButtonText}</button>` : ''}</div></form></div></div>`;
            const modal = tempDiv.firstElementChild;
            document.getElementById('modals-container').appendChild(modal);
            if (showSaveButton) {
                modal.querySelector('.modal-form').onsubmit = (e) => { e.preventDefault(); onSave(new FormData(e.target), modal.querySelector('button[type="submit"]'), modal); };
            }
            modal.querySelectorAll('.close-modal-btn').forEach(btn => btn.onclick = () => modal.remove());
            if (onReady) onReady(modal);
        }

        function showConfirmModal(title, message, onConfirm) {
            const modalId = `confirm-modal-${Date.now()}`;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `<div id="${modalId}" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop"><div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 m-4 modal-content text-center"><h3 class="text-xl font-semibold">${title}</h3><p class="text-gray-600 mt-2">${message}</p><div class="flex justify-center space-x-4 pt-4 mt-4"><button type="button" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 close-confirm-btn">ยกเลิก</button><button type="button" class="px-6 py-2 text-white bg-red-500 rounded-lg hover:bg-red-600 confirm-btn">ยืนยัน</button></div></div></div>`;
            const modal = tempDiv.firstElementChild;
            document.getElementById('modals-container').appendChild(modal);
            const closeModal = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = () => { onConfirm(); closeModal(); };
            modal.querySelector('.close-confirm-btn').onclick = closeModal;
        }

        function showPaymentConfirmModal(memberName, onConfirm) {
            const today = new Date().toISOString().split('T')[0];
            const content = `
                <p>คุณต้องการบันทึกว่าจ่ายค่าแรงให้ <b>${memberName}</b> แล้วใช่หรือไม่?</p>
                <label for="payment-date" class="block mt-4 text-sm font-medium text-gray-700">วันที่จ่ายเงิน</label>
                <input type="date" id="payment-date" name="paymentDate" value="${today}" class="w-full p-2 mt-1 border rounded-lg">
            `;
            showModal('ยืนยันการจ่ายค่าแรง', content, (formData, submitBtn, modal) => {
                const paymentDate = formData.get('paymentDate');
                if (!paymentDate) {
                    alert('กรุณาระบุวันที่จ่ายเงิน');
                    return;
                }
                onConfirm(paymentDate);
                modal.remove();
            });
        }


        async function uploadToCloudinary(file) {
            if (!file) return null;
            const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${appSettings.cloudinaryName}/image/upload`;
            if (!appSettings.cloudinaryName || !appSettings.cloudinaryPreset) {
                alert("กรุณาตั้งค่า Cloudinary Cloud Name และ Upload Preset ในหน้าตั้งค่าระบบก่อน");
                return null;
            }
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', appSettings.cloudinaryPreset);
            try {
                const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                const data = await response.json();
                if (data.secure_url) {
                    return data.secure_url;
                } else if (data.error) {
                    throw new Error(`Cloudinary: ${data.error.message}`);
                } else {
                    throw new Error('เกิดข้อผิดพลาดที่ไม่คาดคิดจากการตอบกลับของ Cloudinary');
                }
            } catch (error) {
                console.error('Cloudinary upload error:', error);
                alert(`การอัปโหลดรูปภาพล้มเหลว: ${error.message}`);
                return null;
            }
        }

        function showJobModal() {
            const content = `<input type="text" name="name" placeholder="ชื่อคิวงาน" required class="w-full p-2 border rounded"><input type="text" name="location" placeholder="สถานที่" required class="w-full p-2 border rounded"><input type="number" name="income" placeholder="งบประมาณ" required class="w-full p-2 border rounded"><label>วันที่เริ่ม</label><input type="date" name="startDate" required class="w-full p-2 border rounded"><label>วันที่สิ้นสุด</label><input type="date" name="endDate" required class="w-full p-2 border rounded">`;
            showModal('เพิ่มคิวงานใหม่', content, async (formData, submitButton, modal) => {
                const startDate = formData.get('startDate'), endDate = formData.get('endDate');
                let workdays = [];
                for (let d = new Date(startDate); d <= new Date(endDate); d.setDate(d.getDate() + 1)) { workdays.push(new Date(d).toISOString().split('T')[0]); }
                await addDoc(collection(db, "jobs"), { 
                    name: formData.get('name'), 
                    location: formData.get('location'), 
                    income: Number(formData.get('income')), 
                    startDate, 
                    endDate, 
                    workdays, 
                    team: [], 
                    expenses: [], 
                    status: 'active', 
                    teamLeaderId: '',
                    whtEnabled: false,
                    vatEnabled: false,
                    whtPercent: appSettings.whtPercent,
                    notes: '',
                    teamNotes: ''
                });
                modal.remove();
            });
        }
        
        function showAddMemberModal() {
            const userOptions = allUsers.map(u => `<option value="${u.id}" data-pic="${u.profilePic || ''}">${u.nickname || u.name}</option>`).join('');
            const content = `
                <div class="flex items-center space-x-4">
                    <img id="add-member-pic-preview" src="https://placehold.co/40x40/E2E8F0/4A5568?text=รูป" class="w-10 h-10 rounded-full object-cover border-2 border-gray-200">
                    <select id="add-member-select" name="userId" required class="w-full p-2 border rounded flex-grow">${userOptions}</select>
                </div>
                <input type="text" name="position" placeholder="ตำแหน่ง" required class="w-full p-2 border rounded">
                <input type="number" name="dailyRate" placeholder="ค่าแรง/วัน" required class="w-full p-2 border rounded">`;
            showModal('เพิ่มสมาชิกในทีม', content, async (formData, submitButton, modal) => {
                const userId = formData.get('userId');
                await updateDoc(doc(db, "jobs", currentJobId), { team: arrayUnion({ userId: userId, position: formData.get('position'), dailyRate: Number(formData.get('dailyRate')), workdays: [], dailyOverrides: {}, isPaid: false })})
                await createNotification(userId, `คุณถูกเพิ่มเข้าคิวงาน: <b>${currentJobData.name}</b>`, currentJobId, currentJobData.name);
                modal.remove();
            }, true, (modal) => {
                const selectEl = modal.querySelector('#add-member-select');
                const previewEl = modal.querySelector('#add-member-pic-preview');
                const updatePreview = () => {
                    const selectedOption = selectEl.options[selectEl.selectedIndex];
                    const picUrl = selectedOption.dataset.pic;
                    previewEl.src = picUrl || 'https://placehold.co/40x40/E2E8F0/4A5568?text=รูป';
                };
                selectEl.onchange = updatePreview;
                updatePreview();
            });
        }
        
        function showEditMemberModal(member) {
            const memberData = allUsers.find(u => u.id === member.userId);
            let userOptions = allUsers.map(u => `<option value="${u.id}" data-pic="${u.profilePic || ''}" ${u.id === member.userId ? 'selected' : ''}>${u.nickname || u.name}</option>`).join('');
            const content = `
                <div class="flex items-center space-x-4">
                    <img id="edit-member-pic-preview" src="${memberData.profilePic || 'https://placehold.co/40x40/E2E8F0/4A5568?text=รูป'}" class="w-10 h-10 rounded-full object-cover border-2 border-gray-200">
                    <select id="edit-member-select" name="userId" required class="w-full p-2 border rounded flex-grow">${userOptions}</select>
                </div>
                <input type="text" name="position" placeholder="ตำแหน่ง" required class="w-full p-2 border rounded" value="${member.position}">
                <input type="number" name="dailyRate" placeholder="ค่าแรง/วัน" required class="w-full p-2 border rounded" value="${member.dailyRate}">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="is-leader-checkbox" name="isLeader" ${currentJobData.teamLeaderId === member.userId ? 'checked' : ''}>
                    <label for="is-leader-checkbox">กำหนดเป็นหัวหน้าทีม</label>
                </div>`;
            showModal('แก้ไขข้อมูลทีมงาน', content, async (formData, submitButton, modal) => {
                const newUserId = formData.get('userId');
                const isLeaderCheckbox = formData.get('isLeader');
                const teamMemberIndex = currentJobData.team.findIndex(m => m.userId === member.userId);

                if (teamMemberIndex > -1) { 
                    currentJobData.team[teamMemberIndex].userId = newUserId;
                    currentJobData.team[teamMemberIndex].position = formData.get('position'); 
                    currentJobData.team[teamMemberIndex].dailyRate = Number(formData.get('dailyRate')); 
                }
                
                let newLeaderId = currentJobData.teamLeaderId;
                if(isLeaderCheckbox) {
                    newLeaderId = newUserId;
                } else if (currentJobData.teamLeaderId === member.userId) {
                    newLeaderId = '';
                }

                await updateDoc(doc(db, "jobs", currentJobId), { team: currentJobData.team, teamLeaderId: newLeaderId });
                modal.remove();
            }, true, (modal) => {
                const selectEl = modal.querySelector('#edit-member-select');
                const previewEl = modal.querySelector('#edit-member-pic-preview');
                const updatePreview = () => {
                    const selectedOption = selectEl.options[selectEl.selectedIndex];
                    const picUrl = selectedOption.dataset.pic;
                    previewEl.src = picUrl || 'https://placehold.co/40x40/E2E8F0/4A5568?text=รูป';
                };
                selectEl.onchange = updatePreview;
            });
        }
        
        function showEditBudgetModal(currentBudget) {
            showModal('แก้ไขงบประมาณ', `<input type="number" name="budget" required class="w-full p-2 border rounded" value="${currentBudget}">`, async (formData, submitButton, modal) => {
                await updateDoc(doc(db, "jobs", currentJobId), { income: Number(formData.get('income')) });
                modal.remove();
            });
        }
        
        function showAddDayModal() {
            showModal('เพิ่มวันทำงาน', `<label>เลือกวันที่ต้องการเพิ่ม</label><input type="date" name="newDay" required class="w-full p-2 border rounded">`, async (formData, submitButton, modal) => {
                const newDay = formData.get('newDay');
                currentJobData.workdays.push(newDay);
                currentJobData.workdays.sort((a, b) => new Date(a) - new Date(b));
                await updateDoc(doc(db, "jobs", currentJobId), { workdays: currentJobData.workdays });
                modal.remove();
            });
        }

        function showExpenseModal() {
            const content = `<input type="text" name="name" placeholder="ชื่อรายการ" required class="w-full p-2 border rounded"><input type="number" name="amount" placeholder="จำนวนเงิน" required class="w-full p-2 border rounded">`;
            showModal('เพิ่มค่าใช้จ่าย', content, async (formData, submitButton, modal) => {
                await updateDoc(doc(db, "jobs", currentJobId), { expenses: arrayUnion({ name: formData.get('name'), amount: Number(formData.get('amount')) })});
                modal.remove();
            });
        }
        
        function showEditExpenseModal(expense, index) {
            const content = `<input type="text" name="name" placeholder="ชื่อรายการ" required class="w-full p-2 border rounded" value="${expense.name}"><input type="number" name="amount" placeholder="จำนวนเงิน" required class="w-full p-2 border rounded" value="${expense.amount}">`;
            showModal('แก้ไขค่าใช้จ่าย', content, async (formData, submitButton, modal) => {
                const updatedExpense = {
                    name: formData.get('name'),
                    amount: Number(formData.get('amount'))
                };
                currentJobData.expenses[index] = updatedExpense;
                await updateDoc(doc(db, "jobs", currentJobId), { expenses: currentJobData.expenses });
                modal.remove();
            });
        }

        function showEditDailyRateModal(userId, day) {
            const member = currentJobData.team.find(m => m.userId === userId);
            const currentRate = (member.dailyOverrides && member.dailyOverrides[day] !== undefined) ? member.dailyOverrides[day] : member.dailyRate;
            const content = `<label>ค่าแรงสำหรับวันที่ ${formatShortDate(day)}</label><input type="number" name="rate" required class="w-full p-2 border rounded" value="${currentRate}">`;
            showModal('แก้ไขค่าแรงรายวัน', content, async (formData, submitButton, modal) => {
                const newRate = Number(formData.get('rate'));
                if (!member.dailyOverrides) member.dailyOverrides = {};
                member.dailyOverrides[day] = newRate;
                await updateDoc(doc(db, "jobs", currentJobId), { team: currentJobData.team });
                modal.remove();
            });
        }

        function showEditJobDetailsModal(job) {
            const content = `<label>ชื่องาน</label><input type="text" name="name" required class="w-full p-2 border rounded" value="${job.name}"><label>สถานที่</label><input type="text" name="location" required class="w-full p-2 border rounded" value="${job.location}"><label>วันที่เริ่ม</label><input type="date" name="startDate" required class="w-full p-2 border rounded" value="${job.startDate}"><label>วันที่สิ้นสุด</label><input type="date" name="endDate" required class="w-full p-2 border rounded" value="${job.endDate}">`;
            showModal('แก้ไขข้อมูล Job', content, async (formData, submitButton, modal) => {
                await updateDoc(doc(db, "jobs", currentJobId), { name: formData.get('name'), location: formData.get('location'), startDate: formData.get('startDate'), endDate: formData.get('endDate') });
                modal.remove();
            });
        }
        
        function showEditWorkdayModal(oldDay) {
            const content = `<label>แก้ไขวันที่จาก ${formatShortDate(oldDay)} เป็น</label><input type="date" name="newDay" required class="w-full p-2 border rounded" value="${oldDay}">`;
            showModal('แก้ไขวันทำงาน', content, async (formData, submitButton, modal) => {
                const newDay = formData.get('newDay');
                const dayIndex = currentJobData.workdays.indexOf(oldDay);
                if (dayIndex > -1) currentJobData.workdays[dayIndex] = newDay;
                currentJobData.workdays.sort((a, b) => new Date(a) - new Date(b));
                currentJobData.team.forEach(member => {
                    const memberDayIndex = member.workdays.indexOf(oldDay);
                    if (memberDayIndex > -1) member.workdays[memberDayIndex] = newDay;
                    if (member.dailyOverrides && member.dailyOverrides[oldDay] !== undefined) {
                        member.dailyOverrides[newDay] = member.dailyOverrides[oldDay];
                        delete member.dailyOverrides[oldDay];
                    }
                });
                await updateDoc(doc(db, "jobs", currentJobId), { workdays: currentJobData.workdays, team: currentJobData.team });
                modal.remove();
            });
        }

        function showUserManagementModal() {
            let userListHTML = `<div class="space-y-4">`;
            allUsers.forEach(user => {
                const displayName = user.nickname || user.name;
                const bankInfo = user.bankAccount;
                userListHTML += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><div class="flex items-center"><img src="${user.profilePic || 'https://placehold.co/40x40/E2E8F0/4A5568?text=??'}" class="w-10 h-10 rounded-full mr-4"><div><p class="font-semibold">${displayName}</p><p class="text-sm text-gray-500">${user.email} - <span class="font-medium">${user.role}</span></p><div class="text-xs text-gray-400 mt-1"><i class="ph ph-bank"></i> ${bankInfo?.bank || 'N/A'}: ${bankInfo?.number || 'N/A'}</div></div></div><div class="flex items-center space-x-2"><button class="modal-switch-view-btn p-2 text-green-500 hover:bg-green-100 rounded-full" data-userid="${user.id}"><i class="ph ph-eye"></i></button><button class="modal-delete-user-btn p-2 text-red-500 hover:bg-red-100 rounded-full" data-userid="${user.id}"><i class="ph ph-trash"></i></button></div></div>`;
            });
            userListHTML += `</div>`;

            showModal('การจัดการทีมงานทั้งหมด', userListHTML, null, false, (modal) => {
                modal.querySelectorAll('.modal-delete-user-btn').forEach(btn => btn.onclick = (e) => {
                    const userIdToDelete = e.currentTarget.dataset.userid;
                    if (userIdToDelete === currentUser.uid) { 
                        alert("ไม่สามารถลบตัวเองได้"); 
                        return; 
                    }
                    const userToDelete = allUsers.find(u => u.id === userIdToDelete);
                    const userName = userToDelete ? (userToDelete.nickname || userToDelete.name) : 'ผู้ใช้คนนี้';

                    showConfirmModal(
                        `ยืนยันการลบ ${userName}`, 
                        'การกระทำนี้จะลบผู้ใช้ออกจากระบบและคิวงานทั้งหมดที่เกี่ยวข้องอย่างถาวร แต่จะไม่ลบบัญชีล็อกอิน คุณแน่ใจหรือไม่?', 
                        async () => {
                            try {
                                const batch = writeBatch(db);

                                // 1. Delete the user document
                                const userRef = doc(db, "users", userIdToDelete);
                                batch.delete(userRef);

                                // 2. Remove the user from all jobs
                                const jobsSnapshot = await getDocs(collection(db, "jobs"));
                                jobsSnapshot.forEach(jobDoc => {
                                    const jobData = jobDoc.data();
                                    const team = jobData.team || [];
                                    
                                    const newTeam = team.filter(member => member.userId !== userIdToDelete);

                                    if (newTeam.length < team.length) {
                                        const jobRef = doc(db, "jobs", jobDoc.id);
                                        batch.update(jobRef, { team: newTeam });
                                    }
                                });

                                // Commit the batch
                                await batch.commit();

                                alert(`ลบ ${userName} เรียบร้อยแล้ว`);
                                modal.remove(); // Close the user management modal
                            } catch (error) {
                                console.error("Error deleting user permanently:", error);
                                alert("เกิดข้อผิดพลาดในการลบผู้ใช้");
                            }
                        }
                    );
                });
                modal.querySelectorAll('.modal-switch-view-btn').forEach(btn => btn.onclick = (e) => {
                    const userIdToImpersonate = e.currentTarget.dataset.userid;
                    switchToUserView(userIdToImpersonate);
                    modal.remove();
                });
            });
        }

        function showManageProfileModal() {
            const content = `
                <div class="flex flex-col items-center space-y-2">
                    <input type="text" name="nickname" class="w-1/2 p-2 border rounded text-center" placeholder="ชื่อเล่น" value="${currentUserData.nickname || ''}">
                    <img id="profile-pic-preview" src="${currentUserData.profilePic || 'https://placehold.co/100x100/E2E8F0/4A5568?text=รูป'}" class="w-24 h-24 rounded-full object-cover border-2 border-gray-200">
                    <label for="profilePicFile" class="cursor-pointer text-sm text-violet-700 font-semibold hover:text-violet-900">เลือกรูปภาพ</label>
                    <input type="file" name="profilePicFile" id="profilePicFile" accept="image/*" class="hidden"/>
                </div>
                <label>Username</label><input type="text" readonly class="w-full p-2 border rounded bg-gray-100" value="${currentUserData.name}">
                <label>เบอร์โทร</label><input type="tel" name="phone" class="w-full p-2 border rounded" value="${currentUserData.phone || ''}">
                <hr>
                <div class="grid grid-cols-2 gap-4">
                    <button type="button" id="manage-bank-account-btn" class="w-full px-4 py-2 font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors">บัญชีธนาคาร</button>
                    <button type="button" id="change-password-from-profile-btn" class="w-full px-4 py-2 font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition-colors">เปลี่ยนรหัสผ่าน</button>
                </div>`;
            showModal('จัดการโปรไฟล์', content, async (formData, submitButton, modal) => {
                submitButton.textContent = 'กำลังบันทึก...';
                submitButton.disabled = true;
                const profilePicFile = formData.get('profilePicFile');
                let newProfilePicUrl = currentUserData.profilePic;
                if (profilePicFile && profilePicFile.size > 0) {
                    newProfilePicUrl = await uploadToCloudinary(profilePicFile) || newProfilePicUrl;
                }
                const updatedData = {
                    nickname: formData.get('nickname'),
                    phone: formData.get('phone'),
                    profilePic: newProfilePicUrl
                };
                await updateDoc(doc(db, "users", currentUser.uid), updatedData);
                currentUserData = {...currentUserData, ...updatedData};
                document.getElementById('user-name-display').textContent = currentUserData.nickname || currentUserData.name;
                modal.remove();
            }, true, (modal) => {
                const fileInput = modal.querySelector('#profilePicFile');
                const previewImg = modal.querySelector('#profile-pic-preview');
                fileInput.onchange = (e) => {
                    if (e.target.files && e.target.files[0]) {
                        previewImg.src = URL.createObjectURL(e.target.files[0]);
                    }
                };
                modal.querySelector('#change-password-from-profile-btn').onclick = () => { modal.remove(); showChangePasswordForCurrentUserModal(); };
                modal.querySelector('#manage-bank-account-btn').onclick = () => { modal.remove(); showBankAccountModal(); };
            });
        }
        
        function showChangePasswordForCurrentUserModal() {
             const content = `
                <label>รหัสผ่านปัจจุบัน</label><input type="password" name="oldPassword" required class="w-full p-2 border rounded">
                <label>รหัสผ่านใหม่</label><input type="password" name="newPassword" required class="w-full p-2 border rounded">
                <label>ยืนยันรหัสผ่านใหม่</label><input type="password" name="confirmPassword" required class="w-full p-2 border rounded">
                <p id="change-pass-error" class="text-sm text-red-500 hidden"></p>`;
             showModal('เปลี่ยนรหัสผ่าน', content, async (formData, submitButton, modal) => {
                const oldPass = formData.get('oldPassword');
                const newPass = formData.get('newPassword');
                const confirmPass = formData.get('confirmPassword');
                
                if (newPass.length < 6) { alert("รหัสผ่านใหม่ต้องมีอย่างน้อย 6 ตัวอักษร"); return; }
                if (newPass !== confirmPass) { alert("รหัสผ่านใหม่และการยืนยันไม่ตรงกัน"); return; }

                submitButton.textContent = 'กำลังเปลี่ยน...';
                submitButton.disabled = true;

                try {
                    const credential = EmailAuthProvider.credential(currentUser.email, oldPass);
                    await reauthenticateWithCredential(currentUser, credential);
                    await updatePassword(currentUser, newPass);
                    alert("เปลี่ยนรหัสผ่านสำเร็จแล้ว");
                    modal.remove();
                } catch(error) {
                    console.error("Password change failed:", error);
                    alert("การเปลี่ยนรหัสผ่านล้มเหลว: รหัสผ่านปัจจุบันไม่ถูกต้อง หรือเกิดข้อผิดพลาดอื่น");
                    submitButton.textContent = 'บันทึก';
                    submitButton.disabled = false;
                }
             });
        }

        function showBankAccountModal() {
            const bankInfo = currentUserData.bankAccount || { name: '', bank: '', number: '' };
            const banks = ['พร้อมเพย์', 'ธนาคารกรุงเทพ', 'ธนาคารกสิกรไทย', 'ธนาคารกรุงไทย', 'ธนาคารไทยพาณิชย์', 'ธนาคารกรุงศรีอยุธยา', 'ธนาคารทหารไทยธนชาต', 'ธนาคารออมสิน', 'ธ.ก.ส.', 'ธนาคารยูโอบี', 'ธนาคารซีไอเอ็มบีไทย'];
            const bankOptions = banks.map(b => `<option value="${b}" ${b === bankInfo.bank ? 'selected' : ''}>${b}</option>`).join('');
            const content = `
                <label>ชื่อบัญชี</label><input type="text" name="accountName" class="w-full p-2 border rounded" value="${bankInfo.name || ''}">
                <label>ธนาคาร</label><select name="bankName" class="w-full p-2 border rounded">${bankOptions}</select>
                <label>หมายเลขบัญชี</label><input type="text" name="accountNumber" class="w-full p-2 border rounded" value="${bankInfo.number || ''}">
            `;
            showModal('ข้อมูลบัญชีธนาคาร', content, async (formData, submitButton, modal) => {
                submitButton.disabled = true;
                submitButton.textContent = 'กำลังบันทึก...';
                const updatedBankAccount = {
                    name: formData.get('accountName'),
                    bank: formData.get('bankName'),
                    number: formData.get('accountNumber')
                };
                await updateDoc(doc(db, "users", currentUser.uid), { bankAccount: updatedBankAccount });
                currentUserData.bankAccount = updatedBankAccount;
                alert('บันทึกข้อมูลบัญชีธนาคารเรียบร้อยแล้ว');
                modal.remove();
            });
        }

        function showAdminBankAccountModal(user) {
            const bankInfo = user.bankAccount || { name: '', bank: '', number: '' };
            const banks = ['พร้อมเพย์', 'ธนาคารกรุงเทพ', 'ธนาคารกสิกรไทย', 'ธนาคารกรุงไทย', 'ธนาคารไทยพาณิชย์', 'ธนาคารกรุงศรีอยุธยา', 'ธนาคารทหารไทยธนชาต', 'ธนาคารออมสิน', 'ธ.ก.ส.', 'ธนาคารยูโอบี', 'ธนาคารซีไอเอ็มบีไทย'];
            const bankOptions = banks.map(b => `<option value="${b}" ${b === bankInfo.bank ? 'selected' : ''}>${b}</option>`).join('');
            const content = `
                <label>ชื่อบัญชี</label><input type="text" name="accountName" class="w-full p-2 border rounded" value="${bankInfo.name || ''}">
                <label>ธนาคาร</label><select name="bankName" class="w-full p-2 border rounded">${bankOptions}</select>
                <label>หมายเลขบัญชี</label><input type="text" name="accountNumber" class="w-full p-2 border rounded" value="${bankInfo.number || ''}">
            `;
            showModal(`บัญชีธนาคารของ ${user.nickname || user.name}`, content, async (formData, submitButton, modal) => {
                submitButton.disabled = true;
                submitButton.textContent = 'กำลังบันทึก...';
                const updatedBankAccount = {
                    name: formData.get('accountName'),
                    bank: formData.get('bankName'),
                    number: formData.get('accountNumber')
                };
                await updateDoc(doc(db, "users", user.id), { bankAccount: updatedBankAccount });
                alert('บันทึกข้อมูลบัญชีธนาคารเรียบร้อยแล้ว');
                modal.remove();
            });
        }
        
        function showForgotPasswordModal() {
            const content = `<label>กรุณากรอกอีเมลของคุณเพื่อรีเซ็ตรหัสผ่าน</label><input type="email" name="email" required class="w-full p-2 border rounded" placeholder="your@email.com">`;
            showModal('ลืมรหัสผ่าน', content, async (formData, submitButton, modal) => {
                const email = formData.get('email');
                try {
                    await sendPasswordResetEmail(auth, email);
                    alert('อีเมลสำหรับรีเซ็ตรหัสผ่านได้ถูกส่งไปแล้ว กรุณาตรวจสอบกล่องจดหมายของคุณ');
                    modal.remove();
                } catch (error) {
                    console.error("Password reset error:", error);
                    alert('เกิดข้อผิดพลาด: ไม่สามารถส่งอีเมลรีเซ็ตรหัสผ่านได้ อาจเป็นเพราะไม่มีอีเมลนี้ในระบบ');
                }
            });
        }

        function switchToUserView(userIdToImpersonate) {
            if (currentUserRole !== 'admin' || originalAdminData) return; // Prevent non-admins or nested impersonation

            const targetUser = allUsers.find(u => u.id === userIdToImpersonate);
            if (targetUser) {
                originalAdminData = { user: currentUser, data: currentUserData, role: currentUserRole };
                
                currentUser = { uid: targetUser.id, email: targetUser.email };
                currentUserData = targetUser;
                currentUserRole = targetUser.role;

                initializeAppUI();
            }
        }

        function returnToAdminView() {
            if (!originalAdminData) return;
            
            currentUser = originalAdminData.user;
            currentUserData = originalAdminData.data;
            currentUserRole = originalAdminData.role;

            originalAdminData = null;
            initializeAppUI();
        }

        async function loadAppSettings() {
            if (currentUserRole !== 'admin') return;
            const settingsRef = doc(db, "settings", "app-config");
            const settingsSnap = await getDoc(settingsRef);
            if (settingsSnap.exists()) {
                appSettings = { ...appSettings, ...settingsSnap.data() };
            } else {
                // If no settings doc, create one with defaults
                await setDoc(settingsRef, appSettings).catch(e => console.error("Could not create default settings:", e));
            }
        }

        function showSettingsView() {
            mainApp.classList.add('hidden');
            document.getElementById('financial-summary-view').classList.add('hidden');
            document.getElementById('settings-view').classList.remove('hidden');

            // Populate form
            document.getElementById('setting-cloudinary-name').value = appSettings.cloudinaryName;
            document.getElementById('setting-cloudinary-preset').value = appSettings.cloudinaryPreset;
            document.getElementById('setting-line-channel-id').value = appSettings.lineChannelId || '';
            document.getElementById('setting-line-channel-secret').value = appSettings.lineChannelSecret || '';
            document.getElementById('setting-facebook-app-id').value = appSettings.facebookAppId || '';
            document.getElementById('setting-facebook-app-secret').value = appSettings.facebookAppSecret || '';
        }

        // --- NOTIFICATION FUNCTIONS ---
        async function createNotification(recipientId, message, jobId = '', jobName = '') {
            if (!recipientId) return;
            // To avoid notifying the action-taker
            const finalRecipients = (Array.isArray(recipientId) ? recipientId : [recipientId]).filter(id => id !== currentUser.uid);
            if (finalRecipients.length === 0) return;

            await addDoc(collection(db, "notifications"), {
                senderId: currentUser.uid,
                senderName: "ระบบ", // Or currentUserData.name
                recipientIds: finalRecipients,
                jobId: jobId,
                jobName: jobName,
                type: 'system_update',
                status: 'info',
                message: message,
                isRead: false,
                createdAt: serverTimestamp()
            });
        }

        function listenForNotifications() {
            if (notificationsUnsubscribe) notificationsUnsubscribe();
            if (!currentUser) return;

            const q = query(collection(db, "notifications"), where("recipientIds", "array-contains", currentUser.uid));
            
            notificationsUnsubscribe = onSnapshot(q, (snapshot) => {
                allNotifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const unreadCount = allNotifications.filter(n => !n.isRead).length;
                
                const badge = document.getElementById('notification-badge');
                if (unreadCount > 0) {
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            });
        }

        async function showRequestToJoinModal(jobId, jobName) {
            const job = allActiveJobs.find(j => j.id === jobId);
            if (!job) return;

            showConfirmModal(
                `ขอลงคิวงาน "${jobName}"?`,
                'คำขอของคุณรอการอนุมัติ หากอนุมัติหรือไม่อนุมัติจะมีแจ้งเตือนอีกครั้ง',
                async () => {
                    const admins = allUsers.filter(u => u.role === 'admin');
                    let recipientIds = admins.map(a => a.id);
                    if (job.teamLeaderId && !recipientIds.includes(job.teamLeaderId)) {
                        recipientIds.push(job.teamLeaderId);
                    }

                    if (job.team.some(m => m.userId === currentUser.uid)) {
                        alert("คุณอยู่ในคิวงานนี้แล้ว");
                        return;
                    }

                    const existingRequestQuery = query(collection(db, "notifications"), 
                        where("senderId", "==", currentUser.uid),
                        where("jobId", "==", jobId),
                        where("type", "==", "join_request"),
                        where("status", "==", "pending")
                    );
                    const existingRequestSnapshot = await getDocs(existingRequestQuery);
                    if (!existingRequestSnapshot.empty) {
                        alert("คุณได้ส่งคำขอสำหรับคิวงานนี้ไปแล้ว");
                        return;
                    }

                    await addDoc(collection(db, "notifications"), {
                        senderId: currentUser.uid,
                        senderName: currentUserData.nickname || currentUserData.name,
                        recipientIds: recipientIds,
                        jobId: jobId,
                        jobName: jobName,
                        type: 'join_request',
                        status: 'pending', // pending, approved, denied
                        isRead: false,
                        createdAt: serverTimestamp()
                    });
                    alert('ส่งคำขอเรียบร้อยแล้ว');
                }
            );
        }

        async function showNotificationsModal() {
            if (allNotifications.length === 0) {
                alert("ยังไม่มีการแจ้งเตือน");
                return;
            }

            let notificationsHTML = '<div class="space-y-3">';
            allNotifications.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0)); // Sort newest first

            for (const notification of allNotifications) {
                let actionButtons = '';
                const isJoinRequest = notification.type === 'join_request' && notification.status === 'pending';
                const jobForNotif = allActiveJobs.find(j => j.id === notification.jobId);
                const canApprove = currentUserRole === 'admin' || (jobForNotif && currentUser.uid === jobForNotif.teamLeaderId);

                if (isJoinRequest && canApprove) {
                    actionButtons = `
                        <div class="flex space-x-2 mt-2">
                            <button class="approve-request-btn px-3 py-1 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600" data-id="${notification.id}">อนุมัติ</button>
                            <button class="deny-request-btn px-3 py-1 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600" data-id="${notification.id}">ปฏิเสธ</button>
                        </div>`;
                }
                
                let statusText = '';
                switch(notification.status) {
                    case 'approved': statusText = `<span class="font-semibold text-green-600"> (อนุมัติแล้ว)</span>`; break;
                    case 'denied': statusText = `<span class="font-semibold text-red-600"> (ถูกปฏิเสธ)</span>`; break;
                }
                
                const message = notification.message || `<b>${notification.senderName}</b> ได้ส่งคำขอเข้าร่วมคิวงาน <b>${notification.jobName}</b>`;

                notificationsHTML += `
                    <div class="p-3 rounded-lg ${notification.isRead ? 'bg-gray-50' : 'bg-blue-50 border-l-4 border-blue-500'}">
                        <p class="text-sm text-gray-800">
                            ${message}${statusText}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">${notification.createdAt ? notification.createdAt.toDate().toLocaleString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : ''}</p>
                        ${actionButtons}
                    </div>
                `;
            }
            notificationsHTML += '</div>';

            showModal('การแจ้งเตือน', notificationsHTML, null, false, (modal) => {
                modal.querySelectorAll('.approve-request-btn').forEach(btn => btn.onclick = (e) => {
                    const notificationId = e.currentTarget.dataset.id;
                    const notification = allNotifications.find(n => n.id === notificationId);
                    approveRequest(notification);
                    modal.remove();
                });
                modal.querySelectorAll('.deny-request-btn').forEach(btn => btn.onclick = (e) => {
                    const notificationId = e.currentTarget.dataset.id;
                    const notification = allNotifications.find(n => n.id === notificationId);
                    denyRequest(notification);
                    modal.remove();
                });
            });

            const unreadNotifications = allNotifications.filter(n => !n.isRead);
            const batch = writeBatch(db);
            unreadNotifications.forEach(notification => {
                const notifRef = doc(db, "notifications", notification.id);
                batch.update(notifRef, { isRead: true });
            });
            await batch.commit();
        }

        async function approveRequest(notification) {
            const content = `
                <p>กำหนดตำแหน่งและค่าแรงสำหรับ <b>${notification.senderName}</b> ในคิวงาน <b>${notification.jobName}</b></p>
                <input type="text" name="position" placeholder="ตำแหน่ง" required class="w-full p-2 border rounded">
                <input type="number" name="dailyRate" placeholder="ค่าแรง/วัน" required class="w-full p-2 border rounded">`;
            
            showModal('อนุมัติคำขอ', content, async (formData, submitBtn, modal) => {
                const position = formData.get('position');
                const dailyRate = Number(formData.get('dailyRate'));

                await updateDoc(doc(db, "jobs", notification.jobId), { 
                    team: arrayUnion({ 
                        userId: notification.senderId, 
                        position: position, 
                        dailyRate: dailyRate, 
                        workdays: [], 
                        dailyOverrides: {}, 
                        isPaid: false 
                    })
                });

                await updateDoc(doc(db, "notifications", notification.id), { status: 'approved' });

                await addDoc(collection(db, "notifications"), {
                    senderId: currentUser.uid,
                    senderName: "ระบบ",
                    recipientIds: [notification.senderId],
                    jobId: notification.jobId,
                    jobName: notification.jobName,
                    type: 'request_response',
                    status: 'approved',
                    message: `คำขอเข้าร่วมคิวงาน <b>${notification.jobName}</b> ของคุณได้รับการอนุมัติแล้ว`,
                    isRead: false,
                    createdAt: serverTimestamp()
                });
                
                alert('อนุมัติคำขอเรียบร้อยแล้ว');
                modal.remove();
            });
        }

        async function denyRequest(notification) {
            await updateDoc(doc(db, "notifications", notification.id), { status: 'denied' });

            await addDoc(collection(db, "notifications"), {
                senderId: currentUser.uid,
                senderName: "ระบบ",
                recipientIds: [notification.senderId],
                jobId: notification.jobId,
                jobName: notification.jobName,
                type: 'request_response',
                status: 'denied',
                message: `คำขอเข้าร่วมคิวงาน <b>${notification.jobName}</b> ของคุณถูกปฏิเสธ`,
                isRead: false,
                createdAt: serverTimestamp()
            });

            alert('ปฏิเสธคำขอเรียบร้อยแล้ว');
        }

    </script>
</body>
</html>
