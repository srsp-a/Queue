<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDB QUEUE ‚Äì Admin Panel (Firebase)</title>
    <!-- Dynamic favicon loaded from settings -->
    <link id="dynamic-favicon" rel="icon" type="image/png" href="">
    <!-- TailwindCSS for utility‚Äëfirst styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Phosphor icons for modern iconography -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-auth-compat.js"></script>
    <style>
        /* Custom fonts and dark base styles */
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #0f172a; /* dark slate background */
            color: #f1f5f9; /* zinc‚Äë50 text for high contrast */
            min-height: 100vh;
            overflow-x: hidden;
        }
        /* Glass card effect used throughout the dashboard */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        /* Scrollbar styling for the sidebar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
    </style>
    <!-- Toast notification styles -->
    <style>
        #toast-container div {
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        #toast-container div.opacity-0 {
            opacity: 0;
            transform: translateY(-10px);
        }

        /* Light theme overrides applied when body has .light-theme class */
        body.light-theme {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        body.light-theme .glass {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.1);
        }
        body.light-theme .text-gray-400 {
            color: #6b7280 !important;
        }
        body.light-theme .text-gray-300 {
            color: #4b5563 !important;
        }

        /* Additional light theme adjustments for better contrast */
        body.light-theme input,
        body.light-theme select,
        body.light-theme textarea {
            background-color: #ffffff !important;
            color: #1f2937 !important;
        }
        body.light-theme .bg-gray-600,
        body.light-theme .bg-gray-700,
        body.light-theme .bg-gray-800,
        body.light-theme .bg-gray-900 {
            background-color: #f9fafb !important;
            color: #1f2937 !important;
        }
        body.light-theme .border-gray-700,
        body.light-theme .border-gray-800,
        body.light-theme .border-gray-900 {
            border-color: #d1d5db !important;
        }

        /* Sidebar navigation adjustments in light mode */
        body.light-theme #sidebar button:hover {
            background-color: #e5e7eb !important;
        }
        body.light-theme #sidebar button.active {
            background-color: #d1d5db !important;
            color: #1f2937 !important;
        }
        body.light-theme #sidebar button.active i {
            color: #1f2937 !important;
        }

        /* Override text colours for very light text classes in light mode */
        body.light-theme .text-white,
        body.light-theme .text-gray-50,
        body.light-theme .text-gray-100,
        body.light-theme .text-gray-200 {
            color: #1f2937 !important;
        }
    </style>
</head>
<body>
    <!-- Login overlay -->
    <div id="login-container" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-80 z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4 text-center">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h2>
            <div class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input id="login-email" type="email" class="w-full p-2 bg-gray-700 rounded-lg" placeholder="admin@example.com" required>
                </div>
                <div>
                    <label for="login-password" class="block text-sm mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input id="login-password" type="password" class="w-full p-2 bg-gray-700 rounded-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <p id="login-error" class="text-sm text-red-500 hidden"></p>
                <button id="login-btn" class="w-full px-4 py-2 font-semibold text-white bg-gradient-to-r from-red-500 to-pink-500 rounded-lg hover:opacity-90">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ</button>
            </div>

        </div>
    </div>
    <!-- Sidebar navigation -->
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 hidden md:block overflow-y-auto glass p-6 z-50">
        <div class="flex items-center mb-8">
            <span class="text-3xl font-bold bg-gradient-to-r from-red-500 to-pink-500 bg-clip-text text-transparent">LDB QUEUE</span>
        </div>
        <nav class="space-y-2">
            <button data-section="dashboard" class="w-full flex items-center p-3 text-left rounded-lg hover:bg-gray-800 transition-colors active">
                <i class="ph ph-gauge text-xl mr-3"></i>
                <span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span>
            </button>
            <button data-section="jobs" class="w-full flex items-center p-3 text-left rounded-lg hover:bg-gray-800 transition-colors">
                <i class="ph ph-briefcase text-xl mr-3"></i>
                <span>‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô</span>
            </button>
            <button data-section="users" class="w-full flex items-center p-3 text-left rounded-lg hover:bg-gray-800 transition-colors">
                <i class="ph ph-users text-xl mr-3"></i>
                <span>‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</span>
            </button>
            <button data-section="financial" class="w-full flex items-center p-3 text-left rounded-lg hover:bg-gray-800 transition-colors">
                <i class="ph ph-chart-bar text-xl mr-3"></i>
                <span>‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</span>
            </button>
            <button data-section="settings" class="w-full flex items-center p-3 text-left rounded-lg hover:bg-gray-800 transition-colors">
                <i class="ph ph-gear-six text-xl mr-3"></i>
                <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
            </button>
            <button data-section="logs" class="w-full flex items-center p-3 text-left rounded-lg hover:bg-gray-800 transition-colors">
                <i class="ph ph-scroll text-xl mr-3"></i>
                <span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</span>
            </button>
        </nav>
        <!-- Profile box at bottom of sidebar -->
        <div class="mt-10 pt-6 border-t border-gray-700">
            <div class="flex items-center space-x-3">
                <!-- Admin avatar will be updated dynamically -->
                <img id="admin-avatar" src="https://placehold.co/40x40/374151/9ca3af?text=üë§" alt="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå" class="w-10 h-10 rounded-full object-cover bg-gray-700">
                <div>
                    <p id="admin-name" class="font-semibold">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</p>
                    <p id="admin-role" class="text-sm text-gray-400">Admin</p>
                </div>
            </div>
            <button id="logout-btn" class="mt-4 w-full flex items-center justify-center px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors">
                <i class="ph ph-sign-out mr-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>
    </aside>

    <!-- Main content area -->
    <div id="main" class="ml-0 md:ml-64 p-6 md:p-8 space-y-8 hidden">
        <!-- Mobile menu and theme toggle buttons -->
        <div class="flex justify-end items-center mb-4 space-x-2">
            <!-- Theme toggle comes first -->
            <button id="theme-toggle" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition-colors" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô/‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô">
                <i id="theme-icon" class="ph ph-sun text-xl"></i>
            </button>
            <!-- Mobile menu button aligned to the right (visible on small screens) -->
            <button id="mobile-menu-toggle" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition-colors md:hidden" title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π">
                <i class="ph ph-list text-xl"></i>
            </button>
        </div>
        <!-- Dashboard section -->
        <section id="dashboard-section" class="section">
            <h1 class="text-3xl font-bold mb-6">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Card: Total jobs -->
                <div class="glass p-6 rounded-xl flex items-center space-x-4">
                    <div class="p-3 rounded-lg bg-gradient-to-br from-red-500 to-pink-500 text-white">
                        <i class="ph ph-briefcase text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        <h3 id="total-jobs" class="text-2xl font-semibold">0</h3>
                    </div>
                </div>
                <!-- Card: Pending jobs -->
                <div class="glass p-6 rounded-xl flex items-center space-x-4">
                    <div class="p-3 rounded-lg bg-gradient-to-br from-orange-500 to-yellow-500 text-white">
                        <i class="ph ph-hourglass text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                        <h3 id="pending-jobs" class="text-2xl font-semibold">0</h3>
                    </div>
                </div>
                <!-- Card: Completed jobs -->
                <div class="glass p-6 rounded-xl flex items-center space-x-4">
                    <div class="p-3 rounded-lg bg-gradient-to-br from-green-500 to-emerald-600 text-white">
                        <i class="ph ph-check-circle text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</p>
                        <h3 id="completed-jobs" class="text-2xl font-semibold">0</h3>
                    </div>
                </div>
                <!-- Card: Team members -->
                <div class="glass p-6 rounded-xl flex items-center space-x-4">
                    <div class="p-3 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 text-white">
                        <i class="ph ph-users text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</p>
                        <h3 id="team-count" class="text-2xl font-semibold">0</h3>
                    </div>
                </div>
            </div>
            <!-- Status summary cards row -->
            <div id="status-summary-cards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 gap-6 mt-6"></div>

            <!-- Charts section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-10">
                <div class="glass p-6 rounded-xl">
                    <h3 class="mb-4 font-semibold text-lg">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                    <canvas id="jobsStatusChart" height="200"></canvas>
                </div>
                <div class="glass p-6 rounded-xl">
                    <h3 class="mb-4 font-semibold text-lg">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö VS ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h3>
                    <canvas id="financeChart" height="200"></canvas>
                </div>
            </div>
            <!-- Financial metrics cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6 mt-10">
                <!-- Total revenue card with icon -->
                <div class="glass p-6 rounded-xl flex items-center space-x-4">
                    <div class="p-3 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 text-white">
                        <i class="ph ph-currency-circle-dollar text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°</p>
                        <h3 id="total-revenue" class="text-2xl font-semibold">0 ‡∏ö‡∏≤‡∏ó</h3>
                    </div>
                </div>
                <!-- Total expenses card with icon -->
                <div class="glass p-6 rounded-xl flex items-center space-x-4">
                    <div class="p-3 rounded-lg bg-gradient-to-br from-red-500 to-orange-500 text-white">
                        <i class="ph ph-wallet text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</p>
                        <h3 id="total-expenses" class="text-2xl font-semibold">0 ‡∏ö‡∏≤‡∏ó</h3>
                    </div>
                </div>
                <!-- Profit/Loss card with icon -->
                <div class="glass p-6 rounded-xl flex items-center space-x-4">
                    <div class="p-3 rounded-lg bg-gradient-to-br from-green-500 to-emerald-600 text-white">
                        <i class="ph ph-chart-bar text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</p>
                        <h3 id="profit-loss" class="text-2xl font-semibold">0 ‡∏ö‡∏≤‡∏ó</h3>
                    </div>
                </div>
                <!-- Wages paid card with icon -->
                <div class="glass p-6 rounded-xl flex items-center space-x-4">
                    <div class="p-3 rounded-lg bg-gradient-to-br from-yellow-400 to-amber-500 text-white">
                        <i class="ph ph-coins text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                        <h3 id="wages-paid" class="text-2xl font-semibold">0 ‡∏ö‡∏≤‡∏ó</h3>
                    </div>
                </div>
                <!-- Wages unpaid card with icon -->
                <div class="glass p-6 rounded-xl flex items-center space-x-4">
                    <div class="p-3 rounded-lg bg-gradient-to-br from-orange-400 to-yellow-500 text-white">
                        <i class="ph ph-hourglass text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢</p>
                        <h3 id="wages-unpaid" class="text-2xl font-semibold">0 ‡∏ö‡∏≤‡∏ó</h3>
                    </div>
                </div>
                <!-- WHT & VAT card with icon -->
                <div class="glass p-6 rounded-xl flex items-center space-x-4">
                    <div class="p-3 rounded-lg bg-gradient-to-br from-purple-500 to-fuchsia-600 text-white">
                        <i class="ph ph-percent text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">‡∏†‡∏≤‡∏©‡∏µ (WHT / VAT)</p>
                        <h3 class="text-xl font-semibold">
                            <span id="total-wht">0</span> ‡∏ö‡∏≤‡∏ó / <span id="total-vat">0</span> ‡∏ö‡∏≤‡∏ó
                        </h3>
                    </div>
                </div>
            </div>
        </section>
        <!-- Jobs section -->
        <section id="jobs-section" class="section hidden">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-3xl font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô</h1>
                <button id="add-job" class="flex items-center px-4 py-2 text-sm font-semibold text-white bg-gradient-to-r from-red-500 to-pink-500 rounded-lg hover:opacity-90">
                    <i class="ph ph-plus-circle mr-2"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
            <!-- Table for job list -->
            <div class="overflow-x-auto glass rounded-xl">
                <table class="min-w-full text-left">
                    <thead class="text-gray-400 text-sm uppercase">
                        <tr>
                            <th class="px-6 py-3">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</th>
                            <th class="px-6 py-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th class="px-6 py-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th class="px-6 py-3">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</th>
                            <th class="px-6 py-3">‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</th>
                            <th class="px-6 py-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="px-6 py-3 text-right">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="jobs-table-body" class="text-sm divide-y divide-gray-700"></tbody>
                </table>
            </div>
        </section>
        <!-- Users section -->
        <section id="users-section" class="section hidden">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-3xl font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</h1>
                <button id="add-user" class="flex items-center px-4 py-2 text-sm font-semibold text-white bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg hover:opacity-90">
                    <i class="ph ph-plus-circle mr-2"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                </button>
            </div>
            <div class="overflow-x-auto glass rounded-xl">
                <table class="min-w-full text-left">
                    <thead class="text-gray-400 text-sm uppercase">
                        <tr>
                            <th class="px-6 py-3">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</th>
                            <th class="px-6 py-3">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                            <th class="px-6 py-3">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                            <th class="px-6 py-3">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>
                            <th class="px-6 py-3">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                            <th class="px-6 py-3">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th>
                            <th class="px-6 py-3">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
                            <th class="px-6 py-3 text-right">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="text-sm divide-y divide-gray-700"></tbody>
                </table>
            </div>
        </section>
        <!-- Financial section -->
        <section id="financial-section" class="section hidden">
            <h1 class="text-3xl font-bold mb-6">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h1>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass p-6 rounded-xl">
                    <h3 class="mb-4 font-semibold text-lg">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h3>
                    <canvas id="financeSummaryChart" height="200"></canvas>
                </div>
                <div class="glass p-6 rounded-xl flex flex-col justify-between">
                    <div>
                        <h3 class="mb-4 font-semibold text-lg">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏©‡∏µ</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span>‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</span>
                                <input id="whtRate" type="number" class="w-20 p-2 bg-gray-800 rounded-lg text-center" value="3" min="0" max="100">%
                            </div>
                            <div class="flex items-center justify-between">
                                <span>VAT</span>
                                <input id="vatRate" type="number" class="w-20 p-2 bg-gray-800 rounded-lg text-center" value="7" min="0" max="100">%
                            </div>
                            <div class="flex items-center justify-between">
                                <span>‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô</span>
                                <select id="currencySelect" class="bg-gray-800 p-2 rounded-lg">
                                    <option value="THB">THB</option>
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button id="save-tax-settings" class="mt-6 px-4 py-2 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 self-start">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                </div>
            </div>
        </section>
        <!-- Settings section -->
        <section id="settings-section" class="section hidden">
            <h1 class="text-3xl font-bold mb-6">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h1>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- General settings card -->
                <div class="glass p-6 rounded-xl">
                    <h3 class="mb-4 font-semibold text-lg">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm mb-1" for="companyName">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö</label>
                            <input id="companyName" type="text" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="LDB QUEUE">
                        </div>
                        <div>
                            <label class="block text-sm mb-1" for="primaryColor">‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏ò‡∏µ‡∏°</label>
                            <input id="primaryColor" type="color" class="w-full h-10 p-1 bg-gray-800 rounded-lg" value="#ef4444">
                        </div>
                        <div>
                            <label class="block text-sm mb-1">‡πÇ‡∏•‡πÇ‡∏Å‡πâ</label>
                            <input id="logoInput" type="file" accept="image/*" class="w-full p-2 bg-gray-800 rounded-lg">
                            <div id="logoPreview" class="mt-2"></div>
                        </div>
                    </div>
                    <button id="save-general-settings" class="mt-4 px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
                <!-- Notification settings card -->
                <div class="glass p-6 rounded-xl">
                    <h3 class="mb-4 font-semibold text-lg">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm mb-1" for="emailNotifications">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</label>
                            <input id="emailNotifications" type="email" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="admin@example.com">
                        </div>
                        <div>
                            <label class="block text-sm mb-1" for="lineToken">LINE Bot Token</label>
                            <input id="lineToken" type="text" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="‡πÉ‡∏™‡πà LINE Bot Token">
                        </div>
                        <div>
                            <label class="inline-flex items-center cursor-pointer">
                                <input id="enableEmail" type="checkbox" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:bg-pink-500 relative transition-all">
                                    <span class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5"></span>
                                </div>
                                <span class="ml-3 text-sm">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•</span>
                            </label>
                        </div>
                        <div>
                            <label class="inline-flex items-center cursor-pointer">
                                <input id="enableLine" type="checkbox" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:bg-pink-500 relative transition-all">
                                    <span class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5"></span>
                                </div>
                                <span class="ml-3 text-sm">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE</span>
                            </label>
                        </div>
                    </div>
                    <button id="save-notification-settings" class="mt-4 px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>

                <!-- Metadata settings card -->
                <div class="glass p-6 rounded-xl">
                    <h3 class="mb-4 font-semibold text-lg">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô & OG</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm mb-1">Favicon</label>
                            <input id="faviconInput" type="file" accept="image/*" class="w-full p-2 bg-gray-800 rounded-lg">
                            <div id="faviconPreview" class="mt-2"></div>
                        </div>
                        <div>
                            <label class="block text-sm mb-1">OG Image</label>
                            <input id="ogImageInput" type="file" accept="image/*" class="w-full p-2 bg-gray-800 rounded-lg">
                            <div id="ogImagePreview" class="mt-2"></div>
                        </div>
                    </div>
                    <button id="save-meta-settings" class="mt-4 px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>

                <!-- Cloudinary settings card -->
                <div class="glass p-6 rounded-xl">
                    <h3 class="mb-4 font-semibold text-lg">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Cloudinary</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm mb-1" for="cloudName">Cloud Name</label>
                            <input id="cloudName" type="text" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô mycloud">
                        </div>
                        <div>
                            <label class="block text-sm mb-1" for="cloudApiKey">API Key</label>
                            <input id="cloudApiKey" type="text" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="API Key">
                        </div>
                        <div>
                            <label class="block text-sm mb-1" for="cloudApiSecret">API Secret</label>
                            <input id="cloudApiSecret" type="password" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="API Secret">
                        </div>
                        <div>
                            <label class="block text-sm mb-1" for="cloudUploadPreset">Upload Preset</label>
                            <input id="cloudUploadPreset" type="text" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="Upload preset">
                        </div>
                    </div>
                    <button id="save-cloudinary-settings" class="mt-4 px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>

                <!-- Facebook login settings card -->
                <div class="glass p-6 rounded-xl">
                    <h3 class="mb-4 font-semibold text-lg">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Facebook Login</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm mb-1" for="fbAppId">App ID</label>
                            <input id="fbAppId" type="text" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="Facebook App ID">
                        </div>
                        <div>
                            <label class="block text-sm mb-1" for="fbAppSecret">App Secret</label>
                            <input id="fbAppSecret" type="password" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="Facebook App Secret">
                        </div>
                        <div>
                            <label class="inline-flex items-center cursor-pointer">
                                <input id="enableFacebook" type="checkbox" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:bg-pink-500 relative transition-all">
                                    <span class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5"></span>
                                </div>
                                <span class="ml-3 text-sm">‡πÄ‡∏õ‡∏¥‡∏î Facebook Login</span>
                            </label>
                        </div>
                    </div>
                    <button id="save-facebook-settings" class="mt-4 px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>

                <!-- SMS settings card -->
                <div class="glass p-6 rounded-xl">
                    <h3 class="mb-4 font-semibold text-lg">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SMS (SMSKUB)</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm mb-1" for="smsApiKey">API Key</label>
                            <input id="smsApiKey" type="text" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="SMSKUB API Key">
                        </div>
                        <div>
                            <label class="block text-sm mb-1" for="smsSender">Sender Name/ID</label>
                            <input id="smsSender" type="text" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á SMS">
                        </div>
                        <div>
                            <label class="inline-flex items-center cursor-pointer">
                                <input id="enableSMS" type="checkbox" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:bg-pink-500 relative transition-all">
                                    <span class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5"></span>
                                </div>
                                <span class="ml-3 text-sm">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô SMS</span>
                            </label>
                        </div>
                    </div>
                    <button id="save-sms-settings" class="mt-4 px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </section>
        <!-- Logs section -->
        <section id="logs-section" class="section hidden">
            <h1 class="text-3xl font-bold mb-6">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h1>
            <div class="glass p-6 rounded-xl">
                <div class="flex items-center justify-between mb-4">
                    <input id="logSearch" type="text" class="w-1/2 p-2 bg-gray-800 rounded-lg" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...">
                    <button id="clearLogs" class="px-4 py-2 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700 text-sm">‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
                </div>
                <ul id="logList" class="space-y-4 max-h-96 overflow-y-auto pr-2"></ul>
            </div>
        </section>
    </div>

    <!-- Modal for adding/editing jobs -->
    <div id="jobModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black opacity-60"></div>
        <div class="glass p-6 w-full max-w-3xl mx-4 rounded-xl relative z-10">
            <h2 id="jobModalTitle" class="text-xl font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
            <form id="jobForm" class="space-y-4">
                <input type="hidden" id="jobId">
                <!-- Job name -->
                <div>
                    <label for="jobName" class="block text-sm mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label>
                    <input id="jobName" type="text" required class="w-full p-2 bg-gray-800 rounded-lg">
                </div>
                <!-- Start, end dates and team needed in one row -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="jobStartDate" class="block text-sm mb-1">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                        <input id="jobStartDate" type="date" required class="w-full p-2 bg-gray-800 rounded-lg">
                    </div>
                    <div>
                        <label for="jobEndDate" class="block text-sm mb-1">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                        <input id="jobEndDate" type="date" required class="w-full p-2 bg-gray-800 rounded-lg">
                    </div>
                    <div>
                        <label for="jobTeamNeeded" class="block text-sm mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</label>
                        <input id="jobTeamNeeded" type="number" min="0" step="1" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô">
                    </div>
                </div>
                <!-- Location, Income, Status in one row -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="jobLocation" class="block text-sm mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input id="jobLocation" type="text" required class="w-full p-2 bg-gray-800 rounded-lg">
                    </div>
                    <div>
                        <label for="jobIncome" class="block text-sm mb-1">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                        <input id="jobIncome" type="number" min="0" step="0.01" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)">
                    </div>
                    <div>
                        <label for="jobStatus" class="block text-sm mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                        <select id="jobStatus" class="w-full p-2 bg-gray-800 rounded-lg">
                            <option value="new">‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</option>
                            <option value="confirmed">‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏ü‡∏£‡∏¥‡∏°</option>
                            <option value="upcoming">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</option>
                            <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                            <option value="in_progress">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>
                            <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                            <option value="cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                        </select>
                    </div>
                </div>
                <!-- Team assignment section redesigned -->
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <label class="block text-sm">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô/‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô</label>
                        <button type="button" id="addTeamMemberBtn" class="px-3 py-1 text-sm font-semibold text-blue-500 hover:underline">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</button>
                    </div>
                    <div id="teamListContainer" class="space-y-4 max-h-64 overflow-y-auto"></div>
                    <!-- Predefined positions list for datalist -->
                    <datalist id="positionsList">
                        <option value="Switcher"></option>
                        <option value="Lowerthrid"></option>
                        <option value="Camera"></option>
                        <option value="Sound"></option>
                        <option value="Replay"></option>
                        <option value="Director"></option>
                        <option value="Support"></option>
                    </datalist>
                </div>
                <div class="flex items-center justify-end space-x-2 pt-2">
                    <button type="button" id="cancelJobBtn" class="px-3 py-2 text-sm font-semibold text-gray-200 bg-gray-600 rounded-lg hover:bg-gray-700">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="px-4 py-2 text-sm font-semibold text-white bg-gradient-to-r from-red-500 to-pink-500 rounded-lg hover:opacity-90">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for adding/editing users -->
    <div id="userModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black opacity-60"></div>
        <div class="glass p-6 w-full max-w-lg mx-4 rounded-xl relative z-10">
            <h2 id="userModalTitle" class="text-xl font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</h2>
            <form id="userForm" class="space-y-4">
                <input type="hidden" id="userId">
                <div>
                    <label for="username" class="block text-sm mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                    <input id="username" type="text" required class="w-full p-2 bg-gray-800 rounded-lg">
                </div>
                <div>
                    <label for="userEmail" class="block text-sm mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input id="userEmail" type="email" required class="w-full p-2 bg-gray-800 rounded-lg">
                </div>
                <div>
                    <label for="userRole" class="block text-sm mb-1">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                    <select id="userRole" class="w-full p-2 bg-gray-800 rounded-lg">
                        <option value="member">‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</option>
                        <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                    </select>
                </div>
                <!-- Profile picture upload -->
                <div>
                    <label class="block text-sm mb-1">‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
                    <div class="flex items-center space-x-4">
                        <img id="userProfilePreview" src="" alt="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå" class="w-16 h-16 rounded-full object-cover bg-gray-700">
                        <input id="userProfileInput" type="file" accept="image/*" class="w-full p-2 bg-gray-800 rounded-lg">
                    </div>
                </div>
                <!-- Additional user fields for nickname, phone and bank account -->
                <div>
                    <label for="userNickname" class="block text-sm mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                    <input id="userNickname" type="text" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ï‡πâ‡∏á">
                </div>
                <div>
                    <label for="userPhone" class="block text-sm mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <input id="userPhone" type="text" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678">
                </div>
                <div>
                    <label class="block text-sm mb-1">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
                    <div class="space-y-2">
                        <input id="userBankName" type="text" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">
                        <input id="userBank" type="text" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£">
                        <input id="userBankNumber" type="text" class="w-full p-2 bg-gray-800 rounded-lg" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">
                    </div>
                </div>
                <div class="flex items-center justify-end space-x-2 pt-2">
                    <button type="button" id="cancelUserBtn" class="px-3 py-2 text-sm font-semibold text-gray-200 bg-gray-600 rounded-lg hover:bg-gray-700">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="px-4 py-2 text-sm font-semibold text-white bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg hover:opacity-90">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast container for notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        /**
         * Firebase Configuration
         *
         * Replace the values below with your Firebase project's configuration.
         * You can find these values in your Firebase Console under
         * Project Settings -> General -> Your apps.
         */
        const firebaseConfig = {
            apiKey: "AIzaSyAedyGR43aEAO_BFufGmplJVuGkmIEYgG0",
            authDomain: "job-queue-app.firebaseapp.com",
            projectId: "job-queue-app",
            storageBucket: "job-queue-app.firebasestorage.app",
            messagingSenderId: "247047529613",
            appId: "1:247047529613:web:d27a980d1de33c22052ec4"
        };
        // Initialize Firebase app and Firestore
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Local cache for jobs and users
        let jobs = [];
        let users = [];
        let logs = [];
        // Application settings loaded from Firestore (shared with q.html)
        let appSettings = {};
        // Holds the current job being edited or created in the job modal
        let currentJobForModal = null;

        /**
         * Upload a file to Cloudinary using unsigned upload.
         * Requires appSettings.cloudinaryName and appSettings.cloudinaryPreset to be set.
         * Returns the secure URL of the uploaded image or null on failure.
         */
        async function uploadToCloudinary(file) {
            if (!file) return null;
            const cloudName = document.getElementById('cloudName').value || appSettings.cloudinaryName;
            const uploadPreset = document.getElementById('cloudUploadPreset').value || appSettings.cloudinaryPreset;
            if (!cloudName || !uploadPreset) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Cloudinary Cloud Name ‡πÅ‡∏•‡∏∞ Upload Preset ‡∏Å‡πà‡∏≠‡∏ô');
                return null;
            }

        /**
         * Display a toast notification.
         * @param {string} message The message to display.
         * @param {'success'|'error'} type Determines the color of the toast.
         */
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `px-4 py-2 rounded-lg shadow-md text-sm text-white ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            toast.textContent = message;
            container.appendChild(toast);
            // Trigger fade out after a delay
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 3000);
            // Remove from DOM after animation
            setTimeout(() => {
                if (toast.parentElement) toast.parentElement.removeChild(toast);
            }, 4000);
        }
            const url = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', uploadPreset);
            try {
                const response = await fetch(url, { method: 'POST', body: formData });
                const data = await response.json();
                if (data.secure_url) {
                    return data.secure_url;
                } else if (data.error) {
                    throw new Error(`Cloudinary: ${data.error.message}`);
                } else {
                    throw new Error('Unexpected error from Cloudinary');
                }
            } catch (error) {
                console.error('Cloudinary upload error:', error);
                alert(`‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`);
                return null;
            }
        }

        // Utility: format date to Thai locale
        function formatDate(dateStr) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateStr).toLocaleDateString('th-TH', options);
        }
        function statusLabel(status) {
            switch (status) {
                case 'new':
                    return '‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
                case 'upcoming':
                    return '‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ';
                case 'confirmed':
                    return '‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏ü‡∏£‡∏¥‡∏°';
                case 'pending':
                    return '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
                case 'in_progress':
                    return '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥';
                case 'completed':
                    return '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
                case 'cancelled':
                    return '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
                default:
                    return '';
            }
        }

        /**
         * Returns HTML markup for a status label with an icon using Phosphor icons.
         * Icons and colours are chosen based on the status. The returned string
         * should be inserted as innerHTML.
         *
         * @param {string} status
         * @returns {string}
         */
        function statusDisplay(status) {
            const label = statusLabel(status);
            // Define icon mapping
            const iconMap = {
                new: 'ph-star',
                upcoming: 'ph-calendar-check',
                confirmed: 'ph-check-circle',
                pending: 'ph-hourglass',
                in_progress: 'ph-spinner',
                completed: 'ph-check-circle',
                cancelled: 'ph-x-circle'
            };
            const icon = iconMap[status] || 'ph-dot';
            return `<span class="inline-flex items-center"><i class="${icon} mr-1"></i>${label}</span>`;
        }

        /**
         * Determine the appropriate status for a job based on current date,
         * creation time, and its existing status. This function does not
         * override explicit cancelled or completed statuses.
         *
         * @param {Object} job - job object with startDate, endDate, createdAt and status
         * @returns {string} new status string
         */
        function determineJobStatus(job) {
            // Preserve cancelled and completed statuses
            if (job.status === 'cancelled' || job.status === 'completed') {
                return job.status;
            }
            const now = new Date();
            // Convert strings to Date objects for comparison
            const start = job.startDate ? new Date(job.startDate) : null;
            const end = job.endDate ? new Date(job.endDate) : start;
            const created = job.createdAt ? new Date(job.createdAt) : null;
            // If job is newly created within last 3 days
            if (created) {
                const diffHours = (now.getTime() - created.getTime()) / (1000 * 60 * 60);
                if (diffHours < 72) {
                    return 'new';
                }
            }
            // Upcoming within next 7 days
            if (start && start > now) {
                const diffDays = (start.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);
                if (diffDays <= 7) {
                    return 'upcoming';
                }
                // Otherwise, confirmed if not new
                return 'confirmed';
            }
            // Currently in progress
            if (start && end && now >= start && now <= end) {
                return 'in_progress';
            }
            // Past jobs that are not completed or cancelled
            if (end && now > end) {
                return 'pending';
            }
            // Default to confirmed
            return 'confirmed';
        }

        /**
         * Iterate through jobs and update their status in Firestore if the
         * automatically determined status differs from the stored status.
         */
        async function updateJobStatuses() {
            const updates = [];
            jobs.forEach(job => {
                const newStatus = determineJobStatus(job);
                if (newStatus && newStatus !== job.status) {
                    // Update local object for immediate UI refresh
                    job.status = newStatus;
                    // Push Firestore update promise
                    updates.push(db.collection('jobs').doc(job.id).update({ status: newStatus }));
                }
            });
            if (updates.length > 0) {
                try {
                    await Promise.all(updates);
                } catch (err) {
                    console.error('Error updating job statuses:', err);
                }
            }
        }

        /**
         * Update the admin profile display in the sidebar using the authenticated
         * user's information. The function attempts to find the user in the
         * loaded `users` array by matching email or UID and then updates
         * the avatar, name and role labels. If no matching record is found,
         * fallback values are used.
         */
        function updateAdminSidebar() {
            const avatarEl = document.getElementById('admin-avatar');
            const nameEl = document.getElementById('admin-name');
            const roleEl = document.getElementById('admin-role');
            const authUser = auth.currentUser;
            if (!authUser || !avatarEl || !nameEl || !roleEl) return;
            let adminUser = null;
            // Try to find user by UID first
            if (Array.isArray(users) && users.length > 0) {
                adminUser = users.find(u => u.id === authUser.uid);
                // Fallback: match by email
                if (!adminUser) {
                    adminUser = users.find(u => u.email === authUser.email);
                }
            }
            // Default values
            let avatarUrl = 'https://placehold.co/40x40/374151/9ca3af?text=üë§';
            let displayName = authUser.email || '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô';
            let roleLabel = 'Admin';
            if (adminUser) {
                avatarUrl = adminUser.profilePic || adminUser.profilePicture || adminUser.photoURL || adminUser.photoUrl || avatarUrl;
                displayName = adminUser.username || adminUser.displayName || adminUser.name || displayName;
                roleLabel = adminUser.role === 'admin' ? '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•' : '‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô';
            }
            avatarEl.src = avatarUrl || avatarEl.src;
            nameEl.textContent = displayName;
            roleEl.textContent = roleLabel;
        }
        // Sidebar navigation handling
        const navButtons = document.querySelectorAll('aside nav button');
        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                // Hide all sections
                document.querySelectorAll('.section').forEach(sec => sec.classList.add('hidden'));
                // Show selected
                const sectionId = btn.getAttribute('data-section');
                document.getElementById(sectionId + '-section').classList.remove('hidden');
                // Highlight active button
                navButtons.forEach(b => {
                    b.classList.remove('bg-gray-800', 'active');
                });
                btn.classList.add('bg-gray-800', 'active');
            });
        });
        // Dashboard metrics update
        function updateDashboardMetrics() {
            // Basic counts
            document.getElementById('total-jobs').textContent = jobs.length;
            document.getElementById('pending-jobs').textContent = jobs.filter(j => j.status === 'pending').length;
            document.getElementById('completed-jobs').textContent = jobs.filter(j => j.status === 'completed').length;
            document.getElementById('team-count').textContent = users.length;
            // Status counts for summary cards and monthly chart
            const statusOrder = ['new','upcoming','confirmed','pending','in_progress','completed','cancelled'];
            const statusCounts = {};
            // monthlyAmounts will accumulate income amounts per status per month rather than counts
            const monthlyAmounts = {};
            statusOrder.forEach(s => {
                statusCounts[s] = 0;
                monthlyAmounts[s] = new Array(12).fill(0);
            });
            jobs.forEach(job => {
                const status = job.status || '';
                if (statusCounts.hasOwnProperty(status)) {
                    statusCounts[status]++;
                    // Determine month index from startDate or date or createdAt
                    let dateStr = job.startDate || job.date || job.endDate || job.createdAt;
                    const income = Number(job.income) || 0;
                    if (dateStr) {
                        const d = new Date(dateStr);
                        if (!isNaN(d)) {
                            const m = d.getMonth();
                            // accumulate income for this status and month
                            monthlyAmounts[status][m] += income;
                        }
                    }
                }
            });
            // Render status summary cards
            const statusStyles = {
                new: { label: '‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà', icon: 'ph-star', color: 'from-yellow-400 to-yellow-600' },
                upcoming: { label: '‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ', icon: 'ph-calendar-check', color: 'from-blue-400 to-blue-600' },
                confirmed: { label: '‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏ü‡∏£‡∏¥‡∏°', icon: 'ph-check-circle', color: 'from-green-500 to-emerald-600' },
                pending: { label: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', icon: 'ph-hourglass', color: 'from-orange-400 to-yellow-500' },
                in_progress: { label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥', icon: 'ph-spinner', color: 'from-purple-500 to-fuchsia-600' },
                completed: { label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', icon: 'ph-check-circle', color: 'from-emerald-500 to-teal-600' },
                cancelled: { label: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', icon: 'ph-x-circle', color: 'from-red-500 to-pink-500' }
            };
            const statusCardsContainer = document.getElementById('status-summary-cards');
            if (statusCardsContainer) {
                let html = '';
                statusOrder.forEach(s => {
                    // Skip duplicate statuses that already appear in the top metrics cards and "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥"
                    if (s === 'pending' || s === 'completed' || s === 'in_progress') return;
                    const cfg = statusStyles[s];
                    if (!cfg) return;
                    html += `
                    <div class="glass p-4 flex items-center space-x-4">
                        <div class="p-3 rounded-lg bg-gradient-to-br ${cfg.color} text-white">
                            <i class="${cfg.icon} text-lg"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">${cfg.label}</p>
                            <h3 class="text-2xl font-semibold">${statusCounts[s] || 0}</h3>
                        </div>
                    </div>`;
                });
                statusCardsContainer.innerHTML = html;
            }
            // Update jobs status chart with monthly data
            if (jobsStatusChart) {
                const months = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
                jobsStatusChart.data.labels = months;
                // Define colours for chart (border and background)
                const colourMap = {
                    new: { border: '#fbbf24', bg: 'rgba(251,191,36,0.2)' },
                    upcoming: { border: '#3b82f6', bg: 'rgba(59,130,246,0.2)' },
                    confirmed: { border: '#22c55e', bg: 'rgba(34,197,94,0.2)' },
                    pending: { border: '#f59e0b', bg: 'rgba(245,158,11,0.2)' },
                    in_progress: { border: '#a855f7', bg: 'rgba(168,85,247,0.2)' },
                    completed: { border: '#10b981', bg: 'rgba(16,185,129,0.2)' },
                    cancelled: { border: '#ef4444', bg: 'rgba(239,68,68,0.2)' }
                };
                // Build datasets excluding in_progress to remove its purple series from the chart
                const datasets = [];
                statusOrder.forEach(s => {
                    if (s === 'in_progress') return;
                    const amounts = monthlyAmounts[s];
                    const colours = colourMap[s];
                    datasets.push({
                        label: statusLabel(s),
                        data: amounts,
                        borderColor: colours.border,
                        backgroundColor: colours.bg,
                        tension: 0.4
                    });
                });
                jobsStatusChart.data.datasets = datasets;
                jobsStatusChart.update();
            }
            // Financial summary calculations
            let totalRevenue = 0;
            let totalExpenses = 0;
            let totalWagesPaid = 0;
            let totalWagesUnpaid = 0;
            let totalWHT = 0;
            let totalVAT = 0;
            const whtDefaultPercent = (appSettings && typeof appSettings.whtPercent !== 'undefined') ? appSettings.whtPercent : 0;
            jobs.forEach(job => {
                const income = Number(job.income) || 0;
                totalRevenue += income;
                // Sum wages and determine paid/unpaid
                let jobWages = 0;
                let jobPaid = 0;
                let jobUnpaid = 0;
                if (Array.isArray(job.team)) {
                    job.team.forEach(member => {
                        // Calculate wage for member: dailyRate * workdays with overrides
                        let memberWage = 0;
                        if (Array.isArray(member.workdays)) {
                            member.workdays.forEach(day => {
                                let rate = 0;
                                if (member.dailyOverrides && member.dailyOverrides.hasOwnProperty(day)) {
                                    rate = Number(member.dailyOverrides[day]) || 0;
                                } else {
                                    rate = Number(member.dailyRate) || 0;
                                }
                                memberWage += rate;
                            });
                        }
                        jobWages += memberWage;
                        if (member.isPaid) {
                            jobPaid += memberWage;
                        } else {
                            jobUnpaid += memberWage;
                        }
                    });
                }
                totalWagesPaid += jobPaid;
                totalWagesUnpaid += jobUnpaid;
                // Sum other expenses
                let jobExpenses = 0;
                if (Array.isArray(job.expenses)) {
                    job.expenses.forEach(exp => {
                        jobExpenses += Number(exp.amount) || 0;
                    });
                }
                totalExpenses += jobWages + jobExpenses;
                // Withholding tax (WHT)
                const whtEnabled = job.whtEnabled;
                if (whtEnabled) {
                    const whtPercent = (typeof job.whtPercent !== 'undefined') ? job.whtPercent : whtDefaultPercent;
                    totalWHT += income * (whtPercent / 100);
                }
                // VAT (assumed 7%)
                const vatEnabled = job.vatEnabled;
                if (vatEnabled) {
                    totalVAT += income * 0.07;
                }
            });
            const profitLoss = totalRevenue - totalExpenses - totalWHT - totalVAT;
            // Update DOM
            const formatCurrency = (val) => {
                return (val || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‡∏ö‡∏≤‡∏ó';
            };
            if (document.getElementById('total-revenue')) document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);
            if (document.getElementById('total-expenses')) document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
            if (document.getElementById('profit-loss')) document.getElementById('profit-loss').textContent = formatCurrency(profitLoss);
            if (document.getElementById('wages-paid')) document.getElementById('wages-paid').textContent = formatCurrency(totalWagesPaid);
            if (document.getElementById('wages-unpaid')) document.getElementById('wages-unpaid').textContent = formatCurrency(totalWagesUnpaid);
            if (document.getElementById('total-wht')) document.getElementById('total-wht').textContent = totalWHT.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (document.getElementById('total-vat')) document.getElementById('total-vat').textContent = totalVAT.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // Update finance chart (‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö VS ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ VS ‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô)
            if (financeChart) {
                financeChart.data.datasets[0].data = [totalRevenue, totalExpenses, profitLoss];
                financeChart.update();
            }
        }
        // Render jobs table
        function renderJobs() {
            const tbody = document.getElementById('jobs-table-body');
            tbody.innerHTML = '';
            jobs.forEach(job => {
                const tr = document.createElement('tr');
                // Apply text colours instead of background highlighting
                if (job.status === 'completed') {
                    // Green text for completed jobs
                    tr.style.color = '#4ade80'; // emerald‚Äë400
                } else if (job.status === 'pending') {
                    // Lighter orange text for past jobs
                    tr.style.color = '#fdba74'; // orange‚Äë300
                }
                // Format date range in Thai short form (e.g., 18-21 ‡∏Å.‡∏¢. 2568)
                let dateDisplay = '';
                const monthsThai = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
                function toThaiDate(d) {
                    if (!d || isNaN(d)) return '';
                    const day = String(d.getDate());
                    const monthName = monthsThai[d.getMonth()];
                    const year = d.getFullYear() + 543;
                    return `${day} ${monthName} ${year}`;
                }
                function toThaiRange(start, end) {
                    if (!start || !end || isNaN(start) || isNaN(end)) return '';
                    const sDay = String(start.getDate());
                    const eDay = String(end.getDate());
                    const monthName = monthsThai[start.getMonth()];
                    const year = start.getFullYear() + 543;
                    return `${sDay}-${eDay} ${monthName} ${year}`;
                }
                if (job.startDate && job.endDate) {
                    const start = (typeof job.startDate === 'object' && job.startDate.toDate) ? job.startDate.toDate() : new Date(job.startDate);
                    const end = (typeof job.endDate === 'object' && job.endDate.toDate) ? job.endDate.toDate() : new Date(job.endDate);
                    if (start && end && start.getTime() === end.getTime()) {
                        // Single day: display a single date (e.g., 6 ‡∏Å.‡∏¢. 2568)
                        dateDisplay = toThaiDate(start);
                    } else if (start && end && start.getMonth() === end.getMonth() && start.getFullYear() === end.getFullYear()) {
                        // Same month & year: use range format (e.g., 18-21 ‡∏Å.‡∏¢. 2568)
                        dateDisplay = toThaiRange(start, end);
                    } else {
                        // Different months/years: show full range
                        dateDisplay = `${toThaiDate(start)} - ${toThaiDate(end)}`;
                    }
                } else if (job.startDate) {
                    const start = (typeof job.startDate === 'object' && job.startDate.toDate) ? job.startDate.toDate() : new Date(job.startDate);
                    dateDisplay = toThaiDate(start);
                } else if (job.date) {
                    const d = (typeof job.date === 'object' && job.date.toDate) ? job.date.toDate() : new Date(job.date);
                    dateDisplay = toThaiDate(d);
                }
                // Income display (‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì)
                const incomeDisplay = (job.income !== undefined && job.income !== null && job.income !== '')
                    ? (Number(job.income).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‡∏ö‡∏≤‡∏ó')
                    : '-';
                // Team count and avatars
                let teamCount = 0;
                let teamNeeded = job.teamNeeded || 0;
                let avatarsHTML = '';
                if (Array.isArray(job.team)) {
                    teamCount = job.team.length;
                    // Generate avatars for all members
                    const avatarImgs = [];
                    job.team.forEach(member => {
                        // Attempt to derive avatar URL from member object or users array
                        let avatar = '';
                        if (member.profilePic || member.photoURL || member.photoUrl || member.avatar) {
                            avatar = member.profilePic || member.photoURL || member.photoUrl || member.avatar;
                        } else if (member.userId) {
                            const userObj = users.find(u => (u.id === member.userId) || (u.userId === member.userId) || (u.uid === member.userId));
                            if (userObj) {
                                avatar = userObj.profilePic || userObj.profilePicture || userObj.photoURL || userObj.photoUrl || '';
                            }
                        }
                        if (avatar) {
                            avatarImgs.push(`<img src="${avatar}" alt="‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô" class="w-6 h-6 rounded-full object-cover border-2 border-gray-800">`);
                        }
                    });
                    // Stack all avatars with negative margin (no limit)
                    avatarsHTML = `<div class="flex -space-x-2">${avatarImgs.join('')}</div>`;
                }
                // Compose team count display: assigned/needed with remaining indicator
                const remaining = Math.max(teamNeeded - teamCount, 0);
                let teamInfo;
                if (teamNeeded) {
                    if (remaining === 0) {
                        // Team is full: show ratio followed by completion label
                        teamInfo = `${teamCount}/${teamNeeded} ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß`;
                    } else {
                        teamInfo = `${teamCount}/${teamNeeded} (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remaining})`;
                    }
                } else {
                    // If no team needed specified, show current count
                    teamInfo = `${teamCount}`;
                }
                // Status display with icon
                const statusHTML = statusDisplay(job.status);
                tr.innerHTML = `
                    <td class="px-6 py-4">${job.name || ''}</td>
                    <td class="px-6 py-4">${dateDisplay}</td>
                    <td class="px-6 py-4">${job.location || ''}</td>
                    <td class="px-6 py-4">${incomeDisplay}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-2">
                            <span>${teamInfo}</span>
                            ${avatarsHTML}
                        </div>
                    </td>
                    <td class="px-6 py-4 capitalize">${statusHTML}</td>
                    <td class="px-6 py-4 text-right space-x-2">
                        <button class="edit-job px-3 py-1 bg-blue-600 text-white rounded-lg text-xs hover:bg-blue-700" data-id="${job.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button class="delete-job px-3 py-1 bg-red-600 text-white rounded-lg text-xs hover:bg-red-700" data-id="${job.id}">‡∏•‡∏ö</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        // Render users table
        function renderUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            users.forEach(user => {
                const tr = document.createElement('tr');
                // Determine display names and profile image
                const displayName = user.username || user.displayName || user.name || '';
                const nickname = user.nickname || '';
                const phone = user.phone || user.phoneNumber || '';
                // Determine bank account display
                let bankDisplay = '-';
                if (user.bankAccount) {
                    const { name: accName = '', bank: bankName = '', number: accNumber = '' } = user.bankAccount;
                    if (accName || bankName || accNumber) {
                        bankDisplay = `${accName || '-'}${bankName ? ' (' + bankName + ')' : ''} ${accNumber || ''}`.trim();
                    }
                }
                // Determine profile picture: check multiple possible fields
                const photo = user.profilePic || user.profilePicture || user.photoURL || user.photoUrl || user.avatar || '';
                const roleLabel = user.role === 'admin' ? '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•' : '‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô';
                tr.innerHTML = `
                    <td class="px-6 py-4">
                        ${photo ? `<img src="${photo}" alt="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå" class="w-8 h-8 rounded-full object-cover">` : '<div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-sm">üë§</div>'}
                    </td>
                    <td class="px-6 py-4">${displayName}</td>
                    <td class="px-6 py-4">${user.email || ''}</td>
                    <td class="px-6 py-4">${nickname || '-'}</td>
                    <td class="px-6 py-4">${phone || '-'}</td>
                    <td class="px-6 py-4">${bankDisplay}</td>
                    <td class="px-6 py-4 capitalize">${roleLabel}</td>
                    <td class="px-6 py-4 text-right space-x-2">
                        <button class="edit-user px-3 py-1 bg-blue-600 text-white rounded-lg text-xs hover:bg-blue-700" data-id="${user.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button class="delete-user px-3 py-1 bg-red-600 text-white rounded-lg text-xs hover:bg-red-700" data-id="${user.id}">‡∏•‡∏ö</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        // Render logs list
        function renderLogs() {
            const list = document.getElementById('logList');
            list.innerHTML = '';
            logs.slice().reverse().forEach(log => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 bg-gray-800 rounded-lg';
                li.innerHTML = `<span>${log.message}</span><span class="text-xs text-gray-400">${new Date(log.date).toLocaleString('th-TH')}</span>`;
                list.appendChild(li);
            });
        }
        // Charts initialization (dummy data for demonstration)
        let jobsStatusChart, financeChart, financeSummaryChart;
        function initCharts() {
            if (jobsStatusChart) jobsStatusChart.destroy();
            if (financeChart) financeChart.destroy();
            if (financeSummaryChart) financeSummaryChart.destroy();
            const months = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
            const ctx1 = document.getElementById('jobsStatusChart').getContext('2d');
            // Initialize jobsStatusChart with no datasets; real data will be injected in updateDashboardMetrics()
            jobsStatusChart = new Chart(ctx1, {
                type: 'line',
                data: { labels: months, datasets: [] },
                options: {
                    plugins: { legend: { labels: { color: '#f1f5f9' } } },
                    scales: { x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.1)' } }, y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.1)' } } }
                }
            });
            const ctx2 = document.getElementById('financeChart').getContext('2d');
            // Bar chart summarizing total revenue, expenses and profit/loss
            financeChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö','‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢','‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô'],
                    datasets: [
                        { label: '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ (‡∏ö‡∏≤‡∏ó)', data: [0,0,0], backgroundColor: ['#3b82f6','#ef4444','#10b981'] }
                    ]
                },
                options: {
                    plugins: { legend: { labels: { color: '#f1f5f9' } } },
                    scales: {
                        x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
            const ctx3 = document.getElementById('financeSummaryChart').getContext('2d');
            financeSummaryChart = new Chart(ctx3, {
                type: 'pie',
                data: { labels: ['‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö','‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢','‡∏Å‡∏≥‡πÑ‡∏£'], datasets: [{ data: [200000,150000,50000], backgroundColor: ['#3b82f6','#ef4444','#10b981'] }] },
                options: { plugins: { legend: { labels: { color: '#f1f5f9' } } } }
            });
        }

        // Fetch jobs from Firestore
        async function loadJobs() {
            try {
                const snapshot = await db.collection('jobs').get();
                jobs = snapshot.docs.map(doc => {
                    const data = doc.data();
                    // Convert date fields from Firestore Timestamp to ISO strings
                    let date = data.date;
                    if (date && typeof date.toDate === 'function') {
                        const jsDate = date.toDate();
                        const year = jsDate.getFullYear();
                        const month = String(jsDate.getMonth() + 1).padStart(2, '0');
                        const day = String(jsDate.getDate()).padStart(2, '0');
                        date = `${year}-${month}-${day}`;
                    }
                    let startDate = data.startDate;
                    if (startDate && typeof startDate.toDate === 'function') {
                        const jsDate = startDate.toDate();
                        const year = jsDate.getFullYear();
                        const month = String(jsDate.getMonth() + 1).padStart(2, '0');
                        const day = String(jsDate.getDate()).padStart(2, '0');
                        startDate = `${year}-${month}-${day}`;
                    }
                    let endDate = data.endDate;
                    if (endDate && typeof endDate.toDate === 'function') {
                        const jsDate = endDate.toDate();
                        const year = jsDate.getFullYear();
                        const month = String(jsDate.getMonth() + 1).padStart(2, '0');
                        const day = String(jsDate.getDate()).padStart(2, '0');
                        endDate = `${year}-${month}-${day}`;
                    }
                    // Convert createdAt to ISO string
                    let createdAt = data.createdAt;
                    if (createdAt && typeof createdAt.toDate === 'function') {
                        createdAt = createdAt.toDate().toISOString();
                    }
                    // Ensure income is number
                    const income = (typeof data.income !== 'undefined' && data.income !== null) ? Number(data.income) : null;
                    const teamNeeded = (typeof data.teamNeeded !== 'undefined' && data.teamNeeded !== null) ? Number(data.teamNeeded) : 0;
                    return { id: doc.id, ...data, date, startDate, endDate, createdAt, income, teamNeeded };
                });
                // Update job statuses based on dates
                await updateJobStatuses();
                // Sort jobs so that the oldest jobs appear last (descending by start date)
                jobs.sort((a, b) => {
                    const aDate = new Date(a.startDate || a.date || a.endDate || 0);
                    const bDate = new Date(b.startDate || b.date || b.endDate || 0);
                    return bDate - aDate;
                });
                renderJobs();
                updateDashboardMetrics();
            } catch (err) {
                console.error('Error loading jobs:', err);
            }
        }
        // Fetch users from Firestore
        async function loadUsers() {
            try {
                const snapshot = await db.collection('users').get();
                users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUsers();
                updateDashboardMetrics();
            } catch (err) {
                console.error('Error loading users:', err);
            }
        }

        // Load application settings from Firestore and populate inputs
        async function loadSettings() {
            try {
                const docRef = db.collection('settings').doc('app-config');
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    appSettings = { ...appSettings, ...docSnap.data() };
                }
                // Populate inputs
                // Favicon & OG previews
                if (appSettings.faviconUrl) {
                    document.getElementById('faviconPreview').innerHTML = `<img src="${appSettings.faviconUrl}" alt="favicon" class="h-12">`;
                }
                if (appSettings.ogImageUrl) {
                    document.getElementById('ogImagePreview').innerHTML = `<img src="${appSettings.ogImageUrl}" alt="og" class="h-20">`;
                }
                // Update page favicon if available
                const favLinkEl = document.getElementById('dynamic-favicon');
                if (favLinkEl && appSettings.faviconUrl) {
                    favLinkEl.href = appSettings.faviconUrl;
                }
                // Cloudinary
                if (appSettings.cloudinaryName) document.getElementById('cloudName').value = appSettings.cloudinaryName;
                if (appSettings.cloudinaryPreset) document.getElementById('cloudUploadPreset').value = appSettings.cloudinaryPreset;
                // Facebook
                if (appSettings.facebookAppId) document.getElementById('fbAppId').value = appSettings.facebookAppId;
                if (appSettings.facebookAppSecret) document.getElementById('fbAppSecret').value = appSettings.facebookAppSecret;
                if (typeof appSettings.isFacebookLoginEnabled !== 'undefined') document.getElementById('enableFacebook').checked = appSettings.isFacebookLoginEnabled;
                // SMS
                if (appSettings.smsKubApiKey) document.getElementById('smsApiKey').value = appSettings.smsKubApiKey;
                if (appSettings.smsSenderName) document.getElementById('smsSender').value = appSettings.smsSenderName;
                if (typeof appSettings.isSmsEnabled !== 'undefined') document.getElementById('enableSMS').checked = appSettings.isSmsEnabled;

                // Recalculate dashboard metrics after settings load (WHT percent may affect calculations)
                updateDashboardMetrics();
            } catch (err) {
                console.error('Error loading settings:', err);
            }
        }

        // Event handlers for Jobs
        document.getElementById('add-job').addEventListener('click', () => openJobModal());
        document.getElementById('cancelJobBtn').addEventListener('click', closeJobModal);
        document.getElementById('jobForm').addEventListener('submit', submitJobForm);
        document.getElementById('jobs-table-body').addEventListener('click', function(e) {
            if (e.target.classList.contains('edit-job')) {
                const id = e.target.getAttribute('data-id');
                openJobModal(id);
            } else if (e.target.classList.contains('delete-job')) {
                const id = e.target.getAttribute('data-id');
                if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    deleteJob(id);
                }
            }
        });
        function openJobModal(id) {
            const modal = document.getElementById('jobModal');
            modal.classList.remove('hidden');
            // Determine job context
            let job = null;
            if (id) {
                job = jobs.find(j => j.id === id) || null;
                currentJobForModal = job;
                // Populate form fields for editing
                document.getElementById('jobModalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô';
                document.getElementById('jobId').value = job?.id || '';
                document.getElementById('jobName').value = job?.name || '';
                document.getElementById('jobStartDate').value = job?.startDate || job?.date || '';
                document.getElementById('jobEndDate').value = job?.endDate || job?.date || '';
                document.getElementById('jobLocation').value = job?.location || '';
                document.getElementById('jobStatus').value = job?.status || 'pending';
                document.getElementById('jobIncome').value = job?.income || '';
                document.getElementById('jobTeamNeeded').value = job?.teamNeeded != null ? job.teamNeeded : '';
            } else {
                currentJobForModal = null;
                document.getElementById('jobModalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
                document.getElementById('jobId').value = '';
                // Reset form fields
                document.getElementById('jobForm').reset();
                document.getElementById('jobStartDate').value = '';
                document.getElementById('jobEndDate').value = '';
                document.getElementById('jobIncome').value = '';
                document.getElementById('jobStatus').value = 'new';
                document.getElementById('jobTeamNeeded').value = '';
            }
            // Initialize team member rows with existing assignments
            initializeTeamRows(currentJobForModal);
        }
        function closeJobModal() {
            document.getElementById('jobModal').classList.add('hidden');
        }
        async function submitJobForm(e) {
            e.preventDefault();
            const id = document.getElementById('jobId').value;
            const data = {
                name: document.getElementById('jobName').value,
                startDate: document.getElementById('jobStartDate').value,
                endDate: document.getElementById('jobEndDate').value,
                location: document.getElementById('jobLocation').value,
                status: document.getElementById('jobStatus').value,
                income: document.getElementById('jobIncome').value ? Number(document.getElementById('jobIncome').value) : null,
                teamNeeded: document.getElementById('jobTeamNeeded').value ? Number(document.getElementById('jobTeamNeeded').value) : null
            };

            // Gather team assignments from schedule table
            const assignments = collectTeamAssignments();
            data.team = assignments;
            const submitBtn = document.querySelector('#jobForm button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            try {
                if (id) {
                    await db.collection('jobs').doc(id).update(data);
                    logs.push({ message: `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô: ${data.name}`, date: new Date() });
                    showToast(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô ${data.name} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                } else {
                    // Set creation timestamp for new jobs
                    data.createdAt = new Date().toISOString();
                    await db.collection('jobs').add(data);
                    logs.push({ message: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô: ${data.name}`, date: new Date() });
                    showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô ${data.name} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                }
                closeJobModal();
                await loadJobs();
                renderLogs();
            } catch (err) {
                console.error('Error saving job:', err);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô: ' + err.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        async function deleteJob(id) {
            try {
                await db.collection('jobs').doc(id).delete();
                logs.push({ message: `‡∏•‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô: ${id}`, date: new Date() });
                showToast(`‡∏•‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô ${id} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                await loadJobs();
                renderLogs();
            } catch (err) {
                console.error('Error deleting job:', err);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô: ' + err.message, 'error');
            }
        }

        // Event handlers for Users
        document.getElementById('add-user').addEventListener('click', () => openUserModal());
        document.getElementById('cancelUserBtn').addEventListener('click', closeUserModal);
        document.getElementById('userForm').addEventListener('submit', submitUserForm);
        document.getElementById('users-table-body').addEventListener('click', function(e) {
            if (e.target.classList.contains('edit-user')) {
                const id = e.target.getAttribute('data-id');
                openUserModal(id);
            } else if (e.target.classList.contains('delete-user')) {
                const id = e.target.getAttribute('data-id');
                if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    deleteUser(id);
                }
            }
        });
        function openUserModal(id) {
            const modal = document.getElementById('userModal');
            modal.classList.remove('hidden');
            if (id) {
                const user = users.find(u => u.id === id);
                document.getElementById('userModalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
                document.getElementById('userId').value = user.id;
                // Use whichever name field is available
                document.getElementById('username').value = user.username || user.displayName || user.name || '';
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userRole').value = user.role;
                // Populate additional fields
                document.getElementById('userNickname').value = user.nickname || '';
                document.getElementById('userPhone').value = user.phone || user.phoneNumber || '';
                const bank = user.bankAccount || {};
                document.getElementById('userBankName').value = bank.name || '';
                document.getElementById('userBank').value = bank.bank || '';
                document.getElementById('userBankNumber').value = bank.number || '';
                // Set profile picture preview
                const previewImg = document.getElementById('userProfilePreview');
                const photoUrl = user.profilePic || user.profilePicture || user.photoURL || user.photoUrl || '';
                previewImg.src = photoUrl || 'https://placehold.co/64x64/374151/9ca3af?text=üë§';
                // Clear file input
                document.getElementById('userProfileInput').value = '';
            } else {
                document.getElementById('userModalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà';
                document.getElementById('userId').value = '';
                document.getElementById('userForm').reset();
                // Clear additional fields explicitly (as reset might not reset non-form controls)
                document.getElementById('userNickname').value = '';
                document.getElementById('userPhone').value = '';
                document.getElementById('userBankName').value = '';
                document.getElementById('userBank').value = '';
                document.getElementById('userBankNumber').value = '';
                // Set default profile picture preview and clear input
                const previewImg = document.getElementById('userProfilePreview');
                previewImg.src = 'https://placehold.co/64x64/374151/9ca3af?text=üë§';
                document.getElementById('userProfileInput').value = '';
            }
        }
        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
        }
        async function submitUserForm(e) {
            e.preventDefault();
            const id = document.getElementById('userId').value;
            // Determine profile picture: either existing or uploaded
            const profileFile = document.getElementById('userProfileInput').files[0];
            let profileUrl = '';
            if (id) {
                const existing = users.find(u => u.id === id);
                if (existing) {
                    profileUrl = existing.profilePic || existing.profilePicture || existing.photoURL || existing.photoUrl || '';
                }
            }
            if (profileFile) {
                const uploaded = await uploadToCloudinary(profileFile);
                if (uploaded) profileUrl = uploaded;
            }
            const data = {
                username: document.getElementById('username').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value,
                nickname: document.getElementById('userNickname').value || '',
                phone: document.getElementById('userPhone').value || '',
                bankAccount: {
                    name: document.getElementById('userBankName').value || '',
                    bank: document.getElementById('userBank').value || '',
                    number: document.getElementById('userBankNumber').value || ''
                },
                profilePic: profileUrl
            };
            try {
                if (id) {
                    await db.collection('users').doc(id).update(data);
                    logs.push({ message: `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${data.username}`, date: new Date() });
                    showToast(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ${data.username} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                } else {
                    await db.collection('users').add(data);
                    logs.push({ message: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${data.username}`, date: new Date() });
                    showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ${data.username} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                }
                closeUserModal();
                await loadUsers();
                renderLogs();
            } catch (err) {
                console.error('Error saving user:', err);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ' + err.message, 'error');
            }
        }
        async function deleteUser(id) {
            try {
                await db.collection('users').doc(id).delete();
                logs.push({ message: `‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${id}`, date: new Date() });
                showToast(`‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ${id} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                await loadUsers();
                renderLogs();
            } catch (err) {
                console.error('Error deleting user:', err);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ' + err.message, 'error');
            }
        }

        // Save settings event handlers
        document.getElementById('save-tax-settings').addEventListener('click', () => {
            const wht = document.getElementById('whtRate').value;
            const vat = document.getElementById('vatRate').value;
            const currency = document.getElementById('currencySelect').value;
            logs.push({ message: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏©‡∏µ: WHT ${wht}%, VAT ${vat}%, ‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô ${currency}`, date: new Date() });
            renderLogs();
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        });
        document.getElementById('save-general-settings').addEventListener('click', () => {
            const name = document.getElementById('companyName').value;
            const color = document.getElementById('primaryColor').value;
            logs.push({ message: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö: ‡∏ä‡∏∑‡πà‡∏≠ ${name}, ‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å ${color}`, date: new Date() });
            renderLogs();
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        });
        document.getElementById('save-notification-settings').addEventListener('click', () => {
            const email = document.getElementById('emailNotifications').value;
            const token = document.getElementById('lineToken').value;
            const emailEnabled = document.getElementById('enableEmail').checked;
            const lineEnabled = document.getElementById('enableLine').checked;
            logs.push({ message: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: Email ${emailEnabled ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}, LINE ${lineEnabled ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}`, date: new Date() });
            renderLogs();
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        });
        // Logo preview
        document.getElementById('logoInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    document.getElementById('logoPreview').innerHTML = `<img src="${ev.target.result}" alt="Logo preview" class="h-20">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // Favicon and OG preview
        document.getElementById('faviconInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    document.getElementById('faviconPreview').innerHTML = `<img src="${ev.target.result}" alt="Favicon preview" class="h-12">`;
                };
                reader.readAsDataURL(file);
            }
        });
        document.getElementById('ogImageInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    document.getElementById('ogImagePreview').innerHTML = `<img src="${ev.target.result}" alt="OG preview" class="h-20">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // User profile picture preview
        document.getElementById('userProfileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const previewImg = document.getElementById('userProfilePreview');
            if (file && previewImg) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    previewImg.src = ev.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Save metadata settings
        document.getElementById('save-meta-settings').addEventListener('click', async () => {
            const btn = document.getElementById('save-meta-settings');
            btn.disabled = true;
            const original = btn.textContent;
            btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            try {
                const faviconFile = document.getElementById('faviconInput').files[0];
                const ogFile = document.getElementById('ogImageInput').files[0];
                let faviconUrl = appSettings.faviconUrl || '';
                let ogUrl = appSettings.ogImageUrl || '';
                if (faviconFile) {
                    const uploaded = await uploadToCloudinary(faviconFile);
                    if (uploaded) faviconUrl = uploaded;
                }
                if (ogFile) {
                    const uploaded = await uploadToCloudinary(ogFile);
                    if (uploaded) ogUrl = uploaded;
                }
                await db.collection('settings').doc('app-config').set({ faviconUrl: faviconUrl, ogImageUrl: ogUrl }, { merge: true });
                appSettings.faviconUrl = faviconUrl;
                appSettings.ogImageUrl = ogUrl;
                logs.push({ message: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Favicon & OG Image', date: new Date() });
                renderLogs();
                // Update favicon link immediately
                const favLinkEl = document.getElementById('dynamic-favicon');
                if (favLinkEl) favLinkEl.href = faviconUrl;
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏û‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞ OG ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (err) {
                console.error('Error saving meta settings:', err);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞ OG: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = original;
            }
        });
        // Save Cloudinary settings
        document.getElementById('save-cloudinary-settings').addEventListener('click', async () => {
            const btn = document.getElementById('save-cloudinary-settings');
            btn.disabled = true;
            const original = btn.textContent;
            btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            const cloudName = document.getElementById('cloudName').value;
            const uploadPreset = document.getElementById('cloudUploadPreset').value;
            const apiKey = document.getElementById('cloudApiKey').value;
            const apiSecret = document.getElementById('cloudApiSecret').value;
            try {
                await db.collection('settings').doc('app-config').set({ cloudinaryName: cloudName, cloudinaryPreset: uploadPreset, cloudinaryApiKey: apiKey, cloudinaryApiSecret: apiSecret }, { merge: true });
                appSettings.cloudinaryName = cloudName;
                appSettings.cloudinaryPreset = uploadPreset;
                appSettings.cloudinaryApiKey = apiKey;
                appSettings.cloudinaryApiSecret = apiSecret;
                logs.push({ message: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Cloudinary: ${cloudName}`, date: new Date() });
                renderLogs();
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Cloudinary ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (err) {
                console.error('Error saving Cloudinary settings:', err);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Cloudinary: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = original;
            }
        });
        // Save Facebook settings
        document.getElementById('save-facebook-settings').addEventListener('click', async () => {
            const btn = document.getElementById('save-facebook-settings');
            btn.disabled = true;
            const original = btn.textContent;
            btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            const appId = document.getElementById('fbAppId').value;
            const appSecret = document.getElementById('fbAppSecret').value;
            const enabled = document.getElementById('enableFacebook').checked;
            try {
                await db.collection('settings').doc('app-config').set({ facebookAppId: appId, facebookAppSecret: appSecret, isFacebookLoginEnabled: enabled }, { merge: true });
                appSettings.facebookAppId = appId;
                appSettings.facebookAppSecret = appSecret;
                appSettings.isFacebookLoginEnabled = enabled;
                logs.push({ message: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Facebook Login: ${enabled ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}`, date: new Date() });
                renderLogs();
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Facebook Login ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (err) {
                console.error('Error saving Facebook settings:', err);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Facebook: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = original;
            }
        });
        // Save SMS settings
        document.getElementById('save-sms-settings').addEventListener('click', async () => {
            const btn = document.getElementById('save-sms-settings');
            btn.disabled = true;
            const original = btn.textContent;
            btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            const apiKey = document.getElementById('smsApiKey').value;
            const sender = document.getElementById('smsSender').value;
            const enabled = document.getElementById('enableSMS').checked;
            try {
                await db.collection('settings').doc('app-config').set({ smsKubApiKey: apiKey, smsSenderName: sender, isSmsEnabled: enabled }, { merge: true });
                appSettings.smsKubApiKey = apiKey;
                appSettings.smsSenderName = sender;
                appSettings.isSmsEnabled = enabled;
                logs.push({ message: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï SMSKUB: ${enabled ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}`, date: new Date() });
                renderLogs();
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SMS ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (err) {
                console.error('Error saving SMS settings:', err);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SMS: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = original;
            }
        });
        // Logging search functionality
        document.getElementById('logSearch').addEventListener('input', function() {
            const term = this.value.toLowerCase();
            document.querySelectorAll('#logList li').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.classList.toggle('hidden', !text.includes(term));
            });
        });
        document.getElementById('clearLogs').addEventListener('click', () => {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                logs = [];
                renderLogs();
            }
        });
        // Log out event: sign out via Firebase Auth
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => {
                logs.push({ message: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', date: new Date() });
                renderLogs();
            }).catch((err) => {
                console.error('Error signing out:', err);
            });
        });

        /**
         * Authentication related functions
         */
        // Update UI based on authentication state
        function updateUIForAuth(user) {
            const loginContainer = document.getElementById('login-container');
            const sidebar = document.getElementById('sidebar');
            const main = document.getElementById('main');
            if (user) {
                // hide login overlay and show admin panel
                loginContainer.classList.add('hidden');
                sidebar.classList.remove('hidden');
                main.classList.remove('hidden');
                // load data
                loadJobs();
                // Load users and update admin sidebar once users are loaded
                loadUsers().then(() => {
                    updateAdminSidebar();
                    updateDashboardMetrics();
                });
                // Load application settings after authentication to populate the Settings page
                loadSettings();
                renderLogs();
            } else {
                loginContainer.classList.remove('hidden');
                sidebar.classList.add('hidden');
                main.classList.add('hidden');
            }
        }
        // Handle sign‚Äëin when user clicks login
        async function handleLogin() {
            const loginInput = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            const loginBtn = document.getElementById('login-btn');
            errorEl.classList.add('hidden');
            loginBtn.disabled = true;
            const originalText = loginBtn.textContent;
            loginBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
            try {
                let emailToUse = loginInput;
                // If input doesn't look like an email (no @), treat it as a name
                if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(loginInput)) {
                    const qs = await db.collection('users').where('name', '==', loginInput).limit(1).get();
                    if (!qs.empty) {
                        const userDoc = qs.docs[0].data();
                        if (userDoc.email) {
                            emailToUse = userDoc.email;
                        } else {
                            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ');
                        }
                    } else {
                        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ');
                    }
                }
                await auth.signInWithEmailAndPassword(emailToUse, password);
                showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } catch (err) {
                errorEl.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ: ' + err.message;
                errorEl.classList.remove('hidden');
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ: ' + err.message, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = originalText;
            }
        }
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        // Listen for authentication state changes
        auth.onAuthStateChanged(user => {
            updateUIForAuth(user);
        });
        // Initial load
        window.addEventListener('DOMContentLoaded', () => {
            initCharts();
            // Data loading will occur after auth state change
        });

        // Theme toggle logic
        function applyDarkTheme() {
            const body = document.body;
            // Remove light-theme class to revert custom styles
            body.classList.remove('light-theme');
            body.style.backgroundColor = '#0f172a';
            body.style.color = '#f1f5f9';
            // Reset glass elements to dark translucent backgrounds
            document.querySelectorAll('.glass').forEach(el => {
                el.style.background = 'rgba(255,255,255,0.05)';
                el.style.borderColor = 'rgba(255,255,255,0.08)';
            });
            // Change the theme icon to sun (indicating dark mode, click to switch to light)
            const icon = document.getElementById('theme-icon');
            if (icon) { icon.className = 'ph ph-sun text-xl'; }
            // Update Chart.js default text colour for dark mode
            if (typeof Chart !== 'undefined') {
                Chart.defaults.color = '#cbd5e1'; // slate‚Äë300 for axis and legend text
                // Refresh existing charts to apply new defaults
                if (window.jobsStatusChart) jobsStatusChart.update();
                if (window.financeChart) financeChart.update();
            }
        }

        function applyLightTheme() {
            const body = document.body;
            // Add light-theme class to apply CSS overrides
            body.classList.add('light-theme');
            body.style.backgroundColor = '#f3f4f6'; // light slate background
            body.style.color = '#1f2937'; // dark text
            document.querySelectorAll('.glass').forEach(el => {
                el.style.background = 'rgba(255,255,255,0.8)';
                el.style.borderColor = 'rgba(0,0,0,0.1)';
            });
            // Change the theme icon to moon (indicating light mode, click to switch to dark)
            const icon = document.getElementById('theme-icon');
            if (icon) { icon.className = 'ph ph-moon text-xl'; }
            // Update Chart.js default text colour for light mode
            if (typeof Chart !== 'undefined') {
                // Use black text for chart elements in light mode for maximum contrast
                Chart.defaults.color = '#000000';
                if (window.jobsStatusChart) jobsStatusChart.update();
                if (window.financeChart) financeChart.update();
            }
        }

        // Determine initial theme using system preference
        function initTheme() {
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (prefersDark) {
                applyDarkTheme();
            } else {
                applyLightTheme();
            }
        }

        // Toggle between dark and light modes
        function toggleTheme() {
            const bodyBg = getComputedStyle(document.body).backgroundColor;
            // Compare computed RGB values for dark background (approximate)
            if (bodyBg.includes('15, 23, 42') || bodyBg.includes('0f172a')) {
                applyLightTheme();
            } else {
                applyDarkTheme();
            }
        }

        // Bind theme toggle button
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        // Bind mobile menu toggle button for small screens
        const mobileMenuBtn = document.getElementById('mobile-menu-toggle');
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.classList.toggle('hidden');
                }
            });
        }
        // Initialize theme on load
        initTheme();

        // Bind button to add new team member row inside the job modal
        const addTeamMemberBtn = document.getElementById('addTeamMemberBtn');
        if (addTeamMemberBtn) {
            addTeamMemberBtn.addEventListener('click', () => {
                addTeamMemberRow();
                // When a new member row is added, immediately populate its date cells
                updateAllTeamMemberDateCells();
            });
        }
        // Update date cells when job date range changes
        const startInput = document.getElementById('jobStartDate');
        const endInput = document.getElementById('jobEndDate');
        if (startInput) {
            startInput.addEventListener('change', () => {
                updateAllTeamMemberDateCells();
            });
        }
        if (endInput) {
            endInput.addEventListener('change', () => {
                updateAllTeamMemberDateCells();
            });
        }

        /* -------------------------------------------------------------------------- */
        /*                             Team assignment logic                         */
        /* -------------------------------------------------------------------------- */
        /**
         * Add a new workday row to a given workdays container. Each workday row contains
         * a date input, a wage input, and a remove button. Optionally prepopulates with
         * existing data.
         * @param {HTMLElement} workdaysContainer The container element for workdays.
         * @param {{date?: string, wage?: number}} dayData Optional data to prepopulate the workday.
         */
        function addWorkdayRow(workdaysContainer, dayData = {}) {
            const row = document.createElement('div');
            row.className = 'workday-row flex items-center space-x-2';
            // Date input
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.className = 'workday-date-input p-1 bg-gray-800 rounded-lg text-sm';
            if (dayData.date) dateInput.value = dayData.date;
            // Wage input
            const wageInput = document.createElement('input');
            wageInput.type = 'number';
            wageInput.min = '0';
            wageInput.step = '0.01';
            wageInput.className = 'workday-wage-input w-20 p-1 bg-gray-800 rounded-lg text-right text-sm';
            wageInput.placeholder = '‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á';
            if (typeof dayData.wage !== 'undefined') wageInput.value = dayData.wage;
            // Remove button
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-workday-btn text-red-500 text-xs';
            removeBtn.textContent = '‡∏•‡∏ö';
            removeBtn.addEventListener('click', () => {
                row.remove();
        // Recalculate total wages when a custom day is removed
        const teamRow = workdaysContainer.closest('.team-row');
        if (teamRow) updateRowTotal(teamRow);
            });
            // Append
            row.appendChild(dateInput);
            row.appendChild(wageInput);
            row.appendChild(removeBtn);
            workdaysContainer.appendChild(row);
    // Attach event listeners to recalculate totals when wage or date changes
    wageInput.addEventListener('input', () => {
        const teamRow = workdaysContainer.closest('.team-row');
        if (teamRow) updateRowTotal(teamRow);
    });
    dateInput.addEventListener('change', () => {
        const teamRow = workdaysContainer.closest('.team-row');
        if (teamRow) updateRowTotal(teamRow);
    });
    return row;
        }

        /**
         * Add a new team member row to the team list container. Each row includes
         * a dropdown to select the team member (showing nickname if available), an
         * input with datalist for selecting or entering a position, and a section
         * to add multiple workday rows. Optionally prepopulates with existing data.
         * @param {{userId?: string, position?: string, workdays?: string[], dailyOverrides?: Object}} memberData
         */
        function addTeamMemberRow(memberData = {}) {
            const container = document.getElementById('teamListContainer');
            if (!container) return;
            const wrapper = document.createElement('div');
            wrapper.className = 'team-row border border-gray-600 rounded-lg p-3 bg-gray-800 space-y-2';
            // Store original member data on the row for future updates (e.g., when date range changes)
            wrapper._memberData = memberData;
            // Build a single flex row containing user selection, position, date cells, and remove button
            const rowFlex = document.createElement('div');
            rowFlex.className = 'flex flex-wrap items-start space-x-2 overflow-x-auto';
            // User selection with profile preview
            const userDiv = document.createElement('div');
            userDiv.className = 'flex items-center space-x-2';
            const avatar = document.createElement('img');
            avatar.className = 'w-8 h-8 rounded-full object-cover';
            // Select for user
            const select = document.createElement('select');
            select.className = 'team-user-select w-32 p-2 bg-gray-700 rounded-lg text-sm';
            let options = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</option>';
            users.forEach(u => {
                const nick = u.nickname || u.username || u.displayName || u.name || u.email || '';
                options += `<option value="${u.id}" data-avatar="${u.profilePic || u.profilePicture || u.photoURL || u.photoUrl || ''}">${nick}</option>`;
            });
            select.innerHTML = options;
            // Update avatar when selection changes
            select.addEventListener('change', () => {
                const selected = select.options[select.selectedIndex];
                const src = selected.getAttribute('data-avatar');
                avatar.src = src || 'https://placehold.co/40x40/374151/9ca3af?text=üë§';
            });
            // Preselect user if provided
            if (memberData.userId) {
                select.value = memberData.userId;
                const opt = select.querySelector(`option[value="${memberData.userId}"]`);
                if (opt) {
                    const src = opt.getAttribute('data-avatar');
                    avatar.src = src || 'https://placehold.co/40x40/374151/9ca3af?text=üë§';
                }
            } else {
                avatar.src = 'https://placehold.co/40x40/374151/9ca3af?text=üë§';
            }
            userDiv.appendChild(avatar);
            userDiv.appendChild(select);
            rowFlex.appendChild(userDiv);
            // Position input with datalist
            const positionDiv = document.createElement('div');
            positionDiv.className = 'flex items-center';
            const posInput = document.createElement('input');
            posInput.setAttribute('list', 'positionsList');
            posInput.className = 'team-position-select w-32 p-2 bg-gray-700 rounded-lg text-sm';
            posInput.placeholder = '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
            if (memberData.position) posInput.value = memberData.position;
            positionDiv.appendChild(posInput);
            rowFlex.appendChild(positionDiv);
            // Date cells container placed next to position
            const dateCellsContainer = document.createElement('div');
            dateCellsContainer.className = 'date-cells-container flex space-x-2 overflow-x-auto';
            rowFlex.appendChild(dateCellsContainer);
            // Total wages cell
            const totalDiv = document.createElement('div');
            totalDiv.className = 'team-total w-24 text-center text-sm flex flex-col items-center justify-center';
            totalDiv.textContent = '0';
            rowFlex.appendChild(totalDiv);
            // Actions cell containing remove button (and optional future icons)
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'team-actions flex items-center space-x-2';
            // Remove team button placed inside actions cell
            const removeTeamBtn = document.createElement('button');
            removeTeamBtn.type = 'button';
            removeTeamBtn.className = 'remove-team-row p-1 text-red-500';
            // Use an icon instead of text for better UI
            removeTeamBtn.innerHTML = '<i class="ph ph-trash"></i>';
            removeTeamBtn.addEventListener('click', () => {
                wrapper.remove();
            });
            actionsDiv.appendChild(removeTeamBtn);
            rowFlex.appendChild(actionsDiv);
            // Append flex row to wrapper
            wrapper.appendChild(rowFlex);
            /*
             * Create a container for custom workday entries.  These rows allow
             * admins to add days outside of the main date range.  Each row
             * will contain a date input, a wage input and a remove button.
             */
            const customDatesContainer = document.createElement('div');
            customDatesContainer.className = 'custom-dates-container space-y-2 mt-2';
            wrapper.appendChild(customDatesContainer);
            // Button to add a new custom day for this team member
            const addDayBtn = document.createElement('button');
            addDayBtn.type = 'button';
            addDayBtn.className = 'add-custom-day-btn text-blue-500 text-xs';
            addDayBtn.textContent = '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
            addDayBtn.addEventListener('click', () => {
                // Use existing addWorkdayRow helper to append a new custom date row
                addWorkdayRow(customDatesContainer);
                // Recalculate total wages whenever a new custom day is added
                updateRowTotal(wrapper);
            });
            wrapper.appendChild(addDayBtn);
            // Populate date cells for the current date range
            updateTeamMemberDateCells(wrapper, memberData);
            // Append wrapper to container
            container.appendChild(wrapper);
            // Calculate total wages after initial population
            updateRowTotal(wrapper);
        }

        /**
         * Initialize team member rows when opening the job modal. Clears existing rows
         * and adds rows based on the provided job data.
         * @param {Object|null} job
         */
        function initializeTeamRows(job) {
            const container = document.getElementById('teamListContainer');
            if (!container) return;
            container.innerHTML = '';
            if (job && Array.isArray(job.team)) {
                job.team.forEach(member => {
                    addTeamMemberRow(member);
                });
            }
            // After creating rows, populate date cells according to current date range
            updateAllTeamMemberDateCells();
        }

        /**
         * Update the date cells for a given team member row based on the current job
         * start and end date inputs. Prepopulates assignments if memberData is provided.
         * @param {HTMLElement} row The team-row element.
         * @param {{workdays?: string[], dailyOverrides?: Object, dailyRate?: number}} memberData
         */
        function updateTeamMemberDateCells(row, memberData = {}) {
            const container = row.querySelector('.date-cells-container');
            if (!container) return;
            container.innerHTML = '';
            const startVal = document.getElementById('jobStartDate').value;
            const endVal = document.getElementById('jobEndDate').value;
            if (!startVal || !endVal) return;
            const startDate = new Date(startVal);
            const endDate = new Date(endVal);
            if (isNaN(startDate) || isNaN(endDate) || startDate > endDate) return;
            // Build dates array
            const dates = [];
            const current = new Date(startDate.getTime());
            while (current <= endDate) {
                dates.push(new Date(current.getTime()));
                current.setDate(current.getDate() + 1);
            }
            dates.forEach(dateObj => {
                const dateStr = dateObj.toISOString().split('T')[0];
                const cell = document.createElement('div');
                cell.className = 'flex flex-col items-center w-20';
                const label = document.createElement('span');
                label.className = 'text-xs mb-1';
                // Format date label: show day/month in Thai short form
                const monthNames = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
                label.textContent = `${dateObj.getDate()} ${monthNames[dateObj.getMonth()]}`;
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'assign-day h-4 w-4';
                checkbox.setAttribute('data-date', dateStr);
                const wageInput = document.createElement('input');
                wageInput.type = 'number';
                wageInput.min = '0';
                wageInput.step = '0.01';
                wageInput.className = 'wage-day w-16 p-1 bg-gray-700 rounded-lg text-right text-xs';
                wageInput.setAttribute('data-date', dateStr);
                // Prepopulate if memberData provided
                if (memberData) {
                    const assigned = Array.isArray(memberData.workdays) && memberData.workdays.includes(dateStr);
                    const overrideRate = memberData.dailyOverrides && memberData.dailyOverrides[dateStr];
                    const defaultRate = memberData.dailyRate;
                    if (assigned || overrideRate) {
                        checkbox.checked = true;
                        wageInput.value = overrideRate || defaultRate || '';
                    }
                }
                // Add event listeners to recalculate total wages when assignment or wage changes
                checkbox.addEventListener('change', () => updateRowTotal(row));
                wageInput.addEventListener('input', () => updateRowTotal(row));
                cell.appendChild(label);
                cell.appendChild(checkbox);
                cell.appendChild(wageInput);
                container.appendChild(cell);
            });
            // Also handle custom workdays outside of the main date range
            const customContainer = row.querySelector('.custom-dates-container');
            if (customContainer) {
                // Clear existing custom rows before repopulating
                customContainer.innerHTML = '';
                if (memberData && Array.isArray(memberData.workdays)) {
                    // Convert dates array to string array for comparison
                    const dateStrings = dates.map(d => d.toISOString().split('T')[0]);
                    memberData.workdays.forEach(wd => {
                        if (!dateStrings.includes(wd)) {
                            // Determine wage for this date: check overrides first, then default rate
                            let wage = 0;
                            if (memberData.dailyOverrides && typeof memberData.dailyOverrides[wd] !== 'undefined') {
                                wage = memberData.dailyOverrides[wd];
                            } else if (typeof memberData.dailyRate !== 'undefined') {
                                wage = memberData.dailyRate;
                            }
                            // Create a custom workday row with date and wage prepopulated
                            const newRow = addWorkdayRow(customContainer, { date: wd, wage: wage });
                            // When a custom date row is added, recalculate total wages
                            updateRowTotal(row);
                        }
                    });
                }
            }
        }

        /**
         * Update date cells for all team member rows. Useful when the job start or end
         * date changes.
         */
        function updateAllTeamMemberDateCells() {
            const rows = document.querySelectorAll('#teamListContainer .team-row');
            rows.forEach(row => {
                // Retrieve stored member data for prepopulation
                const memberData = row._memberData || {};
                updateTeamMemberDateCells(row, memberData);
                // After updating date cells, recalculate total wages for the row
                updateRowTotal(row);
            });
        }

        /**
         * Update the total wages display for a team member row.  Calculates the sum
         * of all selected date wages, including custom workdays.
         * @param {HTMLElement} row
         */
        function updateRowTotal(row) {
            const totalDiv = row.querySelector('.team-total');
            if (!totalDiv) return;
            let total = 0;
            // Gather wages from selected date cells
            const dateCheckboxes = row.querySelectorAll('.date-cells-container .assign-day');
            dateCheckboxes.forEach(cb => {
                if (cb.checked) {
                    const date = cb.getAttribute('data-date');
                    const wageInput = row.querySelector(`.date-cells-container .wage-day[data-date="${date}"]`);
                    const wageVal = wageInput && wageInput.value ? parseFloat(wageInput.value) : 0;
                    if (!isNaN(wageVal)) total += wageVal;
                }
            });
            // Gather wages from custom workday rows
            const customRows = row.querySelectorAll('.custom-dates-container .workday-row');
            customRows.forEach(r => {
                const wageInput = r.querySelector('.workday-wage-input');
                const wageVal = wageInput && wageInput.value ? parseFloat(wageInput.value) : 0;
                if (!isNaN(wageVal)) total += wageVal;
            });
            // Format total using Thai locale
            totalDiv.textContent = total > 0 ? new Intl.NumberFormat('th-TH').format(total) : '0';
        }

        /**
         * Collect team assignments from the dynamic team rows. Returns an array of
         * objects with userId, position, dailyRate, workdays and dailyOverrides.
         */
        function collectTeamAssignments() {
            const assignments = [];
            const rows = document.querySelectorAll('#teamListContainer .team-row');
            rows.forEach(row => {
                const userSelect = row.querySelector('.team-user-select');
                const userId = userSelect ? userSelect.value : '';
                if (!userId) return;
                const positionInput = row.querySelector('.team-position-select');
                const position = positionInput && positionInput.value ? positionInput.value : '';
                const dateCheckboxes = row.querySelectorAll('.date-cells-container .assign-day');
                const workdays = [];
                const wagesMap = {};
                // Gather selected checkboxes within the date range
                dateCheckboxes.forEach(cb => {
                    if (cb.checked) {
                        const date = cb.getAttribute('data-date');
                        if (!date) return;
                        workdays.push(date);
                        const wageInput = row.querySelector(`.date-cells-container .wage-day[data-date="${date}"]`);
                        const wageVal = wageInput && wageInput.value ? parseFloat(wageInput.value) : 0;
                        wagesMap[date] = isNaN(wageVal) ? 0 : wageVal;
                    }
                });
                // Gather custom workdays added outside the date range
                const customRows = row.querySelectorAll('.custom-dates-container .workday-row');
                customRows.forEach(r => {
                    const dateInput = r.querySelector('.workday-date-input');
                    const wageInput = r.querySelector('.workday-wage-input');
                    const dateVal = dateInput ? dateInput.value : '';
                    if (dateVal) {
                        workdays.push(dateVal);
                        const wageVal = wageInput && wageInput.value ? parseFloat(wageInput.value) : 0;
                        wagesMap[dateVal] = isNaN(wageVal) ? 0 : wageVal;
                    }
                });
                if (!workdays.length) return;
                // Determine default daily rate and overrides
                const wageValues = Object.values(wagesMap);
                let dailyRate = wageValues.length > 0 ? wageValues[0] : 0;
                const dailyOverrides = {};
                Object.entries(wagesMap).forEach(([date, val]) => {
                    if (val !== dailyRate) {
                        dailyOverrides[date] = val;
                    }
                });
                assignments.push({
                    userId: userId,
                    position: position,
                    dailyRate: dailyRate,
                    workdays: workdays,
                    dailyOverrides: dailyOverrides
                });
            });
            return assignments;
        }
    </script>
</body>
</html>
