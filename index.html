<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDB QUEUE</title>
    
    <!-- Google Fonts: Kanit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* --- Base Styles & Variables --- */
        :root {
            --primary-color: #8E2DE2;
            --secondary-color: #4A00E0;
            --text-light: #F0F0F0;
            --text-dark: #333;
            --bg-main: #121212;
            --bg-card: #1E1E1E;
            --bg-header: #2A2A2A;
            --border-color: #444;
            --green-profit: #28a745;
            --red-loss: #dc3545;
            --yellow-accent: #FFD700;
            --blue-accent: #0d6efd;
            --border-radius: 12px;
            --shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background: #1c1c1c;
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }

        /* --- Login Container --- */
        #login-container {
            background: var(--bg-card);
            padding: 2.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            text-align: center;
            border-top: 4px solid var(--primary-color);
            transition: all 0.5s ease-in-out;
        }

        #login-container h2 {
            margin-bottom: 2rem;
            color: var(--text-light);
            font-weight: 600;
        }

        .input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .input-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }

        .input-group input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            font-family: 'Kanit', sans-serif;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(142, 45, 226, 0.3);
        }

        #login-btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
        }

        #login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(142, 45, 226, 0.4);
        }
        #login-error {
            color: var(--red-loss);
            margin-top: 1rem;
            min-height: 1.2em;
        }

        /* --- App Container --- */
        #app-container {
            width: 100%;
            max-width: 1400px;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            border-top: 4px solid var(--primary-color);
        }

        header {
            background: var(--bg-header);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        #user-display-name {
            font-weight: 500;
        }

        #logout-btn {
            background: var(--red-loss);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #logout-btn:hover {
            background: #c82333;
        }
        
        main {
            padding: 2rem;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        /* --- Job Section --- */
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: var(--bg-header);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }

        .job-info h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .job-info h2 i {
            margin-right: 0.5rem;
            color: var(--primary-color);
        }
        .job-info p {
            color: #aaa;
        }

        .revenue-total {
            text-align: right;
        }
        .revenue-total p {
            color: #aaa;
            font-size: 0.9rem;
        }
        .revenue-total .amount {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--green-profit);
        }

        .queue-table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        th {
            background-color: rgba(255,255,255,0.05);
            font-weight: 500;
        }
        
        td:first-child {
            text-align: left;
        }

        .profile {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }
        .team-leader .profile-name {
            font-weight: 600;
            color: var(--yellow-accent);
        }
        .team-leader .profile-name::before {
            content: "\f521";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            margin-right: 0.5rem;
        }

        .daily-pay-input {
            width: 80px;
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 6px;
            padding: 0.3rem;
            text-align: center;
            margin-left: 0.5rem;
            font-size: 0.9rem;
        }
        
        .action-buttons {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
        }

        .app-btn {
            background: var(--blue-accent);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Kanit', sans-serif;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .app-btn:hover {
            background: #0b5ed7;
            transform: translateY(-2px);
        }
        .app-btn i {
            margin-right: 0.5rem;
        }

        /* --- Summary Section --- */
        .summary-box {
            background: var(--bg-header);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
        }
        .summary-box h3 {
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.8rem;
            margin-bottom: 1rem;
        }

        #expense-list {
            list-style: none;
            margin-bottom: 1rem;
        }
        #expense-list li {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
        }
        .delete-expense-btn {
            background: none;
            border: none;
            color: var(--red-loss);
            cursor: pointer;
        }
        .add-expense-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .add-expense-form input {
            flex: 1;
            padding: 0.5rem;
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 6px;
        }
        .add-expense-form button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
        }

        .financial-details p {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8rem;
        }
        .financial-details .option-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #wht-percent {
            width: 50px;
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 4px;
            padding: 0.2rem;
        }
        .final-total {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .profit-loss-box {
            padding: 1.5rem;
            border-radius: var(--border-radius);
            text-align: center;
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            transition: all 0.5s;
        }
        .profit {
            background: linear-gradient(45deg, #28a745, #218838);
        }
        .loss {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        /* --- Modal --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background: var(--bg-card);
            margin: 10% auto;
            padding: 2rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: slideIn 0.4s;
            border-top: 4px solid var(--secondary-color);
        }
        .close-btn {
            color: #aaa;
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 1.8rem;
            font-weight: bold;
            cursor: pointer;
        }
        .modal h3 {
            margin-bottom: 1.5rem;
        }
        #user-selection-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
        }
        #user-selection-list label {
            display: block;
            padding: 0.8rem;
            cursor: pointer;
            border-radius: 6px;
        }
        #user-selection-list label:hover {
            background: var(--bg-header);
        }

        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        @keyframes slideIn {
            from {transform: translateY(-50px); opacity: 0;}
            to {transform: translateY(0); opacity: 1;}
        }

        /* --- Utility & Responsive --- */
        .hidden { display: none !important; }
        .admin-only { display: none; } /* Controlled by JS */

        @media (max-width: 992px) {
            main {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            body { padding: 0; }
            #app-container { border-radius: 0; }
            main { padding: 1rem; }
            header { padding: 1rem; }
            .job-header { flex-direction: column; gap: 1rem; align-items: stretch; }
            .revenue-total { text-align: left; }
        }

    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-container">
        <h2>LDB QUEUE LOGIN</h2>
        <div class="input-group">
            <i class="fas fa-envelope"></i>
            <input type="email" id="login-email" placeholder="อีเมล">
        </div>
        <div class="input-group">
            <i class="fas fa-lock"></i>
            <input type="password" id="login-password" placeholder="รหัสผ่าน">
        </div>
        <p id="login-error">&nbsp;</p>
        <button id="login-btn">เข้าสู่ระบบ</button>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden">
        <header>
            <h1>LDB QUEUE</h1>
            <div class="user-info">
                <span id="user-display-name"></span>
                <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</button>
            </div>
        </header>

        <main>
            <section class="queue-section">
                <div class="job-header">
                    <div class="job-info">
                        <h2 id="job-name"><i class="fa-solid fa-video"></i> OB Laos</h2>
                        <p id="job-dates">29 ก.ค. 2568 - 1 ส.ค. 2568</p>
                    </div>
                    <div class="revenue-total">
                        <p>รายได้ทั้งหมด</p>
                        <span id="job-revenue" class="amount">20,000</span>
                    </div>
                </div>

                <div class="queue-table-container">
                    <table id="queue-table">
                        <thead>
                            <tr id="table-header-row">
                                <!-- Headers will be generated by JS -->
                            </tr>
                        </thead>
                        <tbody id="queue-body">
                            <!-- Team members will be generated by JS -->
                        </tbody>
                    </table>
                </div>
                <div class="action-buttons">
                    <button id="add-member-btn" class="app-btn admin-only"><i class="fa-solid fa-user-plus"></i> เพิ่มสมาชิกในคิว</button>
                    <button id="add-day-btn" class="app-btn admin-only"><i class="fa-solid fa-calendar-plus"></i> เพิ่มวันทำงาน</button>
                </div>
            </section>

            <section class="summary-section">
                <div>
                    <div class="summary-box">
                        <h3>ค่าใช้จ่าย</h3>
                        <ul id="expense-list">
                            <!-- Expenses will be generated by JS -->
                        </ul>
                        <div class="add-expense-form admin-only">
                            <input type="text" id="expense-desc" placeholder="รายละเอียด">
                            <input type="number" id="expense-amount" placeholder="จำนวนเงิน">
                            <button id="add-expense-btn">เพิ่ม</button>
                        </div>
                    </div>

                    <div class="summary-box">
                        <h3>สรุปยอด</h3>
                        <div class="financial-details">
                            <p><span>ค่าทีมงานรวม</span> <span id="total-team-cost">0</span></p>
                            <p><span>ค่าใช้จ่ายอื่นๆ</span> <span id="total-other-expense">0</span></p>
                            <hr style="border-color: var(--border-color); margin: 1rem 0;">
                            <p><span>ยอดรวม</span> <span id="sub-total">0</span></p>
                            <p>
                                <label class="option-label">
                                    <input type="checkbox" id="wht-checkbox">
                                    หัก ณ ที่จ่าย (<input type="number" id="wht-percent" value="3" class="admin-only" style="width: 50px;">%)
                                </label>
                                <span id="wht-amount">0</span>
                            </p>
                            <p>
                                <label class="option-label">
                                    <input type="checkbox" id="vat-checkbox">
                                    VAT (7%)
                                </label>
                                <span id="vat-amount">0</span>
                            </p>
                            <div class="final-total">
                                <span>รวมสุทธิ</span>
                                <span id="grand-total">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="profit-loss-container" class="profit-loss-box">
                       <!-- Profit/Loss will be generated by JS -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add Member Modal -->
    <div id="add-member-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-member-modal">&times;</span>
            <h3>เลือกสมาชิกเพื่อเพิ่มในคิว</h3>
            <div id="user-selection-list">
                <!-- User list will be populated by JS -->
            </div>
            <button id="confirm-add-member-btn" class="app-btn" style="margin-top: 1rem;">ยืนยัน</button>
        </div>
    </div>
    
    <!-- Change Password Modal -->
    <div id="change-password-modal" class="modal">
        <div class="modal-content">
            <h3>ตั้งรหัสผ่านใหม่</h3>
            <p>นี่คือการเข้าสู่ระบบครั้งแรก กรุณาตั้งรหัสผ่านใหม่เพื่อความปลอดภัย</p>
            <div class="input-group" style="margin-top: 1.5rem;">
                <i class="fas fa-lock"></i>
                <input type="password" id="new-password" placeholder="รหัสผ่านใหม่">
            </div>
            <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="confirm-new-password" placeholder="ยืนยันรหัสผ่านใหม่">
            </div>
            <p id="password-error" style="color: var(--red-loss); min-height: 1.2em;">&nbsp;</p>
            <button id="confirm-password-change-btn" class="app-btn">ยืนยัน</button>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // =================================================================================
        // PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE
        // วาง Object การตั้งค่า Firebase ของคุณที่นี่
        // =================================================================================
       const firebaseConfig = {
        apiKey: "AIzaSyC6AnEE8aRM_9gw0CIi4Skl_zTPU_CG_CQ",
        authDomain: "ldb-queue-app.firebaseapp.com",
        projectId: "ldb-queue-app",
        storageBucket: "ldb-queue-app.firebasestorage.app",
        messagingSenderId: "626818286678",
        appId: "1:626818286678:web:db8080230e818dc1f7e7f7"
    };
        // =================================================================================

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Global State ---
        let currentUser = null;
        let currentJobId = 'job01'; // Default job to load
        let jobUnsubscribe = null; // To detach listener when logging out

        // --- DOM Elements ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        
        // Modals
        const addMemberModal = document.getElementById('add-member-modal');
        const changePasswordModal = document.getElementById('change-password-modal');

        // --- Authentication ---
        auth.onAuthStateChanged(async (user) => {
            if (user && firebaseConfig.apiKey !== "YOUR_API_KEY") {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    currentUser = { uid: user.uid, ...userDoc.data() };
                    
                    if (currentUser.mustChangePassword) {
                        changePasswordModal.style.display = 'flex';
                    } else {
                        setupUI(currentUser);
                    }
                } else {
                    console.log("User document not found in Firestore.");
                    auth.signOut();
                }
            } else {
                currentUser = null;
                setupUI(null);
            }
        });

        loginBtn.addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginError.textContent = '\u00A0'; // Clear previous error

            if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                loginError.textContent = 'กรุณาตั้งค่า Firebase Config ในโค้ดก่อน';
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error("Login failed:", error);
                    loginError.textContent = 'อีเมลหรือรหัสผ่านไม่ถูกต้อง';
                });
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });
        
        // --- Password Change Logic ---
        document.getElementById('confirm-password-change-btn').addEventListener('click', () => {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            const passwordError = document.getElementById('password-error');
            
            if (newPassword.length < 6) {
                passwordError.textContent = 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร';
                return;
            }
            if (newPassword !== confirmPassword) {
                passwordError.textContent = 'รหัสผ่านไม่ตรงกัน';
                return;
            }

            auth.currentUser.updatePassword(newPassword)
                .then(() => {
                    return db.collection('users').doc(currentUser.uid).update({ mustChangePassword: false });
                })
                .then(() => {
                    changePasswordModal.style.display = 'none';
                    alert('เปลี่ยนรหัสผ่านสำเร็จแล้ว');
                    location.reload(); // Reload to apply changes
                })
                .catch(error => {
                    console.error("Password change failed:", error);
                    passwordError.textContent = 'เกิดข้อผิดพลาด: ' + error.message;
                });
        });

        // --- UI Setup ---
        function setupUI(user) {
            if (user) {
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.getElementById('user-display-name').textContent = user.displayName;
                
                // Role-based access control
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = user.role === 'admin' ? 'inline-block' : 'none';
                });
                
                loadAndRenderJob(currentJobId);

            } else {
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                if (jobUnsubscribe) jobUnsubscribe(); // Detach Firestore listener
            }
        }

        // --- Data Loading & Rendering ---
        function loadAndRenderJob(jobId) {
            if (jobUnsubscribe) jobUnsubscribe(); // Detach previous listener

            jobUnsubscribe = db.collection('jobs').doc(jobId).onSnapshot(async (doc) => {
                if (!doc.exists) {
                    console.error("Job not found!");
                    // You could show a message on the UI here
                    return;
                }
                const jobData = doc.data();
                
                // Render Job Header
                document.getElementById('job-name').innerHTML = `<i class="fa-solid fa-video"></i> ${jobData.name}`;
                document.getElementById('job-dates').textContent = `${jobData.startDate} - ${jobData.endDate}`;
                document.getElementById('job-revenue').textContent = jobData.revenue.toLocaleString();

                // Render Table
                await renderTable(jobData);
                
                // Render Expenses
                renderExpenses(jobData.expenses || []);

                // Calculate financials
                calculateFinancials(jobData.revenue);
                
                // Add event listeners after rendering
                addDynamicEventListeners();

            }, error => {
                console.error("Error fetching job data:", error);
            });
        }
        
        async function renderTable(jobData) {
            const headerRow = document.getElementById('table-header-row');
            const tableBody = document.getElementById('queue-body');
            
            headerRow.innerHTML = '<th>ชื่อ</th>';
            jobData.workDays.forEach(day => {
                headerRow.innerHTML += `<th>${day}</th>`;
            });
            headerRow.innerHTML += '<th>จัดการ</th>';

            tableBody.innerHTML = '';
            // Using Promise.all to fetch all user data in parallel
            const teamMemberPromises = jobData.team.map(memberId => db.collection('users').doc(memberId).get());
            const teamMemberDocs = await Promise.all(teamMemberPromises);

            teamMemberDocs.forEach((userDoc, index) => {
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const row = document.createElement('tr');
                    row.dataset.userId = userDoc.id;

                    // Name column
                    let nameHtml = `<div class="profile">
                        <img src="${userData.profileImageUrl || `https://placehold.co/40x40/4A00E0/FFFFFF?text=${userData.displayName.charAt(0)}`}" alt="profile">
                        <span class="profile-name">${userData.displayName}</span>
                    </div>`;
                    if (index === 0) { // First member is the leader
                         row.classList.add('team-leader');
                    }
                    
                    let rowHtml = `<td>${nameHtml}</td>`;
                    
                    // Workday columns
                    jobData.workDays.forEach(day => {
                        const dailyData = jobData.dailyPay[userDoc.id]?.[day] || { present: false, pay: 0 };
                        rowHtml += `<td>
                            <input type="checkbox" class="presence-check" data-day="${day}" ${dailyData.present ? 'checked' : ''}>
                            <input type="number" class="daily-pay-input admin-only" value="${dailyData.pay}" data-day="${day}">
                        </td>`;
                    });

                    // Action column
                    rowHtml += `<td><button class="delete-member-btn admin-only" data-user-id="${userDoc.id}"><i class="fas fa-trash"></i></button></td>`;

                    row.innerHTML = rowHtml;
                    tableBody.appendChild(row);
                }
            });
        }
        
        function renderExpenses(expenses) {
            const expenseList = document.getElementById('expense-list');
            expenseList.innerHTML = '';
            let totalOtherExpense = 0;
            expenses.forEach((exp, index) => {
                expenseList.innerHTML += `
                    <li>
                        <span>${exp.desc}</span>
                        <span>
                            ${exp.amount.toLocaleString()}
                            <button class="delete-expense-btn admin-only" data-index="${index}"><i class="fas fa-times-circle"></i></button>
                        </span>
                    </li>`;
                totalOtherExpense += exp.amount;
            });
            document.getElementById('total-other-expense').textContent = totalOtherExpense.toLocaleString();
        }

        // --- Financial Calculation ---
        function calculateFinancials(revenue = 0) {
            let totalTeamCost = 0;
            document.querySelectorAll('#queue-body tr').forEach(row => {
                const userId = row.dataset.userId;
                row.querySelectorAll('.presence-check:checked').forEach(checkbox => {
                    const day = checkbox.dataset.day;
                    const payInput = row.querySelector(`.daily-pay-input[data-day="${day}"]`);
                    if (payInput) {
                        totalTeamCost += Number(payInput.value) || 0;
                    }
                });
            });
            document.getElementById('total-team-cost').textContent = totalTeamCost.toLocaleString();

            const totalOtherExpense = Array.from(document.querySelectorAll('#expense-list li'))
                .reduce((sum, li) => {
                    const amountText = li.children[1].textContent.trim().replace(/,/g, '');
                    return sum + (parseFloat(amountText) || 0);
                }, 0);
            
            const subTotal = totalTeamCost + totalOtherExpense;
            document.getElementById('sub-total').textContent = subTotal.toLocaleString();

            const whtPercent = document.getElementById('wht-percent').value / 100;
            const whtEnabled = document.getElementById('wht-checkbox').checked;
            const whtAmount = whtEnabled ? subTotal * whtPercent : 0;
            document.getElementById('wht-amount').textContent = `-${whtAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

            const vatEnabled = document.getElementById('vat-checkbox').checked;
            const vatAmount = vatEnabled ? (subTotal - whtAmount) * 0.07 : 0;
            document.getElementById('vat-amount').textContent = `+${vatAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            const grandTotal = subTotal - whtAmount + vatAmount;
            document.getElementById('grand-total').textContent = grandTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            const profit = revenue - grandTotal;
            const profitBox = document.getElementById('profit-loss-container');
            if (profit >= 0) {
                profitBox.innerHTML = `กำไร: ${profit.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                profitBox.className = 'profit-loss-box profit';
            } else {
                profitBox.innerHTML = `ขาดทุน: ${Math.abs(profit).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                profitBox.className = 'profit-loss-box loss';
            }
            
            // Re-apply admin visibility after calculation updates
            if (currentUser) {
                 document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = currentUser.role === 'admin' ? 'inline-block' : 'none';
                });
            }
        }

        // --- Event Listeners ---
        function addDynamicEventListeners() {
            // Financial calculation triggers
            document.querySelectorAll('.presence-check, #wht-checkbox, #vat-checkbox, .daily-pay-input, #wht-percent').forEach(el => {
                el.addEventListener('change', () => calculateFinancials(parseFloat(document.getElementById('job-revenue').textContent.replace(/,/g, ''))));
            });

            // Admin: Add new expense
            document.getElementById('add-expense-btn').addEventListener('click', () => {
                const desc = document.getElementById('expense-desc').value;
                const amount = parseFloat(document.getElementById('expense-amount').value);
                if (desc && amount > 0) {
                    const newExpense = { desc, amount };
                    db.collection('jobs').doc(currentJobId).update({
                        expenses: firebase.firestore.FieldValue.arrayUnion(newExpense)
                    });
                    document.getElementById('expense-desc').value = '';
                    document.getElementById('expense-amount').value = '';
                }
            });

            // Admin: Delete expense
            document.querySelectorAll('.delete-expense-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const indexToRemove = parseInt(e.currentTarget.dataset.index);
                    const jobDoc = await db.collection('jobs').doc(currentJobId).get();
                    const expenses = jobDoc.data().expenses;
                    expenses.splice(indexToRemove, 1);
                    db.collection('jobs').doc(currentJobId).update({ expenses });
                });
            });
            
            // Admin: Add new day
            document.getElementById('add-day-btn').addEventListener('click', () => {
                const newDay = prompt("กรุณาใส่วันที่ใหม่ (เช่น 2 ส.ค. 2568):");
                if (newDay) {
                    db.collection('jobs').doc(currentJobId).update({
                        workDays: firebase.firestore.FieldValue.arrayUnion(newDay)
                    });
                }
            });
            
            // Admin: Delete member
            document.querySelectorAll('.delete-member-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userIdToRemove = e.currentTarget.dataset.userId;
                    if (confirm('คุณต้องการลบสมาชิกคนนี้ออกจากคิวใช่หรือไม่?')) {
                         db.collection('jobs').doc(currentJobId).update({
                            team: firebase.firestore.FieldValue.arrayRemove(userIdToRemove)
                        });
                    }
                });
            });
            
            // Admin: Open Add Member Modal
            document.getElementById('add-member-btn').addEventListener('click', async () => {
                const userSelectionList = document.getElementById('user-selection-list');
                userSelectionList.innerHTML = 'กำลังโหลด...';
                
                const jobDoc = await db.collection('jobs').doc(currentJobId).get();
                const currentTeamIds = jobDoc.data().team;

                const usersSnapshot = await db.collection('users').get();
                userSelectionList.innerHTML = '';
                usersSnapshot.forEach(doc => {
                    // Only show users who are not already in the team
                    if (!currentTeamIds.includes(doc.id)) {
                        const userData = doc.data();
                        userSelectionList.innerHTML += `
                            <label>
                                <input type="checkbox" name="user-to-add" value="${doc.id}">
                                ${userData.displayName} (${userData.email})
                            </label>
                        `;
                    }
                });
                addMemberModal.style.display = 'flex';
            });
            
            // Admin: Confirm Add Member
            document.getElementById('confirm-add-member-btn').addEventListener('click', () => {
                const selectedUsers = [];
                document.querySelectorAll('input[name="user-to-add"]:checked').forEach(checkbox => {
                    selectedUsers.push(checkbox.value);
                });
                
                if (selectedUsers.length > 0) {
                    db.collection('jobs').doc(currentJobId).update({
                        team: firebase.firestore.FieldValue.arrayUnion(...selectedUsers)
                    });
                }
                addMemberModal.style.display = 'none';
            });
            
            // Close Modal
            document.getElementById('close-member-modal').addEventListener('click', () => {
                addMemberModal.style.display = 'none';
            });
            
            // Update daily pay data in Firestore (for admins)
            document.querySelectorAll('.daily-pay-input, .presence-check').forEach(input => {
                input.addEventListener('change', (e) => {
                    if (currentUser.role !== 'admin') return;
                    
                    const row = e.currentTarget.closest('tr');
                    const userId = row.dataset.userId;
                    const day = e.currentTarget.dataset.day;
                    
                    const isPresent = row.querySelector(`.presence-check[data-day="${day}"]`).checked;
                    const pay = Number(row.querySelector(`.daily-pay-input[data-day="${day}"]`).value);

                    const updatePath = `dailyPay.${userId}.${day}`;
                    db.collection('jobs').doc(currentJobId).update({
                        [updatePath]: { present: isPresent, pay: pay }
                    }).catch(error => console.error("Error updating daily pay:", error));
                });
            });
        }
        
        // Close modal if clicked outside
        window.onclick = function(event) {
            if (event.target == addMemberModal) {
                addMemberModal.style.display = "none";
            }
        }
        
        
        // =================================================================================
        // ONE-TIME SETUP FUNCTIONS (Run from browser console)
        // ฟังก์ชันสำหรับตั้งค่าครั้งเดียว (รันผ่าน Console ของเบราว์เซอร์)
        // =================================================================================

        // 1. To create the first admin user
        function createAdminUser() {
            const email = "admin@ldb.com";
            const password = "defaultpassword"; // Change this!
            auth.createUserWithEmailAndPassword(email, password)
                .then(cred => {
                    return db.collection('users').doc(cred.user.uid).set({
                        email: email,
                        displayName: 'แอดมินใหญ่',
                        role: 'admin',
                        mustChangePassword: true,
                        profileImageUrl: ''
                    });
                })
                .then(() => console.log('Admin user created successfully!'))
                .catch(err => console.error('Error creating admin user:', err));
        }

        // 2. To add sample data to Firestore
        function setupSampleData() {
            // Sample Users
            const users = [
                { id: 'user01', data: { displayName: 'ก๊อต', email: 'god@example.com', role: 'member', profileImageUrl: 'https://placehold.co/100x100/E8A2A2/FFFFFF?text=G' } },
                { id: 'user02', data: { displayName: 'บิ๊กซ์', email: 'bix@example.com', role: 'member', profileImageUrl: 'https://placehold.co/100x100/A2D0E8/FFFFFF?text=B' } },
                { id: 'user03', data: { displayName: 'ต้า', email: 'tar@example.com', role: 'member', profileImageUrl: 'https://placehold.co/100x100/A2E8B9/FFFFFF?text=T' } },
                { id: 'user04', data: { displayName: 'เฟรม', email: 'frame@example.com', role: 'member', profileImageUrl: 'https://placehold.co/100x100/E8D0A2/FFFFFF?text=F' } }
            ];
            
            const batch = db.batch();
            users.forEach(user => {
                const userRef = db.collection('users').doc(user.id);
                batch.set(userRef, user.data);
            });
            
            // Sample Job
            const jobRef = db.collection('jobs').doc('job01');
            batch.set(jobRef, {
                name: 'OB Laos',
                startDate: '29 ก.ค. 2568',
                endDate: '1 ส.ค. 2568',
                revenue: 60000,
                team: ['user01', 'user02', 'user03', 'user04'],
                workDays: ['29 ก.ค. 2568', '30 ก.ค. 2568', '1 ส.ค. 2568'],
                expenses: [
                    { desc: 'ค่าอาหาร', amount: 2000 },
                    { desc: 'ค่า Vmix', amount: 3500 }
                ],
                dailyPay: {
                    'user01': {
                        '29 ก.ค. 2568': { present: true, pay: 7000 },
                        '30 ก.ค. 2568': { present: true, pay: 7000 },
                        '1 ส.ค. 2568': { present: true, pay: 7000 }
                    },
                    'user02': {
                        '29 ก.ค. 2568': { present: true, pay: 6000 },
                        '30 ก.ค. 2568': { present: true, pay: 6000 },
                        '1 ส.ค. 2568': { present: false, pay: 6000 }
                    },
                    'user03': {
                        '29 ก.ค. 2568': { present: true, pay: 7000 },
                        '30 ก.ค. 2568': { present: false, pay: 7000 },
                        '1 ส.ค. 2568': { present: true, pay: 7000 }
                    },
                    'user04': {
                        '29 ก.ค. 2568': { present: true, pay: 6500 },
                        '30 ก.ค. 2568': { present: true, pay: 6500 },
                        '1 ส.ค. 2568': { present: true, pay: 6500 }
                    }
                }
            });

            batch.commit()
                .then(() => console.log('Sample data and users created!'))
                .catch(err => console.error('Error setting up data:', err));
        }

    </script>
</body>
</html>
