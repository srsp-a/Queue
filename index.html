<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDB QUEUE - Job Management</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Kanit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f0f2f5;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #6B73FF 0%, #A855F7 100%);
        }
        .main-gradient-text {
            background: linear-gradient(90deg, #f97316, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .profit-text {
            color: #22c55e; /* green-500 */
        }
        .loss-text {
            color: #ef4444; /* red-500 */
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .hidden {
            display: none;
        }
        .date-header:hover .date-action-btn {
            opacity: 1;
        }
        .custom-checkbox {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #d1d5db; /* gray-300 */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #f9fafb; /* gray-50 */
        }
        .custom-checkbox.checked {
            background-color: #22c55e; /* green-500 */
            border-color: #22c55e;
        }
        .custom-checkbox .ph-check {
            color: white;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .custom-checkbox.checked .ph-check {
            opacity: 1;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div id="app-container" class="min-h-screen">

        <!-- Login Screen -->
        <div id="login-screen" class="flex items-center justify-center min-h-screen gradient-bg">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-xl">
                <div class="text-center">
                    <h1 class="text-4xl font-bold main-gradient-text">LDB QUEUE</h1>
                    <p class="mt-2 text-gray-500">ลงชื่อเข้าใช้เพื่อจัดการคิวงาน</p>
                </div>
                <form id="login-form" class="space-y-6">
                    <div>
                        <!-- EDIT 2: Change label for login -->
                        <label for="login-identifier" class="text-sm font-medium text-gray-700">อีเมล หรือ ชื่อเล่น</label>
                        <input id="login-identifier" name="loginIdentifier" type="text" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500" placeholder="your@email.com หรือ nickname">
                    </div>
                    <div>
                        <label for="password" class="text-sm font-medium text-gray-700">รหัสผ่าน</label>
                        <input id="password" name="password" type="password" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500" placeholder="••••••••">
                    </div>
                    <p id="login-error" class="text-sm text-red-500 hidden"></p>
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white gradient-bg rounded-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-300">
                        ลงชื่อเข้าใช้
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Change Password Modal -->
        <div id="change-password-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 m-4 modal-content">
                <h2 class="text-2xl font-bold text-center">เปลี่ยนรหัสผ่านใหม่</h2>
                <p class="text-center text-gray-500 mt-2">เพื่อความปลอดภัย กรุณาตั้งรหัสผ่านใหม่สำหรับใช้งานครั้งแรก</p>
                <form id="change-password-form" class="mt-6 space-y-4">
                    <div>
                        <label for="new-password" class="text-sm font-medium text-gray-700">รหัสผ่านใหม่</label>
                        <input type="password" id="new-password" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <p id="password-error" class="text-sm text-red-500 hidden"></p>
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white gradient-bg rounded-lg hover:opacity-90">
                        ยืนยันและเข้าสู่ระบบ
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App Screen -->
        <div id="main-app" class="hidden p-4 sm:p-6 lg:p-8">
            <header class="flex flex-wrap items-center justify-between pb-6 mb-6 border-b-2 border-gray-200">
                <div>
                    <h1 class="text-4xl font-bold main-gradient-text">LDB QUEUE</h1>
                    <p id="user-info" class="mt-1 text-gray-500">สวัสดี, <span id="user-name-display" class="font-medium"></span> (<span id="user-role" class="font-medium"></span>)</p>
                    <p class="text-xs text-gray-400">User ID: <span id="user-id-display"></span></p>
                </div>
                <div class="flex items-center space-x-4 mt-4 sm:mt-0">
                    <button id="manage-profile-button" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                        <i class="ph ph-gear mr-1"></i> จัดการโปรไฟล์
                    </button>
                    <button id="logout-button" class="px-4 py-2 font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="ph ph-sign-out mr-1"></i> ออกจากระบบ
                    </button>
                </div>
            </header>

            <!-- Job List -->
            <section>
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold">รายการคิวงาน</h2>
                    <button id="add-job-button" class="px-4 py-2 font-semibold text-white gradient-bg rounded-lg hover:opacity-90 admin-only">
                        <i class="ph ph-plus-circle mr-1"></i> เพิ่ม Job ใหม่
                    </button>
                </div>
                <div id="job-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
            </section>

            <!-- Selected Job Details -->
            <section id="job-details-section" class="mt-8 hidden">
                <div class="p-6 bg-white rounded-2xl shadow-lg">
                    <div class="flex flex-wrap items-start justify-between pb-4 mb-4 border-b">
                        <div>
                            <div class="flex items-center">
                                <h3 id="job-title" class="text-3xl font-bold text-gray-800"></h3>
                                <button id="edit-job-details-btn" class="ml-3 text-gray-400 hover:text-purple-600 admin-only"><i class="ph ph-pencil-simple"></i></button>
                            </div>
                            <p id="job-dates" class="text-gray-500"></p>
                            <p id="job-location" class="flex items-center mt-1 text-gray-500"><i class="ph ph-map-pin mr-2"></i><span id="job-location-text"></span></p>
                        </div>
                        <div class="text-right mt-4 sm:mt-0">
                            <p class="text-gray-500">งบประมาณ</p>
                            <div class="flex items-center justify-end">
                                <p id="job-income" class="text-3xl font-bold text-purple-600"></p>
                                <button id="edit-budget-btn" class="ml-2 text-gray-400 hover:text-purple-600 admin-only"><i class="ph ph-pencil-simple"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <h4 class="text-xl font-semibold mb-4">ทีมงาน</h4>
                            <div class="overflow-x-auto"><table class="min-w-full bg-white"><thead id="schedule-head"></thead><tbody id="schedule-body"></tbody></table></div>
                            <div class="mt-4 flex space-x-2">
                                <button id="add-member-button" class="px-3 py-2 text-sm font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 admin-only"><i class="ph ph-user-plus mr-1"></i> เพิ่มสมาชิก</button>
                                <button id="add-day-button" class="px-3 py-2 text-sm font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 admin-only"><i class="ph ph-calendar-plus mr-1"></i> เพิ่มวันทำงาน</button>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-4"><h4 class="text-xl font-semibold">ค่าใช้จ่ายอื่นๆ</h4><button id="add-expense-button" class="px-3 py-2 text-sm font-semibold text-white bg-orange-500 rounded-lg hover:bg-orange-600 admin-only"><i class="ph ph-plus mr-1"></i> เพิ่ม</button></div>
                            <div id="expense-list" class="space-y-2"></div>
                        </div>
                    </div>
                    <div class="mt-8 pt-6 border-t-2 border-dashed">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="text-xl font-semibold mb-4">สรุปค่าใช้จ่าย</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center"><p>ค่าทีมงานรวม</p><p id="summary-team-cost" class="font-semibold">0 บาท</p></div>
                                    <div class="flex justify-between items-center"><p>ค่าใช้จ่ายอื่นๆ รวม</p><p id="summary-other-expenses" class="font-semibold">0 บาท</p></div>
                                    <hr>
                                    <div class="flex justify-between items-center"><div class="flex items-center"><input type="checkbox" id="wht-toggle" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500"><label for="wht-toggle" class="ml-2">หัก ณ ที่จ่าย (<input type="number" id="wht-percent" value="3" class="w-12 text-center bg-gray-100 rounded">%)</label></div><p id="summary-wht" class="font-semibold">0 บาท</p></div>
                                    <div class="flex justify-between items-center"><div class="flex items-center"><input type="checkbox" id="vat-toggle" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500"><label for="vat-toggle" class="ml-2">VAT (7%)</label></div><p id="summary-vat" class="font-semibold">0 บาท</p></div>
                                    <hr>
                                    <div class="flex justify-between items-center text-lg font-bold"><p>รวมค่าใช้จ่ายทั้งหมด</p><p id="summary-total-cost" class="text-red-500">0 บาท</p></div>
                                </div>
                            </div>
                            <div class="flex flex-col items-center justify-center p-6 rounded-2xl bg-gray-50"><p id="profit-loss-label" class="text-2xl font-semibold">กำไร</p><p id="summary-profit-loss" class="text-5xl font-bold mt-2">0.00 บาท</p></div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="user-management-section" class="mt-8 admin-only">
                <h2 class="text-2xl font-semibold mb-4">การจัดการผู้ใช้</h2>
                <div class="bg-white rounded-2xl shadow-lg p-6"><div id="user-list" class="space-y-4"></div></div>
            </section>
        </div>
    </div>

    <!-- Modals Container -->
    <div id="modals-container"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- START: PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
          apiKey: "AIzaSyAedyGR43aEAO_BFufGmplJVuGkmIEYgG0",
          authDomain: "job-queue-app.firebaseapp.com",
          projectId: "job-queue-app",
          storageBucket: "job-queue-app.appspot.com",
          messagingSenderId: "247047529613",
          appId: "1:247047529613:web:d27a980d1de33c22052ec4"
        };
        // --- END: PASTE YOUR FIREBASE CONFIG HERE ---

        // EDIT 3: Cloudinary Configuration
        // **สำคัญ:** ไปที่ Cloudinary -> Settings -> Upload -> Upload presets
        // สร้าง Upload Preset ใหม่ ตั้งค่า "Signing Mode" เป็น "Unsigned" แล้วคัดลอก "Upload preset name" มาใส่ที่นี่
        const CLOUDINARY_UPLOAD_PRESET = "YOUR_UNSIGNED_UPLOAD_PRESET"; // <--- ใส่ Upload Preset ของคุณที่นี่
        const CLOUDINARY_CLOUD_NAME = "YOUR_CLOUD_NAME"; // <--- ใส่ Cloud Name ของคุณที่นี่
        const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;


        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, currentUserData = null, currentUserRole = null;
        let currentJobId = null, currentJobData = null;
        let jobUnsubscribe = null, usersUnsubscribe = null;
        let allUsers = [];

        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    currentUserData = userDocSnap.data();
                    currentUserRole = currentUserData.role;
                    if (currentUserData.forcePasswordChange) showLoginScreen(null, true);
                    else await initializeAppUI();
                } else {
                    const newUserDoc = { email: user.email, name: user.email.split('@')[0], nickname: '', role: 'member', forcePasswordChange: false, profilePic: '' };
                    try {
                        await setDoc(userDocRef, newUserDoc);
                        currentUserData = newUserDoc;
                        currentUserRole = 'member';
                        await initializeAppUI();
                    } catch (error) { showLoginScreen("เกิดข้อผิดพลาดในการตั้งค่าบัญชีผู้ใช้"); }
                }
            } else {
                currentUser = null; currentUserData = null; currentUserRole = null;
                showLoginScreen();
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const identifier = e.target.loginIdentifier.value;
            const password = e.target.password.value;
            const loginError = document.getElementById('login-error');
            loginError.classList.add('hidden');
            let emailToLogin = identifier;

            // EDIT 2: Login with email or nickname
            if (!identifier.includes('@')) {
                // It's a nickname, find the corresponding email
                // NOTE: For better performance in a large database, create an index on the 'nickname' field in Firestore.
                const q = query(collection(db, "users"), where("nickname", "==", identifier));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    loginError.textContent = "ชื่อเล่นนี้ไม่มีอยู่ในระบบ";
                    loginError.classList.remove('hidden');
                    return;
                }
                // Assuming nicknames are unique
                emailToLogin = querySnapshot.docs[0].data().email;
            }

            signInWithEmailAndPassword(auth, emailToLogin, password)
                .catch(error => {
                    loginError.textContent = "ข้อมูลเข้าระบบไม่ถูกต้อง";
                    loginError.classList.remove('hidden');
                });
        });
        
        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const passwordError = document.getElementById('password-error');
            if (newPassword.length < 6) {
                passwordError.textContent = "รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร";
                passwordError.classList.remove('hidden');
                return;
            }
            try {
                await updatePassword(currentUser, newPassword);
                await updateDoc(doc(db, "users", currentUser.uid), { forcePasswordChange: false });
                document.getElementById('change-password-modal').classList.add('hidden');
                await initializeAppUI();
            } catch (error) {
                passwordError.textContent = "ไม่สามารถเปลี่ยนรหัสผ่านได้: " + error.message;
                passwordError.classList.remove('hidden');
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            if (jobUnsubscribe) jobUnsubscribe();
            if (usersUnsubscribe) usersUnsubscribe();
            signOut(auth);
        });

        function showLoginScreen(errorMsg = null, showChangePassword = false) {
            loginScreen.classList.toggle('hidden', showChangePassword);
            mainApp.classList.add('hidden');
            document.getElementById('change-password-modal').classList.toggle('hidden', !showChangePassword);
            if(errorMsg) {
                const loginError = document.getElementById('login-error');
                loginError.textContent = errorMsg;
                loginError.classList.remove('hidden');
            }
        }

        async function initializeAppUI() {
            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            document.getElementById('user-name-display').textContent = currentUserData.nickname || currentUserData.name;
            document.getElementById('user-role').textContent = currentUserRole;
            document.getElementById('user-id-display').textContent = currentUser.uid;
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = currentUserRole === 'admin' ? '' : 'none';
            });
            listenForJobs();
            listenForUsers();
        }

        function listenForJobs() {
            onSnapshot(collection(db, "jobs"), (snapshot) => {
                const jobList = document.getElementById('job-list');
                jobList.innerHTML = '';
                snapshot.forEach(doc => {
                    const job = doc.data();
                    jobList.innerHTML += `<div class="job-card cursor-pointer p-4 rounded-2xl shadow-md hover:shadow-xl transition-shadow bg-white" data-id="${doc.id}"><div class="w-full h-16 flex items-center justify-center rounded-lg bg-gray-100 mb-2"><i class="ph-fill ph-video-camera text-3xl text-gray-500"></i></div><h5 class="font-semibold truncate">${job.name}</h5><p class="text-xs text-gray-500">${formatDateRange(job.startDate, job.endDate)}</p></div>`;
                });
                document.querySelectorAll('.job-card').forEach(card => card.addEventListener('click', () => selectJob(card.dataset.id)));
            });
        }
        
        function listenForUsers() {
            if (usersUnsubscribe) usersUnsubscribe();
            usersUnsubscribe = onSnapshot(collection(db, "users"), (snapshot) => {
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentUserRole === 'admin') renderUserManagementSection();
            });
        }
        
        function selectJob(jobId) {
            currentJobId = jobId;
            document.getElementById('job-details-section').classList.remove('hidden');
            document.querySelectorAll('.job-card').forEach(card => {
                card.classList.toggle('gradient-bg', card.dataset.id === jobId);
                card.classList.toggle('text-white', card.dataset.id === jobId);
                card.classList.toggle('bg-white', card.dataset.id !== jobId);
            });
            if (jobUnsubscribe) jobUnsubscribe();
            jobUnsubscribe = onSnapshot(doc(db, "jobs", jobId), (docSnap) => {
                if (docSnap.exists()) {
                    currentJobData = docSnap.data();
                    renderJobDetails(currentJobData);
                } else {
                    document.getElementById('job-details-section').classList.add('hidden');
                }
            });
        }

        function renderJobDetails(job) {
            document.getElementById('job-title').textContent = job.name;
            document.getElementById('job-dates').textContent = `${formatDateRange(job.startDate, job.endDate)} (${job.workdays.length} วัน)`;
            document.getElementById('job-location-text').textContent = job.location;
            document.getElementById('job-income').textContent = `${job.income.toLocaleString()} บาท`;
            let headHTML = '<tr><th class="py-2 px-3 border-b text-left">ชื่อ</th>';
            job.workdays.forEach(day => {
                headHTML += `<th class="py-2 px-3 border-b text-center relative date-header">${formatShortDate(day)}<div class="absolute top-0 right-0 flex date-action-btn opacity-0 transition-opacity admin-only"><button class="edit-day-btn text-blue-500 hover:text-blue-700" data-day="${day}"><i class="ph-bold ph-pencil-simple text-xs"></i></button><button class="delete-day-btn text-red-500 hover:text-red-700" data-day="${day}"><i class="ph-bold ph-x-circle text-xs"></i></button></div></th>`;
            });
            headHTML += '<th class="py-2 px-3 border-b text-center admin-only">จัดการ</th></tr>';
            document.getElementById('schedule-head').innerHTML = headHTML;
            const scheduleBody = document.getElementById('schedule-body');
            scheduleBody.innerHTML = '';
            job.team.forEach((member, index) => {
                const memberData = allUsers.find(u => u.id === member.userId);
                if (!memberData) return;
                const displayName = memberData.nickname || memberData.name;
                let rowHTML = `<tr class="hover:bg-gray-50"><td class="py-2 px-3 border-b"><div class="flex items-center"><img src="${memberData.profilePic || 'https://placehold.co/40x40/E2E8F0/4A5568?text=??'}" class="w-8 h-8 rounded-full mr-3"><div><p class="font-medium">${displayName} ${index === 0 ? '<i class="ph-fill ph-crown text-yellow-500"></i>' : ''}</p><p class="text-xs text-gray-500">${member.position}</p></div></div></td>`;
                job.workdays.forEach(day => {
                    const isWorking = member.workdays.includes(day);
                    const dailyRate = (member.dailyOverrides && member.dailyOverrides[day] !== undefined) ? member.dailyOverrides[day] : member.dailyRate;
                    rowHTML += `<td class="py-2 px-3 border-b text-center"><div class="flex flex-col items-center justify-center space-y-1"><button class="custom-checkbox schedule-checkbox ${isWorking ? 'checked' : ''}" data-userid="${member.userId}" data-day="${day}"><i class="ph-bold ph-check text-lg"></i></button><span class="text-xs text-gray-500 hover:text-blue-600 cursor-pointer edit-daily-rate-btn" data-userid="${member.userId}" data-day="${day}">${dailyRate.toLocaleString()}</span></div></td>`;
                });
                rowHTML += `<td class="py-2 px-3 border-b text-center admin-only"><button class="text-blue-500 hover:text-blue-700 mr-2 edit-member-btn" data-userid="${member.userId}"><i class="ph ph-pencil-simple"></i></button><button class="text-red-500 hover:text-red-700 remove-member-btn" data-userid="${member.userId}"><i class="ph ph-trash"></i></button></td></tr>`;
                scheduleBody.innerHTML += rowHTML;
            });
            const expenseList = document.getElementById('expense-list');
            expenseList.innerHTML = '';
            job.expenses.forEach((expense, index) => {
                expenseList.innerHTML += `<div class="flex justify-between items-center p-2 rounded-lg hover:bg-gray-100"><div><p>${expense.name}</p></div><div class="flex items-center space-x-3"><p class="font-semibold">${expense.amount.toLocaleString()}</p><button class="text-red-500 hover:text-red-700 remove-expense-btn admin-only" data-index="${index}"><i class="ph ph-x-circle"></i></button></div></div>`;
            });
            updateCalculations(job);
            document.querySelectorAll('.admin-only').forEach(el => { el.style.display = currentUserRole === 'admin' ? '' : 'none'; });
            addDynamicEventListeners(job);
        }
        
        function updateCalculations(job) {
            const teamTotalCost = job.team.reduce((total, member) => total + calculateTeamCostForMember(member, job.workdays), 0);
            const otherExpensesTotal = job.expenses.reduce((total, expense) => total + expense.amount, 0);
            document.getElementById('summary-team-cost').textContent = `${teamTotalCost.toLocaleString()} บาท`;
            document.getElementById('summary-other-expenses').textContent = `${otherExpensesTotal.toLocaleString()} บาท`;
            const whtPercent = parseFloat(document.getElementById('wht-percent').value) || 0;
            const subtotal = teamTotalCost + otherExpensesTotal;
            const whtAmount = document.getElementById('wht-toggle').checked ? (job.income * whtPercent / 100) : 0;
            const vatAmount = document.getElementById('vat-toggle').checked ? (subtotal * 0.07) : 0;
            const totalCost = subtotal + vatAmount;
            const profitLoss = job.income - totalCost - whtAmount;
            document.getElementById('summary-wht').textContent = `${whtAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท`;
            document.getElementById('summary-vat').textContent = `${vatAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท`;
            document.getElementById('summary-total-cost').textContent = `${totalCost.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท`;
            const profitLossEl = document.getElementById('summary-profit-loss');
            profitLossEl.textContent = `${profitLoss.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท`;
            profitLossEl.className = `text-5xl font-bold mt-2 ${profitLoss >= 0 ? 'profit-text' : 'loss-text'}`;
            document.getElementById('profit-loss-label').textContent = profitLoss >= 0 ? 'กำไร' : 'ขาดทุน';
        }

        function addDynamicEventListeners(job) {
            ['wht-toggle', 'wht-percent', 'vat-toggle'].forEach(id => { document.getElementById(id).oninput = () => updateCalculations(job); });
            document.querySelectorAll('.schedule-checkbox').forEach(box => {
                box.onclick = async (e) => {
                    const button = e.currentTarget;
                    button.classList.toggle('checked');
                    const isChecked = button.classList.contains('checked');
                    const { userid, day } = button.dataset;
                    const teamMember = currentJobData.team.find(m => m.userId === userid);
                    if (isChecked) { if (!teamMember.workdays.includes(day)) teamMember.workdays.push(day); } 
                    else { teamMember.workdays = teamMember.workdays.filter(d => d !== day); }
                    await updateDoc(doc(db, "jobs", currentJobId), { team: currentJobData.team });
                };
            });
            document.querySelectorAll('.edit-member-btn').forEach(btn => btn.onclick = (e) => showEditMemberModal(job.team.find(m => m.userId === e.currentTarget.dataset.userid)));
            document.querySelectorAll('.remove-member-btn').forEach(btn => btn.onclick = (e) => showConfirmModal('ยืนยันการลบ', 'คุณต้องการลบสมาชิกคนนี้ออกจาก Job หรือไม่?', async () => await updateDoc(doc(db, "jobs", currentJobId), { team: arrayRemove(job.team.find(m => m.userId === e.currentTarget.dataset.userid)) })));
            document.querySelectorAll('.remove-expense-btn').forEach(btn => btn.onclick = (e) => showConfirmModal('ยืนยันการลบ', 'คุณต้องการลบค่าใช้จ่ายรายการนี้หรือไม่?', async () => {
                currentJobData.expenses.splice(parseInt(e.currentTarget.dataset.index), 1);
                await updateDoc(doc(db, "jobs", currentJobId), { expenses: currentJobData.expenses });
            }));
            document.querySelectorAll('.delete-day-btn').forEach(btn => btn.onclick = (e) => {
                const dayToDelete = e.currentTarget.dataset.day;
                showConfirmModal('ยืนยันการลบวัน', `คุณต้องการลบวันที่ ${formatShortDate(dayToDelete)} หรือไม่?`, async () => {
                    currentJobData.workdays = currentJobData.workdays.filter(d => d !== dayToDelete);
                    currentJobData.team.forEach(member => {
                        member.workdays = member.workdays.filter(d => d !== dayToDelete);
                        if (member.dailyOverrides) delete member.dailyOverrides[dayToDelete];
                    });
                    await updateDoc(doc(db, "jobs", currentJobId), { workdays: currentJobData.workdays, team: currentJobData.team });
                });
            });
            document.querySelectorAll('.edit-daily-rate-btn').forEach(btn => btn.onclick = (e) => showEditDailyRateModal(e.currentTarget.dataset.userid, e.currentTarget.dataset.day));
            document.querySelectorAll('.edit-day-btn').forEach(btn => btn.onclick = (e) => showEditWorkdayModal(e.currentTarget.dataset.day));
        }
        
        ['add-job-button', 'add-member-button', 'add-day-button', 'add-expense-button', 'edit-budget-btn', 'edit-job-details-btn', 'manage-profile-button'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('click', () => {
                switch(id) {
                    case 'add-job-button': showJobModal(); break;
                    case 'add-member-button': showAddMemberModal(); break;
                    case 'add-day-button': showAddDayModal(); break;
                    case 'add-expense-button': showExpenseModal(); break;
                    case 'edit-budget-btn': showEditBudgetModal(currentJobData.income); break;
                    case 'edit-job-details-btn': showEditJobDetailsModal(currentJobData); break;
                    case 'manage-profile-button': showManageProfileModal(); break;
                }
            });
        });

        function calculateTeamCostForMember(member, workdays) {
            return member.workdays.reduce((total, day) => {
                if (workdays.includes(day)) {
                    const rate = (member.dailyOverrides && member.dailyOverrides[day] !== undefined) ? member.dailyOverrides[day] : member.dailyRate;
                    return total + rate;
                }
                return total;
            }, 0);
        }
        function formatDateRange(start, end) {
            if (!start || !end) return 'N/A';
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return `${new Date(start).toLocaleDateString('th-TH', options)} - ${new Date(end).toLocaleDateString('th-TH', options)}`;
        }
        function formatShortDate(dateString) { return new Date(dateString).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }); }
        
        function showModal(title, contentHTML, onSave, showSaveButton = true) {
            const modalId = `modal-${Date.now()}`;
            document.getElementById('modals-container').innerHTML = `<div id="${modalId}" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop"><div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 m-4 modal-content"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">${title}</h3><button class="text-gray-400 hover:text-gray-600 text-2xl close-modal-btn">&times;</button></div><form class="modal-form space-y-4">${contentHTML}<div class="flex justify-end space-x-3 pt-4"><button type="button" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 close-modal-btn">ยกเลิก</button>${showSaveButton ? '<button type="submit" class="px-4 py-2 text-white gradient-bg rounded-lg hover:opacity-90">บันทึก</button>' : ''}</div></form></div></div>`;
            const modal = document.getElementById(modalId);
            if (showSaveButton) {
                modal.querySelector('.modal-form').onsubmit = (e) => { e.preventDefault(); onSave(new FormData(e.target), modal.querySelector('button[type="submit"]')); modal.remove(); };
            }
            modal.querySelectorAll('.close-modal-btn').forEach(btn => btn.onclick = () => modal.remove());
        }

        function showConfirmModal(title, message, onConfirm) {
            const modalId = `confirm-modal-${Date.now()}`;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `<div id="${modalId}" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop"><div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 m-4 modal-content text-center"><h3 class="text-xl font-semibold">${title}</h3><p class="text-gray-600 mt-2">${message}</p><div class="flex justify-center space-x-4 pt-4 mt-4"><button type="button" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 close-confirm-btn">ยกเลิก</button><button type="button" class="px-6 py-2 text-white bg-red-500 rounded-lg hover:bg-red-600 confirm-btn">ยืนยัน</button></div></div></div>`;
            const modal = tempDiv.firstElementChild;
            document.getElementById('modals-container').appendChild(modal);
            const closeModal = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = () => { onConfirm(); closeModal(); };
            modal.querySelector('.close-confirm-btn').onclick = closeModal;
        }

        async function uploadToCloudinary(file) {
            if (!file) return null;
            if (CLOUDINARY_CLOUD_NAME === "YOUR_CLOUD_NAME" || CLOUDINARY_UPLOAD_PRESET === "YOUR_UNSIGNED_UPLOAD_PRESET") {
                alert("กรุณาตั้งค่า Cloudinary Cloud Name และ Upload Preset ในโค้ดก่อน");
                return null;
            }
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            try {
                const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                const data = await response.json();
                if (data.secure_url) return data.secure_url;
                else throw new Error('Cloudinary upload failed');
            } catch (error) {
                console.error('Cloudinary upload error:', error);
                alert("การอัปโหลดรูปภาพล้มเหลว");
                return null;
            }
        }

        function showJobModal() {
            const content = `<input type="text" name="name" placeholder="ชื่อ Job" required class="w-full p-2 border rounded"><input type="text" name="location" placeholder="สถานที่" required class="w-full p-2 border rounded"><input type="number" name="income" placeholder="งบประมาณ" required class="w-full p-2 border rounded"><label>วันที่เริ่ม</label><input type="date" name="startDate" required class="w-full p-2 border rounded"><label>วันที่สิ้นสุด</label><input type="date" name="endDate" required class="w-full p-2 border rounded">`;
            showModal('สร้าง Job ใหม่', content, async (formData) => {
                const startDate = formData.get('startDate'), endDate = formData.get('endDate');
                let workdays = [];
                for (let d = new Date(startDate); d <= new Date(endDate); d.setDate(d.getDate() + 1)) { workdays.push(new Date(d).toISOString().split('T')[0]); }
                await addDoc(collection(db, "jobs"), { name: formData.get('name'), location: formData.get('location'), income: Number(formData.get('income')), startDate, endDate, workdays, team: [], expenses: [] });
            });
        }
        
        function showAddMemberModal() {
            const userOptions = allUsers.map(u => `<option value="${u.id}">${u.nickname || u.name} (${u.email})</option>`).join('');
            const content = `<select name="userId" required class="w-full p-2 border rounded">${userOptions}</select><input type="text" name="position" placeholder="ตำแหน่ง" required class="w-full p-2 border rounded"><input type="number" name="dailyRate" placeholder="ค่าแรง/วัน" required class="w-full p-2 border rounded">`;
            showModal('เพิ่มสมาชิกในทีม', content, async (formData) => await updateDoc(doc(db, "jobs", currentJobId), { team: arrayUnion({ userId: formData.get('userId'), position: formData.get('position'), dailyRate: Number(formData.get('dailyRate')), workdays: [], dailyOverrides: {} })}));
        }
        
        function showEditMemberModal(member) {
            const content = `<input type="text" name="position" required class="w-full p-2 border rounded" value="${member.position}"><input type="number" name="dailyRate" required class="w-full p-2 border rounded" value="${member.dailyRate}">`;
            showModal('แก้ไขข้อมูลสมาชิก', content, async (formData) => {
                const teamMember = currentJobData.team.find(m => m.userId === member.userId);
                if (teamMember) { teamMember.position = formData.get('position'); teamMember.dailyRate = Number(formData.get('dailyRate')); }
                await updateDoc(doc(db, "jobs", currentJobId), { team: currentJobData.team });
            });
        }
        
        function showEditBudgetModal(currentBudget) {
            showModal('แก้ไขงบประมาณ', `<input type="number" name="budget" required class="w-full p-2 border rounded" value="${currentBudget}">`, async (formData) => await updateDoc(doc(db, "jobs", currentJobId), { income: Number(formData.get('budget')) }));
        }
        
        function showAddDayModal() {
            showModal('เพิ่มวันทำงาน', `<label>เลือกวันที่ต้องการเพิ่ม</label><input type="date" name="newDay" required class="w-full p-2 border rounded">`, async (formData) => {
                const newDay = formData.get('newDay');
                currentJobData.workdays.push(newDay);
                currentJobData.workdays.sort((a, b) => new Date(a) - new Date(b));
                await updateDoc(doc(db, "jobs", currentJobId), { workdays: currentJobData.workdays });
            });
        }

        function showExpenseModal() {
            const content = `<input type="text" name="name" placeholder="ชื่อรายการ" required class="w-full p-2 border rounded"><input type="number" name="amount" placeholder="จำนวนเงิน" required class="w-full p-2 border rounded">`;
            showModal('เพิ่มค่าใช้จ่าย', content, async (formData) => await updateDoc(doc(db, "jobs", currentJobId), { expenses: arrayUnion({ name: formData.get('name'), amount: Number(formData.get('amount')) })}));
        }

        function showEditDailyRateModal(userId, day) {
            const member = currentJobData.team.find(m => m.userId === userId);
            const currentRate = (member.dailyOverrides && member.dailyOverrides[day] !== undefined) ? member.dailyOverrides[day] : member.dailyRate;
            const content = `<label>ค่าแรงสำหรับวันที่ ${formatShortDate(day)}</label><input type="number" name="rate" required class="w-full p-2 border rounded" value="${currentRate}">`;
            showModal('แก้ไขค่าแรงรายวัน', content, async (formData) => {
                const newRate = Number(formData.get('rate'));
                if (!member.dailyOverrides) member.dailyOverrides = {};
                member.dailyOverrides[day] = newRate;
                await updateDoc(doc(db, "jobs", currentJobId), { team: currentJobData.team });
            });
        }

        function showEditJobDetailsModal(job) {
            const content = `<label>ชื่องาน</label><input type="text" name="name" required class="w-full p-2 border rounded" value="${job.name}"><label>สถานที่</label><input type="text" name="location" required class="w-full p-2 border rounded" value="${job.location}"><label>วันที่เริ่ม</label><input type="date" name="startDate" required class="w-full p-2 border rounded" value="${job.startDate}"><label>วันที่สิ้นสุด</label><input type="date" name="endDate" required class="w-full p-2 border rounded" value="${job.endDate}">`;
            showModal('แก้ไขข้อมูล Job', content, async (formData) => await updateDoc(doc(db, "jobs", currentJobId), { name: formData.get('name'), location: formData.get('location'), startDate: formData.get('startDate'), endDate: formData.get('endDate') }));
        }
        
        function showEditWorkdayModal(oldDay) {
            const content = `<label>แก้ไขวันที่จาก ${formatShortDate(oldDay)} เป็น</label><input type="date" name="newDay" required class="w-full p-2 border rounded" value="${oldDay}">`;
            showModal('แก้ไขวันทำงาน', content, async (formData) => {
                const newDay = formData.get('newDay');
                const dayIndex = currentJobData.workdays.indexOf(oldDay);
                if (dayIndex > -1) currentJobData.workdays[dayIndex] = newDay;
                currentJobData.workdays.sort((a, b) => new Date(a) - new Date(b));
                currentJobData.team.forEach(member => {
                    const memberDayIndex = member.workdays.indexOf(oldDay);
                    if (memberDayIndex > -1) member.workdays[memberDayIndex] = newDay;
                    if (member.dailyOverrides && member.dailyOverrides[oldDay] !== undefined) {
                        member.dailyOverrides[newDay] = member.dailyOverrides[oldDay];
                        delete member.dailyOverrides[oldDay];
                    }
                });
                await updateDoc(doc(db, "jobs", currentJobId), { workdays: currentJobData.workdays, team: currentJobData.team });
            });
        }

        function renderUserManagementSection() {
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            allUsers.forEach(user => {
                const displayName = user.nickname || user.name;
                const userCard = `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><div class="flex items-center"><img src="${user.profilePic || 'https://placehold.co/40x40/E2E8F0/4A5568?text=??'}" class="w-10 h-10 rounded-full mr-4"><div><p class="font-semibold">${displayName}</p><p class="text-sm text-gray-500">${user.email} - <span class="font-medium">${user.role}</span></p></div></div><div class="flex items-center space-x-2"><button class="edit-user-btn p-2 text-blue-500 hover:bg-blue-100 rounded-full" data-userid="${user.id}"><i class="ph ph-pencil-simple"></i></button><button class="delete-user-btn p-2 text-red-500 hover:bg-red-100 rounded-full" data-userid="${user.id}"><i class="ph ph-trash"></i></button></div></div>`;
                userList.innerHTML += userCard;
            });
            document.querySelectorAll('.edit-user-btn').forEach(btn => btn.onclick = (e) => showAdminEditUserModal(allUsers.find(u => u.id === e.currentTarget.dataset.userid)));
            document.querySelectorAll('.delete-user-btn').forEach(btn => btn.onclick = (e) => {
                const userIdToDelete = e.currentTarget.dataset.userid;
                if (userIdToDelete === currentUser.uid) { alert("ไม่สามารถลบตัวเองได้"); return; }
                showConfirmModal('ยืนยันการลบผู้ใช้', 'คุณต้องการลบข้อมูลผู้ใช้นี้ใช่หรือไม่? (การกระทำนี้จะลบข้อมูลจากฐานข้อมูล แต่จะไม่ลบบัญชีล็อกอิน)', async () => await deleteDoc(doc(db, "users", userIdToDelete)));
            });
        }

        function showManageProfileModal() {
            const content = `<label>ชื่อจริง</label><input type="text" name="name" required class="w-full p-2 border rounded" value="${currentUserData.name}"><label>ชื่อเล่น</label><input type="text" name="nickname" class="w-full p-2 border rounded" value="${currentUserData.nickname || ''}"><label>รูปโปรไฟล์</label><input type="file" name="profilePicFile" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/><hr><button type="button" id="change-password-from-profile-btn" class="w-full text-left text-blue-600 hover:underline">เปลี่ยนรหัสผ่าน</button>`;
            showModal('จัดการโปรไฟล์', content, async (formData, submitButton) => {
                submitButton.textContent = 'กำลังบันทึก...';
                submitButton.disabled = true;
                const profilePicFile = formData.get('profilePicFile');
                let newProfilePicUrl = currentUserData.profilePic;
                if (profilePicFile && profilePicFile.size > 0) {
                    newProfilePicUrl = await uploadToCloudinary(profilePicFile);
                }
                const updatedData = {
                    name: formData.get('name'),
                    nickname: formData.get('nickname'),
                    profilePic: newProfilePicUrl
                };
                await updateDoc(doc(db, "users", currentUser.uid), updatedData);
                currentUserData = {...currentUserData, ...updatedData};
                document.getElementById('user-name-display').textContent = currentUserData.nickname || currentUserData.name;
            }, true);
            document.getElementById('change-password-from-profile-btn').onclick = () => { document.querySelector('.close-modal-btn').click(); showChangePasswordForCurrentUserModal(); };
        }
        
        function showChangePasswordForCurrentUserModal() {
             const content = `<label>รหัสผ่านใหม่</label><input type="password" name="newPassword" required class="w-full p-2 border rounded">`;
             showModal('เปลี่ยนรหัสผ่าน', content, async (formData) => {
                const newPassword = formData.get('newPassword');
                if (newPassword.length < 6) { alert("รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร"); return; }
                try { await updatePassword(currentUser, newPassword); alert("เปลี่ยนรหัสผ่านสำเร็จแล้ว"); } 
                catch(error) { alert("การเปลี่ยนรหัสผ่านล้มเหลว: " + error.message); }
             });
        }

        function showAdminEditUserModal(user) {
            // EDIT 1: Make email readonly and add tooltip
            const content = `
                <label>อีเมล (ไม่สามารถแก้ไขได้)</label>
                <div class="flex items-center">
                    <input type="email" readonly class="w-full p-2 border rounded bg-gray-100" value="${user.email}">
                    <div class="tooltip ml-2">
                        <i class="ph-fill ph-info-in-motion text-gray-500"></i>
                        <span class="tooltiptext">การเปลี่ยนอีเมลล็อกอินต้องทำใน Firebase Console โดยตรงเพื่อความปลอดภัย</span>
                    </div>
                </div>
                <label>ชื่อจริง</label><input type="text" name="name" required class="w-full p-2 border rounded" value="${user.name}">
                <label>ชื่อเล่น</label><input type="text" name="nickname" class="w-full p-2 border rounded" value="${user.nickname || ''}">
                <label>รูปโปรไฟล์</label><input type="file" name="profilePicFile" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/>
                <label>บทบาท (Role)</label>
                <select name="role" class="w-full p-2 border rounded">
                    <option value="member" ${user.role === 'member' ? 'selected' : ''}>Member</option>
                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                </select>`;
            showModal(`แก้ไขผู้ใช้: ${user.email}`, content, async (formData, submitButton) => {
                submitButton.textContent = 'กำลังบันทึก...';
                submitButton.disabled = true;
                const profilePicFile = formData.get('profilePicFile');
                let newProfilePicUrl = user.profilePic;
                if (profilePicFile && profilePicFile.size > 0) {
                    newProfilePicUrl = await uploadToCloudinary(profilePicFile);
                }
                await updateDoc(doc(db, "users", user.id), {
                    name: formData.get('name'),
                    nickname: formData.get('nickname'),
                    profilePic: newProfilePicUrl,
                    role: formData.get('role')
                });
            });
        }

    </script>
</body>
</html>
