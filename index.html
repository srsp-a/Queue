<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDB QUEUE - Job Management</title>

    <link id="favicon-link" rel="icon" href="">
    <!-- Open Graph Meta Tags for Facebook, LINE, etc. -->
    <meta property="og:title" content="LDB QUEUE ระบบจัดการคิวงานออนไลน์" />
    <meta property="og:description" content="วางแผน ติดตาม และจัดการคิวงานทีมงานได้แบบง่ายๆ" />
    <meta property="og:image" content="https://res.cloudinary.com/dzs7zbikj/image/upload/v1754123468/g988nfpjbs17tohaqzrl.jpg" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://q.liveder.tv/" />
    <meta property="og:site_name" content="LIVEDER.TV" />
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- jsPDF library for exporting summaries to PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        #app-container {
            flex-grow: 1;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #ef4444 0%, #ec4899 100%);
        }
        .main-gradient-text {
            background: linear-gradient(90deg, #ef4444, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .profit-text {
            color: #22c55e; /* green-500 */
        }
        .loss-text {
            color: #ef4444; /* red-500 */
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        .hidden {
            display: none;
        }
        .date-header:hover .date-action-btn {
            opacity: 1;
        }
        .custom-checkbox {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #d1d5db; /* gray-300 */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #f9fafb; /* gray-50 */
        }
        .custom-checkbox.checked {
            background-color: #22c55e; /* green-500 */
            border-color: #22c55e;
        }
        .custom-checkbox .ph-check {
            color: white;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .custom-checkbox.checked .ph-check {
            opacity: 1;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .dragging {
            opacity: 0.5;
            background: #fef9c3; /* yellow-100 */
        }
        .drag-over {
            border-top: 2px solid #ef4444;
        }
        #financial-filter-buttons .active, #show-custom-range-btn.active, #member-financial-filters .active {
            background-color: #ec4899;
            color: white;
        }
        .drag-handle {
            cursor: grab;
            opacity: 0.2;
            transition: opacity 0.2s;
        }
        tr:hover .drag-handle {
            opacity: 1;
        }
        .job-card-title {
            height: 3rem; /* Height for 2 lines */
            line-height: 1.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }
        .job-card-location {
            height: 2.5rem; /* Height for 2 lines with smaller text */
            line-height: 1.25rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }
        /* Fix for selected card text color */
        .job-card.gradient-bg .job-team-status.loss-text,
        .job-card.gradient-bg .job-team-status.profit-text {
            color: white !important;
        }

        /* When a job card is selected and uses the gradient background, override
           the team status text colour and progress bar to ensure readability. */
        .job-card.gradient-bg .job-team-status span {
            color: white !important;
        }
        .job-card.gradient-bg .job-team-status .h-full {
            /* lighten the progress bar on selected cards */
            background-color: rgba(255, 255, 255, 0.4) !important;
        }

        /* Mobile-specific adjustments */
        @media (max-width: 640px) {
            /* Collapse job card details for all cards */
            .job-card.mobile-collapsed p {
                /* hide all paragraphs (date, location, status) */
                display: none;
            }
            .job-card.mobile-collapsed .job-card-location {
                display: none;
            }
            .job-card.mobile-collapsed .job-team-status {
                display: none;
            }
            /* On mobile, always display the job name when collapsed.  Unselected cards will show the name in a very small font.  The selected card (mobile-show-name) will have a slightly larger font to stand out. */
            .job-card.mobile-collapsed h5 {
                display: block !important;
                font-size: 0.5rem !important;
            }
            .job-card.mobile-collapsed.mobile-show-name h5 {
                font-size: 0.8rem !important;
            }
            /* Ensure header action buttons align to the right by default on mobile (safeguard if not already pushed via ml-auto) */
            #main-app header .flex.items-center.space-x-2 {
                margin-left: auto;
            }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="impersonation-banner" class="hidden fixed top-0 left-0 right-0 bg-yellow-400 text-black p-2 text-center z-50 shadow-lg">
        กำลังดูในฐานะ: <span id="impersonated-user-name" class="font-bold"></span>
        <button id="return-to-admin-btn" class="ml-4 bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 text-sm">กลับสู่มุมมองแอดมิน</button>
    </div>

    <div id="app-container" class="min-h-screen">

        <div id="public-view" class="p-4 sm:p-6 lg:p-8">
            <header class="flex flex-wrap items-center justify-between pb-6 mb-6 border-b-2 border-gray-200">
                <div>
                    <h1 class="text-4xl font-bold main-gradient-text">LDB QUEUE</h1>
                    <p class="mt-1 text-gray-500">คิวงานทั้งหมด</p>
                </div>
            <div class="flex items-center space-x-2 md:space-x-4 mt-4 sm:mt-0">
                    <button id="public-login-button" class="px-4 py-2 font-semibold text-white gradient-bg rounded-lg hover:opacity-90">
                       <i class="ph ph-sign-in mr-1"></i> ลงชื่อเข้าใช้
                    </button>
                </div>
            </header>
            <section class="max-w-7xl mx-auto">
                <div class="flex flex-wrap items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold">รายการคิวงาน</h2>
                </div>
                <div id="public-job-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    </div>
            </section>
        </div>

        <!-- Floating action buttons for job detail actions (e.g., cancel request or edit job). These
             appear at the bottom right of the viewport when viewing a job's details. They are
             populated dynamically based on user role and job status. -->
        <div id="job-fab-actions" class="hidden fixed bottom-6 right-6 flex flex-col space-y-2 z-50"></div>

    <!-- Withholding tax list view for members -->
    <div id="withholding-list-view" class="hidden p-4 sm:p-6 lg:p-8">
        <header class="flex items-center justify-between pb-6 mb-6 border-b-2 border-gray-200">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">รายการ หัก ณ ที่จ่าย (50 ทวิ)</h1>
                <p class="mt-1 text-gray-500">สรุปคิวงานและภาษีหัก ณ ที่จ่ายของคุณ</p>
            </div>
            <button id="back-to-financial-from-wht-btn" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                <i class="ph ph-arrow-left mr-1"></i> กลับ
            </button>
        </header>
        <section class="p-4 mb-6 bg-white rounded-2xl shadow-lg">
            <div class="flex flex-wrap items-end gap-4">
                <div>
                    <label for="member-wht-month" class="text-sm font-medium text-gray-700">เดือน</label>
                    <select id="member-wht-month" class="p-2 border rounded-lg"></select>
                </div>
                <div>
                    <label for="member-wht-year" class="text-sm font-medium text-gray-700">ปี</label>
                    <select id="member-wht-year" class="p-2 border rounded-lg"></select>
                </div>
                <button id="member-wht-search-btn" class="px-6 py-2 font-semibold text-white gradient-bg rounded-lg hover:opacity-90">
                    ค้นหา
                </button>
            </div>
        </section>
        <section>
            <div class="overflow-x-auto bg-white rounded-2xl shadow-lg">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่องาน</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">รายรับ (BG)</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">หัก ณ ที่จ่าย</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">คงเหลือ</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ดาวน์โหลด</th>
                        </tr>
                    </thead>
                    <tbody id="member-wht-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">ไม่มีข้อมูล</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Withholding tax management view for admin -->
    <div id="wht-management-view" class="hidden p-4 sm:p-6 lg:p-8">
         <header class="flex items-center justify-between pb-6 mb-6 border-b-2 border-gray-200">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">จัดการภาษี หัก ณ ที่จ่าย</h1>
                <p class="mt-1 text-gray-500">รายการคิวงานที่มีการหักภาษี ณ ที่จ่าย</p>
            </div>
            <button id="back-to-financial-from-tax-btn" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                <i class="ph ph-arrow-left mr-1"></i> กลับ
            </button>
         </header>
         <section class="p-4 mb-6 bg-white rounded-2xl shadow-lg">
            <div class="flex flex-wrap items-end gap-4">
                <div>
                    <label for="admin-wht-month" class="text-sm font-medium text-gray-700">เดือน</label>
                    <select id="admin-wht-month" class="p-2 border rounded-lg"></select>
                </div>
                <div>
                    <label for="admin-wht-year" class="text-sm font-medium text-gray-700">ปี</label>
                    <select id="admin-wht-year" class="p-2 border rounded-lg"></select>
                </div>
                <button id="admin-wht-search-btn" class="px-6 py-2 font-semibold text-white gradient-bg rounded-lg hover:opacity-90">
                    ค้นหา
                </button>
                <button id="admin-wht-export-csv-btn" class="px-6 py-2 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">
                    <i class="ph ph-download-simple"></i><span class="hidden md:inline ml-1">Export CSV</span>
                </button>
                <button id="admin-wht-export-pdf-btn" class="px-6 py-2 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">
                    <i class="ph ph-file-pdf"></i><span class="hidden md:inline ml-1">Export PDF</span>
                </button>
            </div>
         </section>
         <section>
            <div class="overflow-x-auto bg-white rounded-2xl shadow-lg">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่องาน</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">รายรับ (BG)</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">หัก ณ ที่จ่าย</th>
                            <!-- เปลี่ยนหัวข้อคอลัมน์เป็นการอัปโหลด/ดูหนังสือรับรอง -->
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">หนังสือรับรอง</th>
                        </tr>
                    </thead>
                    <tbody id="admin-wht-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">ไม่มีข้อมูล</td></tr>
                    </tbody>
                </table>
            </div>
         </section>
    </div>

        <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-xl modal-content">
                <div class="text-center">
                    <h1 class="text-4xl font-bold main-gradient-text">LDB QUEUE</h1>
                    <p class="mt-2 text-gray-500">ลงชื่อเข้าใช้เพื่อจัดการคิวงาน</p>
                </div>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-identifier" class="text-sm font-medium text-gray-700">อีเมล หรือ Username</label>
                        <input id="login-identifier" name="loginIdentifier" type="text" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="อีเมล หรือ username">
                    </div>
                    <div>
                        <label for="password" class="text-sm font-medium text-gray-700">รหัสผ่าน</label>
                        <div class="relative mt-1">
                            <input id="password" name="password" type="password" required class="w-full px-4 py-2 pr-28 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="••••••••">
                            <a href="#" id="forgot-password-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 text-sm font-medium text-red-600 hover:text-red-500">ลืมรหัสผ่าน?</a>
                        </div>
                    </div>
                    <p id="login-error" class="text-sm text-red-500 hidden"></p>
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white gradient-bg rounded-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-300 disabled:opacity-75">
                        ลงชื่อเข้าใช้
                    </button>
                </form>
                <!-- Facebook login button in login modal -->
                <div id="facebook-login-container-login" class="facebook-login-container hidden mt-2">
                    <button type="button" id="facebook-login-btn-login" class="w-full flex items-center justify-center px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                        เข้าสู่ระบบด้วย Facebook
                    </button>
                </div>
                <p class="text-center text-sm text-gray-600">
                    ยังไม่มีบัญชี? <a href="#" id="show-signup-modal-btn" class="font-medium text-red-600 hover:text-red-500">สมัครสมาชิกที่นี่</a>
                </p>
                 <button id="close-login-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
        </div>

        <div id="signup-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 m-4 modal-content">
                <h2 class="text-2xl font-bold text-center">สร้างบัญชีใหม่</h2>
                <form id="signup-form" class="mt-6 space-y-4">
                    <div>
                        <label for="signup-username" class="text-sm font-medium text-gray-700">Username (อังกฤษ/ตัวเลขเท่านั้น)</label>
                        <input type="text" id="signup-username" name="username" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" pattern="[a-zA-Z0-9_]+">
                    </div>
                    <div>
                        <label for="signup-email" class="text-sm font-medium text-gray-700">อีเมล</label>
                        <input type="email" id="signup-email" name="email" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label for="signup-password" class="text-sm font-medium text-gray-700">รหัสผ่าน</label>
                        <input type="password" id="signup-password" name="password" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label for="signup-confirm-password" class="text-sm font-medium text-gray-700">ยืนยันรหัสผ่าน</label>
                        <input type="password" id="signup-confirm-password" name="confirmPassword" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                    </div>
                    <p id="signup-error" class="text-sm text-red-500 hidden"></p>
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white gradient-bg rounded-lg hover:opacity-90 disabled:opacity-75">สมัครสมาชิก</button>
                </form>
                <!-- Facebook login button in signup modal -->
                <div id="facebook-login-container-signup" class="facebook-login-container hidden mt-2">
                    <button type="button" id="facebook-login-btn-signup" class="w-full flex items-center justify-center px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                        เข้าสู่ระบบด้วย Facebook
                    </button>
                </div>
                 <p class="text-center text-sm text-gray-600 mt-4">
                    มีบัญชีอยู่แล้ว? <a href="#" id="show-login-modal-btn" class="font-medium text-red-600 hover:text-red-500">กลับไปล็อกอิน</a>
                </p>
                 <button id="close-signup-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
        </div>

        <div id="change-password-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 m-4 modal-content">
                <h2 class="text-2xl font-bold text-center">เปลี่ยนรหัสผ่านใหม่</h2>
                <p class="text-center text-gray-500 mt-2">เพื่อความปลอดภัย กรุณาตั้งรหัสผ่านใหม่สำหรับใช้งานครั้งแรก</p>
                <form id="change-password-form" class="mt-6 space-y-4">
                    <div>
                        <label for="new-password" class="text-sm font-medium text-gray-700">รหัสผ่านใหม่</label>
                        <input type="password" id="new-password" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                    </div>
                    <p id="password-error" class="text-sm text-red-500 hidden"></p>
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white gradient-bg rounded-lg hover:opacity-90">
                        ยืนยันและเข้าสู่ระบบ
                    </button>
                </form>
            </div>
        </div>

        <div id="main-app" class="hidden p-4 sm:p-6 lg:p-8">
            <header class="flex flex-wrap items-center justify-between pb-6 mb-6 border-b-2 border-gray-200">
                <div>
                    <h1 class="text-4xl font-bold main-gradient-text">LDB QUEUE</h1>
                    <p id="user-info" class="mt-1 text-gray-500">สวัสดี, <span id="user-name-display" class="font-medium"></span> (<span id="user-role" class="font-medium"></span>)</p>
                    <p class="text-xs text-gray-400">User ID: <span id="user-id-display"></span></p>
                </div>
                <!-- Ensure header action icons (menu, notifications, etc.) align to the right on mobile by adding ml-auto -->
                <div class="flex items-center space-x-2 md:space-x-4 mt-4 sm:mt-0 ml-auto">
                    <button id="notifications-button" class="relative p-2 text-gray-600 bg-gray-200 rounded-full hover:bg-gray-300 focus:outline-none">
                        <i class="ph ph-bell text-xl"></i>
                        <span id="notification-badge" class="absolute -top-1 -right-1 flex items-center justify-center h-5 w-5 rounded-full bg-red-500 text-white text-xs hidden"></span>
                    </button>
                    <!-- Activity log button for admins -->
                    <button id="activity-log-button" class="relative p-2 text-gray-600 bg-gray-200 rounded-full hover:bg-gray-300 focus:outline-none admin-only">
                        <i class="ph ph-list text-xl"></i>
                    </button>
                    <!-- Hide the original line-bot button in nav; a new one will appear in settings -->
                    <button id="line-bot-button-old" class="hidden px-4 py-2 font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors admin-only">
                        <i class="ph ph-robot"></i><span class="hidden md:inline ml-1">แชทบอทไลน์</span>
                    </button>
                    <button id="system-settings-button" class="px-4 py-2 font-semibold text-white bg-gray-600 rounded-lg hover:bg-gray-700 transition-colors admin-only">
                        <i class="ph ph-wrench"></i><span class="hidden md:inline ml-1">ตั้งค่าระบบ</span>
                    </button>
                    <button id="manage-all-users-button" class="px-4 py-2 font-semibold text-white bg-indigo-500 rounded-lg hover:bg-indigo-600 transition-colors admin-only">
                        <i class="ph ph-users-three"></i><span class="hidden md:inline ml-1">จัดการทีมงาน</span>
                    </button>
                    <button id="financial-summary-button" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                        <i class="ph ph-chart-bar"></i><span class="hidden md:inline ml-1">สรุปบัญชีการเงิน</span>
                    </button>
                    <button id="manage-profile-button" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                        <i class="ph ph-gear"></i><span class="hidden md:inline ml-1">จัดการโปรไฟล์</span>
                    </button>
                    <button id="logout-button" class="px-4 py-2 font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="ph ph-sign-out"></i><span class="hidden md:inline ml-1">Logout</span>
                    </button>
                </div>
            </header>

            <section class="max-w-7xl mx-auto">
                <div class="flex flex-wrap items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold">รายการคิวงาน</h2>
                    <div class="flex flex-wrap items-center space-x-2 mt-2 md:mt-0">
                        <button id="add-job-button" class="px-4 py-2 font-semibold text-white gradient-bg rounded-lg hover:opacity-90 admin-only">
                            <i class="ph ph-plus-circle mr-1"></i> เพิ่มคิวงานใหม่
                        </button>
                        <div id="member-job-filters" class="hidden items-center space-x-2">
                            <button id="filter-my-jobs" class="px-4 py-2 text-sm font-semibold rounded-lg">คิวงานของฉัน</button>
                            <button id="filter-all-jobs" class="px-4 py-2 text-sm font-semibold rounded-lg">คิวงานทั้งหมด</button>
                        </div>
                        <!-- Real-time search bar -->
                        
                    </div>
                </div>
                <div id="job-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
            </section>

            <section id="job-details-section" class="mt-8 hidden">
                <div class="p-6 bg-white rounded-2xl shadow-lg">
                        <div id="capture-area" class="relative">
                        <!-- Cancellation notice for jobs that have been cancelled -->
                        <div id="job-cancelled-notice" class="hidden text-center my-4">
                            <span class="text-red-400 text-2xl sm:text-3xl font-semibold">ยกเลิกคิวงานนี้</span>
                        </div>
                        <div class="flex flex-wrap items-start justify-between pb-4 mb-4 border-b">
                            <div>
                                <div class="flex items-center">
                                    <h3 id="job-title" class="text-3xl font-bold text-gray-800"></h3>
                                    <button id="edit-job-details-btn" class="ml-3 text-gray-400 hover:text-red-600 admin-only"><i class="ph ph-pencil-simple"></i></button>
                                </div>
                                <p id="job-dates" class="text-gray-500"></p>
                                <p id="job-location" class="flex items-center mt-1 text-gray-500"><i class="ph ph-map-pin mr-2"></i><span id="job-location-text"></span></p>
                            </div>
                            <!-- Move the budget information to the far right -->
                            <div class="ml-auto text-right mt-4 sm:mt-0">
                                <p id="budget-label" class="text-gray-500 font-bold text-lg">งบประมาณ</p>
                                <div class="flex items-center justify-end">
                                    <div id="member-wage-container" class="text-right">
                                        <p id="job-income" class="text-3xl font-bold"></p>
                                        <p id="member-paid-status" class="text-sm text-green-600 font-medium hidden"></p>
                                        <p id="member-wht-deduction-display" class="text-xs text-red-400"></p>
                                    </div>
                                    <button id="edit-budget-btn" class="ml-2 text-gray-400 hover:text-red-600 admin-only"><i class="ph ph-pencil-simple"></i></button>
                                </div>
                                <!-- Containers for action buttons below the wage/budget section -->
                                <div id="member-action-btn-container" class="mt-2"></div>
                                <div id="admin-action-btn-container" class="mt-2 admin-only"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-2">
                                <h4 class="text-xl font-semibold mb-4">ทีมงาน (<span id="team-member-count">0</span> คน)</h4>
                                <div class="overflow-x-auto"><table class="min-w-full bg-white"><thead id="schedule-head"></thead><tbody id="schedule-body"></tbody></table></div>
                                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="admin-only">
                                        <label for="admin-notes-textarea" class="block text-xl font-semibold mb-2">หมายเหตุ (แอดมิน):</label>
                                        <textarea id="admin-notes-textarea" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="หมายเหตุสำหรับแอดมินเท่านั้น..."></textarea>
                                    </div>
                                    <div id="team-notes-container">
                                        <label for="team-notes-textarea" class="block text-xl font-semibold mb-2">โน้ต:</label>
                                        <textarea id="team-notes-textarea" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="โน้ตสำหรับทีมงานทุกคน..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div id="expense-section" class="admin-only">
                                <div class="flex justify-between items-center mb-4"><h4 class="text-xl font-semibold">ค่าใช้จ่ายอื่นๆ</h4><button id="add-expense-button" class="px-3 py-2 text-sm font-semibold text-white bg-orange-500 rounded-lg hover:bg-orange-600 admin-only"><i class="ph ph-plus mr-1"></i> เพิ่ม</button></div>
                                <div id="expense-list" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <button id="add-member-button" class="px-3 py-2 text-sm font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 admin-only"><i class="ph ph-user-plus mr-1"></i> เพิ่มทีมงาน</button>
                        <button id="add-day-button" class="px-3 py-2 text-sm font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 admin-only"><i class="ph ph-calendar-plus mr-1"></i> เพิ่มวันทำงาน</button>
                        <!-- ปุ่มบันทึกรูปภาพเปิดให้ทีมงานดาวน์โหลดตารางงานได้ด้วย จึงนำคลาส admin-only ออก -->
                        <button id="save-image-btn" class="px-3 py-2 text-sm font-semibold text-white bg-purple-500 rounded-lg hover:bg-purple-600"><i class="ph ph-image mr-1"></i> บันทึกรูปภาพ</button>
                        <!-- ปุ่มขอยกเลิกคิว (สมาชิก) จะแสดงถัดจากปุ่มบันทึกภาพ -->
                        <!-- ปุ่มขอยกเลิกคิวถูกยกเลิกการใช้งาน จึงซ่อน -->
                        <button id="member-request-cancel-btn" class="hidden px-3 py-1 text-xs font-semibold text-red-600 bg-gray-100 rounded-lg hover:bg-gray-200"><i class="ph ph-x-circle mr-1"></i> ขอยกเลิกคิว</button>
                    </div>
                    <!-- Additional action buttons for job details (e.g., cancel or edit) -->
                    <div id="job-extra-actions" class="absolute bottom-4 right-4 flex space-x-2"></div>
                    <div id="cost-summary-section" class="mt-8 pt-6 border-t-2 border-dashed admin-only">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="text-xl font-semibold mb-4">สรุปค่าใช้จ่าย</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center"><p>งบประมาณ</p><p id="summary-budget" class="font-semibold">0 บาท</p></div>
                                    <div class="flex justify-between items-center"><p>ค่าทีมงานรวม (<span id="summary-team-count">0</span> คน)</p><p id="summary-team-cost" class="font-semibold">0 บาท</p></div>
                                    <div class="flex justify-between items-center"><p>ค่าใช้จ่ายอื่นๆ รวม</p><p id="summary-other-expenses" class="font-semibold">0 บาท</p></div>
                                    <hr>
                                    <div class="flex justify-between items-center"><div class="flex items-center"><input type="checkbox" id="wht-toggle" class="h-4 w-4 rounded border-gray-300 text-red-600 focus:ring-red-500"><label for="wht-toggle" class="ml-2">หัก ณ ที่จ่าย (<input type="number" id="wht-percent" value="3" class="w-12 text-center bg-gray-100 rounded">%)</label></div><p id="summary-wht" class="font-semibold">0 บาท</p></div>
                                    <div class="flex justify-between items-center"><div class="flex items-center"><input type="checkbox" id="vat-toggle" class="h-4 w-4 rounded border-gray-300 text-red-600 focus:ring-red-500"><label for="vat-toggle" class="ml-2">VAT (7%)</label></div><p id="summary-vat" class="font-semibold">0 บาท</p></div>
                                    <hr>
                                    <div class="flex justify-between items-center text-lg font-bold"><p>รวมค่าใช้จ่ายทั้งหมด</p><p id="summary-total-cost" class="text-red-500">0 บาท</p></div>
                                </div>
                            </div>
                            <div class="flex flex-col items-center justify-center p-6 rounded-2xl bg-gray-50">
                                <p id="profit-loss-label" class="text-2xl font-semibold">กำไร</p>
                                <p id="summary-profit-loss" class="font-bold mt-2">0.00 บาท</p>
                                <div id="payment-summary-container" class="mt-4 text-center">
                                    <p id="payment-summary" class="text-gray-600"></p>
                                    <button id="pay-all-btn" class="mt-2 px-4 py-2 font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 text-sm disabled:opacity-50 disabled:cursor-not-allowed">จ่ายค่าแรงครบแล้ว</button>
                                </div>
                                <button id="complete-job-btn" class="mt-4 px-6 py-2 font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors admin-only">
                                    <i class="ph ph-check-circle mr-1"></i> เสร็จงานแล้ว
                                </button>
                                <!-- ปุ่มแก้ไขคิวถูกยกเลิกการใช้งาน จึงซ่อน -->
                                <button id="admin-edit-job-btn" class="hidden mt-2 px-3 py-1 text-xs font-semibold text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                                    <i class="ph ph-pencil mr-1"></i> แก้ไขคิว
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Increased padding for a cleaner appearance on the summary view. -->
        <div id="financial-summary-view" class="hidden p-6 sm:p-8 lg:p-12">
            <header class="flex items-center justify-between pb-6 mb-6 border-b-2 border-gray-200">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">สรุปบัญชีและการเงิน</h1>
                    <p class="mt-1 text-gray-500">รายงานรายรับ-รายจ่าย</p>
                </div>
                <button id="back-to-main-app-btn" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                    <i class="ph ph-arrow-left mr-1"></i> กลับหน้าหลัก
                </button>
            </header>

            <section class="p-4 mb-6 bg-white rounded-2xl shadow-lg">
                <div class="flex flex-wrap items-center gap-4">
                    <div id="financial-filter-buttons" class="flex items-center p-1 bg-gray-200 rounded-lg">
                        <button data-period="1m" class="px-4 py-1 text-sm font-semibold rounded-md">1 เดือน</button>
                        <button data-period="2m" class="px-4 py-1 text-sm font-semibold rounded-md">2 เดือน</button>
                        <button data-period="3m" class="px-4 py-1 text-sm font-semibold rounded-md">3 เดือน</button>
                        <button data-period="6m" class="px-4 py-1 text-sm font-semibold rounded-md">6 เดือน</button>
                        <button data-period="1y" class="px-4 py-1 text-sm font-semibold rounded-md">1 ปี</button>
                    </div>
                    <div id="month-year-selector" class="flex items-center gap-2">
                        <select id="summary-month" class="p-2 border rounded-lg"></select>
                        <select id="summary-year" class="p-2 border rounded-lg"></select>
                    </div>
                    <button id="show-custom-range-btn" class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-200 hover:bg-gray-300">
                        ค้นหาตามช่วงเวลา
                    </button>
                    <!-- Button for managing taxes (admin only) -->
                    <button id="tax-management-button" class="hidden px-4 py-2 text-sm font-semibold rounded-lg bg-yellow-100 text-yellow-700 hover:bg-yellow-200">
                        จัดการภาษี
                    </button>
                    <!-- Button to export financial summary as a PDF (admin only) -->
                    <button id="export-summary-pdf-button" class="px-4 py-2 text-sm font-semibold rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 admin-only">
                        <i class="ph ph-download-simple"></i><span class="hidden md:inline ml-1">ส่งออก PDF</span>
                    </button>
                    <!-- Button for withholding tax summary (member only) -->
                    <button id="withholding-button" class="hidden ml-auto px-4 py-2 text-sm font-semibold rounded-lg bg-red-100 text-red-600 hover:bg-red-200">
                        หัก ณ ที่จ่าย
                    </button>
                </div>
                <div id="custom-date-range-selector" class="hidden flex-wrap items-end gap-4 mt-4">
                    <!-- Adjust layout for mobile: stack fields and center the search button -->
                    <div class="flex flex-col sm:flex-row items-start sm:items-end gap-4 w-full">
                        <div>
                            <label for="summary-start-date" class="text-sm font-medium text-gray-700">ตั้งแต่</label>
                            <input type="date" id="summary-start-date" class="p-2 border rounded-lg">
                        </div>
                        <div>
                            <label for="summary-end-date" class="text-sm font-medium text-gray-700">ถึง</label>
                            <input type="date" id="summary-end-date" class="p-2 border rounded-lg">
                        </div>
                        <button id="summary-search-button" class="px-6 py-2 font-semibold text-white gradient-bg rounded-lg hover:opacity-90 w-full sm:w-auto mx-auto sm:mx-0 mt-2 sm:mt-0">
                            ค้นหา
                        </button>
                    </div>
                </div>
            </section>

            <div id="admin-summary-container" class="hidden space-y-8">
                 <section>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h2 class="text-2xl font-semibold mb-4">สรุปภาพรวม</h2>
                            <div class="p-4 bg-white rounded-2xl shadow-lg">
                                <canvas id="financial-chart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h2 class="text-2xl font-semibold mb-4">สถิติ</h2>
                            <div class="space-y-4">
                                <div class="p-4 bg-white rounded-2xl shadow-lg">
                                    <h3 class="font-semibold mb-4">ค่าใช้จ่ายรวม</h3>
                                    <!-- ใช้ดีไซน์ใหม่แบบการ์ดแบ่งสัดส่วนเพื่อแสดงสถิติแต่ละรายการอย่างสวยงาม -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <!-- ค่าแรงจ่ายแล้ว -->
                                        <div class="flex items-center p-3 rounded-lg bg-green-50">
                                            <div class="p-2 rounded-full bg-green-100 text-green-600 mr-3">
                                                <i class="ph ph-wallet"></i>
                                            </div>
                                            <div>
                                                <p class="text-sm text-gray-500">ค่าแรงจ่ายแล้ว</p>
                                                <p><span id="stat-paid-wages" class="text-lg font-bold text-green-600">0</span> <span class="text-sm text-gray-500">บาท</span></p>
                                            </div>
                                        </div>
                                        <!-- ค่าแรงยังไม่จ่าย -->
                                        <div class="flex items-center p-3 rounded-lg bg-yellow-50">
                                            <div class="p-2 rounded-full bg-yellow-100 text-yellow-600 mr-3">
                                                <i class="ph ph-hourglass-low"></i>
                                            </div>
                                            <div>
                                                <p class="text-sm text-gray-500">ค่าแรงยังไม่จ่าย</p>
                                                <p><span id="stat-unpaid-wages" class="text-lg font-bold text-yellow-600">0</span> <span class="text-sm text-gray-500">บาท</span></p>
                                            </div>
                                        </div>
                                        <!-- ค่าใช้จ่ายอื่นๆ -->
                                        <div class="flex items-center p-3 rounded-lg bg-blue-50">
                                            <div class="p-2 rounded-full bg-blue-100 text-blue-600 mr-3">
                                                <i class="ph ph-receipt"></i>
                                            </div>
                                            <div>
                                                <p class="text-sm text-gray-500">ค่าใช้จ่ายอื่นๆ</p>
                                                <p><span id="stat-other-expenses" class="text-lg font-bold text-blue-600">0</span> <span class="text-sm text-gray-500">บาท</span></p>
                                            </div>
                                        </div>
                                        <!-- หัก ณ ที่จ่าย -->
                                        <div class="flex items-center p-3 rounded-lg bg-purple-50">
                                            <div class="p-2 rounded-full bg-purple-100 text-purple-600 mr-3">
                                                <i class="ph ph-percent"></i>
                                            </div>
                                            <div>
                                                <p class="text-sm text-gray-500">หัก ณ ที่จ่าย</p>
                                                <p><span id="stat-wht" class="text-lg font-bold text-purple-600">0</span> <span class="text-sm text-gray-500">บาท</span></p>
                                            </div>
                                        </div>
                                        <!-- VAT -->
                                        <div class="flex items-center p-3 rounded-lg bg-red-50">
                                            <div class="p-2 rounded-full bg-red-100 text-red-600 mr-3">
                                                <i class="ph ph-credit-card"></i>
                                            </div>
                                            <div>
                                                <p class="text-sm text-gray-500">VAT (7%)</p>
                                                <p><span id="stat-vat" class="text-lg font-bold text-red-600">0</span> <span class="text-sm text-gray-500">บาท</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-4 bg-white rounded-2xl shadow-lg">
                                    <h3 class="font-semibold mb-2">ทีมงานที่ได้รับเงินสูงสุด</h3>
                                    <div id="stat-top-earners" class="space-y-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <h2 class="text-2xl font-semibold mb-4">สรุปรายรับ-รายจ่าย</h2>
                    <!-- Container to display totals of selected jobs (admin only) -->
                    <div id="selected-job-totals" class="hidden mb-4">
                        <div class="grid grid-cols-1 sm:grid-cols-5 gap-4 bg-gray-50 p-4 rounded-lg">
                            <div class="text-center">
                                <p class="text-sm text-gray-500">รายรับ</p>
                                <p id="selected-total-income" class="mt-1 text-lg font-bold text-gray-700">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500">VAT (7%)</p>
                                <p id="selected-total-vat" class="mt-1 text-lg font-bold text-gray-700">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500">หัก ณ ที่จ่าย</p>
                                <p id="selected-total-wht" class="mt-1 text-lg font-bold text-gray-700">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500">รายจ่ายทั้งหมด</p>
                                <p id="selected-total-expense" class="mt-1 text-lg font-bold text-gray-700">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500">กำไร/ขาดทุน</p>
                                <p id="selected-total-profit" class="mt-1 text-lg font-bold text-gray-700">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto bg-white rounded-2xl shadow-lg">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><input type="checkbox" id="select-all-jobs-checkbox"></th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่องาน</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">รายรับ</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">VAT (7%)</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">หัก ณ ที่จ่าย</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">รายจ่ายทั้งหมด</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">กำไร/ขาดทุน</th>
                                </tr>
                            </thead>
                            <tbody id="job-summary-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                            <tfoot class="bg-gray-100 font-bold">
                                <tr>
                                    <td class="px-4 py-4"></td>
                                    <td class="px-6 py-4 text-left">รวมทั้งหมด</td>
                                    <td id="total-income-summary" class="px-6 py-4 text-right">0</td>
                                    <td id="total-vat-summary" class="px-6 py-4 text-right">0</td>
                                    <td id="total-wht-summary" class="px-6 py-4 text-right">0</td>
                                    <td id="total-expense-summary" class="px-6 py-4 text-right">0</td>
                                    <td id="total-profit-summary" class="px-6 py-4 text-right">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </section>

                <section>
                    <h2 class="text-2xl font-semibold mb-4">สรุปค่าแรงทีมงาน</h2>
                    <div class="overflow-x-auto bg-white rounded-2xl shadow-lg">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อทีมงาน</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ค่าแรงรวม</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">รับเงินแล้ว</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ยังไม่ได้รับเงิน</th>
                                </tr>
                            </thead>
                            <tbody id="team-wage-summary-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                            <tfoot class="bg-gray-100 font-bold">
                                <tr>
                                    <td class="px-6 py-4 text-left">รวมทั้งหมด</td>
                                    <td id="total-wage-summary" class="px-6 py-4 text-right">0</td>
                                    <td id="total-paid-wage-summary" class="px-6 py-4 text-right">0</td>
                                    <td id="total-unpaid-wage-summary" class="px-6 py-4 text-right">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </section>
            </div>

            <div id="member-summary-container" class="hidden">
                <!-- Summary statistics for member financial overview -->
                <section class="p-4 mb-6 bg-white rounded-2xl shadow-lg">
                    <div id="member-summary-stats" class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                        <!-- Align BG summary to the right for members -->
                        <div class="text-right">
                            <!-- Display remaining BG after withholding instead of gross BG -->
                            <p class="text-sm text-gray-500">BG คงเหลือ</p>
                            <p id="member-total-wage-stat" class="mt-1 text-lg font-bold text-gray-700">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-500">รับเงินแล้ว</p>
                            <p id="member-total-paid-stat" class="mt-1 text-lg font-bold text-gray-700">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-500">ยังไม่ได้รับเงิน</p>
                            <p id="member-total-unpaid-stat" class="mt-1 text-lg font-bold text-gray-700">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-500">หัก ณ ที่จ่าย</p>
                            <p id="member-total-wht-stat" class="mt-1 text-lg font-bold text-gray-700">0</p>
                        </div>
                    </div>
                </section>
                <section>
                    <h2 class="text-2xl font-semibold mb-4">สรุปรายรับ</h2>
                    <div class="overflow-x-auto bg-white rounded-2xl shadow-lg">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่องาน</th>
                                    <!-- Column displays net BG (remaining after withholding) -->
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">BG คงเหลือ</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">รับเงินแล้ว</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ยังไม่ได้รับเงิน</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">หัก ณ ที่จ่าย</th>
                                </tr>
                            </thead>
                            <tbody id="member-wage-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                             <tfoot class="bg-gray-100 font-bold">
                                <tr>
                                    <td class="px-6 py-4 text-left">รวมทั้งหมด</td>
                                    <td id="member-total-wage-summary" class="px-6 py-4 text-right">0</td>
                                    <td id="member-total-paid-summary" class="px-6 py-4 text-right">0</td>
                                    <td id="member-total-unpaid-summary" class="px-6 py-4 text-right">0</td>
                                    <td id="member-total-wht-summary" class="px-6 py-4 text-right">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </section>
            </div>
        </div>

        <div id="settings-view" class="hidden p-4 sm:p-6 lg:p-8">
            <header class="flex items-center justify-between pb-6 mb-6 border-b-2 border-gray-200">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">ตั้งค่าระบบ</h1>
                    <p class="mt-1 text-gray-500">จัดการการตั้งค่าทั่วไปของแอปพลิเคชัน</p>
                </div>
                <button id="back-to-main-from-settings-btn" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                    <i class="ph ph-arrow-left mr-1"></i> กลับหน้าหลัก
                </button>
            </header>
            <section class="max-w-3xl mx-auto">
                <form id="settings-form" class="space-y-6">
                    <div class="p-6 bg-gray-50 rounded-xl shadow border border-gray-200 mb-6">
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Favicon & OG Image</h3>
                        <div class="mt-4 grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-4">
                            <div class="flex flex-col items-center">
                                <label class="block text-sm font-medium text-gray-700">Favicon</label>
                                <img id="favicon-preview" src="https://placehold.co/64x64/E2E8F0/4A5568?text=Icon" class="mt-1 w-16 h-16 rounded-md object-cover border-2 border-gray-200">
                                <label for="setting-favicon-file" class="mt-2 cursor-pointer text-sm text-indigo-600 font-semibold hover:text-indigo-800">เปลี่ยนรูป</label>
                                <input type="file" name="faviconFile" id="setting-favicon-file" accept="image/x-icon, image/png, image/jpeg" class="hidden">
                            </div>
                            <div class="flex flex-col items-center">
                                <label class="block text-sm font-medium text-gray-700">OG Image</label>
                                <img id="og-image-preview" src="https://placehold.co/300x157/E2E8F0/4A5568?text=OG+Image" class="mt-1 w-48 h-24 rounded-md object-cover border-2 border-gray-200">
                                <label for="setting-og-image-file" class="mt-2 cursor-pointer text-sm text-indigo-600 font-semibold hover:text-indigo-800">เปลี่ยนรูป</label>
                                <input type="file" name="ogImageFile" id="setting-og-image-file" accept="image/png, image/jpeg" class="hidden">
                            </div>
                        </div>
                    </div>

                    <div class="p-6 bg-gray-50 rounded-xl shadow border border-gray-200 mb-6">
                        <h3 class="text-lg font-medium text-gray-900">Cloudinary (สำหรับอัปโหลดรูป)</h3>
                         <div class="mt-4 grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-4">
                            <div>
                                <label for="setting-cloudinary-name" class="block text-sm font-medium text-gray-700">Cloud Name</label>
                                <div class="relative">
                                    <input type="password" name="cloudinaryName" id="setting-cloudinary-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm pr-10">
                                    <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-2 text-gray-400 toggle-visibility" data-target="setting-cloudinary-name"><i class="ph ph-eye"></i></button>
                                </div>
                            </div>
                             <div>
                                <label for="setting-cloudinary-preset" class="block text-sm font-medium text-gray-700">Upload Preset</label>
                                <div class="relative">
                                    <input type="password" name="cloudinaryPreset" id="setting-cloudinary-preset" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm pr-10">
                                    <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-2 text-gray-400 toggle-visibility" data-target="setting-cloudinary-preset"><i class="ph ph-eye"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="p-6 bg-gray-50 rounded-xl shadow border border-gray-200 mb-6">
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Line Bot (Line OA)</h3>
                        <p class="mt-1 text-sm text-gray-500">ตั้งค่าสำหรับเชื่อมต่อ Line Official Account เพื่อส่งการแจ้งเตือน</p>
                        <div class="mt-4 grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-4">
                            <div>
                                <label for="setting-line-bot-token" class="block text-sm font-medium text-gray-700">Channel Access Token</label>
                                <div class="relative">
                                    <input type="password" name="lineBotChannelAccessToken" id="setting-line-bot-token" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm pr-10">
                                    <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-2 text-gray-400 toggle-visibility" data-target="setting-line-bot-token"><i class="ph ph-eye"></i></button>
                                </div>
                            </div>
                            <div>
                                <label for="setting-line-bot-secret" class="block text-sm font-medium text-gray-700">Channel Secret</label>
                                <div class="relative">
                                    <input type="password" name="lineBotChannelSecret" id="setting-line-bot-secret" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm pr-10">
                                    <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-2 text-gray-400 toggle-visibility" data-target="setting-line-bot-secret"><i class="ph ph-eye"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center">
                            <input id="setting-line-login-enabled" name="isLineLoginEnabled" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="setting-line-login-enabled" class="ml-3 block text-sm font-medium text-gray-700">เปิดใช้งานปุ่ม "เชื่อมต่อบัญชี Line" ในหน้าโปรไฟล์</label>
                        </div>
                    </div>
                     <div class="p-6 bg-gray-50 rounded-xl shadow border border-gray-200 mb-6">
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Facebook Login</h3>
                        <p class="mt-1 text-sm text-gray-500">ตั้งค่าสำหรับการเข้าสู่ระบบด้วย Facebook</p>
                        <div class="mt-4 grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-4">
                     <div>
                                <label for="setting-facebook-app-id" class="block text-sm font-medium text-gray-700">App ID</label>
                                <div class="relative">
                                    <input type="password" name="facebookAppId" id="setting-facebook-app-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm pr-10">
                                    <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-2 text-gray-400 toggle-visibility" data-target="setting-facebook-app-id"><i class="ph ph-eye"></i></button>
                                </div>
                            </div>
                            <div>
                                <label for="setting-facebook-app-secret" class="block text-sm font-medium text-gray-700">
                                    App Secret
                                    <span class="tooltip inline-block">
                                        <i class="ph ph-info text-gray-400"></i>
                                        <span class="tooltiptext">เพื่อความปลอดภัยสูงสุด App Secret ควรถูกจัดเก็บเป็น Environment Variable ใน Cloud Function เท่านั้น ไม่ควรเก็บในฐานข้อมูลโดยตรง</span>
                                    </span>
                                </label>
                                <div class="relative">
                                    <input type="password" name="facebookAppSecret" id="setting-facebook-app-secret" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm pr-10">
                                    <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-2 text-gray-400 toggle-visibility" data-target="setting-facebook-app-secret"><i class="ph ph-eye"></i></button>
                                </div>
                            </div>
                        </div>
                        <!-- Toggle switches for Facebook login and link buttons -->
                        <div class="mt-4 flex items-center">
                            <input id="setting-facebook-login-enabled" name="isFacebookLoginEnabled" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="setting-facebook-login-enabled" class="ml-3 block text-sm font-medium text-gray-700">เปิดใช้งานปุ่ม "เข้าสู่ระบบด้วย Facebook" ในหน้าเข้าสู่ระบบ</label>
                        </div>
                        <div class="mt-2 flex items-center">
                            <input id="setting-facebook-link-enabled" name="isFacebookLinkEnabled" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="setting-facebook-link-enabled" class="ml-3 block text-sm font-medium text-gray-700">เปิดใช้งานปุ่ม "ผูกบัญชี Facebook" ในหน้าจัดการโปรไฟล์</label>
                        </div>
                    </div>

                    <!-- SMS Notifications (SMSKUB) Section -->
                    <div class="p-6 bg-gray-50 rounded-xl shadow border border-gray-200 mb-6">
                        <h3 class="text-lg font-medium leading-6 text-gray-900">SMS Notifications (SMSKUB)</h3>
                        <p class="mt-1 text-sm text-gray-500">ตั้งค่าสำหรับเชื่อมต่อ SMSKUB API เพื่อส่งการแจ้งเตือนผ่าน SMS</p>
                        <!-- Combine API Key and Sender Name into a responsive grid for better spacing -->
                        <div class="mt-4 grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-4">
                            <!-- API Key field -->
                            <div>
                                <label for="setting-sms-api-key" class="block text-sm font-medium text-gray-700">API Key</label>
                                <div class="relative">
                                    <input type="password" name="smsKubApiKey" id="setting-sms-api-key" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm pr-10">
                                    <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-2 text-gray-400 toggle-visibility" data-target="setting-sms-api-key"><i class="ph ph-eye"></i></button>
                                </div>
                            </div>
                            <!-- Sender Name field -->
                            <div>
                                <label for="setting-sms-sender-name" class="block text-sm font-medium text-gray-700">Sender Name</label>
                                <input type="text" name="smsSenderName" id="setting-sms-sender-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="ชื่อผู้ส่ง">
                            </div>
                        </div>
                        <!-- Toggle for enabling SMS notifications -->
                        <div class="mt-4 flex items-center">
                            <input id="setting-sms-enabled" name="isSmsEnabled" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="setting-sms-enabled" class="ml-3 block text-sm font-medium text-gray-700">เปิดใช้งานการแจ้งเตือนผ่าน SMS</label>
                        </div>
                        <!-- Test SMS form -->
                        <div class="mt-4">
                            <h4 class="text-md font-medium text-gray-700 mb-2">ทดสอบส่ง SMS</h4>
                            <div class="grid grid-cols-1 gap-y-4 sm:grid-cols-2 sm:gap-x-4">
                                <div>
                                    <label for="sms-test-phone" class="block text-sm font-medium text-gray-700">เบอร์โทรศัพท์</label>
                                    <input type="text" id="sms-test-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="เช่น 0812345678">
                                </div>
                                <div class="sm:col-span-2">
                                    <label for="sms-test-message" class="block text-sm font-medium text-gray-700">ข้อความทดสอบ</label>
                                    <textarea id="sms-test-message" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="พิมพ์ข้อความทดสอบ..."></textarea>
                                </div>
                                <div class="sm:col-span-2 flex justify-end">
                                    <button type="button" id="sms-test-button" class="px-6 py-2 font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600">ทดสอบส่ง</button>
                                </div>
                            </div>
                            <div id="sms-test-result" class="mt-2 text-sm text-gray-700"></div>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="px-6 py-2 font-semibold text-white gradient-bg rounded-lg hover:opacity-90">
                            บันทึกการตั้งค่า
                        </button>
                    </div>
                </form>
                <!-- Additional buttons row -->
                <div class="mt-8 flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">
                    <button id="line-bot-button" class="w-full md:w-auto px-4 py-2 font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center">
                        <i class="ph ph-robot"></i><span class="ml-1">แชทบอทไลน์</span>
                    </button>
                    <button id="wht-form-settings-button" class="w-full md:w-auto px-4 py-2 font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center">
                        <i class="ph ph-note-pencil"></i><span class="ml-1">ตั้งค่าแบบฟอร์ม หัก ณ ที่จ่าย</span>
                    </button>
                </div>
            </section>
        </div>

        <div id="line-bot-view" class="hidden p-4 sm:p-6 lg:p-8">
             <header class="flex items-center justify-between pb-6 mb-6 border-b-2 border-gray-200">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">จัดการ Line Bot</h1>
                    <p class="mt-1 text-gray-500">ทดสอบและส่งข้อความแจ้งเตือนผ่าน Line OA</p>
                </div>
                <button id="back-to-main-from-bot-btn" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                    <i class="ph ph-arrow-left mr-1"></i> กลับหน้าหลัก
                </button>
            </header>

            <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                <section class="p-6 bg-white rounded-2xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">ทดสอบส่งข้อความ</h3>
                    <form id="line-test-form" class="space-y-4">
                        <div>
                            <label for="line-test-userid" class="block text-sm font-medium text-gray-700">Line User ID</label>
                            <input type="text" id="line-test-userid" placeholder="U123456789..." required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="line-test-message" class="block text-sm font-medium text-gray-700">ข้อความ</label>
                            <textarea id="line-test-message" rows="4" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="พิมพ์ข้อความทดสอบ..."></textarea>
                        </div>
                        <div class="flex justify-end">
                             <button type="submit" class="px-6 py-2 font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600">
                                ทดสอบส่ง
                            </button>
                        </div>
                    </form>
                </section>

                <section class="p-6 bg-white rounded-2xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">ส่งข้อความถึงทีมงาน</h3>
                    <form id="line-team-form" class="space-y-4">
                        <div>
                            <label for="line-job-select" class="block text-sm font-medium text-gray-700">เลือกคิวงาน</label>
                            <select id="line-job-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                <option>-- กรุณาเลือกคิวงาน --</option>
                            </select>
                        </div>
                        <div>
                            <label for="line-member-select" class="block text-sm font-medium text-gray-700">เลือกทีมงาน</label>
                            <select id="line-member-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" disabled>
                                <option>-- กรุณาเลือกทีมงาน --</option>
                            </select>
                        </div>
                        <div>
                            <label for="line-team-message" class="block text-sm font-medium text-gray-700">ข้อความ</label>
                            <textarea id="line-team-message" rows="4" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="พิมพ์ข้อความ..."></textarea>
                        </div>
                        <div class="flex justify-end">
                             <button type="submit" class="px-6 py-2 font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600">
                                ส่งข้อความ
                            </button>
                        </div>
                    </form>
                </section>
            </div>
        </div>

    </div>

    <!-- Withholding tax view removed per requirements; button is retained but no view will be displayed -->

    <!-- Tax management view for admin -->
    <div id="tax-management-view" class="hidden p-4 sm:p-6 lg:p-8">
         <header class="flex items-center justify-between pb-6 mb-6 border-b-2 border-gray-200">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">จัดการภาษี</h1>
                <p class="mt-1 text-gray-500">รายงานภาษีหัก ณ ที่จ่าย</p>
            </div>
            <button id="back-to-financial-from-tax-btn" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                <i class="ph ph-arrow-left mr-1"></i> กลับ
            </button>
         </header>
         <section class="p-4 mb-6 bg-white rounded-2xl shadow-lg">
            <div class="flex flex-wrap items-end gap-4">
                <div>
                    <label for="tax-month" class="text-sm font-medium text-gray-700">เดือน</label>
                    <select id="tax-month" class="p-2 border rounded-lg"></select>
                </div>
                <div>
                    <label for="tax-year" class="text-sm font-medium text-gray-700">ปี</label>
                    <select id="tax-year" class="p-2 border rounded-lg"></select>
                </div>
                <button id="tax-search-btn" class="px-6 py-2 font-semibold text-white gradient-bg rounded-lg hover:opacity-90">
                    ค้นหา
                </button>
            </div>
         </section>
         <section>
            <div class="overflow-x-auto bg-white rounded-2xl shadow-lg">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่องาน</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">รายรับ</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">หัก ณ ที่จ่าย</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">VAT</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">รายจ่าย</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">กำไร/ขาดทุน</th>
                        </tr>
                    </thead>
                    <tbody id="tax-report-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
         </section>
    </div>

    <footer class="text-center p-4 text-xs text-gray-500 mt-auto">
        © SIRASUPA CORPORATION (THAILAND) CO., LTD. Tax ID: 0435562000799
    </footer>


    <div id="modals-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, sendPasswordResetEmail, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, EmailAuthProvider, reauthenticateWithCredential, OAuthProvider, signInWithRedirect, getRedirectResult, linkWithRedirect, unlink, FacebookAuthProvider, signInWithPopup, linkWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, addDoc, collection, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, query, where, getDocs, serverTimestamp, writeBatch, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // [!!!] การแก้ไขข้อผิดพลาด 'auth/unauthorized-domain' [!!!]
        // ข้อผิดพลาดนี้เกิดจากการตั้งค่าความปลอดภัยของ Firebase ซึ่งไม่ได้อนุญาตให้โดเมนที่ใช้แสดงผลนี้ทำการล็อกอิน
        // คุณจำเป็นต้องเพิ่มโดเมนนี้เข้าไปในโปรเจกต์ Firebase ของคุณเอง โดยทำตามขั้นตอนต่อไปนี้:
        //
        // 1. ไปที่ Firebase Console (https://console.firebase.google.com/)
        // 2. เลือกโปรเจกต์ของคุณ: 'job-queue-app'
        // 3. ไปที่เมนู 'Authentication'
        // 4. เลือกแท็บ 'Settings'
        // 5. เลือกแท็บย่อย 'Authorized domains'
        // 6. คลิก 'Add domain' และใส่โดเมนนี้:
        //    3b8dyoiqnavm8kvmrmf0csdpdfp0s6qv8yf6ijzww1pvgq3k1f-h785866787.scf.usercontent.goog
        // 7. กด 'Add' เพื่อบันทึก
        //
        // หลังจากทำตามขั้นตอนเหล่านี้แล้ว ปุ่มล็อกอินด้วย LINE จะทำงานได้ตามปกติในหน้าแสดงผลนี้

        const firebaseConfig = {
          apiKey: "AIzaSyAedyGR43aEAO_BFufGmplJVuGkmIEYgG0",
          authDomain: "job-queue-app.firebaseapp.com",
          projectId: "job-queue-app",
          storageBucket: "job-queue-app.appspot.com",
          messagingSenderId: "247047529613",
          appId: "1:247047529613:web:d27a980d1de33c22052ec4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, currentUserData = null, currentUserRole = null;
        let currentJobId = null, currentJobData = null;
        let jobUnsubscribe = null, usersUnsubscribe = null, notificationsUnsubscribe = null;
        let allUsers = [];
        let allJobs = [];
        let allActiveJobs = []; // For filtering
        let allCompletedJobs = []; // For financial summary
        let allNotifications = [];
        let originalAdminData = null;
        let memberJobFilter = 'my_jobs'; // 'my_jobs' or 'all'
        let memberFinancialFilter = 'all'; // 'all', 'paid', 'unpaid'
        let financialChart = null;
        let financialFilter = '1m'; // '1m', '2m', '3m', '6m', '1y', 'all'
        let draggedItem = null;
        // สำหรับเก็บลิงก์ไฟล์หนังสือ 50 ทวิ ที่อัปโหลดในแต่ละคิวงาน
        // โครงสร้างใหม่: { [jobId]: { [userId]: [ { data: <dataURL>, uploadedBy, uploadedByName, uploadedAt }, ... ] } }
        // ค่าที่เคยเก็บเป็นสตริงจะถูกแปลงเป็นอาร์เรย์ของเวอร์ชันเพื่อรองรับ version control
        let uploadedMemberCertificates = {};
        try {
            const certDataStr = localStorage.getItem('uploadedMemberCertificates');
            if (certDataStr) {
                uploadedMemberCertificates = JSON.parse(certDataStr) || {};
                // Convert legacy string values into arrays for versioning support
                Object.keys(uploadedMemberCertificates).forEach(jobId => {
                    const jobEntry = uploadedMemberCertificates[jobId] || {};
                    Object.keys(jobEntry).forEach(userId => {
                        const val = jobEntry[userId];
                        if (val && !Array.isArray(val)) {
                            // Wrap single string into an array of one version object
                            jobEntry[userId] = [{ data: val, uploadedBy: null, uploadedByName: null, uploadedAt: null }];
                        }
                    });
                });
            }
        } catch (e) {
            console.warn('Failed to parse uploadedMemberCertificates from localStorage', e);
            uploadedMemberCertificates = {};
        }
        // Activity log for admin actions (e.g., uploads). Persisted in localStorage.
        let activityLog = [];
        try {
            const logStr = localStorage.getItem('activityLog');
            if (logStr) {
                activityLog = JSON.parse(logStr);
            }
        } catch (e) {
            console.warn('Failed to parse activityLog from localStorage', e);
            activityLog = [];
        }
        // Track how many times a member downloaded their certificates per job. Persisted in localStorage.
        let memberDownloadCounts = {};
        try {
            const countsStr = localStorage.getItem('memberDownloadCounts');
            if (countsStr) {
                memberDownloadCounts = JSON.parse(countsStr);
            }
        } catch (e) {
            console.warn('Failed to parse memberDownloadCounts from localStorage', e);
            memberDownloadCounts = {};
        }

        /**
         * Show a global loading overlay. Use before lengthy operations like file upload/download.
         */
        function showLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.remove('hidden');
        }

        /**
         * Hide the global loading overlay.
         */
        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.add('hidden');
        }
        let appSettings = {
            // เปอร์เซ็นต์หักภาษี ณ ที่จ่ายค่าเริ่มต้น (เช่น 3%)
            whtPercent: 3,
            // รายละเอียดสำหรับ Cloudinary สำหรับอัปโหลดไฟล์ต่าง ๆ
            cloudinaryName: "dzs7zbikj",
            cloudinaryPreset: "UploadpresetsQ",
            // ตั้งค่าการเชื่อมต่อ LINE BOT และ Facebook (ค่าดีฟอลต์)
            lineBotChannelAccessToken: "",
            lineBotChannelSecret: "",
            facebookAppId: "",
            facebookAppSecret: "",
            // ตั้งค่า favicon และ og:image
            faviconUrl: "",
            ogImageUrl: "",
            // เปิด/ปิดฟังก์ชัน LINE Login
            isLineLoginEnabled: true,
            // เปิด/ปิดฟังก์ชัน Facebook Login (false = ปิดโดยค่าเริ่มต้น)
            isFacebookLoginEnabled: false,
            // เปิด/ปิดฟังก์ชันผูกบัญชี Facebook ในโปรไฟล์ (false = ปิดโดยค่าเริ่มต้น)
            isFacebookLinkEnabled: false,
            // --- การตั้งค่าสำหรับระบบแจ้งเตือนผ่าน SMS (SMSKUB) ---
            // คีย์สำหรับใช้งาน API ของ SMSKUB
            smsKubApiKey: "",
            // ชื่อผู้ส่ง (Sender Name) ที่ต้องการให้แสดงในข้อความ SMS
            smsSenderName: "",
            // เปิด/ปิดการส่งแจ้งเตือนผ่าน SMS (false = ปิดการส่งโดยค่าเริ่มต้น)
            isSmsEnabled: false,
            // --- เพิ่มการตั้งค่าสำหรับหนังสือรับรองภาษีหัก ณ ที่จ่าย ---
            // เลขประจำตัวผู้เสียภาษีอากร (13 หลัก)
            whtTaxId: "0435562000799",
            // ชื่อบริษัทผู้มีหน้าที่หักภาษี
            whtCompanyName: "บริษัท สิรสุภา คอร์ปอเรชั่น (ประเทศไทย) จำกัด",
            // ที่อยู่ของบริษัท
            whtCompanyAddress: "121/1 หมู่ที่ 5 ตำบลบ้านเดื่อ อำเภอเมืองหนองคาย จ.หนองคาย 43000",
            // ประเภทแบบฟอร์ม (เช่น ภ.ด.ง.3)
            whtFormType: "ภ.ด.ง.3",
            // ประเภทเงินได้ที่ต้องไฮไลท์ (เช่น ค่าบริการ)
            whtIncomeType: "ค่าบริการ",
            // ตัวเลือกผู้จ่ายเงิน (1 = หัก ณ ที่จ่าย, 2 = ไม่หัก เป็นต้น)
            whtPayerOption: "(1)",
            // เคาน์เตอร์รันนัมเบอร์สำหรับเลขเล่มหนังสือและเลขหนังสือ (5 หลัก)
            whtBookCounter: 1,
            whtDocCounter: 1,
            // ชื่อผู้จ่ายเงิน (แอดมิน) ที่จะไปแสดงในหนังสือ
            whtSignerName: "",
            // URL โลโก้บริษัทที่อัปโหลดไว้ (Cloudinary)
            whtCompanyLogoUrl: "",
            // URL ภาพพื้นหลัง/รูปแบบหนังสือ 50 ทวิ ที่ใช้เป็นเทมเพลตในการดาวน์โหลดใบรับรอง
            whtFormImageUrl: ""
            ,
            // เค้าโครงตำแหน่งของข้อมูลบนแบบฟอร์ม 50 ทวิ (กำหนดโดยผู้ดูแลผ่านตัวแก้ไขลาก-วาง)
            // โครงสร้าง: { fieldName: { x: <มม>, y: <มม> }, ... }
            whtFormLayout: {}
        };

        const publicView = document.getElementById('public-view');
        const mainApp = document.getElementById('main-app');
        const loginModal = document.getElementById('login-modal');
        const signupModal = document.getElementById('signup-modal');

        // Handle the redirect result when the page loads
        getRedirectResult(auth)
          .then((result) => {
            if (result) {
                // This is the user from the redirect.
                // The onAuthStateChanged observer will handle the rest.
                console.log("Redirect result processed successfully.");
            }
          }).catch((error) => {
            console.error("Error processing redirect result:", error);
            if (error.code === 'auth/unauthorized-domain') {
                showUnauthorizedDomainModal(window.location.hostname);
            } else {
                const loginError = document.getElementById('login-error');
                loginError.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
                loginError.classList.remove('hidden');
            }
          });

        onAuthStateChanged(auth, async (user) => {
            if (user && !originalAdminData) { // User is signed in
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    // User exists, load data and init UI
                    currentUserData = userDocSnap.data();
                    currentUserRole = currentUserData.role;
                    if (currentUserData.forcePasswordChange) showLoginScreen(null, true);
                    else await initializeAppUI();
                } else {
                    // User does NOT exist in Firestore, create them
                    const newUserDoc = {
                        email: user.email || null,
                        name: user.displayName || `user_${user.uid.substring(0, 6)}`,
                        nickname: user.displayName || '',
                        role: 'member',
                        forcePasswordChange: false,
                        profilePic: user.photoURL || '',
                        bankAccount: { name: '', bank: '', number: '' },
                        idCardCopyUrl: '',
                        phone: user.phoneNumber || '',
                        createdAt: serverTimestamp() // Add creation timestamp
                    };
                    try {
                        await setDoc(userDocRef, newUserDoc);
                        currentUserData = newUserDoc;
                        currentUserRole = 'member';
                        await initializeAppUI();
                    } catch (error) {
                        console.error("Error creating new user document in onAuthStateChanged:", error);
                        showLoginScreen("เกิดข้อผิดพลาดในการตั้งค่าบัญชีผู้ใช้");
                    }
                }
            } else if (!user) { // User is signed out
                currentUser = null; currentUserData = null; currentUserRole = null;
                originalAdminData = null; // Clear impersonation on logout
                // Load application settings before showing the public UI so login/register buttons reflect admin toggles
                await loadAppSettings();
                showPublicUI();
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = 'กำลังเข้าสู่ระบบ...';

            const identifier = e.target.loginIdentifier.value;
            const password = e.target.password.value;
            const loginError = document.getElementById('login-error');
            loginError.classList.add('hidden');
            let emailToLogin = identifier;

            if (!identifier.includes('@')) {
                const q = query(collection(db, "users"), where("name", "==", identifier));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    loginError.textContent = "Username นี้ไม่มีอยู่ในระบบ";
                    loginError.classList.remove('hidden');
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'ลงชื่อเข้าใช้';
                    return;
                }
                emailToLogin = querySnapshot.docs[0].data().email;
            }

            signInWithEmailAndPassword(auth, emailToLogin, password)
                .catch(error => {
                    loginError.textContent = "ข้อมูลเข้าระบบไม่ถูกต้อง";
                    loginError.classList.remove('hidden');
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'ลงชื่อเข้าใช้';
                });
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            const signupError = document.getElementById('signup-error');
            signupError.classList.add('hidden');

            const usernameInput = e.target.username;
            const username = usernameInput.value;
            const email = e.target.email.value;
            const password = e.target.password.value;
            const confirmPassword = e.target.confirmPassword.value;

            if (!usernameInput.checkValidity()) {
                 signupError.textContent = "Username ต้องเป็นภาษาอังกฤษหรือตัวเลขเท่านั้น";
                 signupError.classList.remove('hidden');
                 return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = 'กรุณารอสักครู่...';


            const resetSubmitButton = () => {
                submitButton.disabled = false;
                submitButton.innerHTML = 'สมัครสมาชิก';
            };

            if (password !== confirmPassword) {
                signupError.textContent = "รหัสผ่านและการยืนยันไม่ตรงกัน";
                signupError.classList.remove('hidden');
                resetSubmitButton();
                return;
            }
            if (password.length < 6) {
                signupError.textContent = "รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร";
                signupError.classList.remove('hidden');
                resetSubmitButton();
                return;
            }

            const q = query(collection(db, "users"), where("name", "==", username));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                signupError.textContent = "Username นี้ถูกใช้งานแล้ว";
                signupError.classList.remove('hidden');
                resetSubmitButton();
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const newUserDoc = { 
                    email: user.email, 
                    name: username, 
                    nickname: '', 
                    role: 'member', 
                    forcePasswordChange: false, 
                    profilePic: '', 
                    bankAccount: { name: '', bank: '', number: '' }, 
                    idCardCopyUrl: '',
                    phone: '',
                    createdAt: serverTimestamp() // Add creation timestamp
                };
                await setDoc(doc(db, "users", user.uid), newUserDoc);
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    signupError.textContent = "อีเมลนี้ถูกใช้งานแล้ว";
                } else {
                    signupError.textContent = "เกิดข้อผิดพลาดในการสมัคร: " + error.message;
                }
                signupError.classList.remove('hidden');
                resetSubmitButton();
            }
        });

        // --- Facebook login buttons ---
        // Attach click handlers for Facebook login buttons on login and signup modals
        const fbBtnLogin = document.getElementById('facebook-login-btn-login');
        if (fbBtnLogin) fbBtnLogin.addEventListener('click', handleFacebookLogin);
        const fbBtnSignup = document.getElementById('facebook-login-btn-signup');
        if (fbBtnSignup) fbBtnSignup.addEventListener('click', handleFacebookLogin);

        // Invoke initial visibility update for Facebook login buttons based on default settings
        updateFacebookLoginVisibility();

        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const passwordError = document.getElementById('password-error');
            if (newPassword.length < 6) {
                passwordError.textContent = "รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร";
                passwordError.classList.remove('hidden');
                return;
            }
            try {
                await updatePassword(currentUser, newPassword);
                await updateDoc(doc(db, "users", currentUser.uid), { forcePasswordChange: false });
                document.getElementById('change-password-modal').classList.add('hidden');
                await initializeAppUI();
            } catch (error) {
                passwordError.textContent = "ไม่สามารถเปลี่ยนรหัสผ่านได้: " + error.message;
                passwordError.classList.remove('hidden');
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            if (jobUnsubscribe) jobUnsubscribe();
            if (usersUnsubscribe) usersUnsubscribe();
            if (notificationsUnsubscribe) notificationsUnsubscribe();
            signOut(auth);
        });

        document.getElementById('show-signup-modal-btn').addEventListener('click', (e) => {
            e.preventDefault();
            loginModal.classList.add('hidden');
            signupModal.classList.remove('hidden');
            // Ensure Facebook login button visibility reflects current admin settings when switching modals
            updateFacebookLoginVisibility();
        });

        document.getElementById('show-login-modal-btn').addEventListener('click', (e) => {
            e.preventDefault();
            signupModal.classList.add('hidden');
            loginModal.classList.remove('hidden');
            // Ensure Facebook login button visibility reflects current admin settings when switching modals
            updateFacebookLoginVisibility();
        });
        
        document.getElementById('public-login-button').addEventListener('click', () => {
             loginModal.classList.remove('hidden');
        });

        document.getElementById('close-login-modal-btn').addEventListener('click', () => loginModal.classList.add('hidden'));
        document.getElementById('close-signup-modal-btn').addEventListener('click', () => signupModal.classList.add('hidden'));
        document.getElementById('forgot-password-btn').addEventListener('click', (e) => {
            e.preventDefault();
            showForgotPasswordModal();
        });
        document.getElementById('return-to-admin-btn').addEventListener('click', returnToAdminView);


        function showLoginScreen(errorMsg = null, showChangePassword = false) {
            publicView.classList.add('hidden');
            loginModal.classList.toggle('hidden', showChangePassword);
            signupModal.classList.add('hidden');
            mainApp.classList.add('hidden');
            document.getElementById('change-password-modal').classList.toggle('hidden', !showChangePassword);
            if(errorMsg) {
                const loginError = document.getElementById('login-error');
                loginError.textContent = errorMsg;
                loginError.classList.remove('hidden');
            }
        }

        function showPublicUI() {
            publicView.classList.remove('hidden');
            mainApp.classList.add('hidden');
            loginModal.classList.add('hidden');
            signupModal.classList.add('hidden');
            listenForJobs(true); // Listen for public jobs
        }

        async function initializeAppUI() {
            publicView.classList.add('hidden');
            loginModal.classList.add('hidden');
            signupModal.classList.add('hidden');
            mainApp.classList.remove('hidden');
            document.getElementById('financial-summary-view').classList.add('hidden');
            document.getElementById('settings-view').classList.add('hidden');
            document.getElementById('line-bot-view').classList.add('hidden');


            const banner = document.getElementById('impersonation-banner');
            if (originalAdminData) {
                banner.classList.remove('hidden');
                document.getElementById('impersonated-user-name').textContent = currentUserData.nickname || currentUserData.name;
                mainApp.style.paddingTop = '3rem';
            } else {
                banner.classList.add('hidden');
                mainApp.style.paddingTop = '';
            }

            document.getElementById('user-name-display').textContent = currentUserData.nickname || currentUserData.name;
            // สำหรับสมาชิกจะปรับส่วนหัวให้แสดงสรุปยอดเงินภายหลังใน updateMemberSummary()
            if (currentUserRole === 'member') {
                // ล้างข้อความบทบาท (จะถูกแทนที่ด้วยสรุปใน updateMemberSummary)
                document.getElementById('user-role').textContent = '';
            } else {
                // สำหรับผู้ดูแลระบบ ให้แสดงบทบาทตามปกติ
                document.getElementById('user-role').textContent = currentUserRole;
            }
            // ไม่แสดง User ID ในส่วนหัวอีกต่อไป
            const userIdLine = document.getElementById('user-id-display');
            if (userIdLine && userIdLine.parentElement) {
                userIdLine.parentElement.style.display = 'none';
            }
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = currentUserRole === 'admin' ? '' : 'none';
            });
            document.getElementById('member-job-filters').style.display = currentUserRole === 'member' ? 'flex' : 'none';

            // Load application settings for all roles so member and public UIs can respect admin toggles
            await loadAppSettings();

            listenForJobs(false); // Listen for internal jobs
            listenForUsers();
            listenForNotifications();
            updateNotificationBadge();
        }
        
        function updateNotificationBadge() {
            if (currentUserRole !== 'member') return;

            const myUnfinishedJobs = allActiveJobs.filter(job =>
                job.team.some(member => member.userId === currentUser.uid)
            );
            
            const badge = document.getElementById('notification-badge');
            if(myUnfinishedJobs.length > 0) {
                badge.textContent = myUnfinishedJobs.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function listenForJobs(isPublic = false) {
            const q = collection(db, "jobs");
            onSnapshot(q, (snapshot) => {
                allJobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                allActiveJobs = allJobs
                    .filter(job => job.status !== "completed")
                    .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

                allCompletedJobs = allJobs
                    .filter(job => job.status === "completed")
                    .sort((a, b) => new Date(b.endDate) - new Date(a.endDate));

                if (isPublic) {
                    renderPublicJobs();
                } else {
                    applyFiltersAndRenderJobs();
                }

                // เมื่อมีการอัปเดตคิวงาน ให้คำนวณสรุปยอดเงินของสมาชิกด้วย
                if (!isPublic && currentUserRole === 'member' && typeof updateMemberSummary === 'function') {
                    updateMemberSummary();
                }
            }, (error) => {
                console.error("Error fetching jobs: ", error);
                const jobListContainer = document.getElementById(isPublic ? 'public-job-list' : 'job-list');
                if(jobListContainer) {
                    jobListContainer.innerHTML = `<p class="text-red-500 col-span-full">เกิดข้อผิดพลาดในการโหลดข้อมูลคิวงาน อาจเกิดจากปัญหาการเชื่อมต่อหรือการตั้งค่าสิทธิ์การเข้าถึงข้อมูล</p>`;
                }
            });
        }

        function renderPublicJobs() {
             applyFiltersAndRenderJobs(true);
        }
        
        function applyFiltersAndRenderJobs(isPublic = false) {
            let filteredJobs = allActiveJobs;
            const jobList = document.getElementById(isPublic ? 'public-job-list' : 'job-list');
            jobList.innerHTML = '';


            if (!isPublic && currentUserRole === 'member') {
                document.getElementById('member-job-filters').style.display = 'flex';
                document.getElementById('filter-my-jobs').classList.toggle('gradient-bg', memberJobFilter === 'my_jobs');
                document.getElementById('filter-my-jobs').classList.toggle('text-white', memberJobFilter === 'my_jobs');
                document.getElementById('filter-all-jobs').classList.toggle('gradient-bg', memberJobFilter === 'all');
                document.getElementById('filter-all-jobs').classList.toggle('text-white', memberJobFilter === 'all');
                if (memberJobFilter === 'my_jobs') {
                    filteredJobs = allActiveJobs.filter(job =>
                        job.team.some(member => member.userId === currentUser.uid)
                    );
                }
            } else if (!isPublic) { // Admin filters
                document.getElementById('member-job-filters').style.display = 'none';
            }
            

            // Apply real-time search filter if search input exists
            const searchTerm = (document.getElementById('job-search-input')?.value || '').toLowerCase().trim();
            if (searchTerm) {
                filteredJobs = filteredJobs.filter(job => {
                    const nameMatch = job.name && job.name.toLowerCase().includes(searchTerm);
                    const locationMatch = job.location && job.location.toLowerCase().includes(searchTerm);
                    // Match against team member names and nicknames
                    let memberMatch = false;
                    if (Array.isArray(job.team)) {
                        memberMatch = job.team.some(member => {
                            const user = allUsers.find(u => u.id === member.userId);
                            if (!user) return false;
                            const combined = ((user.nickname || '') + ' ' + (user.name || '')).toLowerCase();
                            return combined.includes(searchTerm);
                        });
                    }
                    // Match against dates: startDate, endDate and individual workdays
                    let dateMatch = false;
                    const tryMatchDate = (dateStr) => {
                        if (!dateStr) return false;
                        return String(dateStr).toLowerCase().includes(searchTerm);
                    };
                    if (tryMatchDate(job.startDate) || tryMatchDate(job.endDate)) {
                        dateMatch = true;
                    }
                    if (!dateMatch && Array.isArray(job.workdays)) {
                        dateMatch = job.workdays.some(d => tryMatchDate(d));
                    }
                    return nameMatch || locationMatch || memberMatch || dateMatch;
                });
            }

            updateNotificationBadge();

            // Lazy-load job cards in batches to improve performance when many jobs exist
            // On mobile (<=640px), show 2 jobs at a time; otherwise load 12 at a time
            const BATCH_SIZE = window.innerWidth <= 640 ? 2 : 12;
            let loadedCount = 0;
            function renderJobBatch() {
                const nextJobs = filteredJobs.slice(loadedCount, loadedCount + BATCH_SIZE);
                nextJobs.forEach(job => {
                    const isMyJob = !isPublic && job.team.some(m => m.userId === currentUser.uid);
                    const iconColorClass = isMyJob ? 'main-gradient-text' : 'text-gray-500';
                    // calculate team and progress details for enhanced card UI
                    const teamNeeded = job.teamNeeded || 0;
                    const teamCount = job.team.length;
                    const remaining = teamNeeded - teamCount;
                    // Determine progress and status colours/text
                    let progressPercentage = 0;
                    let statusText = '';
                    let statusColor = '';
                    let progressColor = '';
                    let teamStatusHTML = '';
                    if (teamNeeded > 0) {
                        progressPercentage = Math.min((teamCount / teamNeeded) * 100, 100);
                        if (remaining <= 0) {
                            statusText = 'ครบแล้ว';
                            statusColor = 'text-red-500 font-semibold';
                            progressColor = 'bg-red-500';
                        } else {
                            statusText = `ขาด ${remaining} คน`;
                            statusColor = 'text-green-500';
                            progressColor = 'bg-green-500';
                        }
                        // build a richer team status section including a progress bar
                        teamStatusHTML = `
                            <div class="mt-2 job-team-status">
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-500">ทีม: ${teamCount}/${teamNeeded}</span>
                                    <span class="${statusColor}">${statusText}</span>
                                </div>
                                <div class="w-full h-1.5 bg-gray-200 rounded-full mt-1 overflow-hidden">
                                    <div class="h-full ${progressColor} rounded-full" style="width:${progressPercentage}%;"></div>
                                </div>
                            </div>
                        `;
                    } else {
                        // if no team size specified show an informational message
                        teamStatusHTML = `<p class="text-xs text-center mt-2 text-gray-400 italic job-team-status">ไม่ระบุจำนวนคน</p>`;
                    }
                    // determine the icon class for this job (fall back to video camera)
                    const iconName = job.icon || 'ph-video-camera';
                    // show a small badge only when the current user is part of this job's team
                    // The badge serves as an indicator that this is your queue.
                    const hasQueueBadge = isMyJob;
                    // Determine if this card is currently selected; selected cards use a white badge, others use red (#ef4444)
                    const isSelected = currentJobId === job.id;
                    const badgeColorClass = isSelected ? 'bg-white' : 'bg-red-500';
                    const queueBadgeHTML = hasQueueBadge ? `
                        <div class="absolute top-1 left-1 sm:top-1 sm:left-1 w-5 h-5 rounded-full ${badgeColorClass} flex items-center justify-center shadow-md">
                            <i class="ph-fill ph-list-check text-pink-500 text-xs"></i>
                        </div>` : '';
                    const cardDiv = document.createElement('div');
                    // Determine if this job has already passed based on its end date
                    const todayStr = new Date().toISOString().split('T')[0];
                    const isPast = job.endDate && job.endDate < todayStr;
                    // modernised card styling: subtle border, gradient highlights and hover lift effect
                    // If the job is in the past, reduce opacity to visually de-emphasise it
                    cardDiv.className = 'job-card group cursor-pointer p-2 sm:p-4 rounded-xl shadow-md hover:shadow-xl transition-all transform bg-white border border-transparent hover:border-red-400 hover:-translate-y-1 relative' + (isPast ? ' opacity-60' : '');
                    // If the job has been cancelled by the admin, apply a pale red background to the card
                    if (job.status === 'cancelled') {
                        cardDiv.classList.add('bg-red-50');
                    }
                    cardDiv.dataset.id = job.id;
                    cardDiv.dataset.name = job.name;
                    // build the card HTML with badge, icon, details and status
                    // Create an hourglass icon on the top-right if the job is in the past
                    const pastBadgeHTML = isPast ? `<div class="absolute top-1 right-1 sm:top-1 sm:right-1"><i class="ph ph-hourglass text-gray-400"></i></div>` : '';
                    cardDiv.innerHTML = `
                        ${queueBadgeHTML}
                        ${pastBadgeHTML}
                        <!-- Icon container with gradient background -->
                        <!-- Main job icon container with custom class for easy selection -->
                        <div class="icon-container flex items-center justify-center h-12 w-12 sm:h-14 sm:w-14 mx-auto rounded-full bg-gradient-to-br from-red-500 to-pink-500 text-white mb-2">
                            <i class="ph-fill ${iconName} text-2xl"></i>
                        </div>
                        <!-- Job name -->
                        <h5 class="font-semibold job-card-title text-center text-gray-900 text-sm sm:text-base">${job.name}</h5>
                        <!-- Date range -->
                        <p class="text-xs text-red-500 font-medium text-center mt-1 flex items-center justify-center">
                            <i class="ph ph-calendar mr-1"></i>${formatDateRange(job.startDate, job.endDate)}
                        </p>
                        <!-- Location -->
                        <p class="text-xs text-gray-500 text-center job-card-location mt-1 flex items-center justify-center">
                            <i class="ph ph-map-pin mr-1"></i>${job.location}
                        </p>
                        ${teamStatusHTML}
                        <!-- Hover arrow to hint clickability -->
                        <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <i class="ph ph-arrow-right text-gray-300"></i>
                        </div>
                    `;
                    // Additional UI for cancellation status, stop icons, and admin/member actions
                    (function() {
                        try {
                            // Determine if current user has previously cancelled this job
                            const hasUserCancelled = (!isPublic && typeof currentUser !== 'undefined' && currentUser) && (
                                (job.cancelledMemberIds && Array.isArray(job.cancelledMemberIds) && job.cancelledMemberIds.includes(currentUser.uid)) ||
                                (job.cancellationRequests && job.cancellationRequests[currentUser.uid])
                            );
                            // Overlay a message if this job is cancelled by admin
                            if (job.status === 'cancelled') {
                                const cancelOverlay = document.createElement('div');
                                cancelOverlay.className = 'absolute inset-0 rounded-xl flex items-center justify-center bg-red-50';
                                cancelOverlay.innerHTML = '<span class="text-red-400 text-base sm:text-lg font-semibold">ยกเลิกคิวงานนี้</span>';
                                cardDiv.appendChild(cancelOverlay);
                            }
                            // Show a stop icon if the current user has cancelled this job
                            if (hasUserCancelled) {
                                const stopIconEl = document.createElement('div');
                                stopIconEl.className = 'absolute top-1 right-8 sm:right-8 w-5 h-5 flex items-center justify-center';
                                stopIconEl.innerHTML = '<i class="ph ph-hand-palm text-red-500 text-lg"></i>';
                                cardDiv.appendChild(stopIconEl);
                            }
                            // Note: action buttons (request cancellation and edit job) are rendered in the job detail view,
                            // not on each card. Do not attach action buttons here to avoid cluttering the job list.
                        } catch (err) {
                            console.error('Error adding cancellation UI', err);
                        }
                    })();
                    cardDiv.addEventListener('click', () => {
                        const jobId = cardDiv.dataset.id;
                        const jobName = cardDiv.dataset.name;
                        const jobData = allJobs.find(j => j.id === jobId);
                        const isMyJobNow = !isPublic && jobData.team.some(m => m.userId === currentUser.uid);
                        if (isPublic) {
                            loginModal.classList.remove('hidden');
                            return;
                        }
                        // Prevent users who cancelled this job from joining again
                        const hasUserCancelledClick = (jobData && currentUser) ? (
                            (jobData.cancelledMemberIds && Array.isArray(jobData.cancelledMemberIds) && jobData.cancelledMemberIds.includes(currentUser.uid)) ||
                            (jobData.cancellationRequests && jobData.cancellationRequests[currentUser.uid])
                        ) : false;
                        if (hasUserCancelledClick && !isMyJobNow && currentUserRole !== 'admin') {
                            alert("คุณไม่สามารถขอลงคิวงานนี้ได้อีก เนื่องจากคุณเคยยกเลิกคิวงานนี้มาแล้ว");
                            return;
                        }
                        if (currentUserRole === 'admin' || isMyJobNow) {
                            // Toggle open/close: if clicking the currently selected job card, deselect it to collapse details
                            if (currentJobId === jobId) {
                                selectJob(null);
                            } else {
                                selectJob(jobId);
                            }
                        } else {
                            const teamNeededNow = jobData.teamNeeded || 0;
                            const teamCountNow = jobData.team.length;
                            if (teamCountNow >= teamNeededNow) {
                                alert("คิวงานนี้ครบแล้ว ไม่สามารถขอเข้าร่วมได้");
                            } else {
                                showRequestToJoinModal(jobId, jobName);
                            }
                        }
                    });
                    jobList.appendChild(cardDiv);
                });
                loadedCount += nextJobs.length;
                // If there are remaining jobs, show a "load more" button
                if (loadedCount < filteredJobs.length) {
                    const loadMoreBtn = document.createElement('button');
                    loadMoreBtn.className = 'block w-full py-2 mt-2 text-center text-gray-600 bg-gray-50 hover:bg-gray-100 rounded-lg';
                    loadMoreBtn.textContent = 'โหลดเพิ่มเติม';
                    loadMoreBtn.addEventListener('click', () => {
                        loadMoreBtn.remove();
                        renderJobBatch();
                    });
                    jobList.appendChild(loadMoreBtn);
                }
            }
            // Render initial batch
            renderJobBatch();
        }

        function listenForUsers() {
            if (usersUnsubscribe) usersUnsubscribe();
            usersUnsubscribe = onSnapshot(collection(db, "users"), (snapshot) => {
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort users by creation date
                allUsers.sort((a, b) => (a.createdAt?.toDate() || 0) - (b.createdAt?.toDate() || 0));
            });
        }

        function selectJob(jobId) {
            currentJobId = jobId;

            // Always unsubscribe from the previous listener
            if (jobUnsubscribe) jobUnsubscribe();

            // Handle deselection
            if (!jobId) {
                document.getElementById('job-details-section').classList.add('hidden');
                currentJobData = null;
                // Untoggle all cards
                document.querySelectorAll('#job-list .job-card, #public-job-list .job-card').forEach(card => {
                    card.classList.remove('gradient-bg');
                    card.classList.add('bg-white');
                    card.querySelector('h5').classList.remove('text-white');
                    card.querySelectorAll('p').forEach(p => {
                         p.classList.remove('text-white', 'text-gray-300');
                         if(!p.classList.contains('job-card-location')) {
                            p.classList.add('text-gray-500');
                         } else {
                            p.classList.add('text-gray-400');
                         }
                    });
                    card.querySelector('.job-team-status')?.classList.remove('text-white');
                    // Reset icon container to default gradient and white icon on deselection
                    const iconContainer = card.querySelector('.icon-container');
                    const iconElement = iconContainer ? iconContainer.querySelector('i') : null;
                    if (iconContainer && iconElement) {
                        iconContainer.classList.add('bg-gradient-to-br','from-red-500','to-pink-500');
                        iconContainer.classList.remove('bg-white','border','border-pink-500');
                        iconElement.classList.add('text-white');
                        iconElement.classList.remove('text-pink-500');
                    // Remove any inline colour styles so the default white icon colour applies
                    iconElement.style.color = '';
                    }
                    // Remove any mobile-collapsed and mobile-show-name classes on deselection
                    card.classList.remove('mobile-collapsed');
                    card.classList.remove('mobile-show-name');
                });
                return; // Stop execution here
            }

            // Handle selection
            document.getElementById('job-details-section').classList.remove('hidden');
            document.querySelectorAll('#job-list .job-card, #public-job-list .job-card').forEach(card => {
                const isSelected = card.dataset.id === jobId;
                card.classList.toggle('gradient-bg', isSelected);
                card.classList.toggle('bg-white', !isSelected);
                card.querySelector('h5').classList.toggle('text-white', isSelected);
                card.querySelectorAll('p').forEach(p => {
                     p.classList.toggle('text-white', isSelected);
                     p.classList.toggle('text-gray-300', isSelected);
                     p.classList.toggle('text-gray-500', !isSelected && !p.classList.contains('job-card-location'));
                     p.classList.toggle('text-gray-400', !isSelected && p.classList.contains('job-card-location'));
                });
                card.querySelector('.job-team-status')?.classList.toggle('text-white', isSelected);
                // Toggle the job icon appearance when selected/deselected
                const iconContainer = card.querySelector('.icon-container');
                const iconElement = iconContainer ? iconContainer.querySelector('i') : null;
                if (iconContainer && iconElement) {
                    if (isSelected) {
                        // When selected, make the circle white with a coloured border and set the icon colour to red
                        iconContainer.classList.remove('bg-gradient-to-br', 'from-red-500', 'to-pink-500');
                        iconContainer.classList.add('bg-white', 'border', 'border-pink-500');
                        iconElement.style.color = '#ef4444';
                    } else {
                        // When not selected, revert to the default gradient circle and remove any inline colour
                        iconContainer.classList.add('bg-gradient-to-br', 'from-red-500', 'to-pink-500');
                        iconContainer.classList.remove('bg-white', 'border', 'border-pink-500');
                        iconElement.style.color = '';
                    }
                }
                // Update the badge colour: selected cards use white, others use red (#ef4444)
                const badgeIcon = card.querySelector('.ph-list-check');
                if (badgeIcon && badgeIcon.parentElement) {
                    const badgeDiv = badgeIcon.parentElement;
                    badgeDiv.classList.toggle('bg-white', isSelected);
                    badgeDiv.classList.toggle('bg-red-500', !isSelected);
                }
                // Do not collapse job cards on mobile; always remove collapse-related classes so full details show
                card.classList.remove('mobile-collapsed');
                card.classList.remove('mobile-show-name');
            });

            // Set up the new listener
            jobUnsubscribe = onSnapshot(doc(db, "jobs", jobId), (docSnap) => {
                if (docSnap.exists()) {
                    currentJobData = docSnap.data();
                    renderJobDetails(currentJobData);
                } else {
                    // This case handles if the job is deleted while being viewed
                    document.getElementById('job-details-section').classList.add('hidden');
                    currentJobId = null;
                    currentJobData = null;
                }
            }, (error) => {
                console.error("Error fetching job details:", error);
                document.getElementById('job-details-section').classList.add('hidden');
            });
        }

        function renderJobDetails(job) {
            document.getElementById('job-title').textContent = job.name;
            // Show or hide cancellation notice depending on job status
            const cancelNoticeEl = document.getElementById('job-cancelled-notice');
            if (cancelNoticeEl) {
                if (job.status === 'cancelled') {
                    cancelNoticeEl.classList.remove('hidden');
                } else {
                    cancelNoticeEl.classList.add('hidden');
                }
            }
            document.getElementById('job-dates').textContent = `${formatDateRange(job.startDate, job.endDate)} (${job.workdays.length} วัน)`;
            document.getElementById('job-location-text').textContent = job.location;
            document.getElementById('team-member-count').textContent = job.team.length;
            
            const memberWhtDisplay = document.getElementById('member-wht-deduction-display');
            memberWhtDisplay.textContent = ''; // Clear previous

            const budgetLabel = document.getElementById('budget-label');
            const jobIncomeEl = document.getElementById('job-income');
            const memberPaidStatusEl = document.getElementById('member-paid-status');

            jobIncomeEl.classList.remove('profit-text', 'text-blue-600');

            if (currentUserRole === 'member') {
                budgetLabel.textContent = 'BG';
                const myTeamData = job.team.find(m => m.userId === currentUser.uid);
                let myTotalWage = 0;
                let myNetWage = 0;
                if (myTeamData) {
                    // Gross wage based on assigned workdays
                    myTotalWage = calculateTeamCostForMember(myTeamData, job.workdays);
                    // Initialize net wage with gross value; will be adjusted below if withholding applies
                    myNetWage = myTotalWage;
                    if (myTeamData.isPaid) {
                        jobIncomeEl.classList.add('profit-text');
                        memberPaidStatusEl.textContent = `ได้รับเงินแล้ว (${formatShortDateWithBEYear(myTeamData.paymentDate)})`;
                    } else {
                        jobIncomeEl.classList.add('text-blue-600');
                        memberPaidStatusEl.textContent = 'ยังไม่ได้รับเงิน';
                    }
                    memberPaidStatusEl.classList.toggle('hidden', !myTeamData.isPaid);

                    if(myTeamData.whtEnabled) {
                        // Calculate withholding amount based on global percentage
                        const whtAmount = myTotalWage * (appSettings.whtPercent / 100);
                        // Adjust net wage to reflect actual take-home after withholding
                        myNetWage = myTotalWage - whtAmount;
                        memberWhtDisplay.textContent = `(หัก ณ ที่จ่าย ${appSettings.whtPercent}% : ${whtAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท)`;
                    }

                } else {
                    jobIncomeEl.classList.add('text-blue-600');
                }
                // Display net wage (remaining after withholding) instead of gross wage
                const displayWage = myTeamData ? myNetWage : myTotalWage;
                jobIncomeEl.textContent = `${displayWage.toLocaleString()} บาท`;
            } else { // admin
                budgetLabel.textContent = 'งบประมาณ';
                jobIncomeEl.textContent = `${job.income.toLocaleString()} บาท`;
                jobIncomeEl.classList.add('text-blue-600');
                memberPaidStatusEl.classList.add('hidden');
            }

            let headHTML = '<tr><th class="py-2 px-3 border-b text-left">ชื่อ</th>';
            job.workdays.forEach(day => {
                headHTML += `<th class="py-2 px-3 border-b text-center relative date-header">${formatShortDate(day)}<div class="absolute top-0 right-0 flex date-action-btn opacity-0 transition-opacity admin-only"><button class="edit-day-btn text-blue-500 hover:text-blue-700" data-day="${day}"><i class="ph-bold ph-pencil-simple text-xs"></i></button><button class="delete-day-btn text-red-500 hover:text-red-700" data-day="${day}"><i class="ph-bold ph-x-circle text-xs"></i></button></div></th>`;
            });
            // Determine if current user is the team leader
            const currentIsTeamLeader = job.teamLeaderId && currentUser && currentUser.uid === job.teamLeaderId;
            // Total column should display only for admins. Management column displays for admins and team leader.
            const totalHeaderClass = (currentUserRole === 'admin') ? '' : 'admin-only';
            const managementHeaderClass = (currentUserRole === 'admin' || currentIsTeamLeader) ? '' : 'admin-only';
            headHTML += `<th class="py-2 px-3 border-b text-center ${totalHeaderClass}">รวม</th><th class="py-2 px-3 border-b text-center ${managementHeaderClass}">จัดการ</th></tr>`;
            document.getElementById('schedule-head').innerHTML = headHTML;
            const scheduleBody = document.getElementById('schedule-body');
            scheduleBody.innerHTML = '';
                job.team.forEach((member) => {
                const memberData = allUsers.find(u => u.id === member.userId);
                if (!memberData) return; // Skip rendering if user data not found
                const displayName = memberData.nickname || memberData.name;
                const isTeamLeader = job.teamLeaderId === member.userId;
                const draggableClass = currentUserRole === 'admin' ? 'draggable-row' : '';
                // determine if member has complete withholding account
                const wht = memberData.withholdingAccount || {};
                const addr2 = wht.address || {};
                const completeWht = wht && wht.idNumber && addr2.houseNumber && addr2.subdistrict && addr2.district && addr2.province && addr2.postalCode && wht.idCardCopyUrl;
                const starIcon = completeWht ? '<i class="ph-fill ph-star text-yellow-400 mr-1"></i>' : '';
                let rowHTML = `<tr class="${draggableClass}" draggable="${currentUserRole === 'admin'}" data-userid="${member.userId}"><td class="py-2 px-3 border-b"><div class="flex items-center"><i class="ph ph-dots-six-vertical drag-handle text-gray-400 mr-2 admin-only"></i><img src="${memberData.profilePic || 'https://placehold.co/40x40/E2E8F0/4A5568?text=??'}" class="w-8 h-8 rounded-full mr-3 object-cover"><div><p class="font-medium flex items-center">${starIcon}${displayName} ${isTeamLeader ? '<i class="ph-fill ph-crown text-yellow-500 ml-1"></i>' : ''}</p><p class="text-xs text-gray-500">${member.position}</p></div></div></td>`;

                job.workdays.forEach(day => {
                    const isWorking = member.workdays.includes(day);
                    const dailyRate = (member.dailyOverrides && member.dailyOverrides[day] !== undefined) ? member.dailyOverrides[day] : member.dailyRate;
                    // Determine rate visibility and editability: team leader or admin can see all, member sees their own
                    const canViewRate = (currentUserRole === 'admin' || currentIsTeamLeader || (currentUser && currentUser.uid === member.userId));
                    let rateDisplayHTML = `<span class="text-xs text-gray-400">-</span>`;
                    if (canViewRate) {
                        const canEditRate = (currentUserRole === 'admin' || currentIsTeamLeader);
                        rateDisplayHTML = `<span class="text-xs text-gray-500 ${canEditRate ? 'hover:text-blue-600 cursor-pointer edit-daily-rate-btn' : ''}" data-userid="${member.userId}" data-day="${day}">${dailyRate.toLocaleString()}</span>`;
                    }
                    // Disable schedule checkboxes for all except admin or the team leader; allow leader to modify schedule
                    const isDisabled = !(currentUserRole === 'admin' || currentIsTeamLeader);
                    const disabledClass = isDisabled ? 'cursor-not-allowed' + (isWorking ? '' : ' opacity-50') : '';
                    rowHTML += `<td class="py-2 px-3 border-b text-center"><div class="flex flex-col items-center justify-center space-y-1"><button class="custom-checkbox schedule-checkbox ${isWorking ? 'checked' : ''} ${disabledClass}" data-userid="${member.userId}" data-day="${day}" ${isDisabled ? 'disabled' : ''}><i class="ph-bold ph-check text-lg"></i></button>${rateDisplayHTML}</div></td>`;
                });

                // Total wage column; show only for admin. If withholding tax is enabled for this member, deduct it and display the deduction.
                const baseTotal = calculateTeamCostForMember(member, job.workdays);
                let whtDeduction = 0;
                let netTotal = baseTotal;
                if (currentUserRole === 'admin' && member.whtEnabled) {
                    const percent = (job.whtPercent === undefined ? appSettings.whtPercent : job.whtPercent);
                    whtDeduction = baseTotal * (percent / 100);
                    netTotal = baseTotal - whtDeduction;
                }
                const totalCellClass = (currentUserRole === 'admin') ? '' : 'admin-only';
                rowHTML += `<td class="py-2 px-3 border-b text-center ${totalCellClass}">
                                <div class="${member.isPaid ? 'profit-text' : ''} font-semibold">${netTotal.toLocaleString()}</div>
                                ${whtDeduction ? `<div class="text-xs text-red-500">- ${whtDeduction.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}</div>` : ''}
                                ${member.isPaid ? `<div class="text-xs text-gray-500">จ่ายเมื่อ ${formatShortDate(member.paymentDate)}</div>` : ''}
                            </td>`;

                // Management column; show for admin or team leader. Hide withholding checkbox for team leader.
                const payButtonIcon = member.isPaid ? 'ph-arrow-counter-clockwise' : 'ph-currency-dollar';
                const payButtonColor = member.isPaid ? 'text-orange-500 hover:text-orange-700' : 'text-green-500 hover:text-green-700';
                const managementCellClass = (currentUserRole === 'admin' || currentIsTeamLeader) ? '' : 'admin-only';
                // Build WHT checkbox only for admin
                const whtCheckboxHTML = (currentUserRole === 'admin') ? `<input type="checkbox" title="หัก ณ ที่จ่าย 3%" class="h-4 w-4 rounded border-gray-300 text-red-600 focus:ring-red-500 member-wht-checkbox" data-userid="${member.userId}" ${member.whtEnabled ? 'checked' : ''}>` : '';
                rowHTML += `<td class="py-2 px-3 border-b text-center ${managementCellClass}">
                                <div class="flex items-center justify-center space-x-2">
                                    <button class="text-blue-500 hover:text-blue-700 edit-member-btn" data-userid="${member.userId}"><i class="ph ph-pencil-simple"></i></button>
                                    <button class="text-red-500 hover:text-red-700 remove-member-btn" data-userid="${member.userId}"><i class="ph ph-trash"></i></button>
                                    <!-- Hide the pay button for non-admins; only administrators can mark wages as paid/unpaid -->
                                    <button class="${currentUserRole !== 'admin' ? 'hidden' : ''} pay-member-btn ${payButtonColor}" data-userid="${member.userId}"><i class="ph ${payButtonIcon}"></i></button>
                                    ${whtCheckboxHTML}
                                </div>
                            </td></tr>`;
                scheduleBody.innerHTML += rowHTML;
            });

            const expenseList = document.getElementById('expense-list');
            expenseList.innerHTML = '';
            (job.expenses || []).forEach((expense, index) => {
                // Determine if current user can edit/remove this expense
                const canEditExpense = (currentUserRole === 'admin') || (currentIsTeamLeader && expense.addedBy === (currentUser ? currentUser.uid : null));
                // Construct label: show name with the nickname of the person who added in parentheses if available
                // If the person who added this expense is an admin, do not show their nickname
                let addedLabel = '';
                try {
                    const addedByUser = allUsers ? allUsers.find(u => u.id === expense.addedBy) : null;
                    const showNickname = addedByUser ? addedByUser.role !== 'admin' : true;
                    if (expense.addedByNickname && showNickname) {
                        addedLabel = ` (${expense.addedByNickname})`;
                    }
                } catch (e) {
                    // Fallback to showing nickname if available
                    if (expense.addedByNickname) addedLabel = ` (${expense.addedByNickname})`;
                }
                const editButtons = canEditExpense ? `<button class="text-blue-500 hover:text-blue-700 edit-expense-btn" data-index="${index}"><i class="ph ph-pencil-simple"></i></button><button class="text-red-500 hover:text-red-700 remove-expense-btn" data-index="${index}"><i class="ph ph-x-circle"></i></button>` : '';
                expenseList.innerHTML += `<div class="flex justify-between items-center p-2 rounded-lg hover:bg-gray-100"><div><p>${expense.name}${addedLabel}</p></div><div class="flex items-center space-x-3"><p class="font-semibold">${expense.amount.toLocaleString()}</p>${editButtons}</div></div>`;
            });

            document.getElementById('wht-toggle').checked = job.whtEnabled || false;
            document.getElementById('vat-toggle').checked = job.vatEnabled || false;
            document.getElementById('wht-percent').value = job.whtPercent === undefined ? appSettings.whtPercent : job.whtPercent;

            document.getElementById('admin-notes-textarea').value = job.notes || '';

            const teamNotesContainer = document.getElementById('team-notes-container');
            const teamNotesTextarea = document.getElementById('team-notes-textarea');
            teamNotesTextarea.value = job.teamNotes || '';
            const isTeamLeader = job.teamLeaderId === currentUser.uid;
            const canEditTeamNotes = currentUserRole === 'admin' || isTeamLeader;
            teamNotesTextarea.disabled = !canEditTeamNotes;
            teamNotesTextarea.classList.toggle('bg-gray-100', !canEditTeamNotes);

            if (!job.teamNotes && !canEditTeamNotes) {
                teamNotesContainer.classList.add('hidden');
            } else {
                teamNotesContainer.classList.remove('hidden');
            }

            updateCalculations(job);
            renderPaymentSummary(job);
            // หากเป็นหัวหน้าทีม (ไม่ใช่ผู้ดูแลระบบ) ปิดการแก้ไขหัก ณ ที่จ่าย, VAT และซ่อนปุ่มจ่าย/เสร็จงาน
            const isCurrentLeader = job.teamLeaderId && currentUser && currentUser.uid === job.teamLeaderId;
            if (isCurrentLeader && currentUserRole !== 'admin') {
                const whtToggle = document.getElementById('wht-toggle');
                const vatToggle = document.getElementById('vat-toggle');
                const whtPercentInput = document.getElementById('wht-percent');
                if (whtToggle) { whtToggle.disabled = true; }
                if (vatToggle) { vatToggle.disabled = true; }
                if (whtPercentInput) { whtPercentInput.disabled = true; }
                const payAllBtn = document.getElementById('pay-all-btn');
                const completeJobBtn = document.getElementById('complete-job-btn');
                if (payAllBtn) payAllBtn.style.display = 'none';
                if (completeJobBtn) completeJobBtn.style.display = 'none';
            }

            const completeJobBtn = document.getElementById('complete-job-btn');
            if (job.status === 'completed') {
                completeJobBtn.innerHTML = `<i class="ph ph-arrow-u-left-up mr-1"></i> ย้อนคืนคิวงาน`;
                completeJobBtn.className = 'mt-4 px-6 py-2 font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors admin-only';
                completeJobBtn.onclick = () => revertJobStatus(currentJobId);
            } else {
                completeJobBtn.innerHTML = `<i class="ph ph-check-circle mr-1"></i> เสร็จงานแล้ว`;
                completeJobBtn.className = 'mt-4 px-6 py-2 font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors admin-only';
                completeJobBtn.onclick = () => completeJob(currentJobId);
            }

            // แสดงเฉพาะองค์ประกอบของผู้ดูแลระบบให้แอดมินเท่านั้น
            // แต่อนุญาตให้หัวหน้าทีมเห็นส่วนสรุปค่าใช้จ่าย ค่าใช้จ่ายอื่นๆ ปุ่มเพิ่มค่าใช้จ่าย และปุ่มเพิ่มทีมงานของตนเอง
            document.querySelectorAll('.admin-only').forEach(el => {
                const isExpenseOrSummary = (el.id === 'expense-section' || el.id === 'cost-summary-section');
                const isAddExpenseBtn = (el.id === 'add-expense-button');
                const isAddMemberBtn = (el.id === 'add-member-button');
                const isLeader = job.teamLeaderId && currentUser && currentUser.uid === job.teamLeaderId;
                // Admin sees all; team leader sees expense & summary, add expense and add member buttons
                if (currentUserRole === 'admin' || ((isExpenseOrSummary || isAddExpenseBtn || isAddMemberBtn) && isLeader)) {
                    el.style.display = '';
                } else {
                    el.style.display = 'none';
                }
            });
            addDynamicEventListeners(job);
            // Update extra action buttons (e.g., cancel request or edit queue) based on the current job and user role
            updateJobDetailActions(job);
        }

        function renderPaymentSummary(job) {
            const summaryContainer = document.getElementById('payment-summary-container');
            // Hide the payment summary for non-admin users (e.g., team leaders) and show it for admins
            if (currentUserRole !== 'admin') {
                if (summaryContainer) summaryContainer.style.display = 'none';
                return;
            } else {
                if (summaryContainer) summaryContainer.style.display = '';
            }

        /**
         * อัปเดตปุ่มดำเนินการในหน้ารายละเอียดคิวงานตามบทบาทของผู้ใช้และสถานะของงาน
         * แสดงปุ่มขอยกเลิกคิวสำหรับสมาชิกและปุ่มแก้ไขคิวสำหรับแอดมิน
         * งานที่ผ่านไปแล้วหรือถูกยกเลิก/เสร็จสิ้นแล้วจะไม่แสดงปุ่มใดๆ
         * @param {Object} job
         */
        function updateJobDetailActions(job) {
            // Hide legacy floating actions container if exists
            const fabContainer = document.getElementById('job-fab-actions');
            if (fabContainer) {
                fabContainer.classList.add('hidden');
                fabContainer.innerHTML = '';
            }
            // Grab buttons from the DOM
            const memberCancelBtn = document.getElementById('member-request-cancel-btn');
            const adminEditBtn = document.getElementById('admin-edit-job-btn');
            // Determine if job is past
            const today = new Date().toISOString().split('T')[0];
            const isPast = job.endDate && job.endDate < today;
            // Member cancel button visibility and state
            if (memberCancelBtn) {
                // Show only for members of the job team; hide for others
                if (currentUserRole === 'member' && job.team.some(m => m.userId === (currentUser ? currentUser.uid : null))) {
                    memberCancelBtn.classList.remove('hidden');
            // Determine if cancel should be disabled. Members are only allowed to request
            // cancellation when the job date is within 5 days. It is disabled when more than 5
            // days remain, when the member has previously cancelled, the job is completed/cancelled,
            // or the job has already passed.
                    const daysToStart = Math.ceil((new Date(job.startDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));
                    const hasCancelled = (job.cancelledMemberIds && job.cancelledMemberIds.includes(currentUser.uid)) || (job.cancellationRequests && job.cancellationRequests[currentUser.uid]);
                    // Disable when more than 5 days remain (too early), when already cancelled, when job is completed/cancelled or past
                    const disableCancel = hasCancelled || daysToStart > 5 || job.status === 'completed' || job.status === 'cancelled' || isPast;
                    memberCancelBtn.disabled = disableCancel;
                    memberCancelBtn.classList.toggle('opacity-50', disableCancel);
                    memberCancelBtn.classList.toggle('cursor-not-allowed', disableCancel);
                    if (disableCancel) {
                        memberCancelBtn.onclick = (e) => {
                            // Prevent event bubbling
                            e.stopPropagation();
                            e.preventDefault();
                            // Show a clear message explaining why the member cannot cancel.
                            alert('ไม่สามารถขอยกเลิกคิวงานได้ก่อนถึงวันงาน 5 วัน หรือคุณได้เคยยกเลิกคิวนี้แล้ว');
                        };
                    } else {
                        memberCancelBtn.onclick = (e) => {
                            // Prevent event bubbling
                            e.stopPropagation();
                            e.preventDefault();
                            requestCancel(job.id, job.name);
                        };
                    }
                } else {
                    // Hide for users who are not team members or not a member role
                    memberCancelBtn.classList.add('hidden');
                    memberCancelBtn.onclick = null;
                }
            }
            // Admin edit button visibility and click handler
            if (adminEditBtn) {
                if (currentUserRole === 'admin') {
                    adminEditBtn.classList.remove('hidden');
                    adminEditBtn.onclick = (e) => {
                        // Prevent event bubbling
                        e.stopPropagation();
                        e.preventDefault();
                        showEditJobOptions(job);
                    };
                } else {
                    adminEditBtn.classList.add('hidden');
                    adminEditBtn.onclick = null;
                }
            }
        }

            const paidMembers = job.team.filter(m => m.isPaid);
            const unpaidMembers = job.team.filter(m => !m.isPaid);
            const paidCount = paidMembers.length;
            const paidAmount = paidMembers.reduce((total, member) => total + calculateTeamCostForMember(member, job.workdays), 0);

            const summaryEl = document.getElementById('payment-summary');
            summaryEl.textContent = `จ่ายแล้ว: ${paidAmount.toLocaleString()} บาท / ${paidCount} คน`;

            const payAllBtn = document.getElementById('pay-all-btn');
            payAllBtn.disabled = unpaidMembers.length === 0;

            const completeJobBtn = document.getElementById('complete-job-btn');
            if (job.status !== 'completed') {
                completeJobBtn.disabled = unpaidMembers.length > 0;
                completeJobBtn.classList.toggle('opacity-50', unpaidMembers.length > 0);
                completeJobBtn.classList.toggle('cursor-not-allowed', unpaidMembers.length > 0);
            } else {
                 completeJobBtn.disabled = false;
                 completeJobBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function updateCalculations(job) {
            document.getElementById('summary-team-count').textContent = job.team.length;
            const teamTotalCost = job.team.reduce((total, member) => total + calculateTeamCostForMember(member, job.workdays), 0);
            const otherExpensesTotal = (job.expenses || []).reduce((total, expense) => total + expense.amount, 0);
            document.getElementById('summary-budget').textContent = `${(job.income || 0).toLocaleString()} บาท`;
            document.getElementById('summary-team-cost').textContent = `${teamTotalCost.toLocaleString()} บาท`;
            document.getElementById('summary-other-expenses').textContent = `${otherExpensesTotal.toLocaleString()} บาท`;

            const whtPercentValue = job.whtPercent === undefined ? appSettings.whtPercent : job.whtPercent;
            const subtotal = teamTotalCost + otherExpensesTotal;
            const whtAmount = job.whtEnabled ? (job.income * whtPercentValue / 100) : 0;
            const vatAmount = job.vatEnabled ? (job.income * 0.07) : 0; // VAT is calculated from budget

            const totalCost = subtotal; // Total cost is now team + other expenses
            const profitLoss = (job.income - vatAmount) - totalCost - whtAmount; // Profit is budget minus vat, minus costs, minus wht

            document.getElementById('summary-wht').textContent = `${whtAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท`;
            document.getElementById('summary-vat').textContent = `${vatAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท`;
            document.getElementById('summary-total-cost').textContent = `${totalCost.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท`;
            
            const profitLossEl = document.getElementById('summary-profit-loss');
            // Display profit/loss with "บาท" on a new line and center-align
            profitLossEl.innerHTML = `<span class="block">${profitLoss.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span><span class="block text-base">บาท</span>`;
            profitLossEl.style.textAlign = 'center';
            profitLossEl.className = `font-bold mt-2 ${profitLoss >= 0 ? 'text-5xl profit-text' : 'text-4xl loss-text'}`;
            // Update the profit/loss label. For the team leader, show "คงเหลือ" instead of "กำไร/ขาดทุน".
            const profitLossLabelEl = document.getElementById('profit-loss-label');
            let labelText = '';
            if (currentUserRole === 'admin') {
                labelText = profitLoss >= 0 ? 'กำไร' : 'ขาดทุน';
            } else {
                // Determine if current user is the team leader for this job
                const isLeader = job.teamLeaderId && currentUser && currentUser.uid === job.teamLeaderId;
                if (isLeader) {
                    labelText = 'คงเหลือ';
                } else {
                    labelText = profitLoss >= 0 ? 'กำไร' : 'ขาดทุน';
                }
            }
            profitLossLabelEl.textContent = labelText;
        }


        async function handleTaxSettingsChange() {
            if (!currentJobId || !currentJobData) return;

            const whtEnabled = document.getElementById('wht-toggle').checked;
            const vatEnabled = document.getElementById('vat-toggle').checked;
            const whtPercent = parseFloat(document.getElementById('wht-percent').value) || 0;

            const updatedJobForCalc = { ...currentJobData, whtEnabled, vatEnabled, whtPercent };
            updateCalculations(updatedJobForCalc);

            try {
                await updateDoc(doc(db, "jobs", currentJobId), { whtEnabled, vatEnabled, whtPercent });
            } catch (error) { console.error("Failed to save tax settings:", error); }
        }

        function addDynamicEventListeners(job) {
            ['wht-toggle', 'wht-percent', 'vat-toggle'].forEach(id => { document.getElementById(id).oninput = handleTaxSettingsChange; });

            const adminNotesTextarea = document.getElementById('admin-notes-textarea');
            if (adminNotesTextarea) {
                adminNotesTextarea.onblur = async (e) => {
                    const newNotes = e.target.value;
                    if (currentJobData.notes !== newNotes) {
                        await updateDoc(doc(db, "jobs", currentJobId), { notes: newNotes });
                    }
                };
            }

            const teamNotesTextarea = document.getElementById('team-notes-textarea');
            if (teamNotesTextarea) {
                teamNotesTextarea.onblur = async (e) => {
                    const newTeamNotes = e.target.value;
                    if (currentJobData.teamNotes !== newTeamNotes) {
                        await updateDoc(doc(db, "jobs", currentJobId), { teamNotes: newTeamNotes });
                    }
                };
            }

            document.querySelectorAll('.schedule-checkbox').forEach(box => {
                box.onclick = async (e) => {
                    const button = e.currentTarget;
                    const { userid, day } = button.dataset;
                    const updatedTeam = currentJobData.team.map(m => {
                        if (m.userId === userid) {
                            const isWorking = m.workdays.includes(day);
                            if (isWorking) {
                                m.workdays = m.workdays.filter(d => d !== day);
                            } else {
                                m.workdays.push(day);
                            }
                        }
                        return m;
                    });
                    await updateDoc(doc(db, "jobs", currentJobId), { team: updatedTeam });
                };
            });
            
             document.querySelectorAll('.member-wht-checkbox').forEach(box => {
                box.onchange = async (e) => {
                    const checkbox = e.currentTarget;
                    const { userid } = checkbox.dataset;
                    const isChecked = checkbox.checked;

                    const updatedTeam = currentJobData.team.map(m => {
                        if (m.userId === userid) {
                            return { ...m, whtEnabled: isChecked };
                        }
                        return m;
                    });

                    await updateDoc(doc(db, "jobs", currentJobId), { team: updatedTeam });
                };
            });

            document.querySelectorAll('.pay-member-btn').forEach(btn => btn.onclick = (e) => {
                const userIdToToggle = e.currentTarget.dataset.userid;
                const memberInfo = currentJobData.team.find(m => m.userId === userIdToToggle);
                const memberUser = allUsers.find(u => u.id === userIdToToggle);
                const memberName = memberUser.nickname || memberUser.name;

                if (memberInfo.isPaid) {
                    showConfirmModal('ยืนยันการยกเลิกจ่ายค่าแรง', `คุณต้องการยกเลิกสถานะ "ได้รับเงินแล้ว" ของ ${memberName} ใช่หรือไม่?`, async () => {
                        const updatedTeam = currentJobData.team.map(m => {
                            if (m.userId === userIdToToggle) {
                                const { paymentDate, ...rest } = m;
                                return { ...rest, isPaid: false };
                            }
                            return m;
                        });
                        await updateDoc(doc(db, "jobs", currentJobId), { team: updatedTeam });
                    });
                } else {
                    showPaymentConfirmModal(memberName, memberUser, async (paymentDate) => {
                        const updatedTeam = currentJobData.team.map(m => {
                            if (m.userId === userIdToToggle) {
                                return { ...m, isPaid: true, paymentDate: paymentDate };
                            }
                            return m;
                        });
                        await updateDoc(doc(db, "jobs", currentJobId), { team: updatedTeam });
                    });
                }
            });

            document.getElementById('pay-all-btn').onclick = () => {
                 showPaymentConfirmModal('ทีมงานที่เหลือทั้งหมด', null, async (paymentDate) => {
                    const updatedTeam = currentJobData.team.map(m => {
                        if (!m.isPaid) {
                            return { ...m, isPaid: true, paymentDate: paymentDate };
                        }
                        return m;
                    });
                    await updateDoc(doc(db, "jobs", currentJobId), { team: updatedTeam });
                });
            };

            document.querySelectorAll('.edit-member-btn').forEach(btn => btn.onclick = (e) => showEditMemberModal(job.team.find(m => m.userId === e.currentTarget.dataset.userid)));
            document.querySelectorAll('.remove-member-btn').forEach(btn => btn.onclick = (e) => {
                const userIdToRemove = e.currentTarget.dataset.userid;
                const memberToRemove = currentJobData.team.find(m => m.userId === userIdToRemove);
                if (memberToRemove) {
                    showConfirmModal('ยืนยันการลบ', 'คุณต้องการลบทีมงานคนนี้ออกจากคิวงานนี้หรือไม่?', async () => {
                        await updateDoc(doc(db, "jobs", currentJobId), { team: arrayRemove(memberToRemove) });
                    });
                }
            });
            document.querySelectorAll('.remove-expense-btn').forEach(btn => btn.onclick = (e) => {
                const indexToRemove = parseInt(e.currentTarget.dataset.index);
                const expenseToRemove = currentJobData.expenses[indexToRemove];
                if (expenseToRemove) {
                    showConfirmModal('ยืนยันการลบ', `คุณต้องการลบค่าใช้จ่ายรายการ "${expenseToRemove.name}" หรือไม่?`, async () => {
                        const updatedExpenses = currentJobData.expenses.filter((_, index) => index !== indexToRemove);
                        await updateDoc(doc(db, "jobs", currentJobId), { expenses: updatedExpenses });
                    });
                }
            });
            document.querySelectorAll('.edit-expense-btn').forEach(btn => btn.onclick = (e) => {
                const index = parseInt(e.currentTarget.dataset.index);
                showEditExpenseModal(currentJobData.expenses[index], index);
            });
            document.querySelectorAll('.delete-day-btn').forEach(btn => btn.onclick = (e) => {
                const dayToDelete = e.currentTarget.dataset.day;
                showConfirmModal('ยืนยันการลบวัน', `คุณต้องการลบวันที่ ${formatShortDate(dayToDelete)} หรือไม่?`, async () => {
                    currentJobData.workdays = currentJobData.workdays.filter(d => d !== dayToDelete);
                    currentJobData.team.forEach(member => {
                        member.workdays = member.workdays.filter(d => d !== dayToDelete);
                        if (member.dailyOverrides) delete member.dailyOverrides[dayToDelete];
                    });
                    await updateDoc(doc(db, "jobs", currentJobId), { workdays: currentJobData.workdays, team: currentJobData.team });
                });
            });
            document.querySelectorAll('.edit-daily-rate-btn').forEach(btn => btn.onclick = (e) => showEditDailyRateModal(e.currentTarget.dataset.userid, e.currentTarget.dataset.day));
            document.querySelectorAll('.edit-day-btn').forEach(btn => btn.onclick = (e) => showEditWorkdayModal(e.currentTarget.dataset.day));

            // Drag and Drop Event Listeners
            const scheduleBody = document.getElementById('schedule-body');
            scheduleBody.addEventListener('dragstart', e => {
                if (currentUserRole !== 'admin') return;
                draggedItem = e.target;
                setTimeout(() => e.target.classList.add('dragging'), 0);
            });

            scheduleBody.addEventListener('dragend', e => {
                 if (currentUserRole !== 'admin') return;
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            });

            scheduleBody.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(scheduleBody, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (afterElement == null) {
                    scheduleBody.appendChild(draggable);
                } else {
                    scheduleBody.insertBefore(draggable, afterElement);
                }
            });

            scheduleBody.addEventListener('drop', async e => {
                e.preventDefault();
                if (currentUserRole !== 'admin') return;
                const newOrderedIds = [...scheduleBody.querySelectorAll('tr')].map(tr => tr.dataset.userid);
                const newTeamOrder = newOrderedIds.map(id => currentJobData.team.find(m => m.userId === id));
                await updateDoc(doc(db, "jobs", currentJobId), { team: newTeamOrder });
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('tr:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        ['add-job-button', 'add-member-button', 'add-day-button', 'add-expense-button', 'edit-budget-btn', 'edit-job-details-btn', 'manage-profile-button', 'manage-all-users-button', 'save-image-btn', 'financial-summary-button', 'back-to-main-app-btn', 'notifications-button', 'filter-my-jobs', 'filter-all-jobs', 'system-settings-button', 'line-bot-button', 'tax-management-button', 'withholding-button', 'activity-log-button'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                if (id === 'filter-my-jobs') {
                    el.addEventListener('click', () => { memberJobFilter = 'my_jobs'; applyFiltersAndRenderJobs(); });
                } else if (id === 'filter-all-jobs') {
                    el.addEventListener('click', () => { memberJobFilter = 'all'; applyFiltersAndRenderJobs(); });
                } else if (id === 'financial-summary-button') {
                    el.addEventListener('click', showFinancialSummaryView);
                } else if (id === 'back-to-main-app-btn') {
                    el.addEventListener('click', () => {
                        mainApp.classList.remove('hidden');
                        document.getElementById('financial-summary-view').classList.add('hidden');
                    });
                } else {
                     el.addEventListener('click', () => {
                        switch(id) {
                            case 'add-job-button': showJobModal(); break;
                            case 'add-member-button': showAddMemberModal(); break;
                            case 'add-day-button': showAddDayModal(); break;
                            case 'add-expense-button': showExpenseModal(); break;
                            case 'edit-budget-btn': showEditBudgetModal(currentJobData.income); break;
                            case 'edit-job-details-btn': showEditJobDetailsModal(currentJobData); break;
                            case 'manage-profile-button': showManageProfileModal(); break;
                            case 'manage-all-users-button': showUserManagementModal(); break;
                            case 'system-settings-button': showSettingsView(); break;
                            case 'line-bot-button': showLineBotView(); break;
                            case 'tax-management-button':
                                // ผู้ดูแลจะเข้าสู่หน้าจัดการภาษีหัก ณ ที่จ่าย
                                showWhtManagementView();
                                break;
                            case 'withholding-button':
                                // สมาชิกจะเข้าสู่หน้า รายการหัก ณ ที่จ่าย
                                showMemberWhtListView();
                                break;
                            case 'activity-log-button':
                                // แสดงประวัติการทำรายการ (Activity Log)
                                showActivityLogModal();
                                break;
                            case 'save-image-btn':
                                // Build a custom summary for the screenshot that omits monetary values.
                                if (!currentJobData) return;
                                // Create a temporary container for the summary
                                const tempContainer = document.createElement('div');
                                tempContainer.style.padding = '24px';
                                tempContainer.style.backgroundColor = '#ffffff';
                                tempContainer.style.color = '#1f2937'; // Tailwind gray-800
                                tempContainer.style.fontFamily = "'Kanit', sans-serif";
                                // Gather data: job name, date range, location, team names, workdays
                                const jobName = currentJobData.name || '';
                                // Format date range using existing helper
                                const dateRange = formatDateRange(currentJobData.startDate, currentJobData.endDate);
                                const location = currentJobData.location || '';
                                // Build a header row for workdays and create a table showing each member's schedule.
                                const workdays = currentJobData.workdays || [];
                                // Construct header cells for each workday
                                const headerCells = workdays.map(day => `<th style="padding:6px;text-align:center;font-size:0.75rem;font-weight:500;color:#374151;border:1px dotted #e5e7eb;">${formatShortDate(day)}</th>`).join('');
                                // Build rows: first cell contains profile + name + position, subsequent cells contain green check marks if working
                                const teamTableRows = currentJobData.team.map(m => {
                                    const userData = allUsers.find(u => u.id === m.userId);
                                    const displayName = userData ? (userData.nickname || userData.name) : '';
                                    const profilePic = (userData && userData.profilePic) ? userData.profilePic : 'https://placehold.co/40x40/E2E8F0/4A5568?text=??';
                                    const position = m.position || '';
                                    // Build cells for each workday: green check if member works on that day
                                    const dayCells = workdays.map(day => {
                                        const isWorking = (m.workdays || []).includes(day);
                                        return `<td style="padding:6px;text-align:center;vertical-align:middle;font-size:1rem;border:1px dotted #d1d5db;background-color:#f9fafb;border-radius:6px;">${isWorking ? '<span style="color:#22c55e;">✔</span>' : ''}</td>`;
                                    }).join('');
                                    return `<tr><td style="display:flex;align-items:center;padding:6px;border:1px dotted #d1d5db;background-color:#f9fafb;border-radius:6px;"><img src="${profilePic}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;margin-right:8px;"><div><div style="font-weight:500;">${displayName}</div><div style="font-size:0.7rem;color:#6b7280;">${position}</div></div></td>${dayCells}</tr>`;
                                }).join('');
                                const teamTableHTML = `<table style="width:100%;border-collapse:collapse;border:1px dotted #e5e7eb;border-radius:8px;overflow:hidden;"><thead><tr><th style="padding:6px;text-align:left;font-size:0.8rem;font-weight:600;color:#374151;border:1px dotted #e5e7eb;">ทีมงาน</th>${headerCells}</tr></thead><tbody>${teamTableRows}</tbody></table>`;
                                // Prepare optional notes
                                let notesHTML = '';
                                if (currentJobData.notes) {
                                    notesHTML += `<p style="margin-top:0.5rem;">หมายเหตุ: ${currentJobData.notes}</p>`;
                                }
                                if (currentJobData.teamNotes) {
                                    notesHTML += `<p style="margin-top:0.25rem;">โน้ต: ${currentJobData.teamNotes}</p>`;
                                }
                                // Assemble HTML for the summary without the separate workdays line
                                tempContainer.innerHTML = `
                                    <h3 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">${jobName}</h3>
                                    <p style="margin-bottom: 0.25rem;">วันที่: ${dateRange}</p>
                                    <p style="margin-bottom: 0.25rem;">สถานที่: ${location}</p>
                                    <div style="margin-top:0.75rem;">${teamTableHTML}</div>
                                    ${notesHTML}
                                `;
                                // Position the container off-screen to avoid disrupting layout
                                tempContainer.style.position = 'absolute';
                                tempContainer.style.left = '-9999px';
                                document.body.appendChild(tempContainer);
                                html2canvas(tempContainer, { scale: 2, backgroundColor: '#ffffff' , useCORS: true }).then(canvas => {
                                    const link = document.createElement('a');
                                    link.download = `job-summary-${currentJobId}.png`;
                                    link.href = canvas.toDataURL();
                                    link.click();
                                    // Clean up
                                    document.body.removeChild(tempContainer);
                                });
                                break;
                            case 'notifications-button':
                                showNotificationsModal();
                                break;
                        }
                    });
                }
            }
        });

        document.getElementById('back-to-main-from-settings-btn').addEventListener('click', () => {
            document.getElementById('settings-view').classList.add('hidden');
            mainApp.classList.remove('hidden');
        });

        document.getElementById('back-to-main-from-bot-btn').addEventListener('click', () => {
            document.getElementById('line-bot-view').classList.add('hidden');
            mainApp.classList.remove('hidden');
        });

        // Back buttons and search/export for withholding and tax management views (ใหม่)
        const backWhtBtn = document.getElementById('back-to-financial-from-wht-btn');
        if (backWhtBtn) {
            backWhtBtn.addEventListener('click', () => {
                // ซ่อนหน้าแสดงรายการหัก ณ ที่จ่าย แล้วกลับไปที่สรุปบัญชี
                document.getElementById('withholding-list-view').classList.add('hidden');
                showFinancialSummaryView();
            });
        }
        const backTaxBtn = document.getElementById('back-to-financial-from-tax-btn');
        if (backTaxBtn) {
            backTaxBtn.addEventListener('click', () => {
                // ซ่อนหน้า จัดการภาษี หัก ณ ที่จ่าย แล้วกลับไปที่สรุปบัญชี
                document.getElementById('wht-management-view').classList.add('hidden');
                showFinancialSummaryView();
            });
        }
        // Attach search button for member withholding list
        const memberWhtSearchBtn = document.getElementById('member-wht-search-btn');
        if (memberWhtSearchBtn) {
            memberWhtSearchBtn.addEventListener('click', () => {
                generateMemberWhtList();
            });
        }
        // Attach search button for admin tax management
        const adminWhtSearchBtn = document.getElementById('admin-wht-search-btn');
        if (adminWhtSearchBtn) {
            adminWhtSearchBtn.addEventListener('click', () => {
                generateAdminWhtReport();
            });
        }
        // Attach export buttons for admin
        const adminExportCsvBtn = document.getElementById('admin-wht-export-csv-btn');
        if (adminExportCsvBtn) {
            adminExportCsvBtn.addEventListener('click', () => {
                exportAdminWhtData();
            });
        }
        const adminExportPdfBtn = document.getElementById('admin-wht-export-pdf-btn');
        if (adminExportPdfBtn) {
            adminExportPdfBtn.addEventListener('click', () => {
                exportAdminWhtDataPdf();
            });
        }

        /**
         * แปลงตัวเลขเป็นตัวหนังสือภาษาไทย เพื่อใช้ในเอกสารหนังสือรับรอง
         * รองรับเลขจนถึงหลักล้านและจุดทศนิยม (สตางค์)
         */
        function numberToThaiText(num) {
            const numStr = (+num).toFixed(2);
            const [intPart, decPart] = numStr.split('.');
            const txtNumArr = ['ศูนย์','หนึ่ง','สอง','สาม','สี่','ห้า','หก','เจ็ด','แปด','เก้า'];
            const txtDigitArr = ['', 'สิบ', 'ร้อย', 'พัน', 'หมื่น', 'แสน', 'ล้าน'];
            function readNumber(n) {
                let result = '';
                const len = n.length;
                [...n].forEach((digit, idx) => {
                    const num = parseInt(digit);
                    if (num === 0) return;
                    const pos = len - idx - 1;
                    if (pos === 0 && num === 1 && len > 1) {
                        result += 'เอ็ด';
                    } else if (pos === 1 && num === 2) {
                        result += 'ยี่';
                    } else if (pos === 1 && num === 1) {
                        result += '';
                    } else {
                        result += txtNumArr[num];
                    }
                    result += txtDigitArr[pos];
                });
                return result;
            }
            let bahtText = readNumber(intPart);
            bahtText += 'บาท';
            let satangText = '';
            if (decPart && decPart !== '00') {
                satangText = readNumber(decPart);
                satangText += 'สตางค์';
            } else {
                satangText = 'ถ้วน';
            }
            return bahtText + satangText;
        }

        /**
         * เติมตัวเลือกเดือน/ปี สำหรับหน้า รายการหัก ณ ที่จ่าย ของสมาชิก
         * ดึงข้อมูลจาก allJobs เพื่อดูว่างานใดบ้างในช่วงปีใดเดือนใด
         */
        function populateWhtListMonthYearSelect() {
            const monthSelect = document.getElementById('member-wht-month');
            const yearSelect = document.getElementById('member-wht-year');
            if (!monthSelect || !yearSelect) return;
            // เคลียร์ค่าปัจจุบัน
            monthSelect.innerHTML = '';
            yearSelect.innerHTML = '';
            const monthNames = ['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];
            monthNames.forEach((m, idx) => {
                const opt = document.createElement('option');
                opt.value = idx + 1;
                opt.textContent = m;
                monthSelect.appendChild(opt);
            });
            // รวบรวมปีจาก workdays ของทุกคิวงาน
            const yearSet = new Set();
            allJobs.forEach(job => {
                if (!job.workdays || job.workdays.length === 0) return;
                job.workdays.forEach(day => {
                    const d = new Date(day);
                    if (!isNaN(d)) yearSet.add(d.getFullYear());
                });
            });
            // หากยังไม่มีปี ให้ใส่ปีปัจจุบัน
            if (yearSet.size === 0) yearSet.add(new Date().getFullYear());
            [...yearSet].sort((a,b) => a - b).forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                yearSelect.appendChild(opt);
            });
            // ตั้งค่าเริ่มต้นเป็นเดือน/ปีปัจจุบัน
            const now = new Date();
            monthSelect.value = now.getMonth() + 1;
            yearSelect.value = now.getFullYear();
        }

        /**
         * สร้างตารางรายการหัก ณ ที่จ่ายสำหรับสมาชิกในเดือน/ปีที่เลือก
         */
        function generateMemberWhtList() {
            const tableBody = document.getElementById('member-wht-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            const selectedMonth = parseInt(document.getElementById('member-wht-month').value);
            const selectedYear = parseInt(document.getElementById('member-wht-year').value);
            let rows = '';
            let hasData = false;
            allJobs.forEach(job => {
                if (!job.workdays || !job.team) return;
                // ตรวจสอบว่ามีวันทำงานในเดือน/ปีนี้หรือไม่
                const hasWorkInMonth = job.workdays.some(day => {
                    const d = new Date(day);
                    return d.getMonth() + 1 === selectedMonth && d.getFullYear() === selectedYear;
                });
                if (!hasWorkInMonth) return;
                // หาทีมของผู้ใช้ปัจจุบัน
                const member = job.team.find(m => m.userId === currentUser.uid);
                if (!member || !member.whtEnabled) return;
                // คำนวณรายรับและภาษีที่หัก
                const totalWage = calculateTeamCostForMember(member, job.workdays);
                const whtAmount = (totalWage * appSettings.whtPercent) / 100;
                const net = totalWage - whtAmount;
                hasData = true;
                // Determine if admin has uploaded certificates for this job/member and count downloads
                const jobCerts = uploadedMemberCertificates[job.id] || {};
                const certData = jobCerts[currentUser.uid];
                let totalVersions = 0;
                if (certData) {
                    totalVersions = Array.isArray(certData) ? certData.length : 1;
                }
                const downloadCount = (memberDownloadCounts[job.id] && memberDownloadCounts[job.id][currentUser.uid]) ? memberDownloadCounts[job.id][currentUser.uid] : 0;
                const hasNew = totalVersions > downloadCount;
                const highlightClass = hasNew ? 'bg-yellow-50' : '';
                const newIcon = hasNew ? '<i class="ph ph-bell-ringing text-red-500 mr-1"></i>' : '';
                const downloadLabel = downloadCount > 0 ? ` (โหลดแล้ว ${downloadCount} ครั้ง)` : '';
                rows += `<tr class="hover:bg-gray-50 ${highlightClass}">
                    <td class="px-6 py-4 whitespace-nowrap">${job.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${totalWage.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${whtAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${net.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <button type="button" class="text-blue-600 hover:text-blue-800 member-download-btn" data-jobid="${job.id}">${newIcon}<i class="ph ph-download-simple"></i>${downloadLabel}</button>
                    </td>
                </tr>`;
            });
            if (!hasData) {
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">ไม่มีข้อมูล</td></tr>';
            } else {
                tableBody.innerHTML = rows;
                // Attach download handler for each row to support versioned downloads
                tableBody.querySelectorAll('.member-download-btn').forEach(btn => {
                    const jobId = btn.dataset.jobid;
                    btn.addEventListener('click', () => {
                        downloadUploadedMemberCertificate(jobId);
                    });
                });
            }
        }

        /**
         * แสดงหน้า รายการหัก ณ ที่จ่าย สำหรับสมาชิก
         * ซ่อนหน้าอื่นและตั้งค่าตัวเลือกเดือน/ปี แล้วสร้างตาราง
         */
        function showMemberWhtListView() {
            // ซ่อนสรุปบัญชีและหน้าหลัก
            document.getElementById('financial-summary-view').classList.add('hidden');
            // แสดงเมนูหลัก (mainApp) เพื่อให้ส่วนหัวและปุ่มยังอยู่เหมือนเดิม
            // ป้องกันซ่อน mainApp เพื่อไม่ให้หายไป
            // แสดงหน้า withholding list
            const viewEl = document.getElementById('withholding-list-view');
            if (!viewEl) return;
            viewEl.classList.remove('hidden');
            // เตรียมตัวเลือกเดือน/ปีและข้อมูล
            populateWhtListMonthYearSelect();
            // เมื่อมีการเปลี่ยนเดือน/ปี ให้สร้างตารางใหม่
            const monthSel = document.getElementById('member-wht-month');
            const yearSel = document.getElementById('member-wht-year');
            if (monthSel) monthSel.onchange = () => generateMemberWhtList();
            if (yearSel) yearSel.onchange = () => generateMemberWhtList();
            generateMemberWhtList();
        }

        /**
         * helper: ดึงไฟล์รูปภาพและแปลงเป็น dataURL สำหรับใส่ใน PDF
         */
        async function toDataUrl(url) {
            if (!url) return null;
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
            } catch (e) {
                console.error('Error fetching image', e);
                return null;
            }
        }

        /**
         * สร้างไฟล์ PDF หนังสือรับรองหัก ณ ที่จ่าย (50 ทวิ) ของสมาชิกในเดือนที่เลือก
         * นำข้อมูลทุกคิวงานในเดือนนั้นมารวมกัน
         */
        async function downloadMemberCertificate() {
            // Show loading overlay while generating the certificate
            showLoading();
            const selectedMonth = parseInt(document.getElementById('member-wht-month').value);
            const selectedYear = parseInt(document.getElementById('member-wht-year').value);
            // รวบรวมคิวงานของสมาชิกในเดือน/ปีนี้
            const jobsForMonth = [];
            let totalWage = 0;
            let totalWht = 0;
            allJobs.forEach(job => {
                if (!job.workdays || !job.team) return;
                const hasWork = job.workdays.some(day => {
                    const d = new Date(day);
                    return d.getMonth() + 1 === selectedMonth && d.getFullYear() === selectedYear;
                });
                if (!hasWork) return;
                const member = job.team.find(m => m.userId === currentUser.uid);
                if (!member || !member.whtEnabled) return;
                const wage = calculateTeamCostForMember(member, job.workdays);
                const wht = wage * appSettings.whtPercent / 100;
                jobsForMonth.push({ name: job.name, wage, wht });
                totalWage += wage;
                totalWht += wht;
            });
            if (jobsForMonth.length === 0) {
                alert('ไม่มีข้อมูลคิวงานที่ต้องหัก ณ ที่จ่ายในเดือนที่เลือก');
                hideLoading();
                return;
            }

        /**
         * Download the latest uploaded certificate for a specific job if available.
         * Falls back to generating a new certificate if admin has not uploaded any file.
         * Tracks download count for version control and highlights new files.
         */
        function downloadUploadedMemberCertificate(jobId) {
            showLoading();
            try {
                const jobCerts = uploadedMemberCertificates[jobId] || {};
                const certVal = jobCerts[currentUser.uid];
                let latestData = null;
                if (certVal) {
                    if (Array.isArray(certVal)) {
                        const lastVersion = certVal[certVal.length - 1];
                        latestData = lastVersion && lastVersion.data;
                    } else {
                        latestData = certVal;
                    }
                }
                if (latestData) {
                    if (!memberDownloadCounts[jobId]) {
                        memberDownloadCounts[jobId] = {};
                    }
                    if (!memberDownloadCounts[jobId][currentUser.uid]) {
                        memberDownloadCounts[jobId][currentUser.uid] = 0;
                    }
                    memberDownloadCounts[jobId][currentUser.uid] += 1;
                    localStorage.setItem('memberDownloadCounts', JSON.stringify(memberDownloadCounts));
                    // open the PDF in new tab
                    window.open(latestData, '_blank');
                    // regenerate list to update highlight and counts
                    generateMemberWhtList();
                } else {
                    // no uploaded certificate; generate and download aggregated certificate
                    downloadMemberCertificate();
                }
            } finally {
                hideLoading();
            }
        }
            // กำหนดหมายเลขเล่ม/เลขที่สำหรับสมาชิกตามเดือน/ปี
            const uniqueKey = `${selectedYear}_${selectedMonth}`;
            const { bookNo, docNo } = await getOrAssignBookDoc(uniqueKey, currentUser.uid);
            // วันสิ้นเดือน
            const issueDate = new Date(selectedYear, selectedMonth, 0);
            const issueDateStr = `${issueDate.getDate()}/${issueDate.getMonth()+1}/${issueDate.getFullYear()+543}`;
            const thaiWhtText = numberToThaiText(totalWht);
            // สร้าง PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            // ใส่ภาพพื้นหลังหนังสือ 50 ทวิ (ถ้ามี)
            if (appSettings.whtFormImageUrl) {
                const bgData = await toDataUrl(appSettings.whtFormImageUrl);
                if (bgData) {
                    pdf.addImage(bgData, 'PNG', 0, 0, 210, 297);
                }
            }
            pdf.setFont('Helvetica');
            pdf.setFontSize(12);
            // โลโก้บริษัท (ถ้ามี)
            const logoData = await toDataUrl(appSettings.whtCompanyLogoUrl);
            if (logoData) {
                pdf.addImage(logoData, 'PNG', 10, 10, 30, 30);
            }
            const layout = appSettings.whtFormLayout || {};
            // ส่วนหัว
            const titlePos = layout.title || { x: 105, y: 20 };
            pdf.setFontSize(layout.title?.size || 16);
            pdf.text('หนังสือรับรองการหักภาษี ณ ที่จ่าย (50 ทวิ)', titlePos.x, titlePos.y, { align: 'center' });
            const bookPos = layout.bookNo || { x: 105, y: titlePos.y + 8 };
            pdf.setFontSize(layout.bookNo?.size || 12);
            pdf.text(`เล่มที่ ${bookNo}   เลขที่ ${docNo}`, bookPos.x, bookPos.y, { align: 'center' });
            const taxPos = layout.taxId || { x: 105, y: bookPos.y + 8 };
            pdf.setFontSize(layout.taxId?.size || 12);
            pdf.text(`เลขประจำตัวผู้เสียภาษีอากร: ${appSettings.whtTaxId}`, taxPos.x, taxPos.y, { align: 'center' });
            const compNamePos = layout.companyName || { x: 105, y: taxPos.y + 8 };
            pdf.setFontSize(layout.companyName?.size || 12);
            pdf.text(appSettings.whtCompanyName, compNamePos.x, compNamePos.y, { align: 'center' });
            const compAddrPos = layout.companyAddress || { x: 105, y: compNamePos.y + 6 };
            pdf.setFontSize(layout.companyAddress?.size || 12);
            pdf.text(appSettings.whtCompanyAddress, compAddrPos.x, compAddrPos.y, { align: 'center' });
            if (layout.formType) { pdf.setFontSize(layout.formType.size || 12); pdf.text(appSettings.whtFormType || '', layout.formType.x, layout.formType.y); }
            if (layout.incomeType) { pdf.setFontSize(layout.incomeType.size || 12); pdf.text(appSettings.whtIncomeType || '', layout.incomeType.x, layout.incomeType.y); }
            if (layout.payerOption) { pdf.setFontSize(layout.payerOption.size || 12); pdf.text(appSettings.whtPayerOption || '', layout.payerOption.x, layout.payerOption.y); }
            // ผู้ออกหนังสือ
            const signerLabel = `ผู้ออกหนังสือ: ${currentUserData.nickname || currentUserData.name}`;
            if (layout.signerName) {
                pdf.setFontSize(layout.signerName.size || 12);
                pdf.text(signerLabel, layout.signerName.x, layout.signerName.y);
            } else {
                pdf.setFontSize(12);
                pdf.text(signerLabel, 20, compAddrPos.y + 20);
            }
            // ผู้ถูกหักภาษี (คือสมาชิกเอง)
            const recipientLabel = `ผู้ถูกหักภาษี: ${currentUserData.nickname || currentUserData.name}`;
            if (layout.recipientName) {
                pdf.setFontSize(layout.recipientName.size || 12);
                pdf.text(recipientLabel, layout.recipientName.x, layout.recipientName.y);
            } else {
                pdf.setFontSize(12);
                pdf.text(recipientLabel, 20, compAddrPos.y + 28);
            }
            // รายละเอียดคิวงาน
            const detailsStartY = (layout.totalPay && layout.totalPay.y) ? layout.totalPay.y - (jobsForMonth.length * 5) - 15 : (layout.recipientName ? layout.recipientName.y + 6 : compAddrPos.y + 34);
            pdf.text('รายละเอียดคิวงาน', 20, detailsStartY);
            let runningY = detailsStartY + 6;
            pdf.setFontSize(layout.detailItem?.size || 10);
            jobsForMonth.forEach(item => {
                pdf.text(`- ${item.name}: ${item.wage.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} บาท`, 25, runningY);
                runningY += 5;
            });
            pdf.setFontSize(layout.totalPay?.size || 12);
            const totalPayPos = layout.totalPay || { x: 20, y: runningY + 3 };
            pdf.text(`รวมจำนวนเงินที่จ่ายทั้งสิ้น: ${totalWage.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} บาท`, totalPayPos.x, totalPayPos.y);
            const taxAmtPos = layout.taxAmount || { x: 20, y: totalPayPos.y + 6 };
            pdf.text(`ภาษีที่หักและนำส่งไว้: ${totalWht.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} บาท`, taxAmtPos.x, taxAmtPos.y);
            const taxTextPos = layout.taxAmountText || { x: 20, y: taxAmtPos.y + 6 };
            pdf.text(`รวมเงินภาษีที่หักนำส่งไว้ (ตัวอักษร): ${thaiWhtText}`, taxTextPos.x, taxTextPos.y);
            const datePos = layout.issueDate || { x: 20, y: taxTextPos.y + 6 };
            pdf.text(`ออกหนังสือ ณ วันที่ ${issueDateStr}`, datePos.x, datePos.y);
            const signLineY = datePos.y + 8;
            pdf.text('ลงชื่อ _________________________', 20, signLineY);
            const signNamePos = layout.signerName || { x: 20, y: signLineY + 6 };
            pdf.text(`(${appSettings.whtSignerName || currentUserData.nickname || currentUserData.name})`, signNamePos.x, signNamePos.y);
            // บันทึกไฟล์
            pdf.save(`WHT_${currentUserData.nickname || currentUserData.name}_${selectedMonth}_${selectedYear}.pdf`);
        }

        /**
         * เติมตัวเลือกเดือน/ปีสำหรับหน้าจัดการภาษีของผู้ดูแล
         * หากไม่เลือกเดือน/ปี จะถือเป็นการดูช่วง 3 เดือนล่าสุด
         */
        function populateAdminWhtMonthYearSelect() {
            const monthSelect = document.getElementById('admin-wht-month');
            const yearSelect = document.getElementById('admin-wht-year');
            if (!monthSelect || !yearSelect) return;
            monthSelect.innerHTML = '';
            yearSelect.innerHTML = '';
            // ตัวเลือกเริ่มต้น (ว่าง = 3 เดือนล่าสุด)
            const emptyOptM = document.createElement('option');
            emptyOptM.value = '';
            emptyOptM.textContent = '- ทุกเดือน -';
            monthSelect.appendChild(emptyOptM);
            const emptyOptY = document.createElement('option');
            emptyOptY.value = '';
            emptyOptY.textContent = '- ทุกปี -';
            yearSelect.appendChild(emptyOptY);
            const monthNames = ['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];
            monthNames.forEach((m, idx) => {
                const opt = document.createElement('option');
                opt.value = idx + 1;
                opt.textContent = m;
                monthSelect.appendChild(opt);
            });
            const yearSet = new Set();
            allJobs.forEach(job => {
                if (!job.workdays || job.workdays.length === 0) return;
                job.workdays.forEach(day => {
                    const d = new Date(day);
                    if (!isNaN(d)) yearSet.add(d.getFullYear());
                });
            });
            if (yearSet.size === 0) yearSet.add(new Date().getFullYear());
            [...yearSet].sort((a,b) => a - b).forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                yearSelect.appendChild(opt);
            });

            // By default select current month and year so that the report shows the current month's queue immediately
            try {
                const now = new Date();
                monthSelect.value = String(now.getMonth() + 1);
                yearSelect.value = String(now.getFullYear());
            } catch (err) {
                // ignore errors and leave defaults unchanged
            }
        }

        /**
         * สร้างรายงานภาษีหัก ณ ที่จ่ายสำหรับผู้ดูแล แสดงเฉพาะคิวงานที่มีการหักภาษี
         */
        function generateAdminWhtReport() {
            const bodyEl = document.getElementById('admin-wht-table-body');
            if (!bodyEl) return;
            bodyEl.innerHTML = '';
            const monthVal = document.getElementById('admin-wht-month').value;
            const yearVal = document.getElementById('admin-wht-year').value;
            const selectedMonth = monthVal ? parseInt(monthVal) : null;
            const selectedYear = yearVal ? parseInt(yearVal) : null;
            // ช่วงอ้างอิง 3 เดือนล่าสุดหากไม่เลือก
            const now = new Date();
            const jobsToDisplay = [];
            allJobs.forEach(job => {
                if (!job.workdays || !job.team) return;
                // ตรวจสอบช่วงเวลา
                let include = false;
                if (selectedMonth && selectedYear) {
                    include = job.workdays.some(day => {
                        const d = new Date(day);
                        return d.getMonth() + 1 === selectedMonth && d.getFullYear() === selectedYear;
                    });
                } else {
                    // 3 เดือนล่าสุด
                    include = job.workdays.some(day => {
                        const d = new Date(day);
                        const diffMonths = (now.getFullYear() - d.getFullYear()) * 12 + (now.getMonth() - d.getMonth());
                        return diffMonths >= 0 && diffMonths < 3;
                    });
                }
                if (!include) return;
                // หาสมาชิกที่มีการหักภาษี
                let jobGross = 0;
                let jobWht = 0;
                const detailMembers = [];
                job.team.forEach(member => {
                    if (!member.whtEnabled) return;
                    const wage = calculateTeamCostForMember(member, job.workdays);
                    const whtAmt = wage * appSettings.whtPercent / 100;
                    jobGross += wage;
                    jobWht += whtAmt;
                    const userData = allUsers.find(u => u.id === member.userId) || {};
                    // Show nickname along with bank account name (or full name) e.g. "Nickname (บัญชี)", fallback to full name
                    const nickname = userData.nickname || '';
                    let accName = '';
                    try {
                        accName = (userData.bankAccount && userData.bankAccount.name) ? userData.bankAccount.name : '';
                    } catch (e) {
                        accName = '';
                    }
                    const fullName = userData.name || '';
                    const displayInner = accName || fullName;
                    const displayName = nickname ? `${nickname} (${displayInner})` : displayInner;
                    detailMembers.push({
                        id: member.userId,
                        name: displayName,
                        profilePic: userData.profilePic || '',
                        wage,
                        wht: whtAmt
                    });
                });
                if (detailMembers.length > 0) {
                    jobsToDisplay.push({ id: job.id, name: job.name, gross: jobGross, wht: jobWht, members: detailMembers });
                }
            });
            if (jobsToDisplay.length === 0) {
                bodyEl.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">ไม่มีข้อมูล</td></tr>';
                return;
            }
            // แจ้งเตือนผู้ดูแลทุกวันที่ 1 หากมีสมาชิกที่ยังไม่มีหนังสือรับรองอัปโหลด
            try {
                const today = new Date();
                if (today.getDate() === 1) {
                    const hasMissing = jobsToDisplay.some(jobItem => {
                        const certs = uploadedMemberCertificates[jobItem.id] || {};
                        return jobItem.members.some(m => {
                            const val = certs[m.id];
                            return !(val && ((Array.isArray(val) && val.length > 0) || (!Array.isArray(val) && val)));
                        });
                    });
                    if (hasMissing) {
                        alert('กรุณาอัพโหลด 50ทวิ รายเดือน');
                    }
                }
            } catch (err) {
                console.error(err);
            }
            jobsToDisplay.forEach(job => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 cursor-pointer';
                // ตรวจสอบว่าทุกคนมีใบรับรองหรือไม่
                const certs = uploadedMemberCertificates[job.id] || {};
                const allHave = job.members.every(m => {
                    const val = certs[m.id];
                    return val && ((Array.isArray(val) && val.length > 0) || (!Array.isArray(val) && val));
                });
                const certIconClass = allHave ? 'ph-eye' : 'ph-upload-simple';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-left font-medium text-gray-800 job-name-cell">${job.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${job.gross.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${job.wht.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <button type="button" class="text-blue-600 hover:text-blue-800 job-cert-btn" data-jobid="${job.id}">
                            <i class="ph ${certIconClass}"></i>
                        </button>
                    </td>`;
                // คลิกชื่อคิวงานเพื่อแสดง/ซ่อนรายละเอียดทีมงานและการอัปโหลดใบรับรอง
                tr.querySelector('.job-name-cell').addEventListener('click', () => {
                    toggleAdminJobDetails(job, tr);
                });
                // คลิกปุ่มใบรับรอง แสดง/ซ่อนรายละเอียดเช่นเดียวกัน
                const certBtn = tr.querySelector('.job-cert-btn');
                certBtn.addEventListener('click', () => {
                    toggleAdminJobDetails(job, tr);
                });
                bodyEl.appendChild(tr);
            });
        }

        /**
         * แสดง/ซ่อนรายละเอียดสมาชิกของงานในรายงานภาษีหัก ณ ที่จ่ายของผู้ดูแล
         */
        function toggleAdminJobDetails(job, rowEl) {
            // หากมีแถวรายละเอียดอยู่แล้ว ให้ลบทิ้ง
            const nextRow = rowEl.nextSibling;
            if (nextRow && nextRow.classList && nextRow.classList.contains('detail-row')) {
                nextRow.remove();
                return;
            }
            // สร้างแถวรายละเอียดใหม่
            const detailTr = document.createElement('tr');
            detailTr.className = 'detail-row bg-gray-50';
            const td = document.createElement('td');
            td.colSpan = 4;
            // สร้าง HTML รายชื่อสมาชิกและปุ่มอัปโหลดใบรับรอง
            let html = '<div class="p-4 space-y-2">';
            job.members.forEach(member => {
                const jobCerts = uploadedMemberCertificates[job.id] || {};
                const certVal = jobCerts[member.id];
                const hasCert = certVal && ((Array.isArray(certVal) && certVal.length > 0) || (!Array.isArray(certVal) && certVal));
                const certIcon = hasCert ? 'ph-eye' : 'ph-upload-simple';
                html += `<div class="flex items-center justify-between p-2 bg-gray-100 rounded-lg">
                    <div class="flex items-center space-x-3 flex-1">
                        <img src="${member.profilePic || 'https://placehold.co/32x32/E2E8F0/4A5568?text=??'}" class="w-8 h-8 rounded-full object-cover" />
                        <div>
                            <p class="font-medium">${member.name}</p>
                            <p id="book-doc-${job.id}-${member.id}" class="text-xs text-gray-500">กำลังโหลด...</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button type="button" class="text-blue-600 hover:text-blue-800 member-cert-btn" data-jobid="${job.id}" data-userid="${member.id}"><i class="ph ${certIcon}"></i></button>
                        <input type="file" accept=".pdf" class="hidden member-cert-upload" data-jobid="${job.id}" data-userid="${member.id}">
                    </div>
                </div>`;
            });
            html += '</div>';
            td.innerHTML = html;
            detailTr.appendChild(td);
            rowEl.parentNode.insertBefore(detailTr, rowEl.nextSibling);
            // หลังจากแสดงผล ให้ดึงเลขเล่ม/เลขที่จริงและตั้งค่าฟังก์ชันอัปโหลด
            job.members.forEach(async (member) => {
                const labelEl = td.querySelector(`#book-doc-${job.id}-${member.id}`);
                try {
                    const { bookNo, docNo } = await getOrAssignBookDoc(job.id, member.id);
                    if (labelEl) {
                        labelEl.textContent = `เล่มที่ ${bookNo} | เลขที่ ${docNo}`;
                    }
                } catch (err) {
                    console.error(err);
                }
            });
            // ตั้งค่า event สำหรับปุ่มและ input
            td.querySelectorAll('.member-cert-btn').forEach(btn => {
                const jobId = btn.dataset.jobid;
                const userId = btn.dataset.userid;
                const inputEl = td.querySelector(`input.member-cert-upload[data-jobid="${jobId}"][data-userid="${userId}"]`);
                btn.addEventListener('click', () => {
                    const jobCerts = uploadedMemberCertificates[jobId] || {};
                    const certVal = jobCerts[userId];
                    let dataUrl = null;
                    if (Array.isArray(certVal)) {
                        const lastVer = certVal[certVal.length - 1];
                        dataUrl = lastVer && lastVer.data;
                    } else if (certVal) {
                        dataUrl = certVal;
                    }
                    if (dataUrl) {
                        window.open(dataUrl, '_blank');
                    } else {
                        inputEl && inputEl.click();
                    }
                });
                if (inputEl) {
                    inputEl.addEventListener('change', (e) => {
                        const file = e.target.files && e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (ev) => {
                                const resultData = ev.target.result;
                                if (!uploadedMemberCertificates[jobId]) {
                                    uploadedMemberCertificates[jobId] = {};
                                }
                                const existingCert = uploadedMemberCertificates[jobId][userId];
                                // Initialize as array if not existing or convert legacy string to array
                                if (!existingCert) {
                                    uploadedMemberCertificates[jobId][userId] = [];
                                } else if (!Array.isArray(existingCert)) {
                                    uploadedMemberCertificates[jobId][userId] = [{ data: existingCert, uploadedBy: null, uploadedByName: null, uploadedAt: null }];
                                }
                                uploadedMemberCertificates[jobId][userId].push({
                                    data: resultData,
                                    uploadedBy: currentUser ? currentUser.uid : null,
                                    uploadedByName: (currentUser && (currentUser.nickname || currentUser.displayName || currentUser.name)) || null,
                                    uploadedAt: new Date().toISOString()
                                });
                                // Persist updated certificates
                                localStorage.setItem('uploadedMemberCertificates', JSON.stringify(uploadedMemberCertificates));
                                // Log activity
                                try {
                                    const memberData = allUsers.find(u => u.id === userId) || {};
                                    const memberDisplay = memberData.nickname || memberData.name || userId;
                                    const uploaderDisplay = (currentUser && (currentUser.nickname || currentUser.displayName || currentUser.name)) || 'ระบบ';
                                    const timestamp = new Date().toISOString().replace('T', ' ').split('.')[0];
                                    activityLog.push({
                                        message: `คุณ ${uploaderDisplay} อัปโหลด 50ทวิ ให้คุณ ${memberDisplay} เมื่อ ${timestamp}`,
                                        timestamp: timestamp
                                    });
                                    localStorage.setItem('activityLog', JSON.stringify(activityLog));
                                    // Send notification to the member about the new certificate
                                    if (typeof createNotification === 'function') {
                                        const notifMessage = `แอดมินได้อัปโหลดหนังสือรับรองหัก ณ ที่จ่าย สำหรับคิวงาน ${job.name}`;
                                        createNotification(userId, notifMessage, job.id, job.name);
                                    }
                                } catch (err) {
                                    console.error(err);
                                }
                                // Reset download count for new version
                                if (!memberDownloadCounts[jobId]) {
                                    memberDownloadCounts[jobId] = {};
                                }
                                memberDownloadCounts[jobId][userId] = 0;
                                localStorage.setItem('memberDownloadCounts', JSON.stringify(memberDownloadCounts));
                                // Update icon for this member
                                const iconEl = btn.querySelector('i');
                                if (iconEl) {
                                    iconEl.classList.remove('ph-upload-simple');
                                    iconEl.classList.add('ph-eye');
                                }
                                // Update icon on job row if all members now have certificates
                                const rowIcon = rowEl.querySelector('.job-cert-btn i');
                                if (rowIcon) {
                                    const certs = uploadedMemberCertificates[jobId] || {};
                                    const allHave = job.members.every(m => {
                                        const c = certs[m.id];
                                        return c && ((Array.isArray(c) && c.length > 0) || (!Array.isArray(c) && c));
                                    });
                                    rowIcon.classList.remove('ph-upload-simple', 'ph-eye');
                                    rowIcon.classList.add(allHave ? 'ph-eye' : 'ph-upload-simple');
                                }
                                inputEl.value = '';
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            });
        }

        /**
         * แสดงรายชื่อทีมงานที่มีการหักภาษีสำหรับคิวงานนั้น ๆ ใน modal เพื่อให้ดาวน์โหลดหนังสือแต่ละคน
         */
        function showJobWhtCertificates(job) {
            let content = '<div class="space-y-2">';
            // แสดงรายการทีมงาน และจะแสดงเลขเล่ม/เลขที่ เมื่อโหลดเสร็จ
            job.members.forEach(member => {
                content += `<div class="flex items-center justify-between p-2 bg-gray-100 rounded-lg">
                    <div class="flex items-start space-x-3 flex-1">
                        <img src="${member.profilePic || 'https://placehold.co/32x32/E2E8F0/4A5568?text=??'}" class="w-8 h-8 rounded-full object-cover" />
                        <div>
                            <p>${member.name}</p>
                            <p id="book-doc-${member.id}" class="text-xs text-gray-500">กำลังโหลด...</p>
                        </div>
                    </div>
                    <button type="button" class="text-blue-600 hover:text-blue-800 download-certi-btn" data-userid="${member.id}"><i class="ph ph-download-simple"></i> ดาวน์โหลด</button>
                </div>`;
            });
            content += '</div>';
            showModal(`หนังสือรับรองหัก ณ ที่จ่าย (${job.name})`, content, null, false, async (modal) => {
                // หลังจากเปิดโมดอล ให้ดึงเลขเล่ม/เลขที่จริงจากฟังก์ชัน getOrAssignBookDoc
                for (const member of job.members) {
                    try {
                        const labels = modal.querySelector(`#book-doc-${member.id}`);
                        const { bookNo, docNo } = await getOrAssignBookDoc(job.id, member.id);
                        if (labels) labels.textContent = `เล่มที่ ${bookNo} | เลขที่ ${docNo}`;
                    } catch (err) {
                        console.error(err);
                    }
                }
                modal.querySelectorAll('.download-certi-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const uid = e.currentTarget.dataset.userid;
                        downloadCertificateForUser(uid);
                    });
                });
            });
        }

        /**
         * สร้างไฟล์ PDF หนังสือรับรองให้สมาชิกเฉพาะผู้ดูแล (เลือก user)
         */
        async function downloadCertificateForUser(userId) {
            const monthVal = document.getElementById('admin-wht-month').value;
            const yearVal = document.getElementById('admin-wht-year').value;
            const selectedMonth = monthVal ? parseInt(monthVal) : null;
            const selectedYear = yearVal ? parseInt(yearVal) : null;
            const userData = allUsers.find(u => u.id === userId);
            if (!userData) return;
            const jobsForUser = [];
            let totalWage = 0;
            let totalWht = 0;
            const now = new Date();
            allJobs.forEach(job => {
                if (!job.workdays || !job.team) return;
                // ตรวจสอบว่าตรงเดือน/ปี หรือช่วง 3 เดือน
                let include = false;
                if (selectedMonth && selectedYear) {
                    include = job.workdays.some(day => {
                        const d = new Date(day);
                        return d.getMonth() + 1 === selectedMonth && d.getFullYear() === selectedYear;
                    });
                } else {
                    include = job.workdays.some(day => {
                        const d = new Date(day);
                        const diffMonths = (now.getFullYear() - d.getFullYear()) * 12 + (now.getMonth() - d.getMonth());
                        return diffMonths >= 0 && diffMonths < 3;
                    });
                }
                if (!include) return;
                const member = job.team.find(m => m.userId === userId);
                if (!member || !member.whtEnabled) return;
                const wage = calculateTeamCostForMember(member, job.workdays);
                const whtAmt = wage * appSettings.whtPercent / 100;
                jobsForUser.push({ name: job.name, wage, wht: whtAmt });
                totalWage += wage;
                totalWht += whtAmt;
            });
            if (jobsForUser.length === 0) {
                alert('ไม่มีข้อมูลคิวงานที่ต้องหัก ณ ที่จ่ายสำหรับผู้ใช้นี้');
                return;
            }
            // ดึงหรือกำหนดหมายเลขเล่ม/เลขที่จากฟังก์ชัน getOrAssignBookDoc แทนการใช้เคาน์เตอร์โดยตรง
            let uniqueKey;
            if (selectedYear && selectedMonth) {
                uniqueKey = `${selectedYear}_${selectedMonth}`;
            } else {
                const nowKey = new Date();
                uniqueKey = `recent_${nowKey.getFullYear()}_${nowKey.getMonth()+1}`;
            }
            const { bookNo, docNo } = await getOrAssignBookDoc(uniqueKey, userId);
            const thaiWhtText = numberToThaiText(totalWht);
            const issueDate = new Date();
            const issueDateStr = `${issueDate.getDate()}/${issueDate.getMonth()+1}/${issueDate.getFullYear()+543}`;
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p','mm','a4');
            // ใส่ภาพพื้นหลังหนังสือ 50 ทวิ (ถ้ามี)
            if (appSettings.whtFormImageUrl) {
                const bgData = await toDataUrl(appSettings.whtFormImageUrl);
                if (bgData) {
                    pdf.addImage(bgData, 'PNG', 0, 0, 210, 297);
                }
            }
            pdf.setFont('Helvetica');
            pdf.setFontSize(12);
            const logoData = await toDataUrl(appSettings.whtCompanyLogoUrl);
            if (logoData) {
                pdf.addImage(logoData,'PNG',10,10,30,30);
            }
            const layout = appSettings.whtFormLayout || {};
            // Title
            const titlePos = layout.title || { x: 105, y: 20 };
            pdf.setFontSize(layout.title?.size || 16);
            pdf.text('หนังสือรับรองการหักภาษี ณ ที่จ่าย (50 ทวิ)', titlePos.x, titlePos.y, { align: 'center' });
            // book/doc
            const bookPos = layout.bookNo || { x: 105, y: titlePos.y + 8 };
            pdf.setFontSize(layout.bookNo?.size || 12);
            pdf.text(`เล่มที่ ${bookNo}   เลขที่ ${docNo}`, bookPos.x, bookPos.y, { align: 'center' });
            // tax id
            const taxPos = layout.taxId || { x: 105, y: bookPos.y + 8 };
            pdf.setFontSize(layout.taxId?.size || 12);
            pdf.text(`เลขประจำตัวผู้เสียภาษีอากร: ${appSettings.whtTaxId}`, taxPos.x, taxPos.y, { align: 'center' });
            // company name & address
            const compNamePos = layout.companyName || { x: 105, y: taxPos.y + 8 };
            pdf.setFontSize(layout.companyName?.size || 12);
            pdf.text(appSettings.whtCompanyName, compNamePos.x, compNamePos.y, { align: 'center' });
            const compAddrPos = layout.companyAddress || { x: 105, y: compNamePos.y + 6 };
            pdf.setFontSize(layout.companyAddress?.size || 12);
            pdf.text(appSettings.whtCompanyAddress, compAddrPos.x, compAddrPos.y, { align: 'center' });
            // form type & income type & payer option
            if (layout.formType) { pdf.setFontSize(layout.formType.size || 12); pdf.text(appSettings.whtFormType || '', layout.formType.x, layout.formType.y); }
            if (layout.incomeType) { pdf.setFontSize(layout.incomeType.size || 12); pdf.text(appSettings.whtIncomeType || '', layout.incomeType.x, layout.incomeType.y); }
            if (layout.payerOption) { pdf.setFontSize(layout.payerOption.size || 12); pdf.text(appSettings.whtPayerOption || '', layout.payerOption.x, layout.payerOption.y); }
            // signer
            const signerLabel = `ผู้ออกหนังสือ: ${currentUserData.nickname || currentUserData.name}`;
            if (layout.signerName) {
                pdf.setFontSize(layout.signerName.size || 12);
                pdf.text(signerLabel, layout.signerName.x, layout.signerName.y);
            } else {
                pdf.setFontSize(12);
                pdf.text(signerLabel, 20, compAddrPos.y + 20);
            }
            // recipient
            const recipientLabel = `ผู้ถูกหักภาษี: ${userData.nickname || userData.name}`;
            if (layout.recipientName) {
                pdf.setFontSize(layout.recipientName.size || 12);
                pdf.text(recipientLabel, layout.recipientName.x, layout.recipientName.y);
            } else {
                pdf.setFontSize(12);
                pdf.text(recipientLabel, 20, compAddrPos.y + 28);
            }
            // details header
            const detailsStartY = (layout.totalPay && layout.totalPay.y) ? layout.totalPay.y - (jobsForUser.length * 5) - 15 : (layout.recipientName ? layout.recipientName.y + 6 : compAddrPos.y + 34);
            pdf.setFontSize(layout.detailsHeader?.size || 12);
            pdf.text('รายละเอียดคิวงาน', 20, detailsStartY);
            let runningY = detailsStartY + 6;
            pdf.setFontSize(layout.detailItem?.size || 10);
            jobsForUser.forEach(item => {
                pdf.text(`- ${item.name}: ${item.wage.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})} บาท`, 25, runningY);
                runningY += 5;
            });
            pdf.setFontSize(layout.totalPay?.size || 12);
            // totals
            const totalPayPos = layout.totalPay || { x: 20, y: runningY + 3 };
            pdf.text(`รวมจำนวนเงินที่จ่ายทั้งสิ้น: ${totalWage.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})} บาท`, totalPayPos.x, totalPayPos.y);
            const taxAmtPos = layout.taxAmount || { x: 20, y: totalPayPos.y + 6 };
            pdf.text(`ภาษีที่หักและนำส่งไว้: ${totalWht.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})} บาท`, taxAmtPos.x, taxAmtPos.y);
            const taxTextPos = layout.taxAmountText || { x: 20, y: taxAmtPos.y + 6 };
            pdf.text(`รวมเงินภาษีที่หักนำส่งไว้ (ตัวอักษร): ${thaiWhtText}`, taxTextPos.x, taxTextPos.y);
            const datePos = layout.issueDate || { x: 20, y: taxTextPos.y + 6 };
            pdf.text(`ออกหนังสือ ณ วันที่ ${issueDateStr}`, datePos.x, datePos.y);
            const signLineY = datePos.y + 8;
            pdf.text('ลงชื่อ _________________________', 20, signLineY);
            const signNamePos = layout.signerName || { x: 20, y: signLineY + 6 };
            pdf.text(`(${appSettings.whtSignerName || currentUserData.nickname || currentUserData.name})`, signNamePos.x, signNamePos.y);
            pdf.save(`WHT_${userData.nickname || userData.name}.pdf`);
            hideLoading();
        }

        /**
         * ส่งออกข้อมูลตารางภาษีหัก ณ ที่จ่ายของผู้ดูแลเป็นไฟล์ CSV
         */
        function exportAdminWhtData() {
            const bodyEl = document.getElementById('admin-wht-table-body');
            if (!bodyEl) return;
            let csv = 'ชื่องาน,รายรับ (BG),หัก ณ ที่จ่าย\n';
            bodyEl.querySelectorAll('tr').forEach(tr => {
                // ข้ามแถวรายละเอียด
                if (tr.classList.contains('detail-row')) return;
                const cells = tr.querySelectorAll('td');
                if (cells.length >= 3) {
                    const name = cells[0].textContent.trim();
                    const gross = cells[1].textContent.trim();
                    const wht = cells[2].textContent.trim();
                    csv += `${name},${gross},${wht}\n`;
                }
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'wht-report.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        /**
         * ส่งออกข้อมูลตารางภาษีหัก ณ ที่จ่ายเป็น PDF (ใช้ html2canvas + jsPDF)
         * เพื่อความง่าย จะทำการแปลงทั้งตารางเป็นภาพและบันทึกเป็น PDF
         */
        function exportAdminWhtDataPdf() {
            const tableContainer = document.querySelector('#wht-management-view table');
            if (!tableContainer) return;
            html2canvas(tableContainer, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 10;
                let imgWidth = pageWidth - 2 * margin;
                let imgHeight = (canvas.height * imgWidth) / canvas.width;
                const maxHeight = pageHeight - 2 * margin;
                if (imgHeight > maxHeight) {
                    imgHeight = maxHeight;
                    imgWidth = (canvas.width * imgHeight) / canvas.height;
                }
                const imgX = margin + ((pageWidth - 2 * margin - imgWidth) / 2);
                const imgY = margin;
                pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth, imgHeight);
                pdf.save('wht-report.pdf');
            });
        }

        /**
         * แสดงหน้า จัดการภาษีหัก ณ ที่จ่าย สำหรับผู้ดูแล
         */
        function showWhtManagementView() {
            // ซ่อนสรุปบัญชี
            document.getElementById('financial-summary-view').classList.add('hidden');
            const viewEl = document.getElementById('wht-management-view');
            if (!viewEl) return;
            viewEl.classList.remove('hidden');
            populateAdminWhtMonthYearSelect();
            // เมื่อมีการเปลี่ยนเดือน/ปี ให้สร้างรายงานใหม่
            const mSel = document.getElementById('admin-wht-month');
            const ySel = document.getElementById('admin-wht-year');
            if (mSel) mSel.onchange = () => generateAdminWhtReport();
            if (ySel) ySel.onchange = () => generateAdminWhtReport();
            generateAdminWhtReport();
        }

        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'กำลังบันทึก...';

            const formData = new FormData(e.target);
            const faviconFile = formData.get('faviconFile');
            const ogImageFile = formData.get('ogImageFile');

            let newFaviconUrl = appSettings.faviconUrl;
            if (faviconFile && faviconFile.size > 0) {
                newFaviconUrl = await uploadToCloudinary(faviconFile) || newFaviconUrl;
            }

            let newOgImageUrl = appSettings.ogImageUrl;
            if (ogImageFile && ogImageFile.size > 0) {
                newOgImageUrl = await uploadToCloudinary(ogImageFile) || newOgImageUrl;
            }

            const newSettings = {
                cloudinaryName: formData.get('cloudinaryName'),
                cloudinaryPreset: formData.get('cloudinaryPreset'),
                lineBotChannelAccessToken: formData.get('lineBotChannelAccessToken'),
                lineBotChannelSecret: formData.get('lineBotChannelSecret'),
                facebookAppId: formData.get('facebookAppId'),
                facebookAppSecret: formData.get('facebookAppSecret'),
                faviconUrl: newFaviconUrl,
                ogImageUrl: newOgImageUrl,
                isLineLoginEnabled: formData.get('isLineLoginEnabled') === 'on',
                isFacebookLoginEnabled: formData.get('isFacebookLoginEnabled') === 'on',
                isFacebookLinkEnabled: formData.get('isFacebookLinkEnabled') === 'on',
                // SMSKUB settings
                smsKubApiKey: formData.get('smsKubApiKey'),
                smsSenderName: formData.get('smsSenderName'),
                isSmsEnabled: formData.get('isSmsEnabled') === 'on'
            };

            try {
                await setDoc(doc(db, "settings", "app-config"), newSettings, { merge: true });
                appSettings = { ...appSettings, ...newSettings }; // Update local settings object

                // Update live DOM elements
                document.getElementById('favicon-link').href = appSettings.faviconUrl;
                // Removed updating OG image meta tag; using static OG tags instead
                // Update visibility of Facebook login controls based on new settings
                updateFacebookLoginVisibility();

                alert('บันทึกการตั้งค่าเรียบร้อยแล้ว');
            } catch (error) {
                console.error("Error saving settings:", error);
                alert('เกิดข้อผิดพลาดในการบันทึกการตั้งค่า');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'บันทึกการตั้งค่า';
            }
        });


        document.getElementById('line-test-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const userId = document.getElementById('line-test-userid').value;
            const message = document.getElementById('line-test-message').value;
            if (userId && message) {
                sendLineMessage(userId, message);
            }
        });

        document.getElementById('line-team-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const memberSelect = document.getElementById('line-member-select');
            const userId = memberSelect.value;
            const userName = memberSelect.options[memberSelect.selectedIndex].text;
            const message = document.getElementById('line-team-message').value;
            if (userId && message) {
                sendLineMessage(userId, message, userName);
            } else {
                alert('กรุณาเลือกทีมงานและป้อนข้อความ');
            }
        });

        document.getElementById('line-job-select').addEventListener('change', (e) => {
            const jobId = e.target.value;
            const memberSelect = document.getElementById('line-member-select');
            memberSelect.innerHTML = '<option value="">-- กรุณาเลือกทีมงาน --</option>';
            memberSelect.disabled = true;

            if (jobId) {
                const selectedJob = allJobs.find(j => j.id === jobId);
                if (selectedJob && selectedJob.team) {
                    selectedJob.team.forEach(member => {
                        const userData = allUsers.find(u => u.id === member.userId);
                        if (userData) { // Ensure user data exists
                            // Here we assume userData.lineUserId exists. In a real app, you'd need to handle cases where it doesn't.
                            const option = document.createElement('option');
                            option.value = userData.lineUserId || ''; // Use Line User ID
                            option.textContent = userData.nickname || userData.name;
                            if (!userData.lineUserId) {
                                option.disabled = true;
                                option.textContent += ' (ยังไม่เชื่อมต่อ Line)';
                            }
                            memberSelect.appendChild(option);
                        }
                    });
                    memberSelect.disabled = false;
                }
            }
        });

        // Attach event listener for withholding form settings button (admin)
        const whtFormSettingsBtn = document.getElementById('wht-form-settings-button');
        if (whtFormSettingsBtn) {
            whtFormSettingsBtn.addEventListener('click', () => {
                showWhtFormSettingsModal();
            });
        }

        // -----------------------------------------------------------------------------
        // SMS test send event handler
        // When administrators click the "ทดสอบส่ง" button, validate inputs, call the
        // existing sendSmsMessage() helper, and display a confirmation.  This
        // non‑persistent test allows you to verify connectivity to the SMSKUB API
        // without affecting real jobs or notifications.
        const smsTestBtn = document.getElementById('sms-test-button');
        if (smsTestBtn) {
            smsTestBtn.addEventListener('click', () => {
                const phoneInput = document.getElementById('sms-test-phone');
                const messageInput = document.getElementById('sms-test-message');
                const resultDiv = document.getElementById('sms-test-result');
                const phone = phoneInput.value.trim();
                const msg = messageInput.value.trim();
                // Validate that both the phone number and message are provided
                if (!phone || !msg) {
                    alert('กรุณากรอกเบอร์โทรศัพท์และข้อความทดสอบ');
                    return;
                }
                // Call the existing SMS sending function.  This uses the saved API Key and Sender Name configured in
                // the Settings form.  If SMS is disabled or the API key is missing, sendSmsMessage() will emit a
                // console warning or show an alert.
                sendSmsMessage(phone, msg);
                // Provide a simple confirmation message.  To implement proper error reporting,
                // consider modifying sendSmsMessage() to return a promise and update this message based on the response.
                resultDiv.textContent = `ระบบได้ทำการส่งข้อความทดสอบไปยัง ${phone} แล้ว (โปรดตรวจสอบโทรศัพท์ของคุณ).`;
            });
        }


        function completeJob(jobId) {
            showConfirmModal('ยืนยันการจบงาน', 'คุณต้องการย้ายงานนี้ออกจากคิวงานปัจจุบันใช่หรือไม่?', async () => {
                for (const member of currentJobData.team) {
                    await createNotification(member.userId, `คิวงาน <b>${currentJobData.name}</b> เสร็จสิ้นแล้ว`, jobId, currentJobData.name);
                }
                await updateDoc(doc(db, "jobs", jobId), { status: "completed" });
                document.getElementById('job-details-section').classList.add('hidden');
                selectJob(null); // Deselect job
            });
        }

        function revertJobStatus(jobId) {
            showConfirmModal('ยืนยันการย้อนคืนคิวงาน', 'คุณต้องการย้ายงานนี้กลับไปที่คิวงานปัจจุบันใช่หรือไม่?', async () => {
                await updateDoc(doc(db, "jobs", jobId), { status: "active" });
                await createNotification(currentJobData.team.map(m => m.userId), `คิวงาน <b>${currentJobData.name}</b> ถูกย้ายกลับมายังคิวงานปัจจุบัน`, jobId, currentJobData.name);
            });
        }

        function showFinancialSummaryView() {
            mainApp.classList.add('hidden');
            document.getElementById('settings-view').classList.add('hidden');
            document.getElementById('line-bot-view').classList.add('hidden');
            document.getElementById('financial-summary-view').classList.remove('hidden');

            // Show the appropriate summary containers based on role and generate report
            if (currentUserRole === 'admin') {
                document.getElementById('admin-summary-container').classList.remove('hidden');
                document.getElementById('member-summary-container').classList.add('hidden');
            } else {
                document.getElementById('admin-summary-container').classList.add('hidden');
                document.getElementById('member-summary-container').classList.remove('hidden');
            }
            // Always set up month/year filters
            setupFinancialFilters();
            // Do not set up member financial filters as the filter bar has been removed
            generateFinancialReport();
            // Toggle visibility of withholding and tax management buttons based on user role
            const whtButtonEl = document.getElementById('withholding-button');
            const taxButtonEl = document.getElementById('tax-management-button');
            if (whtButtonEl) {
                if (currentUserRole === 'admin') {
                    whtButtonEl.classList.add('hidden');
                } else {
                    whtButtonEl.classList.remove('hidden');
                }
            }
            if (taxButtonEl) {
                if (currentUserRole === 'admin') {
                    taxButtonEl.classList.remove('hidden');
                } else {
                    taxButtonEl.classList.add('hidden');
                }
            }
        }
        
        function setupMemberFinancialFilters() {
            const filterButtons = document.getElementById('member-financial-filters');
            filterButtons.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    memberFinancialFilter = e.target.dataset.status;
                    filterButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    generateFinancialReport();
                });
            });
        }


        function setupFinancialFilters() {
            const monthSelect = document.getElementById('summary-month');
            const yearSelect = document.getElementById('summary-year');
            const filterButtons = document.getElementById('financial-filter-buttons');
            const showCustomRangeBtn = document.getElementById('show-custom-range-btn'); // New button
            const customDateSelector = document.getElementById('custom-date-range-selector');
            const searchButton = document.getElementById('summary-search-button');
            const monthYearSelector = document.getElementById('month-year-selector');

            // Populate Months
            monthSelect.innerHTML = '';
            const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                monthSelect.appendChild(option);
            });

            // Populate Years
            yearSelect.innerHTML = '';
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= currentYear - 5; i--) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + 543; // Display in B.E.
                yearSelect.appendChild(option);
            }

            // Set default to current month and year
            const today = new Date();
            monthSelect.value = today.getMonth();
            yearSelect.value = today.getFullYear();

            // Add event listeners for the pre-defined period buttons
            filterButtons.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    financialFilter = e.target.dataset.period;

                    // Update active state
                    filterButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    showCustomRangeBtn.classList.remove('active');
                    e.target.classList.add('active');

                    // Hide custom selector, show/hide month selector
                    customDateSelector.classList.add('hidden');
                    monthYearSelector.classList.toggle('hidden', financialFilter !== '1m');

                    // Generate report immediately
                    generateFinancialReport();
                });
            });

            // Add event listener for the new "custom range" button
            showCustomRangeBtn.addEventListener('click', () => {
                // Update active state
                filterButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                showCustomRangeBtn.classList.add('active');

                // Show the custom date selector
                customDateSelector.classList.toggle('hidden');
                monthYearSelector.classList.add('hidden');
            });

            // The search button within the custom range selector
            searchButton.addEventListener('click', () => {
                financialFilter = 'all'; // This tells generateFinancialReport to use the date pickers
                generateFinancialReport();
            });

            monthSelect.addEventListener('change', generateFinancialReport);
            yearSelect.addEventListener('change', generateFinancialReport);
        }

        function generateFinancialReport() {
            const monthYearSelector = document.getElementById('month-year-selector');

            let startDate, endDate = new Date();
            const today = new Date();

            switch (financialFilter) {
                case '1m':
                    const selectedYear = parseInt(document.getElementById('summary-year').value);
                    const selectedMonth = parseInt(document.getElementById('summary-month').value);
                    startDate = new Date(selectedYear, selectedMonth, 1);
                    endDate = new Date(selectedYear, selectedMonth + 1, 0, 23, 59, 59);
                    break;
                case '2m':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    break;
                case '3m':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
                    break;
                case '6m':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 5, 1);
                    break;
                case '1y':
                    startDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
                    break;
                case 'all':
                    const customStartDate = document.getElementById('summary-start-date').value;
                    const customEndDate = document.getElementById('summary-end-date').value;
                    if (customStartDate && customEndDate) {
                        startDate = new Date(customStartDate);
                        endDate = new Date(customEndDate);
                        endDate.setHours(23, 59, 59);
                    } else {
                        // If 'all' is clicked but no dates are set, show all time
                        startDate = new Date(2000, 0, 1);
                        endDate = new Date();
                    }
                    break;
            }

            const filteredJobs = allJobs.filter(job => {
                const jobStart = new Date(job.startDate);
                const jobEnd = new Date(job.endDate);
                return jobStart <= endDate && jobEnd >= startDate;
            });

            if (currentUserRole === 'admin') {
                generateAdminReport(filteredJobs, startDate, endDate);
            } else {
                generateMemberReport(filteredJobs);
            }
        }

        function generateAdminReport(jobs, reportStartDate, reportEndDate) {
            const jobSummaryBody = document.getElementById('job-summary-table-body');
            const teamWageBody = document.getElementById('team-wage-summary-table-body');
            const statTopEarners = document.getElementById('stat-top-earners');
            jobSummaryBody.innerHTML = '';
            teamWageBody.innerHTML = '';
            statTopEarners.innerHTML = '';

            let totalIncome = 0, totalExpenses = 0, totalProfit = 0;
            let totalPaidWages = 0, totalUnpaidWages = 0;
            let totalOtherExpenses = 0, totalWht = 0, totalVat = 0;

            const userWages = {};

            jobs.forEach(job => {
                const teamCost = job.team.reduce((total, member) => total + calculateTeamCostForMember(member, job.workdays), 0);
                const otherExpenses = (job.expenses || []).reduce((total, expense) => total + expense.amount, 0);
                
                const whtPercentValue = job.whtPercent === undefined ? appSettings.whtPercent : job.whtPercent;
                const whtAmount = job.whtEnabled ? (job.income * whtPercentValue / 100) : 0;
                const vatAmount = job.vatEnabled ? (job.income * 0.07) : 0; // VAT from budget

                const jobTotalExpenses = teamCost + otherExpenses;
                const profit = (job.income - vatAmount) - jobTotalExpenses - whtAmount;
                
                const jobMonth = new Date(job.startDate).toLocaleDateString('th-TH', { month: 'short' });
                const statusHTML = job.status === 'completed' ? `<i class="text-xs text-green-500"> (เสร็จงานแล้ว)</i>` : '';

                totalIncome += job.income;
                totalExpenses += jobTotalExpenses;
                totalProfit += profit;
                totalOtherExpenses += otherExpenses;
                totalWht += whtAmount;
                totalVat += vatAmount;


                jobSummaryBody.innerHTML += `
                    <tr class="cursor-pointer hover:bg-gray-100 job-summary-row" data-id="${job.id}">
                        <td class="px-4 py-4 whitespace-nowrap"><input type="checkbox" class="job-select-checkbox" data-id="${job.id}"></td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${job.name} <span class="text-xs text-gray-400">(${jobMonth})</span>${statusHTML}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${job.income.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${vatAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                           ${whtAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-red-500">${jobTotalExpenses.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right ${profit >= 0 ? 'profit-text' : 'loss-text'}">
                            <span class="block">${profit.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                            <span class="block text-xs">บาท</span>
                        </td>
                    </tr>
                `;

                job.team.forEach(member => {
                    if (!allUsers.find(u => u.id === member.userId)) return; // Skip if user doesn't exist
                    const wage = calculateTeamCostForMember(member, job.workdays);
                    if (!userWages[member.userId]) {
                        userWages[member.userId] = { total: 0, unpaid: 0 };
                    }
                    userWages[member.userId].total += wage;

                    if (!member.isPaid) {
                        userWages[member.userId].unpaid += wage;
                        totalUnpaidWages += wage;
                    } else {
                        totalPaidWages += wage;
                    }
                });
            });

            // Attach change listeners to job selection checkboxes to update the selected job totals
            document.querySelectorAll('.job-select-checkbox').forEach(cb => {
                cb.addEventListener('change', updateSelectedJobTotals);
            });
            // Attach change listener for the select-all checkbox
            const selectAllCb = document.getElementById('select-all-jobs-checkbox');
            if (selectAllCb) {
                selectAllCb.addEventListener('change', (e) => {
                    const checked = e.target.checked;
                    document.querySelectorAll('.job-select-checkbox').forEach(cb => {
                        cb.checked = checked;
                    });
                    updateSelectedJobTotals();
                });
            }

            document.querySelectorAll('.job-summary-row').forEach(row => {
                 // Clicking anywhere on the row except the checkbox
                row.addEventListener('click', (e) => {
                    if (e.target.type === 'checkbox') return;
                    const jobId = row.dataset.id;
                    document.getElementById('financial-summary-view').classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    selectJob(jobId);
                });
            });
            
             document.getElementById('select-all-jobs-checkbox').onchange = (e) => {
                document.querySelectorAll('.job-select-checkbox').forEach(cb => cb.checked = e.target.checked);
            };

            document.getElementById('total-income-summary').textContent = totalIncome.toLocaleString();
            document.getElementById('total-vat-summary').textContent = totalVat.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('total-wht-summary').textContent = totalWht.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('total-expense-summary').textContent = totalExpenses.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('total-profit-summary').textContent = totalProfit.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('total-profit-summary').className = `px-6 py-4 text-right font-bold ${totalProfit >= 0 ? 'profit-text' : 'loss-text'}`;

            let totalWages = 0;
            const sortedUsers = Object.keys(userWages).sort((a,b) => userWages[b].total - userWages[a].total);

            sortedUsers.forEach(userId => {
                const user = allUsers.find(u => u.id === userId);
                if (!user) return; // Double check to prevent errors
                const userName = user.nickname || user.name;
                const wageData = userWages[userId];
                const paidAmount = wageData.total - wageData.unpaid;
                totalWages += wageData.total;
                teamWageBody.innerHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${userName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right font-semibold">${wageData.total.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right profit-text">${paidAmount.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right loss-text">${wageData.unpaid > 0 ? wageData.unpaid.toLocaleString() : '-'}</td>
                    </tr>
                `;
            });
            document.getElementById('total-wage-summary').textContent = totalWages.toLocaleString();
            document.getElementById('total-paid-wage-summary').textContent = totalPaidWages.toLocaleString();
            document.getElementById('total-unpaid-wage-summary').textContent = totalUnpaidWages.toLocaleString();

            // Update stats
            document.getElementById('stat-paid-wages').textContent = totalPaidWages.toLocaleString();
            document.getElementById('stat-unpaid-wages').textContent = totalUnpaidWages.toLocaleString();
            document.getElementById('stat-other-expenses').textContent = totalOtherExpenses.toLocaleString();
            document.getElementById('stat-wht').textContent = totalWht.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('stat-vat').textContent = totalVat.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            document.querySelector('#stat-top-earners').previousElementSibling.textContent = "ทีมงานที่ได้รับเงินสูงสุด";

            sortedUsers.slice(0, 5).forEach((userId, index) => {
                 const user = allUsers.find(u => u.id === userId);
                 if (user) {
                    const topEarnerClass = index === 0 ? 'border-4 border-yellow-400' : '';
                    statTopEarners.innerHTML += `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <img src="${user.profilePic || 'https://placehold.co/40x40/E2E8F0/4A5568?text=??'}" class="w-10 h-10 rounded-full object-cover mr-3 ${topEarnerClass}">
                            <span class="${index === 0 ? 'text-lg' : ''}">${user.nickname || user.name}</span>
                        </div>
                        <span class="font-bold ${index === 0 ? 'text-lg' : ''}">${userWages[userId].total.toLocaleString()} บาท</span>
                    </div>`;
                 }
            });

            // Update Chart
            updateFinancialChart(jobs, reportStartDate, reportEndDate);
        }

        function updateFinancialChart(jobs, startDate, endDate) {
            const ctx = document.getElementById('financial-chart').getContext('2d');
            const data = {
                labels: [],
                datasets: [
                    { label: 'รายรับ', data: [], backgroundColor: 'rgba(54, 162, 235, 0.5)', borderColor: 'rgb(54, 162, 235)', borderWidth: 1 },
                    { label: 'รายจ่าย', data: [], backgroundColor: 'rgba(255, 99, 132, 0.5)', borderColor: 'rgb(255, 99, 132)', borderWidth: 1 },
                    { label: 'กำไร', data: [], backgroundColor: 'rgba(75, 192, 192, 0.5)', borderColor: 'rgb(75, 192, 192)', borderWidth: 1 }
                ]
            };

            const monthlyData = {};
            const monthFormatter = new Intl.DateTimeFormat('th-TH', { month: 'short', year: '2-digit' });

            // Initialize months in the range
            let current = new Date(startDate);
            while (current <= endDate) {
                const monthKey = monthFormatter.format(current);
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { income: 0, expense: 0, profit: 0 };
                }
                current.setMonth(current.getMonth() + 1);
            }

            jobs.forEach(job => {
                const monthKey = monthFormatter.format(new Date(job.startDate));
                if (monthlyData[monthKey]) {
                    const teamCost = job.team.reduce((total, member) => total + calculateTeamCostForMember(member, job.workdays), 0);
                    const otherExpenses = (job.expenses || []).reduce((total, expense) => total + expense.amount, 0);

                    const whtPercentValue = job.whtPercent === undefined ? appSettings.whtPercent : job.whtPercent;
                    const whtAmount = job.whtEnabled ? (job.income * whtPercentValue / 100) : 0;
                    const vatAmount = job.vatEnabled ? (job.income * 0.07) : 0; // VAT from budget
                    
                    const totalExpense = teamCost + otherExpenses;
                    const profit = (job.income - vatAmount) - totalExpense - whtAmount;


                    monthlyData[monthKey].income += job.income;
                    monthlyData[monthKey].expense += totalExpense;
                    monthlyData[monthKey].profit += profit;
                }
            });

            for (const monthKey in monthlyData) {
                data.labels.push(monthKey);
                data.datasets[0].data.push(monthlyData[monthKey].income);
                data.datasets[1].data.push(monthlyData[monthKey].expense);
                data.datasets[2].data.push(monthlyData[monthKey].profit);
            }

            if (financialChart) financialChart.destroy();
            financialChart = new Chart(ctx, { type: 'bar', data: data, options: { scales: { y: { beginAtZero: true } } } });
        }


        function generateMemberReport(jobs) {
            const memberWageBody = document.getElementById('member-wage-table-body');
            memberWageBody.innerHTML = '';
            // Totals for net wages (after withholding), paid, unpaid and withholding tax
            let totalNetWage = 0, totalPaid = 0, totalUnpaid = 0, totalWht = 0;

            // Get only jobs where the current user is part of the team
            const memberJobs = jobs.filter(job => job.team.some(m => m.userId === currentUser.uid));

            memberJobs.forEach(job => {
                const myTeamData = job.team.find(m => m.userId === currentUser.uid);
                if (myTeamData) {
                    // Calculate gross wage based on workdays
                    const wage = calculateTeamCostForMember(myTeamData, job.workdays);
                    // Determine withholding percentage: use job-specific whtPercent if set, otherwise global setting
                    const whtPercentValue = job.whtPercent === undefined ? appSettings.whtPercent : job.whtPercent;
                    const whtAmount = myTeamData.whtEnabled ? (wage * (whtPercentValue / 100)) : 0;
                    // Net wage after withholding
                    const netWage = wage - whtAmount;
                    // Determine amounts that have been paid/unpaid to the member
                    const paidAmount = myTeamData.isPaid ? netWage : 0;
                    const unpaidAmount = !myTeamData.isPaid ? netWage : 0;

                    // Accumulate totals
                    totalNetWage += netWage;
                    totalPaid += paidAmount;
                    totalUnpaid += unpaidAmount;
                    totalWht += whtAmount;

                    const jobMonth = new Date(job.startDate).toLocaleDateString('th-TH', { month: 'short' });

                    // Append table row with net wage and withholding information
                    memberWageBody.innerHTML += `
                        <tr class="cursor-pointer hover:bg-gray-100 member-job-summary-row" data-id="${job.id}">
                            <td class="px-6 py-4 whitespace-nowrap">${job.name} <span class="text-xs text-gray-400">(${jobMonth})</span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-right font-semibold">${netWage.toLocaleString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right profit-text">${paidAmount > 0 ? paidAmount.toLocaleString() : '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right loss-text">${unpaidAmount > 0 ? unpaidAmount.toLocaleString() : '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">${whtAmount > 0 ? whtAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-'}</td>
                        </tr>
                    `;
                }
            });

            // Update summary totals in the new stats bar
            document.getElementById('member-total-wage-stat').textContent = totalNetWage.toLocaleString();
            document.getElementById('member-total-paid-stat').textContent = totalPaid.toLocaleString();
            document.getElementById('member-total-unpaid-stat').textContent = totalUnpaid.toLocaleString();
            document.getElementById('member-total-wht-stat').textContent = totalWht.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // Update summary totals in the table footer (for compatibility)
            const wageSummaryEl = document.getElementById('member-total-wage-summary');
            const paidSummaryEl = document.getElementById('member-total-paid-summary');
            const unpaidSummaryEl = document.getElementById('member-total-unpaid-summary');
            const whtSummaryEl = document.getElementById('member-total-wht-summary');
            if (wageSummaryEl) wageSummaryEl.textContent = totalNetWage.toLocaleString();
            if (paidSummaryEl) paidSummaryEl.textContent = totalPaid.toLocaleString();
            if (unpaidSummaryEl) unpaidSummaryEl.textContent = totalUnpaid.toLocaleString();
            if (whtSummaryEl) whtSummaryEl.textContent = totalWht.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // Attach click listeners to rows to navigate to job details
            document.querySelectorAll('.member-job-summary-row').forEach(row => {
                row.addEventListener('click', () => {
                    const jobId = row.dataset.id;
                    document.getElementById('financial-summary-view').classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    selectJob(jobId);
                });
            });
        }

        /**
         * Update the totals summary displayed above the admin job summary table based on selected jobs.
         */
        function updateSelectedJobTotals() {
            const selectedCbs = document.querySelectorAll('.job-select-checkbox:checked');
            const totalsContainer = document.getElementById('selected-job-totals');
            if (!totalsContainer) return;
            // If no jobs are selected, hide the container and reset values
            if (selectedCbs.length === 0) {
                totalsContainer.classList.add('hidden');
                document.getElementById('selected-total-income').textContent = '0';
                document.getElementById('selected-total-vat').textContent = '0';
                document.getElementById('selected-total-wht').textContent = '0';
                document.getElementById('selected-total-expense').textContent = '0';
                document.getElementById('selected-total-profit').textContent = '0';
                return;
            }
            // Initialize sums
            let sumIncome = 0;
            let sumVat = 0;
            let sumWht = 0;
            let sumExpense = 0;
            let sumProfit = 0;
            // Compute totals for each selected job
            selectedCbs.forEach(cb => {
                const jobId = cb.dataset.id;
                const job = allJobs.find(j => j.id === jobId);
                if (job) {
                    const teamCost = job.team.reduce((total, member) => total + calculateTeamCostForMember(member, job.workdays), 0);
                    const otherExpenses = (job.expenses || []).reduce((total, expense) => total + expense.amount, 0);
                    const whtPercentValue = job.whtPercent === undefined ? appSettings.whtPercent : job.whtPercent;
                    const whtAmount = job.whtEnabled ? (job.income * whtPercentValue / 100) : 0;
                    const vatAmount = job.vatEnabled ? (job.income * 0.07) : 0;
                    const jobExpenses = teamCost + otherExpenses;
                    const profit = (job.income - vatAmount) - jobExpenses - whtAmount;
                    sumIncome += job.income;
                    sumVat += vatAmount;
                    sumWht += whtAmount;
                    sumExpense += jobExpenses;
                    sumProfit += profit;
                }
            });
            // Update DOM
            document.getElementById('selected-total-income').textContent = sumIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('selected-total-vat').textContent = sumVat.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('selected-total-wht').textContent = sumWht.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('selected-total-expense').textContent = sumExpense.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('selected-total-profit').textContent = sumProfit.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            // Show container
            totalsContainer.classList.remove('hidden');
        }

        function calculateTeamCostForMember(member, workdays) {
            return member.workdays.reduce((total, day) => {
                if (workdays.includes(day)) {
                    const rate = (member.dailyOverrides && member.dailyOverrides[day] !== undefined) ? member.dailyOverrides[day] : member.dailyRate;
                    return total + rate;
                }
                return total;
            }, 0);
        }

        /**
         * คำนวณและอัปเดตข้อความสรุปยอดเงินคงเหลือของสมาชิกในส่วนหัว
         * จะแสดงจำนวนคิวงานที่ยังไม่ได้รับเงิน (งานที่ผ่านมา) และคิวงานที่รอทำในอนาคต
         * พร้อมจำนวนเงินของแต่ละส่วนและผลรวมทั้งหมด
         */
        function updateMemberSummary() {
            try {
                if (!currentUser || currentUserRole !== 'member') return;
                const todayStr = new Date().toISOString().split('T')[0];
                let pastJobsCount = 0;
                let pastJobsAmount = 0;
                let upcomingJobsCount = 0;
                let upcomingJobsAmount = 0;
                allJobs.forEach(job => {
                    // ตรวจสอบว่า currentUser อยู่ในทีมของงานนี้หรือไม่
                    const member = Array.isArray(job.team) ? job.team.find(m => m.userId === currentUser.uid) : null;
                    if (!member) return;
                    // คำนวณค่าแรงทั้งหมดของสมาชิกสำหรับงานนี้
                    const wage = calculateTeamCostForMember(member, job.workdays || []);
                    // พิจารณางานที่สิ้นสุดก่อนวันนี้ว่าเป็น "งานที่ผ่านมา" ตามเงื่อนไข
                    const isPast = (job.endDate && job.endDate < todayStr);
                    if (isPast) {
                        // หากยังไม่ได้รับเงิน
                        if (!member.isPaid) {
                            pastJobsCount++;
                            pastJobsAmount += wage;
                        }
                    } else {
                        // งานที่ยังไม่ถึงกำหนดสิ้นสุดถือเป็นคิวงานคงเหลือ
                        upcomingJobsCount++;
                        upcomingJobsAmount += wage;
                    }
                });
                const total = pastJobsAmount + upcomingJobsAmount;
                const userInfoP = document.getElementById('user-info');
                if (userInfoP) {
                    const displayName = currentUserData.nickname || currentUserData.name;
                    // build two lines of summary as per requirements
                    const line1 = `เสร็จงานแล้ว ${pastJobsCount} คิว เงินคงเหลือ ${pastJobsAmount.toLocaleString()} บาท `;
                    const line2 = `คิวงานคงเหลือ ${upcomingJobsCount} คิว จำนวนเงิน ${upcomingJobsAmount.toLocaleString()} บาท รวมเป็นเงิน ${total.toLocaleString()} บาท`;
                    userInfoP.innerHTML = `สวัสดี, <span id="user-name-display" class="font-medium">${displayName}</span><br><span class="text-xs text-gray-500">${line1}</span><br><span class="text-xs text-gray-500">${line2}</span>`;
                }
            } catch (e) {
                console.error('Error updating member summary:', e);
            }
        }

        /**
         * จัดสรรและดึงหมายเลขเล่มและเลขที่หนังสือที่ไม่ซ้ำกัน
         * uniqueKey ควรเป็นตัวแทนที่ไม่ซ้ำของใบรับรอง เช่น jobId หรือ ปี-เดือนของสมาชิก
         * userId คือรหัสผู้รับใบรับรอง
         * ฟังก์ชันนี้จะตรวจสอบใน Firestore ว่ามีการกำหนดไว้แล้วหรือไม่ หากไม่มีก็จะใช้เคาน์เตอร์ปัจจุบันและอัปเดต
         */
        async function getOrAssignBookDoc(uniqueKey, userId) {
            try {
                const docId = `${uniqueKey}_${userId}`;
                const numRef = doc(db, 'assignedWhtNumbers', docId);
                const snap = await getDoc(numRef);
                if (snap.exists()) {
                    const data = snap.data();
                    return { bookNo: data.bookNo, docNo: data.docNo };
                }
                // หากยังไม่มี เลือกเลขใหม่จากเคาน์เตอร์ (2 หลัก)
                // bookNo และ docNo เป็นเลข 2 หลัก 01-99 ตามลำดับ เมื่อ docNo เกิน 99 จะขึ้นเล่มใหม่และวน docNo กลับมา 01
                let bookNo = appSettings.whtBookCounter;
                let docNo = appSettings.whtDocCounter;
                // prepare return values with padding
                const paddedBook = String(bookNo).padStart(2, '0');
                const paddedDoc = String(docNo).padStart(2, '0');
                // update counters for next assignment
                appSettings.whtDocCounter++;
                if (appSettings.whtDocCounter > 99) {
                    appSettings.whtDocCounter = 1;
                    appSettings.whtBookCounter++;
                    if (appSettings.whtBookCounter > 99) {
                        appSettings.whtBookCounter = 1;
                    }
                }
                // บันทึกการจองไว้ใน Firestore และอัปเดตเคาน์เตอร์ใน settings
                await setDoc(numRef, { bookNo: paddedBook, docNo: paddedDoc });
                await setDoc(doc(db, 'settings', 'app-config'), {
                    whtBookCounter: appSettings.whtBookCounter,
                    whtDocCounter: appSettings.whtDocCounter
                }, { merge: true });
                return { bookNo: paddedBook, docNo: paddedDoc };
            } catch (err) {
                console.error('Error assigning book/doc numbers:', err);
                // fallback: still return numbers without saving
                // fallback ใช้รูปแบบ 2 หลักแบบเดียวกับด้านบน
                let bookNo = appSettings.whtBookCounter;
                let docNo = appSettings.whtDocCounter;
                const paddedBook = String(bookNo).padStart(2, '0');
                const paddedDoc = String(docNo).padStart(2, '0');
                appSettings.whtDocCounter++;
                if (appSettings.whtDocCounter > 99) {
                    appSettings.whtDocCounter = 1;
                    appSettings.whtBookCounter++;
                    if (appSettings.whtBookCounter > 99) {
                        appSettings.whtBookCounter = 1;
                    }
                }
                return { bookNo: paddedBook, docNo: paddedDoc };
            }
        }
        function formatDateRange(start, end) {
            if (!start || !end) return 'N/A';
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            const startDate = new Date(start).toLocaleDateString('th-TH', options);
            const endDate = new Date(end).toLocaleDateString('th-TH', options);
            if (startDate === endDate) {
                return startDate;
            }
            return `${startDate} - ${endDate}`;
        }
        function formatShortDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
        }
        function formatShortDateWithBEYear(dateString) {
            if (!dateString) return '';
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('th-TH', options);
        }

        function showModal(title, contentHTML, onSave, showSaveButton = true, onReady = null, saveButtonText = 'บันทึก') {
            const modalId = `modal-${Date.now()}`;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `<div id="${modalId}" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop"><div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 m-4 modal-content"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">${title}</h3><button class="text-gray-400 hover:text-gray-600 text-2xl close-modal-btn">&times;</button></div><form class="modal-form space-y-4">${contentHTML}<div class="flex justify-end space-x-3 pt-4"><button type="button" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 close-modal-btn">ยกเลิก</button>${showSaveButton ? `<button type="submit" class="px-4 py-2 text-white gradient-bg rounded-lg hover:opacity-90">${saveButtonText}</button>` : ''}</div></form></div></div>`;
            const modal = tempDiv.firstElementChild;
            document.getElementById('modals-container').appendChild(modal);
            if (showSaveButton) {
                modal.querySelector('.modal-form').onsubmit = (e) => { e.preventDefault(); onSave(new FormData(e.target), modal.querySelector('button[type="submit"]'), modal); };
            }
            modal.querySelectorAll('.close-modal-btn').forEach(btn => btn.onclick = () => modal.remove());
            if (onReady) onReady(modal);
        }

        function showConfirmModal(title, message, onConfirm) {
            const modalId = `confirm-modal-${Date.now()}`;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `<div id="${modalId}" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop"><div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 m-4 modal-content text-center"><h3 class="text-xl font-semibold">${title}</h3><p class="text-gray-600 mt-2">${message}</p><div class="flex justify-center space-x-4 pt-4 mt-4"><button type="button" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 close-confirm-btn">ยกเลิก</button><button type="button" class="px-6 py-2 text-white bg-red-500 rounded-lg hover:bg-red-600 confirm-btn">ยืนยัน</button></div></div></div>`;
            const modal = tempDiv.firstElementChild;
            document.getElementById('modals-container').appendChild(modal);
            const closeModal = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = () => { onConfirm(); closeModal(); };
            modal.querySelector('.close-confirm-btn').onclick = closeModal;
        }

        /**
         * แสดงหน้าต่างยืนยันการจ่ายค่าแรง พร้อมรายละเอียดบัญชีของทีมงาน
         * @param {string} memberName ชื่อทีมงานสำหรับข้อความยืนยัน
         * @param {object|null} memberUser ข้อมูลผู้ใช้ที่เกี่ยวข้อง (อาจเป็น null เมื่อจ่ายรวมหลายคน)
         * @param {function} onConfirm callback เมื่อยืนยันการจ่าย
         */
        function showPaymentConfirmModal(memberName, memberUser, onConfirm) {
            const today = new Date().toISOString().split('T')[0];
            // ดึงข้อมูลบัญชีธนาคารจาก memberUser หากมี
            let bankInfoHTML = '';
            if (memberUser && memberUser.bankAccount) {
                const { name: accName = '', bank: bankName = '', number: accNumber = '' } = memberUser.bankAccount;
                // ใช้ไอคอนธนาคารทั่วไปเนื่องจากไม่สามารถแสดงโลโก้เฉพาะได้
                bankInfoHTML = `
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm font-semibold text-gray-700 mb-1">ข้อมูลบัญชีธนาคาร</p>
                        <div class="flex items-center text-sm text-gray-600"><i class="ph ph-bank mr-2"></i><span class="font-medium">ชื่อบัญชี:</span><span class="ml-1">${accName || '-'}</span></div>
                        <div class="flex items-center text-sm text-gray-600 mt-1"><span class="font-medium mr-2">ธนาคาร:</span><span>${bankName || '-'}</span></div>
                        <div class="flex items-center text-sm text-gray-600 mt-1"><span class="font-medium mr-2">เลขที่บัญชี:</span><span>${accNumber || '-'}</span></div>
                    </div>
                `;
            }
            const content = `
                <p>คุณต้องการบันทึกว่าจ่ายค่าแรงให้ <b>${memberName}</b> แล้วใช่หรือไม่?</p>
                ${bankInfoHTML}
                <label for="payment-date" class="block mt-4 text-sm font-medium text-gray-700">วันที่จ่ายเงิน</label>
                <input type="date" id="payment-date" name="paymentDate" value="${today}" class="w-full p-2 mt-1 border rounded-lg">
            `;
            showModal('ยืนยันการจ่ายค่าแรง', content, (formData, submitBtn, modal) => {
                const paymentDate = formData.get('paymentDate');
                if (!paymentDate) {
                    alert('กรุณาระบุวันที่จ่ายเงิน');
                    return;
                }
                onConfirm(paymentDate);
                modal.remove();
            });
        }


        async function uploadToCloudinary(file) {
            if (!file) return null;
            const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${appSettings.cloudinaryName}/image/upload`;
            if (!appSettings.cloudinaryName || !appSettings.cloudinaryPreset) {
                alert("กรุณาตั้งค่า Cloudinary Cloud Name และ Upload Preset ในหน้าตั้งค่าระบบก่อน");
                return null;
            }
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', appSettings.cloudinaryPreset);
            try {
                const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                const data = await response.json();
                if (data.secure_url) {
                    return data.secure_url;
                } else if (data.error) {
                    throw new Error(`Cloudinary: ${data.error.message}`);
                } else {
                    throw new Error('เกิดข้อผิดพลาดที่ไม่คาดคิดจากการตอบกลับของ Cloudinary');
                }
            } catch (error) {
                console.error('Cloudinary upload error:', error);
                alert(`การอัปโหลดรูปภาพล้มเหลว: ${error.message}`);
                return null;
            }
        }

        function showJobModal() {
            const content = `
                <div class="space-y-6 p-4 bg-gray-50 rounded-lg">
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">ชื่อคิวงาน</label>
                        <input type="text" name="name" required class="w-full p-2 border rounded" placeholder="ระบุชื่อคิวงาน">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">สถานที่</label>
                        <input type="text" name="location" required class="w-full p-2 border rounded" placeholder="ระบุสถานที่">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">ไอคอน</label>
                        <select name="icon" required class="w-full p-2 border rounded">
                            <option value="ph-video-camera">กล้องโอบี</option>
                            <option value="ph-broadcast">ถ่ายทอด</option>
                            <option value="ph-microphone">ไมโครโฟน</option>
                            <option value="ph-music-notes-simple">ดนตรี</option>
                            <option value="ph-film-slate">ภาพยนตร์</option>
                            <option value="ph-airplay">หน้าจอ</option>
                            <!-- เพิ่มไอคอนใหม่สำหรับคิวงาน -->
                            <option value="ph-soccer-ball">ฟุตบอล</option>
                            <option value="ph-bicycle">จักรยานขาไถ</option>
                            <option value="ph-buddha">พระพุทธรูป</option>
                            <option value="ph-camera">กล้อง</option>
                            <option value="ph-airplane">โดรน</option>
                            <option value="ph-crown">นางงาม</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-gray-700">งบประมาณ (บาท)</label>
                            <input type="number" name="income" min="0" required class="w-full p-2 border rounded" placeholder="0">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-gray-700">จำนวนทีมงานที่รับ</label>
                            <input type="number" name="teamNeeded" min="0" required class="w-full p-2 border rounded" placeholder="0">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-gray-700">วันที่เริ่ม</label>
                            <input type="date" name="startDate" required class="w-full p-2 border rounded">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-gray-700">วันที่สิ้นสุด</label>
                            <input type="date" name="endDate" required class="w-full p-2 border rounded">
                        </div>
                    </div>
                </div>`;
            showModal('เพิ่มคิวงานใหม่', content, async (formData, submitButton, modal) => {
                const startDate = formData.get('startDate'), endDate = formData.get('endDate');
                let workdays = [];
                for (let d = new Date(startDate); d <= new Date(endDate); d.setDate(d.getDate() + 1)) { workdays.push(new Date(d).toISOString().split('T')[0]); }
                await addDoc(collection(db, "jobs"), {
                    name: formData.get('name'),
                    location: formData.get('location'),
                    income: Number(formData.get('income')),
                    teamNeeded: Number(formData.get('teamNeeded')),
                    startDate,
                    endDate,
                    workdays,
                    team: [],
                    // เพิ่มค่าใช้จ่ายเริ่มต้น: ค่าเดินทาง, ค่า Vmix, ค่า Internet ตามที่ระบบกำหนดไว้ล่วงหน้า
                    expenses: [
                        { name: 'ค่าเดินทาง', amount: 1500 },
                        { name: 'ค่า Vmix', amount: 2000 },
                        { name: 'ค่า Internet', amount: 1500 }
                    ],
                    status: 'active',
                    teamLeaderId: '',
                    whtEnabled: false,
                    vatEnabled: false,
                    whtPercent: appSettings.whtPercent,
                    notes: '',
                    teamNotes: '',
                    icon: formData.get('icon')
                });
                modal.remove();
            });
        }

        function showAddMemberModal() {
            // Filter users who are not already in the team
            let availableUsers = allUsers;
            if (currentJobData && currentJobData.team) {
                availableUsers = allUsers.filter(u => !currentJobData.team.some(m => m.userId === u.id));
            }
            const userOptions = availableUsers.map(u => `<option value="${u.id}" data-pic="${u.profilePic || ''}">${u.nickname || u.name}</option>`).join('');
            const positions = ['Switcher','Lowerthird','Camera','Sound','Replay','Director','Support'];
            // Determine whether current user is allowed to specify a daily rate. Admins and the team leader can set wages.
            const isLeader = currentJobData && currentJobData.teamLeaderId && currentUser && currentUser.uid === currentJobData.teamLeaderId;
            const canSetWage = (currentUserRole === 'admin' || isLeader);
            // Show daily rate input only when allowed
            const rateInputHTML = canSetWage ? '<input type="number" name="dailyRate" placeholder="ค่าแรง/วัน" required class="w-full p-2 border rounded">' : '';
            const content = `
                <div class="flex items-center space-x-4">
                    <img id="add-member-pic-preview" src="https://placehold.co/40x40/E2E8F0/4A5568?text=รูป" class="w-10 h-10 rounded-full object-cover border-2 border-gray-200">
                    <select id="add-member-select" name="userId" required class="w-full p-2 border rounded flex-grow">${userOptions}</select>
                </div>
                <div class="space-y-2 mt-3">
                    <label class="block text-sm font-semibold text-gray-700">ตำแหน่ง (เลือกได้หลายตำแหน่ง)</label>
                    <div class="flex flex-wrap gap-2">
                        ${positions.map(pos => `<label class="cursor-pointer flex items-center space-x-2 px-3 py-1 border rounded-full hover:bg-gray-100">
                            <input type="checkbox" class="position-checkbox" value="${pos}">
                            <span>${pos}</span>
                        </label>`).join('')}
                    </div>
                    <input type="text" name="otherPosition" placeholder="ตำแหน่งอื่นๆ (คั่นด้วย /)" class="w-full p-2 border rounded">
                </div>
                <div class="mt-3">
                    ${rateInputHTML}
                </div>`;
            showModal('เพิ่มสมาชิกในทีม', content, async (formData, submitButton, modal) => {
                const userId = formData.get('userId');
                // Collect positions from checkboxes and other input
                const checks = modal.querySelectorAll('.position-checkbox');
                let posList = [];
                checks.forEach(cb => {
                    if (cb.checked) posList.push(cb.value);
                });
                const otherPos = formData.get('otherPosition')?.trim() || '';
                if (otherPos) {
                    posList = posList.concat(otherPos.split('/').map(s => s.trim()).filter(Boolean));
                }
                const positionStr = posList.join('/');
                // Use provided daily rate when allowed; otherwise default to 0
                const dailyRateValue = canSetWage ? Number(formData.get('dailyRate')) : 0;
                await updateDoc(doc(db, "jobs", currentJobId), { team: arrayUnion({ userId: userId, position: positionStr, dailyRate: dailyRateValue, workdays: [], dailyOverrides: {}, isPaid: false, whtEnabled: false })});
                await createNotification(userId, `คุณถูกเพิ่มเข้าคิวงาน: <b>${currentJobData.name}</b>`, currentJobId, currentJobData.name);
                modal.remove();
            }, true, (modal) => {
                const selectEl = modal.querySelector('#add-member-select');
                const previewEl = modal.querySelector('#add-member-pic-preview');
                const updatePreview = () => {
                    const selectedOption = selectEl.options[selectEl.selectedIndex];
                    const picUrl = selectedOption.dataset.pic;
                    previewEl.src = picUrl || 'https://placehold.co/40x40/E2E8F0/4A5568?text=รูป';
                };
                selectEl.onchange = updatePreview;
                updatePreview();
            });
        }

        function showEditMemberModal(member) {
            const memberData = allUsers.find(u => u.id === member.userId);
            // Create select options for all users
            let userOptions = allUsers.map(u => `<option value="${u.id}" data-pic="${u.profilePic || ''}" ${u.id === member.userId ? 'selected' : ''}>${u.nickname || u.name}</option>`).join('');
            const positions = ['Switcher','Lowerthrid','Camera','Sound','Replay','Director','Support'];
            // Parse current positions
            const currentPositions = (member.position || '').split('/').map(p => p.trim()).filter(Boolean);
            const standardPositionsChecked = positions.map(pos => currentPositions.includes(pos));
            const otherPositions = currentPositions.filter(p => !positions.includes(p)).join('/');
            // Determine permission to edit wage: admins or the team leader
            const isLeader = currentJobData && currentJobData.teamLeaderId && currentUser && currentUser.uid === currentJobData.teamLeaderId;
            const canEditWage = (currentUserRole === 'admin' || isLeader);
            // Daily rate input shown only if allowed
            const rateInputHTML_edit = canEditWage
                ? `<input type="number" name="dailyRate" placeholder="ค่าแรง/วัน" required class="w-full p-2 border rounded mt-3" value="${member.dailyRate}">`
                : '';
            const content = `
                <div class="flex items-center space-x-4">
                    <img id="edit-member-pic-preview" src="${memberData.profilePic || 'https://placehold.co/40x40/E2E8F0/4A5568?text=รูป'}" class="w-10 h-10 rounded-full object-cover border-2 border-gray-200">
                    <select id="edit-member-select" name="userId" required class="w-full p-2 border rounded flex-grow">${userOptions}</select>
                </div>
                <div class="space-y-2 mt-3">
                    <label class="block text-sm font-semibold text-gray-700">ตำแหน่ง (เลือกได้หลายตำแหน่ง)</label>
                    <div class="flex flex-wrap gap-2">
                        ${positions.map((pos, idx) => `<label class="cursor-pointer flex items-center space-x-2 px-3 py-1 border rounded-full hover:bg-gray-100">
                            <input type="checkbox" class="edit-position-checkbox" value="${pos}" ${standardPositionsChecked[idx] ? 'checked' : ''}>
                            <span>${pos}</span>
                        </label>`).join('')}
                    </div>
                    <input type="text" name="otherPosition" placeholder="ตำแหน่งอื่นๆ (คั่นด้วย /)" class="w-full p-2 border rounded" value="${otherPositions}">
                </div>
                ${rateInputHTML_edit}
                <!-- Hide the "set as team leader" checkbox for non-admins. Only administrators should be able to assign a team leader. -->
                <div class="flex items-center space-x-2 mt-3 ${currentUserRole !== 'admin' ? 'hidden' : ''}">
                    <input type="checkbox" id="is-leader-checkbox" name="isLeader" ${currentJobData.teamLeaderId === member.userId ? 'checked' : ''}>
                    <label for="is-leader-checkbox">กำหนดเป็นหัวหน้าทีม</label>
                </div>`;
            showModal('แก้ไขข้อมูลทีมงาน', content, async (formData, submitButton, modal) => {
                const newUserId = formData.get('userId');
                const isLeaderCheckbox = formData.get('isLeader');
                const teamMemberIndex = currentJobData.team.findIndex(m => m.userId === member.userId);

                // Collect positions
                const checks = modal.querySelectorAll('.edit-position-checkbox');
                let posList = [];
                checks.forEach(cb => {
                    if (cb.checked) posList.push(cb.value);
                });
                const otherPos = formData.get('otherPosition')?.trim() || '';
                if (otherPos) {
                    posList = posList.concat(otherPos.split('/').map(s => s.trim()).filter(Boolean));
                }
                const positionStr = posList.join('/');

                if (teamMemberIndex > -1) {
                    currentJobData.team[teamMemberIndex].userId = newUserId;
                    currentJobData.team[teamMemberIndex].position = positionStr;
                    // Update daily rate if allowed
                    if (canEditWage) {
                        currentJobData.team[teamMemberIndex].dailyRate = Number(formData.get('dailyRate'));
                    }
                }

                let newLeaderId = currentJobData.teamLeaderId;
                if (isLeaderCheckbox) {
                    newLeaderId = newUserId;
                } else if (currentJobData.teamLeaderId === member.userId) {
                    newLeaderId = '';
                }

                await updateDoc(doc(db, "jobs", currentJobId), { team: currentJobData.team, teamLeaderId: newLeaderId });
                modal.remove();
            }, true, (modal) => {
                const selectEl = modal.querySelector('#edit-member-select');
                const previewEl = modal.querySelector('#edit-member-pic-preview');
                const updatePreview = () => {
                    const selectedOption = selectEl.options[selectEl.selectedIndex];
                    const picUrl = selectedOption.dataset.pic;
                    previewEl.src = picUrl || 'https://placehold.co/40x40/E2E8F0/4A5568?text=รูป';
                };
                selectEl.onchange = updatePreview;
            });
        }

        function showEditBudgetModal(currentBudget) {
            showModal('แก้ไขงบประมาณ', `<input type="number" name="income" required class="w-full p-2 border rounded" value="${currentBudget}">`, async (formData, submitButton, modal) => {
                await updateDoc(doc(db, "jobs", currentJobId), { income: Number(formData.get('income')) });
                modal.remove();
            });
        }

        function showAddDayModal() {
            showModal('เพิ่มวันทำงาน', `<label>เลือกวันที่ต้องการเพิ่ม</label><input type="date" name="newDay" required class="w-full p-2 border rounded">`, async (formData, submitButton, modal) => {
                const newDay = formData.get('newDay');
                currentJobData.workdays.push(newDay);
                currentJobData.workdays.sort((a, b) => new Date(a) - new Date(b));
                await updateDoc(doc(db, "jobs", currentJobId), { workdays: currentJobData.workdays });
                modal.remove();
            });
        }

        function showExpenseModal() {
            const content = `<input type="text" name="name" placeholder="ชื่อรายการ" required class="w-full p-2 border rounded"><input type="number" name="amount" placeholder="จำนวนเงิน" required class="w-full p-2 border rounded">`;
            showModal('เพิ่มค่าใช้จ่าย', content, async (formData, submitButton, modal) => {
                // Capture fields for tracking who added the expense
                const name = formData.get('name');
                const amount = Number(formData.get('amount'));
                const addedBy = currentUser ? currentUser.uid : null;
                // Do not store admin nickname when admin adds the expense
                let addedByNickname = (currentUserData && (currentUserData.nickname || currentUserData.name)) || '';
                if (currentUserRole === 'admin') {
                    addedByNickname = '';
                }
                await updateDoc(doc(db, "jobs", currentJobId), { expenses: arrayUnion({ name, amount, addedBy, addedByNickname }) });
                modal.remove();
            });
        }

        function showEditExpenseModal(expense, index) {
            const content = `<input type="text" name="name" placeholder="ชื่อรายการ" required class="w-full p-2 border rounded" value="${expense.name}"><input type="number" name="amount" placeholder="จำนวนเงิน" required class="w-full p-2 border rounded" value="${expense.amount}">`;
            showModal('แก้ไขค่าใช้จ่าย', content, async (formData, submitButton, modal) => {
                const updatedExpense = {
                    ...expense,
                    name: formData.get('name'),
                    amount: Number(formData.get('amount'))
                };
                // If admin is editing the expense, clear the nickname to avoid displaying admin nickname
                if (currentUserRole === 'admin') {
                    updatedExpense.addedByNickname = '';
                }
                currentJobData.expenses[index] = updatedExpense;
                await updateDoc(doc(db, "jobs", currentJobId), { expenses: currentJobData.expenses });
                modal.remove();
            });
        }

        function showEditDailyRateModal(userId, day) {
            const member = currentJobData.team.find(m => m.userId === userId);
            const currentRate = (member.dailyOverrides && member.dailyOverrides[day] !== undefined) ? member.dailyOverrides[day] : member.dailyRate;
            const content = `<label>ค่าแรงสำหรับวันที่ ${formatShortDate(day)}</label><input type="number" name="rate" required class="w-full p-2 border rounded" value="${currentRate}">`;
            showModal('แก้ไขค่าแรงรายวัน', content, async (formData, submitButton, modal) => {
                const newRate = Number(formData.get('rate'));
                if (!member.dailyOverrides) member.dailyOverrides = {};
                member.dailyOverrides[day] = newRate;
                await updateDoc(doc(db, "jobs", currentJobId), { team: currentJobData.team });
                modal.remove();
            });
        }

        function showEditJobDetailsModal(job) {
            // Construct a modernised form layout using a responsive grid.
            // Each field is grouped with its label for better readability.
            const content = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">ไอคอน</label>
                        <select name="icon" required class="w-full p-2 border rounded">
                            <option value="ph-video-camera" ${job.icon === 'ph-video-camera' ? 'selected' : ''}>กล้องโอบี</option>
                            <option value="ph-broadcast" ${job.icon === 'ph-broadcast' ? 'selected' : ''}>ถ่ายทอด</option>
                            <option value="ph-microphone" ${job.icon === 'ph-microphone' ? 'selected' : ''}>ไมโครโฟน</option>
                            <option value="ph-music-notes-simple" ${job.icon === 'ph-music-notes-simple' ? 'selected' : ''}>ดนตรี</option>
                            <option value="ph-film-slate" ${job.icon === 'ph-film-slate' ? 'selected' : ''}>ภาพยนตร์</option>
                            <option value="ph-airplay" ${job.icon === 'ph-airplay' ? 'selected' : ''}>หน้าจอ</option>
                            <!-- Added additional icons for a wider selection -->
                            <option value="ph-soccer-ball" ${job.icon === 'ph-soccer-ball' ? 'selected' : ''}>ฟุตบอล</option>
                            <option value="ph-bicycle" ${job.icon === 'ph-bicycle' ? 'selected' : ''}>จักรยานขาไถ</option>
                            <option value="ph-buddha" ${job.icon === 'ph-buddha' ? 'selected' : ''}>พระพุทธรูป</option>
                            <option value="ph-camera" ${job.icon === 'ph-camera' ? 'selected' : ''}>กล้อง</option>
                            <option value="ph-airplane" ${job.icon === 'ph-airplane' ? 'selected' : ''}>โดรน</option>
                            <option value="ph-crown" ${job.icon === 'ph-crown' ? 'selected' : ''}>นางงาม</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">ชื่องาน</label>
                        <input type="text" name="name" required class="w-full p-2 border rounded" value="${job.name}">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">สถานที่</label>
                        <input type="text" name="location" required class="w-full p-2 border rounded" value="${job.location}">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">จำนวนทีมงานที่รับ</label>
                        <input type="number" name="teamNeeded" min="0" required class="w-full p-2 border rounded" value="${job.teamNeeded || 0}">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">วันที่เริ่ม</label>
                        <input type="date" name="startDate" required class="w-full p-2 border rounded" value="${job.startDate}">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">วันที่สิ้นสุด</label>
                        <input type="date" name="endDate" required class="w-full p-2 border rounded" value="${job.endDate}">
                    </div>
                </div>
                `;
            showModal('แก้ไขข้อมูลคิวงาน', content, async (formData, submitButton, modal) => {
                await updateDoc(doc(db, "jobs", currentJobId), {
                    name: formData.get('name'),
                    location: formData.get('location'),
                    teamNeeded: Number(formData.get('teamNeeded')),
                    startDate: formData.get('startDate'),
                    endDate: formData.get('endDate'),
                    icon: formData.get('icon')
                });
                modal.remove();
            });
        }

        function showEditWorkdayModal(oldDay) {
            const content = `<label>แก้ไขวันที่จาก ${formatShortDate(oldDay)} เป็น</label><input type="date" name="newDay" required class="w-full p-2 border rounded" value="${oldDay}">`;
            showModal('แก้ไขวันทำงาน', content, async (formData, submitButton, modal) => {
                const newDay = formData.get('newDay');
                const dayIndex = currentJobData.workdays.indexOf(oldDay);
                if (dayIndex > -1) currentJobData.workdays[dayIndex] = newDay;
                currentJobData.workdays.sort((a, b) => new Date(a) - new Date(b));
                currentJobData.team.forEach(member => {
                    const memberDayIndex = member.workdays.indexOf(oldDay);
                    if (memberDayIndex > -1) member.workdays[memberDayIndex] = newDay;
                    if (member.dailyOverrides && member.dailyOverrides[oldDay] !== undefined) {
                        member.dailyOverrides[newDay] = member.dailyOverrides[oldDay];
                        delete member.dailyOverrides[oldDay];
                    }
                });
                await updateDoc(doc(db, "jobs", currentJobId), { workdays: currentJobData.workdays, team: currentJobData.team });
                modal.remove();
            });
        }

        function showUserManagementModal() {
            let userListHTML = `<div class="space-y-4">`;
            allUsers.forEach(user => {
                const displayName = user.nickname || user.name;
                const bankInfo = user.bankAccount;
                // When constructing the user list, ensure that action buttons inside the form
                // are explicitly marked as type="button". Without this attribute, buttons
                // default to type="submit", which causes the parent form (created by showModal)
                // to submit and inadvertently close the modal when clicked.  Adding
                // type="button" prevents this undesired form submission.
                userListHTML += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <img src="${user.profilePic || 'https://placehold.co/40x40/E2E8F0/4A5568?text=??'}" class="w-10 h-10 rounded-full mr-4">
                        <div>
                            <p class="font-semibold flex items-center">
                                ${(() => {
                                    const wht = user.withholdingAccount || {};
                                    const addr = wht.address || {};
                                    const complete = wht && wht.idNumber && addr.houseNumber && addr.subdistrict && addr.district && addr.province && addr.postalCode && wht.idCardCopyUrl;
                                    return complete ? '<i class="ph-fill ph-star text-yellow-400 mr-1"></i>' : '';
                                })()}${displayName}
                            </p>
                            <p class="text-sm text-gray-500">${user.email} - <span class="font-medium">${user.role}</span></p>
                            <div class="text-xs text-gray-400 mt-1"><i class="ph ph-bank"></i> ${bankInfo?.bank || 'N/A'}: ${bankInfo?.number || 'N/A'}</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button type="button" class="modal-switch-view-btn p-2 text-green-500 hover:bg-green-100 rounded-full" data-userid="${user.id}"><i class="ph ph-eye"></i></button>
                        <!-- View withholding account info button -->
                        <button type="button" class="modal-view-wht-btn p-2 text-blue-500 hover:bg-blue-100 rounded-full" data-userid="${user.id}"><i class="ph ph-file-text"></i></button>
                        <button type="button" class="modal-delete-user-btn p-2 text-red-500 hover:bg-red-100 rounded-full" data-userid="${user.id}"><i class="ph ph-trash"></i></button>
                    </div>
                </div>`;
            });
            userListHTML += `</div>`;

            showModal(`การจัดการทีมงานทั้งหมด (${allUsers.length} คน)`, userListHTML, null, false, (modal) => {
                modal.querySelectorAll('.modal-delete-user-btn').forEach(btn => btn.onclick = (e) => {
                    const userIdToDelete = e.currentTarget.dataset.userid;
                    if (userIdToDelete === currentUser.uid) {
                        alert("ไม่สามารถลบตัวเองได้");
                        return;
                    }
                    const userToDelete = allUsers.find(u => u.id === userIdToDelete);
                    const userName = userToDelete ? (userToDelete.nickname || userToDelete.name) : 'ผู้ใช้คนนี้';

                    showConfirmModal(
                        `ยืนยันการลบ ${userName}`,
                        'การกระทำนี้จะลบผู้ใช้ออกจากระบบและคิวงานทั้งหมดที่เกี่ยวข้องอย่างถาวร แต่จะไม่ลบบัญชีล็อกอิน คุณแน่ใจหรือไม่?',
                        async () => {
                            try {
                                const batch = writeBatch(db);

                                // 1. Delete the user document
                                const userRef = doc(db, "users", userIdToDelete);
                                batch.delete(userRef);

                                // 2. Remove the user from all jobs
                                const jobsSnapshot = await getDocs(collection(db, "jobs"));
                                jobsSnapshot.forEach(jobDoc => {
                                    const jobData = jobDoc.data();
                                    const team = jobData.team || [];

                                    const newTeam = team.filter(member => member.userId !== userIdToDelete);

                                    if (newTeam.length < team.length) {
                                        const jobRef = doc(db, "jobs", jobDoc.id);
                                        batch.update(jobRef, { team: newTeam });
                                    }
                                });

                                // Commit the batch
                                await batch.commit();

                                alert(`ลบ ${userName} เรียบร้อยแล้ว`);
                                modal.remove(); // Close the user management modal
                            } catch (error) {
                                console.error("Error deleting user permanently:", error);
                                alert("เกิดข้อผิดพลาดในการลบผู้ใช้");
                            }
                        }
                    );
                });
                modal.querySelectorAll('.modal-switch-view-btn').forEach(btn => btn.onclick = (e) => {
                    const userIdToImpersonate = e.currentTarget.dataset.userid;
                    switchToUserView(userIdToImpersonate);
                    modal.remove();
                });
                // Attach handlers to view withholding account buttons
                modal.querySelectorAll('.modal-view-wht-btn').forEach(btn => btn.onclick = (e) => {
                    const userId = e.currentTarget.dataset.userid;
                    showUserWhtDetailModal(userId);
                });
            });
        }

        function showManageProfileModal() {
            const content = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left: Profile picture and identifiers -->
                    <div class="flex flex-col items-center space-y-3">
                        <img id="profile-pic-preview" src="${currentUserData.profilePic || 'https://placehold.co/150x150/E2E8F0/4A5568?text=รูป'}" class="w-32 h-32 rounded-full object-cover border-2 border-gray-200" />
                        <label for="profilePicFile" class="cursor-pointer text-sm text-violet-700 font-semibold hover:text-violet-900">เลือกรูปภาพ</label>
                        <input type="file" name="profilePicFile" id="profilePicFile" accept="image/*" class="hidden" />
                        <!-- Small text showing email -->
                        <p class="text-xs text-gray-500">Email: ${currentUser.email || currentUserData.email || ''}</p>
                    </div>
                    <!-- Right: Fields -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ชื่อเล่น</label>
                            <input type="text" name="nickname" required class="mt-1 block w-full p-2 border rounded" placeholder="ชื่อเล่น" value="${currentUserData.nickname || ''}" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Username</label>
                            <input type="text" readonly class="mt-1 block w-full p-2 border rounded bg-gray-100" value="${currentUserData.name}" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">เบอร์โทร</label>
                            <input type="tel" name="phone" required class="mt-1 block w-full p-2 border rounded" value="${currentUserData.phone || ''}" />
                        </div>
                    </div>
                </div>
                <hr class="my-4" />
                <div id="social-linking-container" class="space-y-2"></div>
                <hr class="my-4" />
                <div class="grid grid-cols-2 gap-4">
                    <button type="button" id="manage-bank-account-btn" class="w-full px-4 py-2 font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors">บัญชีธนาคาร</button>
                    <button type="button" id="change-password-from-profile-btn" class="w-full px-4 py-2 font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition-colors">เปลี่ยนรหัสผ่าน</button>
                </div>`;
            showModal('จัดการโปรไฟล์', content, async (formData, submitButton, modal) => {
                const nickname = formData.get('nickname').trim();
                const phone = formData.get('phone').trim();

                if (!nickname || !phone) {
                    alert('กรุณากรอกชื่อเล่นและเบอร์โทรให้ครบถ้วน');
                    return;
                }

                submitButton.textContent = 'กำลังบันทึก...';
                submitButton.disabled = true;
                const profilePicFile = formData.get('profilePicFile');
                let newProfilePicUrl = currentUserData.profilePic;
                if (profilePicFile && profilePicFile.size > 0) {
                    newProfilePicUrl = await uploadToCloudinary(profilePicFile) || newProfilePicUrl;
                }
                const updatedData = {
                    nickname: nickname,
                    phone: phone,
                    profilePic: newProfilePicUrl
                };
                await updateDoc(doc(db, "users", currentUser.uid), updatedData);
                currentUserData = {...currentUserData, ...updatedData};
                document.getElementById('user-name-display').textContent = currentUserData.nickname || currentUserData.name;
                modal.remove();
            }, true, (modal) => {
                const fileInput = modal.querySelector('#profilePicFile');
                const previewImg = modal.querySelector('#profile-pic-preview');
                fileInput.onchange = (e) => {
                    if (e.target.files && e.target.files[0]) {
                        previewImg.src = URL.createObjectURL(e.target.files[0]);
                    }
                };

                // Social Linking UI
                const socialContainer = modal.querySelector('#social-linking-container');
                let html = '';
                let showSocial = false;
                // LINE linking
                if (appSettings.isLineLoginEnabled) {
                    showSocial = true;
                    if (currentUserData.lineUserId) {
                        html += `<div class="flex items-center justify-between mb-2">
                            <p class="text-sm font-medium text-gray-700">เชื่อมต่อกับ LINE แล้ว</p>
                            <button type="button" id="unlink-line-btn" class="text-sm text-red-600 hover:text-red-800">ยกเลิกการเชื่อมต่อ</button>
                        </div>`;
                    } else {
                        html += `<button type="button" id="link-line-btn" class="w-full flex items-center justify-center px-4 py-2 mb-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-500 hover:bg-green-600">เชื่อมต่อบัญชี LINE</button>`;
                    }
                }
                // Facebook linking
                if (appSettings.isFacebookLinkEnabled) {
                    showSocial = true;
                    if (currentUserData.facebookUserId) {
                        html += `<div class="flex items-center justify-between mb-2">
                            <p class="text-sm font-medium text-gray-700">เชื่อมต่อกับ Facebook แล้ว</p>
                            <button type="button" id="unlink-facebook-btn" class="text-sm text-red-600 hover:text-red-800">ยกเลิกการเชื่อมต่อ</button>
                        </div>`;
                    } else {
                        html += `<button type="button" id="link-facebook-btn" class="w-full flex items-center justify-center px-4 py-2 mb-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">ผูกบัญชี Facebook</button>`;
                    }
                }
                if (showSocial) {
                    socialContainer.innerHTML = html;
                    socialContainer.classList.remove('hidden');
                    // Attach event handlers for LINE
                    const linkLineBtn = modal.querySelector('#link-line-btn');
                    if (linkLineBtn) linkLineBtn.onclick = async () => { await handleLinkLineAccount(); modal.remove(); };
                    const unlinkLineBtn = modal.querySelector('#unlink-line-btn');
                    if (unlinkLineBtn) unlinkLineBtn.onclick = async () => { await handleUnlinkLineAccount(); modal.remove(); showManageProfileModal(); };
                    // Attach event handlers for Facebook
                    const linkFbBtn = modal.querySelector('#link-facebook-btn');
                    if (linkFbBtn) linkFbBtn.onclick = async () => { await handleLinkFacebookAccount(); modal.remove(); };
                    const unlinkFbBtn = modal.querySelector('#unlink-facebook-btn');
                    if (unlinkFbBtn) unlinkFbBtn.onclick = async () => { await handleUnlinkFacebookAccount(); modal.remove(); showManageProfileModal(); };
                } else {
                    socialContainer.innerHTML = '';
                    socialContainer.classList.add('hidden');
                }


                modal.querySelector('#change-password-from-profile-btn').onclick = () => { modal.remove(); showChangePasswordForCurrentUserModal(); };
                modal.querySelector('#manage-bank-account-btn').onclick = () => { modal.remove(); showBankAccountModal(); };
                // Insert a very small User ID label at the bottom center of the modal
                try {
                    const formEl = modal.querySelector('form.modal-form');
                    if (formEl) {
                        const uidEl = document.createElement('p');
                        uidEl.textContent = `User ID: ${currentUser.uid}`;
                        // Use a smaller font size and center alignment
                        uidEl.className = 'text-[8px] text-gray-400 mt-3 text-center';
                        formEl.appendChild(uidEl);
                    }
                } catch (e) {
                    console.error('Error inserting User ID label:', e);
                }
            });
        }

        function showChangePasswordForCurrentUserModal() {
             const content = `
                <div class="space-y-6 p-4 bg-gray-50 rounded-lg">
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">รหัสผ่านปัจจุบัน</label>
                        <input type="password" name="oldPassword" required class="w-full p-2 border rounded">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">รหัสผ่านใหม่</label>
                        <input type="password" name="newPassword" required class="w-full p-2 border rounded">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">ยืนยันรหัสผ่านใหม่</label>
                        <input type="password" name="confirmPassword" required class="w-full p-2 border rounded">
                    </div>
                    <p id="change-pass-error" class="text-sm text-red-500 hidden"></p>
                </div>
             `;
             showModal('เปลี่ยนรหัสผ่าน', content, async (formData, submitButton, modal) => {
                const oldPass = formData.get('oldPassword');
                const newPass = formData.get('newPassword');
                const confirmPass = formData.get('confirmPassword');

                if (newPass.length < 6) { alert("รหัสผ่านใหม่ต้องมีอย่างน้อย 6 ตัวอักษร"); return; }
                if (newPass !== confirmPass) { alert("รหัสผ่านใหม่และการยืนยันไม่ตรงกัน"); return; }

                submitButton.textContent = 'กำลังเปลี่ยน...';
                submitButton.disabled = true;

                try {
                    const credential = EmailAuthProvider.credential(currentUser.email, oldPass);
                    await reauthenticateWithCredential(currentUser, credential);
                    await updatePassword(currentUser, newPass);
                    alert("เปลี่ยนรหัสผ่านสำเร็จแล้ว");
                    modal.remove();
                } catch(error) {
                    console.error("Password change failed:", error);
                    alert("การเปลี่ยนรหัสผ่านล้มเหลว: รหัสผ่านปัจจุบันไม่ถูกต้อง หรือเกิดข้อผิดพลาดอื่น");
                    submitButton.textContent = 'บันทึก';
                    submitButton.disabled = false;
                }
             });
        }

        function showBankAccountModal() {
            const bankInfo = currentUserData.bankAccount || { name: '', bank: '', number: '' };
            const idCardUrl = currentUserData.idCardCopyUrl || '';
            const banks = ['พร้อมเพย์', 'ธนาคารกรุงเทพ', 'ธนาคารกสิกรไทย', 'ธนาคารกรุงไทย', 'ธนาคารไทยพาณิชย์', 'ธนาคารกรุงศรีอยุธยา', 'ธนาคารทหารไทยธนชาต', 'ธนาคารออมสิน', 'ธ.ก.ส.', 'ธนาคารยูโอบี', 'ธนาคารซีไอเอ็มบีไทย'];
            const bankOptions = banks.map(b => `<option value="${b}" ${b === bankInfo.bank ? 'selected' : ''}>${b}</option>`).join('');
            // Create the modal content without the ID card upload section (moved to the withholding page)
            const content = `
                <div class="space-y-6 p-4 bg-gray-50 rounded-lg">
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">ชื่อบัญชี</label>
                        <input type="text" name="accountName" class="w-full p-2 border rounded" value="${bankInfo.name || ''}" placeholder="ระบุชื่อบัญชี">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">ธนาคาร</label>
                        <select name="bankName" class="w-full p-2 border rounded">${bankOptions}</select>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">หมายเลขบัญชี</label>
                        <input type="text" name="accountNumber" class="w-full p-2 border rounded" value="${bankInfo.number || ''}" placeholder="ระบุเลขบัญชี">
                    </div>
                    <div class="flex justify-end pt-2">
                        <button type="button" id="open-wht-account-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                            ตั้งค่าบัญชีหัก ณ ที่จ่าย
                        </button>
                    </div>
                </div>
            `;
            showModal('ข้อมูลบัญชีธนาคาร', content, async (formData, submitButton, modal) => {
                submitButton.disabled = true;
                submitButton.textContent = 'กำลังบันทึก...';

                const updatedBankAccount = {
                    name: formData.get('accountName'),
                    bank: formData.get('bankName'),
                    number: formData.get('accountNumber')
                };
                // Save only the bank account information; ID card upload handled elsewhere
                await updateDoc(doc(db, "users", currentUser.uid), { 
                    bankAccount: updatedBankAccount
                });
                currentUserData.bankAccount = updatedBankAccount;
                alert('บันทึกข้อมูลบัญชีธนาคารเรียบร้อยแล้ว');
                modal.remove();
            }, true, (modal) => {
                // When the modal is ready, attach click handler for the withholding account button
                const whtBtn = modal.querySelector('#open-wht-account-btn');
                if (whtBtn) {
                    whtBtn.onclick = () => {
                        // Close the bank account modal and open the withholding account settings
                        modal.remove();
                        showWithholdingAccountModal();
                    };
                }
            });
        }


        function showForgotPasswordModal() {
            const content = `<label>กรุณากรอกอีเมลของคุณเพื่อรีเซ็ตรหัสผ่าน</label><input type="email" name="email" required class="w-full p-2 border rounded" placeholder="your@email.com">`;
            showModal('ลืมรหัสผ่าน', content, async (formData, submitButton, modal) => {
                const email = formData.get('email');
                try {
                    await sendPasswordResetEmail(auth, email);
                    alert('อีเมลสำหรับรีเซ็ตรหัสผ่านได้ถูกส่งไปแล้ว กรุณาตรวจสอบกล่องจดหมายของคุณ');
                    modal.remove();
                } catch (error) {
                    console.error("Password reset error:", error);
                    alert('เกิดข้อผิดพลาด: ไม่สามารถส่งอีเมลรีเซ็ตรหัสผ่านได้ อาจเป็นเพราะไม่มีอีเมลนี้ในระบบ');
                }
            });
        }

        /**
         * รายการจังหวัดของประเทศไทย สำหรับการเลือกที่อยู่ในแบบฟอร์มบัญชีหัก ณ ที่จ่าย
         * จัดเตรียมรายชื่อจังหวัดโดยประมาณ 77 จังหวัด เพื่อใช้ใน dropdown
         */
        const thaiProvinces = [
            'กรุงเทพมหานคร', 'กระบี่', 'กาญจนบุรี', 'กาฬสินธุ์', 'ขอนแก่น',
            'จันทบุรี', 'ฉะเชิงเทรา', 'ชลบุรี', 'ชัยนาท', 'ชัยภูมิ', 'ชุมพร',
            'เชียงราย', 'เชียงใหม่', 'ตรัง', 'ตราด', 'ตาก', 'นครนายก', 'นครปฐม',
            'นครพนม', 'นครราชสีมา', 'นครศรีธรรมราช', 'นครสวรรค์', 'นนทบุรี',
            'นราธิวาส', 'น่าน', 'บึงกาฬ', 'บุรีรัมย์', 'ปทุมธานี', 'ประจวบคีรีขันธ์',
            'ปราจีนบุรี', 'ปัตตานี', 'พระนครศรีอยุธยา', 'พังงา', 'พัทลุง',
            'พิจิตร', 'พิษณุโลก', 'เพชรบุรี', 'เพชรบูรณ์', 'แพร่', 'พะเยา',
            'ภูเก็ต', 'มหาสารคาม', 'มุกดาหาร', 'แม่ฮ่องสอน', 'ยะลา', 'ยโสธร',
            'ระนอง', 'ระยอง', 'ราชบุรี', 'ลพบุรี', 'ลำปาง', 'ลำพูน', 'ศรีสะเกษ',
            'สกลนคร', 'สงขลา', 'สตูล', 'สมุทรปราการ', 'สมุทรสงคราม', 'สมุทรสาคร',
            'สระแก้ว', 'สระบุรี', 'สิงห์บุรี', 'สุโขทัย', 'สุพรรณบุรี',
            'สุราษฎร์ธานี', 'สุรินทร์', 'หนองคาย', 'หนองบัวลำภู', 'อ่างทอง',
            'อำนาจเจริญ', 'อุดรธานี', 'อุตรดิตถ์', 'อุทัยธานี', 'อุบลราชธานี'
        ];

        /**
         * แสดงหน้าตั้งค่าบัญชีหัก ณ ที่จ่าย สำหรับทีมงาน
         * แบบฟอร์มนี้จะบันทึกข้อมูลลงในผู้ใช้ (users) ที่เข้าสู่ระบบปัจจุบัน
         */
        function showWithholdingAccountModal() {
            // ดึงข้อมูลการตั้งค่าบัญชีหัก ณ ที่จ่ายปัจจุบัน หากมี
            const whtInfo = currentUserData.withholdingAccount || {};
            // เตรียมข้อมูลที่อยู่ย่อย
            const address = whtInfo.address || {};
            // สร้าง options สำหรับรายชื่อจังหวัด
            const provinceOptions = thaiProvinces.map(prov => `<option value="${prov}" ${prov === (address.province || '') ? 'selected' : ''}>${prov}</option>`).join('');
            // ชื่อ-สกุลจะดึงมาจากชื่อบัญชีธนาคาร หากไม่มีให้ใช้ชื่อ-สกุลใน whtInfo
            const defaultName = whtInfo.name || (currentUserData.bankAccount && currentUserData.bankAccount.name ? currentUserData.bankAccount.name : '');
            // สร้าง HTML ของแบบฟอร์ม
            const content = `
                <div class="space-y-6 p-4 bg-gray-50 rounded-lg">
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">ชื่อ-สกุล</label>
                        <input type="text" name="whtName" class="w-full p-2 border rounded bg-gray-100" value="${defaultName}" readonly>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">เลขบัตรประชาชน</label>
                        <input type="text" name="idCardNumber" class="w-full p-2 border rounded" value="${whtInfo.idNumber || ''}" required>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">ที่อยู่</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <input type="text" name="houseNumber" placeholder="บ้านเลขที่" class="w-full p-2 border rounded" value="${address.houseNumber || ''}">
                            <input type="text" name="moo" placeholder="หมู่ที่" class="w-full p-2 border rounded" value="${address.moo || ''}">
                            <input type="text" name="subdistrict" placeholder="ตำบล" class="w-full p-2 border rounded" value="${address.subdistrict || ''}">
                            <input type="text" name="district" placeholder="อำเภอ" class="w-full p-2 border rounded" value="${address.district || ''}">
                            <select name="province" class="w-full p-2 border rounded">
                                <option value="">-- เลือกจังหวัด --</option>
                                ${provinceOptions}
                            </select>
                            <input type="text" name="postalCode" placeholder="รหัสไปรษณีย์" class="w-full p-2 border rounded" value="${address.postalCode || ''}">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">อัปโหลดสำเนาบัตรประชาชน</label>
                        ${whtInfo.idCardCopyUrl ? `<img src="${whtInfo.idCardCopyUrl}" class="w-40 h-24 object-cover rounded border" />` : ''}
                        <input type="file" name="idCardFile" accept="image/*" class="w-full">
                    </div>
                </div>
            `;
            showModal('ตั้งค่าบัญชีหัก ณ ที่จ่าย', content, async (formData, submitButton, modal) => {
                submitButton.disabled = true;
                submitButton.textContent = 'กำลังบันทึก...';
                // เตรียม URL สำเนาบัตรประชาชน
                let idCardUrl = whtInfo.idCardCopyUrl || '';
                const file = formData.get('idCardFile');
                if (file && file.size > 0) {
                    // อัปโหลดภาพไป Cloudinary หากมีการเลือกไฟล์
                    const uploaded = await uploadToCloudinary(file);
                    if (uploaded) {
                        idCardUrl = uploaded;
                    } else {
                        submitButton.disabled = false;
                        submitButton.textContent = 'บันทึก';
                        return;
                    }
                }
                const newWht = {
                    name: formData.get('whtName'),
                    idNumber: formData.get('idCardNumber'),
                    address: {
                        houseNumber: formData.get('houseNumber'),
                        moo: formData.get('moo'),
                        subdistrict: formData.get('subdistrict'),
                        district: formData.get('district'),
                        province: formData.get('province'),
                        postalCode: formData.get('postalCode')
                    },
                    idCardCopyUrl: idCardUrl
                };
                try {
                    await updateDoc(doc(db, 'users', currentUser.uid), { withholdingAccount: newWht });
                    currentUserData.withholdingAccount = newWht;
                    alert('บันทึกข้อมูลบัญชีหัก ณ ที่จ่ายเรียบร้อยแล้ว');
                    modal.remove();
                } catch (err) {
                    console.error('Error saving withholding account:', err);
                    alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
                    submitButton.disabled = false;
                    submitButton.textContent = 'บันทึก';
                }
            });
        }

        /**
         * แสดงข้อมูลบัญชีหัก ณ ที่จ่ายของทีมงานแต่ละคน (เฉพาะแอดมิน)
         * เมื่อเรียกใช้จะเปิด modal พร้อมรายละเอียด หากไม่มีข้อมูลจะแจ้งว่าไม่ได้ตั้งค่า
         */
        function showUserWhtDetailModal(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            const whtInfo = user.withholdingAccount;
            let content = '';
            if (!whtInfo) {
                content = `<p class="text-center text-gray-500">ทีมงานคนนี้ยังไม่ได้ตั้งค่าบัญชีหัก ณ ที่จ่าย</p>`;
                const title = `ข้อมูลบัญชีหัก ณ ที่จ่าย (${user.nickname || user.name})`;
                showModal(title, content, null, false);
            } else {
                // Mask a string by keeping first two characters and replacing the rest with xxxxxxxx
                const maskString = (str) => {
                    if (!str) return '';
                    const prefix = str.toString().slice(0, 2);
                    return `${prefix}xxxxxxx`;
                };
                // Build masked name and ID number
                const maskedName = maskString(whtInfo.name);
                const maskedId = maskString(whtInfo.idNumber);
                const fullName = whtInfo.name || '';
                const fullId = whtInfo.idNumber || '';
                const addr = whtInfo.address || {};
                // Build masked and full address strings
                const buildAddress = (mask) => {
                    const parts = [];
                    if (mask) {
                        if (addr.houseNumber) parts.push(maskString(addr.houseNumber));
                        if (addr.moo) parts.push('หมู่ ' + maskString(addr.moo));
                        if (addr.subdistrict) parts.push(maskString(addr.subdistrict));
                        if (addr.district) parts.push(maskString(addr.district));
                        if (addr.province) parts.push(maskString(addr.province));
                        if (addr.postalCode) parts.push(maskString(addr.postalCode));
                    } else {
                        if (addr.houseNumber) parts.push(addr.houseNumber);
                        if (addr.moo) parts.push('หมู่ ' + addr.moo);
                        if (addr.subdistrict) parts.push(addr.subdistrict);
                        if (addr.district) parts.push(addr.district);
                        if (addr.province) parts.push(addr.province);
                        if (addr.postalCode) parts.push(addr.postalCode);
                    }
                    return parts.join(' ').trim();
                };
                const maskedAddress = buildAddress(true);
                const fullAddress = buildAddress(false);
                // Build image tags for masked (faded) and full (normal)
                const maskedImg = whtInfo.idCardCopyUrl ? `<div class="mt-2"><img src="${whtInfo.idCardCopyUrl}" class="w-full object-cover rounded opacity-50 grayscale" /></div>` : '';
                const fullImg = whtInfo.idCardCopyUrl ? `<div class="mt-2"><img src="${whtInfo.idCardCopyUrl}" class="w-full object-cover rounded" /></div>` : '';
                const maskedHtml = `
                    <p><strong>ชื่อ-สกุล:</strong> ${maskedName}</p>
                    <p><strong>เลขบัตรประชาชน:</strong> ${maskedId}</p>
                    <p><strong>ที่อยู่:</strong> ${maskedAddress || '-'}</p>
                    ${maskedImg}
                `;
                const fullHtml = `
                    <p><strong>ชื่อ-สกุล:</strong> ${fullName}</p>
                    <p><strong>เลขบัตรประชาชน:</strong> ${fullId}</p>
                    <p><strong>ที่อยู่:</strong> ${fullAddress || '-'}</p>
                    ${fullImg}
                `;
                const title = `ข้อมูลบัญชีหัก ณ ที่จ่าย (${user.nickname || user.name})`;
                // Determine if current user is admin; admins can toggle masking, team members cannot
                const isAdmin = (typeof currentUserRole !== 'undefined' && currentUserRole === 'admin');
                let wrapper;
                if (isAdmin) {
                    // Show toggle button for admin; ensure button does not submit the modal form
                    wrapper = `
                        <div class="relative">
                            <button type="button" id="toggle-wht-mask-btn" class="absolute top-0 right-0 text-gray-500 hover:text-gray-700" title="แสดง/ซ่อนข้อมูลเต็ม"><i class="ph ph-eye"></i></button>
                            <div id="wht-detail-content" class="mt-6">
                                ${maskedHtml}
                            </div>
                        </div>
                    `;
                } else {
                    // For team members: always show masked details; hide the toggle
                    wrapper = `
                        <div class="mt-2">
                            ${maskedHtml}
                        </div>
                    `;
                }
                showModal(title, wrapper, null, false, (modal) => {
                    if (isAdmin) {
                        let masked = true;
                        const toggleBtn = modal.querySelector('#toggle-wht-mask-btn');
                        const contentDiv = modal.querySelector('#wht-detail-content');
                        if (toggleBtn && contentDiv) {
                            toggleBtn.addEventListener('click', () => {
                                masked = !masked;
                                contentDiv.innerHTML = masked ? maskedHtml : fullHtml;
                                // Swap icon
                                toggleBtn.innerHTML = masked ? '<i class="ph ph-eye"></i>' : '<i class="ph ph-eye-slash"></i>';
                            });
                        }
                    }
                });
            }
        }

        /**
         * แสดงหน้าตั้งค่าแบบฟอร์ม หัก ณ ที่จ่าย สำหรับแอดมิน
         * ผู้ดูแลสามารถปรับแก้ค่าต่าง ๆ เช่นเปอร์เซ็นต์หัก ณ ที่จ่าย
         */
        function showWhtFormSettingsModal() {
            // สร้างแบบฟอร์มเพื่อแก้ไขรายละเอียดแบบฟอร์มหักภาษี
            const content = `
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">เล่มที่ (อัตโนมัติ)</label>
                        <input type="text" disabled value="${String(appSettings.whtBookCounter).padStart(2,'0')}" class="w-full p-2 border rounded bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">เลขที่ (อัตโนมัติ)</label>
                        <input type="text" disabled value="${String(appSettings.whtDocCounter).padStart(2,'0')}" class="w-full p-2 border rounded bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">เปอร์เซ็นต์หัก ณ ที่จ่าย (%)</label>
                        <input type="number" step="0.01" min="0" name="whtPercent" class="w-full p-2 border rounded" value="${appSettings.whtPercent ?? 0}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">เลขประจำตัวผู้เสียภาษีอากร</label>
                        <input type="text" name="whtTaxId" maxlength="13" class="w-full p-2 border rounded" value="${appSettings.whtTaxId || ''}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ชื่อบริษัทผู้หักภาษี</label>
                        <input type="text" name="whtCompanyName" class="w-full p-2 border rounded" value="${appSettings.whtCompanyName || ''}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ที่อยู่บริษัท</label>
                        <textarea name="whtCompanyAddress" class="w-full p-2 border rounded" rows="2" required>${appSettings.whtCompanyAddress || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ประเภทแบบฟอร์ม</label>
                        <select name="whtFormType" class="w-full p-2 border rounded">
                            <option value="ภ.ด.ง.3" ${appSettings.whtFormType === 'ภ.ด.ง.3' ? 'selected' : ''}>ภ.ด.ง.3</option>
                            <option value="ภ.ง.ด.53" ${appSettings.whtFormType === 'ภ.ง.ด.53' ? 'selected' : ''}>ภ.ง.ด.53</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ประเภทเงินได้</label>
                        <select name="whtIncomeType" class="w-full p-2 border rounded">
                            <option value="ค่าบริการ" ${appSettings.whtIncomeType === 'ค่าบริการ' ? 'selected' : ''}>ค่าบริการ</option>
                            <option value="ค่าเช่า" ${appSettings.whtIncomeType === 'ค่าเช่า' ? 'selected' : ''}>ค่าเช่า</option>
                            <option value="อื่นๆ" ${appSettings.whtIncomeType === 'อื่นๆ' ? 'selected' : ''}>อื่นๆ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ตัวเลือกผู้จ่ายเงิน</label>
                        <select name="whtPayerOption" class="w-full p-2 border rounded">
                            <option value="(1)" ${appSettings.whtPayerOption === '(1)' ? 'selected' : ''}>(1) หัก ณ ที่จ่าย</option>
                            <option value="(2)" ${appSettings.whtPayerOption === '(2)' ? 'selected' : ''}>(2) ไม่หัก ณ ที่จ่าย</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ลงชื่อ (ผู้จ่ายเงิน)</label>
                        <input type="text" name="whtSignerName" class="w-full p-2 border rounded" value="${appSettings.whtSignerName || ''}" placeholder="ชื่อผู้จ่ายเงิน">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">อัปโหลดโลโก้บริษัท</label>
                        <input type="file" name="whtCompanyLogoFile" accept="image/*" class="block w-full text-sm text-gray-600">
                        <img id="wht-logo-preview" src="${appSettings.whtCompanyLogoUrl || ''}" class="mt-2 max-h-20" />
                    </div>
                    <!-- removed certificate template upload and editor as per new requirements -->
                </div>
            `;
            showModal('ตั้งค่าแบบฟอร์ม หัก ณ ที่จ่าย', content, async (formData, submitButton, modal) => {
                // ตรวจสอบและบันทึกค่าจากฟอร์ม
                const percentVal = parseFloat(formData.get('whtPercent'));
                if (isNaN(percentVal) || percentVal < 0) {
                    alert('กรุณากรอกเปอร์เซ็นต์ที่ถูกต้อง');
                    return;
                }
                // ดึงค่าจากฟอร์ม
                const taxId = formData.get('whtTaxId');
                const companyName = formData.get('whtCompanyName');
                const companyAddress = formData.get('whtCompanyAddress');
                const formType = formData.get('whtFormType');
                const incomeType = formData.get('whtIncomeType');
                const payerOption = formData.get('whtPayerOption');
                const signerName = formData.get('whtSignerName');
                const logoFile = formData.get('whtCompanyLogoFile');
                const formImageFile = formData.get('whtFormImageFile');
                submitButton.disabled = true;
                submitButton.textContent = 'กำลังบันทึก...';
                let logoUrl = appSettings.whtCompanyLogoUrl;
                // หากมีอัปโหลดโลโก้ใหม่
                if (logoFile && logoFile.size > 0) {
                    const uploaded = await uploadToCloudinary(logoFile);
                    if (uploaded) logoUrl = uploaded;
                }
                let formImgUrl = appSettings.whtFormImageUrl;
                // หากมีอัปโหลดภาพหนังสือ 50 ทวิ ใหม่
                if (formImageFile && formImageFile.size > 0) {
                    const uploadedFormImg = await uploadToCloudinary(formImageFile);
                    if (uploadedFormImg) formImgUrl = uploadedFormImg;
                }
                try {
                    // สร้างอ็อบเจ็กต์ layout จากตำแหน่งจริงในตัวแก้ไขเทมเพลต
                    let layoutObj = {};
                    if (modal) {
                        const editorEl = modal.querySelector('#wht-template-editor');
                        if (editorEl) {
                            const editorRect = editorEl.getBoundingClientRect();
                            editorEl.querySelectorAll('[data-field].template-field').forEach(el => {
                                const rect = el.getBoundingClientRect();
                                const field = el.dataset.field;
                                const mmX = ((rect.left - editorRect.left) / editorRect.width) * 210;
                                const mmY = ((rect.top - editorRect.top) / editorRect.height) * 297;
                                // เก็บขนาดตัวอักษรเป็นหน่วย point (px * 0.75)
                                const fontSizePx = parseFloat(window.getComputedStyle(el).fontSize);
                                const fontSizePt = fontSizePx * 0.75;
                                layoutObj[field] = { x: mmX, y: mmY, size: fontSizePt };
                            });
                        }
                    }
                    // บันทึกลง Firestore
                    await setDoc(doc(db, 'settings', 'app-config'), {
                        whtPercent: percentVal,
                        whtTaxId: taxId,
                        whtCompanyName: companyName,
                        whtCompanyAddress: companyAddress,
                        whtFormType: formType,
                        whtIncomeType: incomeType,
                        whtPayerOption: payerOption,
                        whtSignerName: signerName,
                        whtCompanyLogoUrl: logoUrl,
                        whtFormImageUrl: formImgUrl,
                        whtFormLayout: layoutObj
                    }, { merge: true });
                    // อัปเดตค่าใน appSettings
                    Object.assign(appSettings, {
                        whtPercent: percentVal,
                        whtTaxId: taxId,
                        whtCompanyName: companyName,
                        whtCompanyAddress: companyAddress,
                        whtFormType: formType,
                        whtIncomeType: incomeType,
                        whtPayerOption: payerOption,
                        whtSignerName: signerName,
                        whtCompanyLogoUrl: logoUrl,
                        whtFormImageUrl: formImgUrl,
                        whtFormLayout: layoutObj
                    });
                    alert('บันทึกการตั้งค่าแบบฟอร์ม หัก ณ ที่จ่ายเรียบร้อยแล้ว');
                    modal.remove();
                } catch (err) {
                    console.error('Error updating withholding form settings:', err);
                    alert('เกิดข้อผิดพลาดในการบันทึกการตั้งค่า');
                    submitButton.disabled = false;
                    submitButton.textContent = 'บันทึก';
                }
            }, true, (modalEl) => {
                // preview change of logo on input change
                const logoInput = modalEl.querySelector('input[name="whtCompanyLogoFile"]');
                const logoPreview = modalEl.querySelector('#wht-logo-preview');
                if (logoInput) {
                    logoInput.addEventListener('change', (e) => {
                        if (e.target.files && e.target.files[0]) {
                            logoPreview.src = URL.createObjectURL(e.target.files[0]);
                        }
                    });
                }
                // preview change of certificate template image on input change
                const formInput = modalEl.querySelector('input[name="whtFormImageFile"]');
                const formPreview = modalEl.querySelector('#wht-form-preview');
                if (formInput) {
                    formInput.addEventListener('change', (e) => {
                        if (e.target.files && e.target.files[0]) {
                            const url = URL.createObjectURL(e.target.files[0]);
                            formPreview.src = url;
                            // update background of editor as well
                            const editor = modalEl.querySelector('#wht-template-editor');
                            if (editor) {
                                editor.style.backgroundImage = `url(${url})`;
                            }
                        }
                    });
                }
                // ตั้งค่า editor background
                const editor = modalEl.querySelector('#wht-template-editor');
                if (editor) {
                    if (appSettings.whtFormImageUrl) {
                            editor.style.backgroundImage = `url(${appSettings.whtFormImageUrl})`;
                            editor.style.backgroundSize = 'contain';
                            editor.style.backgroundRepeat = 'no-repeat';
                            editor.style.backgroundPosition = 'center';
                    }
                    // helper to make an element draggable within the editor
                    function makeDraggable(el) {
                        el.classList.add('template-field');
                        el.style.position = 'absolute';
                        el.style.cursor = 'move';
                        el.style.backgroundColor = 'rgba(255,255,255,0.7)';
                        el.style.padding = '2px 4px';
                        if (!el.style.fontSize) {
                            el.style.fontSize = '12px';
                        }
                        el.style.border = '1px dashed #888';
                        // เพิ่มปุ่มเพิ่ม/ลดขนาด
                        const plus = document.createElement('span');
                        plus.textContent = '+';
                        plus.style.position = 'absolute';
                        plus.style.right = '0px';
                        plus.style.top = '-10px';
                        plus.style.cursor = 'pointer';
                        plus.style.fontSize = '10px';
                        plus.style.color = '#4a5568';
                        const minus = document.createElement('span');
                        minus.textContent = '-';
                        minus.style.position = 'absolute';
                        minus.style.right = '12px';
                        minus.style.top = '-10px';
                        minus.style.cursor = 'pointer';
                        minus.style.fontSize = '10px';
                        minus.style.color = '#4a5568';
                        plus.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const currentSize = parseFloat(window.getComputedStyle(el).fontSize);
                            el.style.fontSize = (currentSize + 1) + 'px';
                        });
                        minus.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const currentSize = parseFloat(window.getComputedStyle(el).fontSize);
                            el.style.fontSize = Math.max(6, currentSize - 1) + 'px';
                        });
                        el.appendChild(plus);
                        el.appendChild(minus);

                        // Allow adjusting font size via mouse wheel: scroll up to increase, down to decrease
                        el.addEventListener('wheel', (ev) => {
                            ev.preventDefault();
                            const currentSize = parseFloat(window.getComputedStyle(el).fontSize);
                            if (ev.deltaY < 0) {
                                el.style.fontSize = (currentSize + 1) + 'px';
                            } else {
                                el.style.fontSize = Math.max(6, currentSize - 1) + 'px';
                            }
                        });
                        let offsetX, offsetY;
                        const onMouseMove = (ev) => {
                            const rect = editor.getBoundingClientRect();
                            let x = ev.clientX - rect.left - offsetX;
                            let y = ev.clientY - rect.top - offsetY;
                            x = Math.max(0, Math.min(x, rect.width - el.offsetWidth));
                            y = Math.max(0, Math.min(y, rect.height - el.offsetHeight));
                            el.style.left = x + 'px';
                            el.style.top = y + 'px';
                        };
                        const onMouseUp = () => {
                            window.removeEventListener('mousemove', onMouseMove);
                            window.removeEventListener('mouseup', onMouseUp);
                        };
                        el.addEventListener('mousedown', (ev) => {
                            ev.preventDefault();
                            // ignore drag when clicking plus/minus
                            if (ev.target === plus || ev.target === minus) return;
                            const rect = el.getBoundingClientRect();
                            offsetX = ev.clientX - rect.left;
                            offsetY = ev.clientY - rect.top;
                            window.addEventListener('mousemove', onMouseMove);
                            window.addEventListener('mouseup', onMouseUp);
                        });
                    }
                    // handle palette dragstart
                    const palette = modalEl.querySelector('#wht-field-palette');
                    if (palette) {
                        palette.querySelectorAll('[draggable]').forEach(item => {
                            item.addEventListener('dragstart', (ev) => {
                                ev.dataTransfer.setData('text/plain', item.dataset.field);
                            });
                        });
                    }
                    // allow drop on editor
                    editor.addEventListener('dragover', (ev) => {
                        ev.preventDefault();
                    });
                    editor.addEventListener('drop', (ev) => {
                        ev.preventDefault();
                        const field = ev.dataTransfer.getData('text/plain');
                        if (!field) return;
                        // check if exists
                        let existing = editor.querySelector(`[data-field="${field}"]`);
                        if (!existing) {
                            existing = document.createElement('div');
                            existing.textContent = field;
                            existing.dataset.field = field;
                            editor.appendChild(existing);
                            makeDraggable(existing);
                        }
                        const rect = editor.getBoundingClientRect();
                        const x = ev.clientX - rect.left;
                        const y = ev.clientY - rect.top;
                        existing.style.left = x + 'px';
                        existing.style.top = y + 'px';
                    });
                    // load existing layout positions if any
                    const layout = appSettings.whtFormLayout || {};
                    Object.keys(layout).forEach(field => {
                        const cfg = layout[field];
                        const el = document.createElement('div');
                        el.textContent = field;
                        el.dataset.field = field;
                        editor.appendChild(el);
                        makeDraggable(el);
                        // convert mm back to px
                        const xPx = (cfg.x / 210) * editor.clientWidth;
                        const yPx = (cfg.y / 297) * editor.clientHeight;
                        el.style.left = xPx + 'px';
                        el.style.top = yPx + 'px';
                    });
                }
            });
        }

        function switchToUserView(userIdToImpersonate) {
            if (currentUserRole !== 'admin' || originalAdminData) return; // Prevent non-admins or nested impersonation

            const targetUser = allUsers.find(u => u.id === userIdToImpersonate);
            if (targetUser) {
                originalAdminData = { user: currentUser, data: currentUserData, role: currentUserRole };

                currentUser = { uid: targetUser.id, email: targetUser.email };
                currentUserData = targetUser;
                currentUserRole = targetUser.role;

                initializeAppUI();
            }
        }

        function returnToAdminView() {
            if (!originalAdminData) return;

            currentUser = originalAdminData.user;
            currentUserData = originalAdminData.data;
            currentUserRole = originalAdminData.role;

            originalAdminData = null;
            initializeAppUI();
        }

        async function loadAppSettings() {
            // Always load application settings from Firestore, regardless of user role.
            const settingsRef = doc(db, "settings", "app-config");
            const settingsSnap = await getDoc(settingsRef);
            if (settingsSnap.exists()) {
                appSettings = { ...appSettings, ...settingsSnap.data() };
            } else {
                // If no settings doc, create one with defaults
                await setDoc(settingsRef, appSettings).catch(e => console.error("Could not create default settings:", e));
            }
            // Update live DOM elements after loading
            document.getElementById('favicon-link').href = appSettings.faviconUrl || '';
            // Removed dynamic update of OG image meta tag; using static OG tags instead
            // Reflect Facebook login visibility based on settings
            updateFacebookLoginVisibility();
        }

        function showSettingsView() {
            mainApp.classList.add('hidden');
            document.getElementById('financial-summary-view').classList.add('hidden');
            document.getElementById('line-bot-view').classList.add('hidden');
            document.getElementById('settings-view').classList.remove('hidden');

            // Populate form
            document.getElementById('favicon-preview').src = appSettings.faviconUrl || 'https://placehold.co/64x64/E2E8F0/4A5568?text=Icon';
            document.getElementById('og-image-preview').src = appSettings.ogImageUrl || 'https://placehold.co/300x157/E2E8F0/4A5568?text=OG+Image';
            document.getElementById('setting-cloudinary-name').value = appSettings.cloudinaryName;
            document.getElementById('setting-cloudinary-preset').value = appSettings.cloudinaryPreset;
            document.getElementById('setting-line-bot-token').value = appSettings.lineBotChannelAccessToken || '';
            document.getElementById('setting-line-bot-secret').value = appSettings.lineBotChannelSecret || '';
            document.getElementById('setting-facebook-app-id').value = appSettings.facebookAppId || '';
            document.getElementById('setting-facebook-app-secret').value = appSettings.facebookAppSecret || '';
            document.getElementById('setting-line-login-enabled').checked = appSettings.isLineLoginEnabled;
            const fbLoginChk = document.getElementById('setting-facebook-login-enabled');
            if (fbLoginChk) fbLoginChk.checked = appSettings.isFacebookLoginEnabled;
            const fbLinkChk = document.getElementById('setting-facebook-link-enabled');
            if (fbLinkChk) fbLinkChk.checked = appSettings.isFacebookLinkEnabled;

            // Populate SMS settings fields
            const smsApiKeyInput = document.getElementById('setting-sms-api-key');
            const smsSenderInput = document.getElementById('setting-sms-sender-name');
            const smsEnabledCheckbox = document.getElementById('setting-sms-enabled');
            if (smsApiKeyInput) smsApiKeyInput.value = appSettings.smsKubApiKey || '';
            if (smsSenderInput) smsSenderInput.value = appSettings.smsSenderName || '';
            if (smsEnabledCheckbox) smsEnabledCheckbox.checked = appSettings.isSmsEnabled;

            // Add change listeners for image previews
            const faviconInput = document.getElementById('setting-favicon-file');
            const faviconPreview = document.getElementById('favicon-preview');
            faviconInput.onchange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    faviconPreview.src = URL.createObjectURL(e.target.files[0]);
                }
            };

            const ogImageInput = document.getElementById('setting-og-image-file');
            const ogImagePreview = document.getElementById('og-image-preview');
            ogImageInput.onchange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    ogImagePreview.src = URL.createObjectURL(e.target.files[0]);
                }
            };
        }

        function showLineBotView() {
            mainApp.classList.add('hidden');
            document.getElementById('financial-summary-view').classList.add('hidden');
            document.getElementById('settings-view').classList.add('hidden');
            document.getElementById('line-bot-view').classList.remove('hidden');

            const jobSelect = document.getElementById('line-job-select');
            jobSelect.innerHTML = '<option value="">-- กรุณาเลือกคิวงาน --</option>';
            allActiveJobs.forEach(job => {
                const option = document.createElement('option');
                option.value = job.id;
                option.textContent = job.name;
                jobSelect.appendChild(option);
            });
        }

        function sendLineMessage(userId, message, userName = null) {
            // This is a placeholder function.
            // In a real application, this would trigger a Cloud Function
            // that uses the Channel Access Token to send a message via the LINE Messaging API.
            const recipientName = userName ? `${userName} (${userId})` : userId;
            const alertMessage = `[จำลองการส่งข้อความ]\n\nถึง: ${recipientName}\n\nข้อความ: ${message}\n\n(ฟังก์ชันนี้ต้องมีการพัฒนาเพิ่มเติมในฝั่งเซิร์ฟเวอร์เพื่อส่งข้อความจริง)`;
            alert(alertMessage);
        }

    /**
     * ส่งข้อความ SMS ผ่านบริการ SMSKUB
     * ฟังก์ชันนี้เป็นตัวอย่างการเชื่อมต่อและยังไม่ได้ส่งข้อความจริง
     * ในการใช้งานจริงควรเรียกไปยัง Cloud Function หรือ Backend ของคุณ
     * ซึ่งจะจัดการการส่งข้อความ SMS ผ่าน API ของ SMSKUB
     *
     * @param {string} phoneNumber เบอร์โทรศัพท์ผู้รับ
     * @param {string} message ข้อความที่จะส่ง
     */
    function sendSmsMessage(phoneNumber, message) {
        // ตรวจสอบว่ามีการเปิดใช้งาน SMS และมีข้อมูล API ครบถ้วนหรือไม่
        if (!appSettings.isSmsEnabled) {
            return;
        }
        const apiKey = appSettings.smsKubApiKey;
        const sender = appSettings.smsSenderName || '';
        if (!apiKey) {
            console.warn('SMSKUB API key is not set.');
            return;
        }
        // ตัวอย่างการส่งคำขอไปยัง API ของ SMSKUB (ต้องพัฒนาเพิ่มเติมในฝั่งเซิร์ฟเวอร์)
        /*
        fetch('https://console.sms-kub.com/api/sendSMS', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                api_key: apiKey,
                sender: sender,
                msisdn: phoneNumber,
                message: message
            })
        })
        .then(res => res.json())
        .then(data => console.log('SMSKUB response:', data))
        .catch(err => console.error('SMS send error:', err));
        */
        const alertMessage = `[จำลองการส่ง SMS]\n\nถึง: ${phoneNumber}\n\nข้อความ: ${message}\n\n(ฟังก์ชันนี้ต้องมีการพัฒนาเพิ่มเติมในฝั่งเซิร์ฟเวอร์เพื่อส่ง SMS จริง)`;
        alert(alertMessage);
    }

        async function handleLinkLineAccount() {
            try {
                const provider = new OAuthProvider('oidc.line');
                await linkWithRedirect(auth.currentUser, provider);
            } catch (error) {
                console.error("LINE Linking Error:", error);
                 if (error.code === 'auth/unauthorized-domain') {
                    showUnauthorizedDomainModal(window.location.hostname);
                } else {
                    alert(`เกิดข้อผิดพลาดในการเชื่อมต่อบัญชี LINE: ${error.message}`);
                }
            }
        }

        async function handleUnlinkLineAccount() {
            try {
                await unlink(auth.currentUser, 'oidc.line');
                await updateDoc(doc(db, "users", currentUser.uid), { lineUserId: null });
                currentUserData.lineUserId = null;
                alert('ยกเลิกการเชื่อมต่อบัญชี LINE สำเร็จ');
            } catch (error) {
                console.error("LINE Unlinking Error:", error);
                alert(`เกิดข้อผิดพลาดในการยกเลิกการเชื่อมต่อ: ${error.message}`);
            }
        }

        /**
         * เชื่อมต่อบัญชี Facebook กับผู้ใช้ที่ล็อกอินอยู่ในปัจจุบัน
         * ใช้การทำงานแบบ popup เพื่อหลีกเลี่ยง redirect ออกจากแอป
         */
        async function handleLinkFacebookAccount() {
            try {
                const provider = new FacebookAuthProvider();
                const result = await linkWithPopup(auth.currentUser, provider);
                const user = result.user;
                // Attempt to extract provider data (id, name, photo)
                const fbProviderData = user.providerData.find(p => p.providerId === 'facebook.com') || {};
                const fbUid = fbProviderData.uid || null;
                const fbName = fbProviderData.displayName || user.displayName || null;
                const fbPhoto = fbProviderData.photoURL || user.photoURL || null;
                if (fbUid) {
                    const userRef = doc(db, 'users', user.uid);
                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists()) {
                        const data = userSnap.data();
                        const updateObj = {
                            facebookUserId: fbUid,
                            facebookName: fbName,
                            facebookPhotoUrl: fbPhoto
                        };
                        // Update profile picture if none
                        if (!data.profilePic) {
                            updateObj.profilePic = fbPhoto;
                        }
                        // Update nickname if none
                        if (!data.nickname) {
                            updateObj.nickname = fbName;
                        }
                        await updateDoc(userRef, updateObj);
                        // Update local cache
                        Object.assign(currentUserData, updateObj);
                        // Update display name in header if nickname was set
                        const nameDisplayEl = document.getElementById('user-name-display');
                        if (nameDisplayEl) {
                            nameDisplayEl.textContent = currentUserData.nickname || currentUserData.name;
                        }
                        alert('เชื่อมต่อบัญชี Facebook สำเร็จ');
                    }
                }
            } catch (error) {
                console.error('Facebook linking error:', error);
                if (error.code === 'auth/unauthorized-domain') {
                    showUnauthorizedDomainModal(window.location.hostname);
                } else if (error.code === 'auth/credential-already-in-use' || error.code === 'auth/provider-already-linked') {
                    alert('บัญชี Facebook นี้ถูกเชื่อมต่อกับผู้ใช้รายอื่นแล้ว');
                } else {
                    alert(`เกิดข้อผิดพลาดในการเชื่อมต่อบัญชี Facebook: ${error.message}`);
                }
            }
        }

        /**
         * ยกเลิกการเชื่อมต่อบัญชี Facebook ของผู้ใช้ปัจจุบัน
         */
        async function handleUnlinkFacebookAccount() {
            try {
                await unlink(auth.currentUser, 'facebook.com');
                // Remove Facebook fields from Firestore
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    facebookUserId: deleteField(),
                    facebookName: deleteField(),
                    facebookPhotoUrl: deleteField()
                });
                currentUserData.facebookUserId = null;
                currentUserData.facebookName = null;
                currentUserData.facebookPhotoUrl = null;
                alert('ยกเลิกการเชื่อมต่อบัญชี Facebook สำเร็จ');
            } catch (error) {
                console.error('Facebook unlinking error:', error);
                alert(`เกิดข้อผิดพลาดในการยกเลิกการเชื่อมต่อบัญชี Facebook: ${error.message}`);
            }
        }

        /**
         * เข้าสู่ระบบด้วย Facebook สำหรับผู้ใช้ที่ยังไม่ได้เข้าสู่ระบบ
         */
        async function handleFacebookLogin() {
            try {
                const provider = new FacebookAuthProvider();
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                // Extract provider details
                const fbProviderData = user.providerData.find(p => p.providerId === 'facebook.com') || {};
                const fbUid = fbProviderData.uid || null;
                const fbName = fbProviderData.displayName || user.displayName || null;
                const fbPhoto = fbProviderData.photoURL || user.photoURL || null;
                // Update user document if exists
                const userRef = doc(db, 'users', user.uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists() && fbUid) {
                    const data = userSnap.data();
                    const updateObj = {
                        facebookUserId: fbUid,
                        facebookName: fbName,
                        facebookPhotoUrl: fbPhoto
                    };
                    if (!data.profilePic) updateObj.profilePic = fbPhoto;
                    if (!data.nickname) updateObj.nickname = fbName;
                    await updateDoc(userRef, updateObj);
                    Object.assign(currentUserData || {}, updateObj);
                }
            } catch (error) {
                console.error('Facebook login error:', error);
                if (error.code === 'auth/unauthorized-domain') {
                    showUnauthorizedDomainModal(window.location.hostname);
                } else {
                    alert(`เกิดข้อผิดพลาดในการเข้าสู่ระบบผ่าน Facebook: ${error.message}`);
                }
            }
        }

        /**
         * ปรับการแสดงผลปุ่มเข้าสู่ระบบผ่าน Facebook ในหน้าเข้าสู่ระบบ/สมัครสมาชิก
         */
        function updateFacebookLoginVisibility() {
            const loginContainer = document.getElementById('facebook-login-container-login');
            const signupContainer = document.getElementById('facebook-login-container-signup');
            if (appSettings && appSettings.isFacebookLoginEnabled) {
                if (loginContainer) loginContainer.classList.remove('hidden');
                if (signupContainer) signupContainer.classList.remove('hidden');
            } else {
                if (loginContainer) loginContainer.classList.add('hidden');
                if (signupContainer) signupContainer.classList.add('hidden');
            }
        }
        

        function showUnauthorizedDomainModal(domain) {
            const content = `
                <p class="text-center text-red-600 font-semibold">การดำเนินการล้มเหลวเนื่องจากโดเมนไม่ได้รับอนุญาต</p>
                <p class="mt-4 text-sm text-gray-700">กรุณาเพิ่มโดเมนต่อไปนี้ลงใน "Authorized domains" ในการตั้งค่า Firebase Authentication ของคุณ:</p>
                <div class="mt-2 p-2 bg-gray-100 rounded-md text-center font-mono text-sm break-all">${domain}</div>
                <p class="mt-4 text-sm text-gray-500">ขั้นตอน: Firebase Console > Authentication > Settings > Authorized domains > Add domain</p>
            `;
            showModal('ข้อผิดพลาด: โดเมนไม่ได้รับอนุญาต', content, null, false, null, "คัดลอก");
        }


        // --- NOTIFICATION FUNCTIONS ---
        async function createNotification(recipientId, message, jobId = '', jobName = '') {
            if (!recipientId) return;
            // To avoid notifying the action-taker
            const finalRecipients = (Array.isArray(recipientId) ? recipientId : [recipientId]).filter(id => id !== currentUser.uid);
            if (finalRecipients.length === 0) return;

            await addDoc(collection(db, "notifications"), {
                senderId: currentUser.uid,
                senderName: "ระบบ", // Or currentUserData.name
                recipientIds: finalRecipients,
                jobId: jobId,
                jobName: jobName,
                type: 'system_update',
                status: 'info',
                message: message,
                isRead: false,
                createdAt: serverTimestamp()
            });

            // ส่ง SMS ถึงผู้รับแต่ละราย (ถ้าเปิดใช้งาน SMS) หลังจากบันทึกการแจ้งเตือนแล้ว
            if (appSettings && appSettings.isSmsEnabled) {
                for (const uid of finalRecipients) {
                    try {
                        const userDocRef = doc(db, "users", uid);
                        const userSnap = await getDoc(userDocRef);
                        if (userSnap.exists()) {
                            const userData = userSnap.data();
                            const phone = userData.phone || userData.phoneNumber || '';
                            if (phone) {
                                sendSmsMessage(phone, message);
                            }
                        }
                    } catch (err) {
                        console.error('Error sending SMS to user', uid, err);
                    }
                }
            }
        }

    /**
     * Display a modal showing the activity log for admin actions.
     * Logs are stored in the global activityLog array and persisted in localStorage.
     */
    function showActivityLogModal() {
        // Clone and sort logs by timestamp descending
        let logs = Array.isArray(activityLog) ? activityLog.slice() : [];
        logs.sort((a, b) => {
            const ta = new Date(a.timestamp || 0);
            const tb = new Date(b.timestamp || 0);
            return tb - ta;
        });
        let content = '<div class="space-y-2 max-h-[60vh] overflow-y-auto">';
        if (logs.length === 0) {
            content += '<p class="text-center text-gray-500">ไม่มีประวัติ</p>';
        } else {
            logs.forEach(log => {
                const ts = log.timestamp || '';
                const msg = log.message || '';
                content += `<div class="p-2 border-b"><p class="text-xs text-gray-500 mb-1">${ts}</p><p>${msg}</p></div>`;
            });
        }
        content += '</div>';
        showModal('ประวัติกิจกรรม', content, null, false);
    }

        function listenForNotifications() {
            if (notificationsUnsubscribe) notificationsUnsubscribe();
            if (!currentUser) return;

            const q = query(collection(db, "notifications"), where("recipientIds", "array-contains", currentUser.uid));

            notificationsUnsubscribe = onSnapshot(q, (snapshot) => {
                allNotifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const unreadCount = allNotifications.filter(n => !n.isRead).length;

                // This badge is now for general notifications, not job count
                const badge = document.getElementById('notification-badge');
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            });
        }

        async function showRequestToJoinModal(jobId, jobName) {
            const job = allActiveJobs.find(j => j.id === jobId);
            if (!job) return;

            showConfirmModal(
                `ขอลงคิวงาน "${jobName}"?`,
                'คำขอของคุณรอการอนุมัติ หากอนุมัติหรือไม่อนุมัติจะมีแจ้งเตือนอีกครั้ง',
                async () => {
                    const admins = allUsers.filter(u => u.role === 'admin');
                    let recipientIds = admins.map(a => a.id);
                    if (job.teamLeaderId && !recipientIds.includes(job.teamLeaderId)) {
                        recipientIds.push(job.teamLeaderId);
                    }

                    if (job.team.some(m => m.userId === currentUser.uid)) {
                        alert("คุณอยู่ในคิวงานนี้แล้ว");
                        return;
                    }

                    const existingRequestQuery = query(collection(db, "notifications"),
                        where("senderId", "==", currentUser.uid),
                        where("jobId", "==", jobId),
                        where("type", "==", "join_request"),
                        where("status", "==", "pending")
                    );
                    const existingRequestSnapshot = await getDocs(existingRequestQuery);
                    if (!existingRequestSnapshot.empty) {
                        alert("คุณได้ส่งคำขอสำหรับคิวงานนี้ไปแล้ว");
                        return;
                    }

                    await addDoc(collection(db, "notifications"), {
                        senderId: currentUser.uid,
                        senderName: currentUserData.nickname || currentUserData.name,
                        recipientIds: recipientIds,
                        jobId: jobId,
                        jobName: jobName,
                        type: 'join_request',
                        status: 'pending', // pending, approved, denied
                        isRead: false,
                        createdAt: serverTimestamp()
                    });
                    alert('ส่งคำขอเรียบร้อยแล้ว');
                }
            );
        }

        /**
         * ส่งคำขอยกเลิกคิวงานไปยังแอดมินและหัวหน้าทีม
         * @param {string} jobId
         * @param {string} jobName
         */
        async function requestCancel(jobId, jobName) {
            const job = allActiveJobs.find(j => j.id === jobId);
            if (!job) return;
            showConfirmModal(
                `ขอยกเลิกคิวงาน "${jobName}"?`,
                'คำขอของคุณรอการอนุมัติ หากอนุมัติหรือไม่อนุมัติจะมีแจ้งเตือนอีกครั้ง',
                async () => {
                    // Determine recipients: all admins and team leader
                    const admins = allUsers.filter(u => u.role === 'admin');
                    let recipientIds = admins.map(a => a.id);
                    if (job.teamLeaderId && !recipientIds.includes(job.teamLeaderId)) {
                        recipientIds.push(job.teamLeaderId);
                    }
                    // Check for existing pending cancel request
                    const existingQuery = query(collection(db, "notifications"),
                        where("senderId", "==", currentUser.uid),
                        where("jobId", "==", jobId),
                        where("type", "==", "cancel_request"),
                        where("status", "==", "pending")
                    );
                    const existingSnap = await getDocs(existingQuery);
                    if (!existingSnap.empty) {
                        alert("คุณได้ส่งคำขอยกเลิกคิวงานนี้ไปแล้ว");
                        return;
                    }
                    // Update job document with cancellation request status
                    const updates = {};
                    updates[`cancellationRequests.${currentUser.uid}`] = 'pending';
                    await updateDoc(doc(db, "jobs", jobId), updates);
                    // Create notification for cancellation request
                    await addDoc(collection(db, "notifications"), {
                        senderId: currentUser.uid,
                        senderName: currentUserData?.nickname || currentUserData?.name || '',
                        recipientIds: recipientIds,
                        jobId: jobId,
                        jobName: jobName,
                        type: 'cancel_request',
                        status: 'pending',
                        isRead: false,
                        createdAt: serverTimestamp()
                    });
                    alert('ส่งคำขอเรียบร้อยแล้ว');
                }
            );
        }

        /**
         * แสดงตัวเลือกสำหรับแก้ไขคิวงาน (ยกเลิกหรือลบ) สำหรับแอดมิน
         * @param {Object} job
         */
        function showEditJobOptions(job) {
            const content = `
                <div class="space-y-4">
                    <button type="button" id="admin-cancel-job-btn" class="w-full px-4 py-2 text-white bg-red-500 rounded-lg hover:bg-red-600">ยกเลิกคิวงาน</button>
                    <button type="button" id="admin-delete-job-btn" class="w-full px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">ลบคิวงาน</button>
                </div>
            `;
            showModal('แก้ไขคิวงาน', content, null, false, (modal) => {
                const cancelBtn = modal.querySelector('#admin-cancel-job-btn');
                const deleteBtn = modal.querySelector('#admin-delete-job-btn');
                if (cancelBtn) {
                    cancelBtn.onclick = () => {
                        showConfirmModal('ยืนยันการยกเลิกคิวงาน', `คุณต้องการยกเลิกคิวงาน "${job.name}" ใช่หรือไม่?`, async () => {
                            await updateDoc(doc(db, "jobs", job.id), { status: 'cancelled' });
                        });
                        modal.remove();
                    };
                }
                if (deleteBtn) {
                    deleteBtn.onclick = () => {
                        showConfirmModal('ยืนยันการลบคิวงาน', `คุณต้องการลบคิวงาน "${job.name}" ใช่หรือไม่?`, async () => {
                            await deleteDoc(doc(db, "jobs", job.id));
                        });
                        modal.remove();
                    };
                }
            });
        }

        /**
         * อนุมัติคำขอยกเลิกคิวงาน
         * @param {Object} notification
         */
        async function approveCancel(notification) {
            const jobRef = doc(db, "jobs", notification.jobId);
            const jobSnap = await getDoc(jobRef);
            if (!jobSnap.exists()) return;
            const jobData = jobSnap.data();
            // Find member to remove
            const memberToRemove = jobData.team?.find(m => m.userId === notification.senderId);
            const updates = {};
            if (memberToRemove) {
                updates.team = arrayRemove(memberToRemove);
            }
            // Mark cancellation request as approved
            updates[`cancellationRequests.${notification.senderId}`] = 'approved';
            // Add to cancelledMemberIds list
            updates.cancelledMemberIds = arrayUnion(notification.senderId);
            await updateDoc(jobRef, updates);
            // Mark the original notification as approved
            await updateDoc(doc(db, "notifications", notification.id), { status: 'approved' });
            // Send response notification
            await addDoc(collection(db, "notifications"), {
                senderId: currentUser.uid,
                senderName: "ระบบ",
                recipientIds: [notification.senderId],
                jobId: notification.jobId,
                jobName: notification.jobName,
                type: 'cancel_response',
                status: 'approved',
                message: `คำขอยกเลิกคิวงาน <b>${notification.jobName}</b> ของคุณได้รับการอนุมัติ`,
                isRead: false,
                createdAt: serverTimestamp()
            });
            alert('อนุมัติคำขอยกเลิกคิวงานเรียบร้อยแล้ว');
        }

        /**
         * ปฏิเสธคำขอยกเลิกคิวงาน
         * @param {Object} notification
         */
        async function denyCancel(notification) {
            // Update the cancellation request status in job doc
            const jobRef = doc(db, "jobs", notification.jobId);
            await updateDoc(jobRef, { [`cancellationRequests.${notification.senderId}`]: 'denied' });
            // Mark the original notification as denied
            await updateDoc(doc(db, "notifications", notification.id), { status: 'denied' });
            // Send response notification
            await addDoc(collection(db, "notifications"), {
                senderId: currentUser.uid,
                senderName: "ระบบ",
                recipientIds: [notification.senderId],
                jobId: notification.jobId,
                jobName: notification.jobName,
                type: 'cancel_response',
                status: 'denied',
                message: `คำขอยกเลิกคิวงาน <b>${notification.jobName}</b> ของคุณถูกปฏิเสธ`,
                isRead: false,
                createdAt: serverTimestamp()
            });
            alert('ปฏิเสธคำขอยกเลิกคิวงานเรียบร้อยแล้ว');
        }

        async function showNotificationsModal() {
            // หากไม่มีการแจ้งเตือนเลย ให้แจ้ง
            if (allNotifications.length === 0) {
                alert("ยังไม่มีการแจ้งเตือน");
                return;
            }

            // เรียงลำดับจากใหม่ไปเก่า
            allNotifications.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
            const unreadCount = allNotifications.filter(n => !n.isRead).length;

            let notificationsHTML = '<div class="space-y-3">';
            // เพิ่มปุ่มอ่านทั้งหมดหากมีข้อความที่ยังไม่ได้อ่าน
            if (unreadCount > 0) {
                // Use type="button" to avoid submitting the modal form when clicked
                notificationsHTML += '<div class="flex justify-end"><button type="button" id="mark-all-read-btn" class="text-blue-600 hover:underline text-sm">อ่านทั้งหมด</button></div>';
            }

            for (const notification of allNotifications) {
                let actionButtons = '';
                const isJoinRequest = notification.type === 'join_request' && notification.status === 'pending';
                const isCancelRequest = notification.type === 'cancel_request' && notification.status === 'pending';
                const jobForNotif = allActiveJobs.find(j => j.id === notification.jobId);
                const canApprove = currentUserRole === 'admin' || (jobForNotif && currentUser && currentUser.uid === jobForNotif.teamLeaderId);
                if (canApprove) {
                    if (isJoinRequest) {
                        // Buttons for join request
                        actionButtons = `
                            <div class="flex space-x-2 mt-2">
                                <button type="button" class="approve-request-btn px-3 py-1 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600" data-id="${notification.id}">อนุมัติ</button>
                                <button type="button" class="deny-request-btn px-3 py-1 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600" data-id="${notification.id}">ปฏิเสธ</button>
                            </div>`;
                    } else if (isCancelRequest) {
                        // Buttons for cancel request
                        actionButtons = `
                            <div class="flex space-x-2 mt-2">
                                <button type="button" class="approve-cancel-btn px-3 py-1 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600" data-id="${notification.id}">อนุมัติการยกเลิก</button>
                                <button type="button" class="deny-cancel-btn px-3 py-1 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600" data-id="${notification.id}">ปฏิเสธ</button>
                            </div>`;
                    }
                }

                let statusText = '';
                switch(notification.status) {
                    case 'approved': statusText = `<span class="font-semibold text-green-600"> (อนุมัติแล้ว)</span>`; break;
                    case 'denied': statusText = `<span class="font-semibold text-red-600"> (ถูกปฏิเสธ)</span>`; break;
                }

                const message = notification.message || `<b>${notification.senderName}</b> ได้ส่งคำขอเข้าร่วมคิวงาน <b>${notification.jobName}</b>`;

                // ปุ่มอ่านแล้วสำหรับข้อความที่ยังไม่ได้อ่าน
                // Ensure the mark read button does not submit the form by specifying type="button"
                const markReadBtnHtml = !notification.isRead ? `<button type="button" class="mark-read-btn text-xs text-blue-600 hover:underline mt-2" data-id="${notification.id}">อ่านแล้ว</button>` : '';

                notificationsHTML += `
                    <div class="p-3 rounded-lg ${notification.isRead ? 'bg-gray-50' : 'bg-blue-50 border-l-4 border-blue-500'}">
                        <p class="text-sm text-gray-800">
                            ${message}${statusText}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">${notification.createdAt ? notification.createdAt.toDate().toLocaleString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : ''}</p>
                        ${actionButtons}
                        ${markReadBtnHtml}
                    </div>
                `;
            }
            notificationsHTML += '</div>';

            // แสดงโมดัลการแจ้งเตือน โดยไม่ปิดเองหลังจากกดปุ่มอนุมัติ/ปฏิเสธ
            showModal('การแจ้งเตือน', notificationsHTML, null, false, (modal) => {
                // Event สำหรับปุ่มอนุมัติ/ปฏิเสธคำขอเข้าคิวงาน
                modal.querySelectorAll('.approve-request-btn').forEach(btn => btn.onclick = (e) => {
                    const notificationId = e.currentTarget.dataset.id;
                    const notification = allNotifications.find(n => n.id === notificationId);
                    approveRequest(notification);
                    modal.remove();
                });
                modal.querySelectorAll('.deny-request-btn').forEach(btn => btn.onclick = (e) => {
                    const notificationId = e.currentTarget.dataset.id;
                    const notification = allNotifications.find(n => n.id === notificationId);
                    denyRequest(notification);
                    modal.remove();
                });
                // Events for cancel request approval/denial
                modal.querySelectorAll('.approve-cancel-btn').forEach(btn => btn.onclick = (e) => {
                    const notificationId = e.currentTarget.dataset.id;
                    const notification = allNotifications.find(n => n.id === notificationId);
                    approveCancel(notification);
                    modal.remove();
                });
                modal.querySelectorAll('.deny-cancel-btn').forEach(btn => btn.onclick = (e) => {
                    const notificationId = e.currentTarget.dataset.id;
                    const notification = allNotifications.find(n => n.id === notificationId);
                    denyCancel(notification);
                    modal.remove();
                });
                // Event สำหรับปุ่มอ่านแล้วแต่ละรายการ
                modal.querySelectorAll('.mark-read-btn').forEach(btn => btn.onclick = async (e) => {
                    const notifId = e.currentTarget.dataset.id;
                    try {
                        await updateDoc(doc(db, 'notifications', notifId), { isRead: true });
                        // อัปเดต UI ให้เป็นอ่านแล้ว
                        const card = e.currentTarget.closest('.p-3');
                        if (card) {
                            card.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500');
                            card.classList.add('bg-gray-50');
                        }
                        // ซ่อนปุ่มอ่านแล้วหลังอ่าน
                        e.currentTarget.style.display = 'none';
                        // อัพเดต badge
                        const remaining = allNotifications.filter(n => !n.isRead && n.id !== notifId).length;
                        const badge = document.getElementById('notification-badge');
                        if (remaining > 0) {
                            badge.textContent = remaining;
                            badge.classList.remove('hidden');
                        } else {
                            badge.classList.add('hidden');
                        }
                    } catch (err) {
                        console.error('Error marking notification as read', err);
                    }
                });
                // Event สำหรับปุ่มอ่านทั้งหมด
                const markAllBtn = modal.querySelector('#mark-all-read-btn');
                if (markAllBtn) {
                    markAllBtn.onclick = async () => {
                        try {
                            const unread = allNotifications.filter(n => !n.isRead);
                            // ใช้ batch เพื่ออัปเดตสถานะทั้งหมด
                            const batch = writeBatch(db);
                            unread.forEach(n => {
                                batch.update(doc(db, 'notifications', n.id), { isRead: true });
                            });
                            await batch.commit();
                            // อัปเดต UI: เปลี่ยนสีการ์ดเป็นอ่านแล้วและซ่อนปุ่มอ่านแล้วทุกอัน
                            modal.querySelectorAll('.p-3').forEach(card => {
                                card.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500');
                                card.classList.add('bg-gray-50');
                            });
                            modal.querySelectorAll('.mark-read-btn').forEach(btn => {
                                btn.style.display = 'none';
                            });
                            markAllBtn.style.display = 'none';
                            // ซ่อน badge
                            const badge = document.getElementById('notification-badge');
                            badge.classList.add('hidden');
                        } catch (err) {
                            console.error('Error marking all notifications as read', err);
                        }
                    };
                }
            });
        }

        async function approveRequest(notification) {
            // Provide a position selector with icons to improve clarity. Also allow free text entry for custom positions.
            const content = `
                <p>กำหนดตำแหน่งและค่าแรงสำหรับ <b>${notification.senderName}</b> ในคิวงาน <b>${notification.jobName}</b></p>
                <label class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
                <select name="position" required class="w-full p-2 border rounded">
                    <option value="" disabled selected>เลือกตำแหน่ง</option>
                    <option value="Camera">Camera</option>
                    <option value="Lighting">Lighting</option>
                    <option value="Sound">Sound</option>
                    <option value="Director">Director</option>
                    <option value="อื่นๆ">อื่นๆ</option>
                </select>
                <input type="text" name="customPosition" placeholder="ตำแหน่งอื่นๆ" class="w-full p-2 border rounded hidden">
                <label class="block text-sm font-medium text-gray-700 mt-2">ค่าแรง/วัน</label>
                <input type="number" name="dailyRate" placeholder="จำนวนเงินต่อวัน" required class="w-full p-2 border rounded">`;

            showModal('อนุมัติคำขอ', content, async (formData, submitBtn, modal) => {
                // Determine position: use custom input if provided and selection is "อื่นๆ"
                let positionVal = formData.get('position');
                const customPos = formData.get('customPosition');
                if (positionVal === 'อื่นๆ' && customPos) {
                    positionVal = customPos;
                }
                const dailyRate = Number(formData.get('dailyRate'));

                await updateDoc(doc(db, "jobs", notification.jobId), {
                    team: arrayUnion({
                        userId: notification.senderId,
                        position: positionVal,
                        dailyRate: dailyRate,
                        workdays: [],
                        dailyOverrides: {},
                        isPaid: false,
                        whtEnabled: false
                    })
                });

                await updateDoc(doc(db, "notifications", notification.id), { status: 'approved' });
                
                const notificationMessage = `คำขอเข้าร่วมคิวงาน <b>${notification.jobName}</b> ของคุณได้รับการอนุมัติแล้ว (BG: ${dailyRate.toLocaleString()} บาท/วัน)`;

                await addDoc(collection(db, "notifications"), {
                    senderId: currentUser.uid,
                    senderName: "ระบบ",
                    recipientIds: [notification.senderId],
                    jobId: notification.jobId,
                    jobName: notification.jobName,
                    type: 'request_response',
                    status: 'approved',
                    message: notificationMessage,
                    isRead: false,
                    createdAt: serverTimestamp()
                });

                alert('อนุมัติคำขอเรียบร้อยแล้ว');
                modal.remove();
            }, true, (modalEl) => {
                // On ready: show/hide custom position input based on selection
                const selectEl = modalEl.querySelector('select[name="position"]');
                const customInput = modalEl.querySelector('input[name="customPosition"]');
                if (selectEl && customInput) {
                    selectEl.addEventListener('change', (e) => {
                        if (e.target.value === 'อื่นๆ') {
                            customInput.classList.remove('hidden');
                            customInput.required = true;
                        } else {
                            customInput.classList.add('hidden');
                            customInput.required = false;
                        }
                    });
                }
            });
        }

        async function denyRequest(notification) {
            await updateDoc(doc(db, "notifications", notification.id), { status: 'denied' });

            await addDoc(collection(db, "notifications"), {
                senderId: currentUser.uid,
                senderName: "ระบบ",
                recipientIds: [notification.senderId],
                jobId: notification.jobId,
                jobName: notification.jobName,
                type: 'request_response',
                status: 'denied',
                message: `คำขอเข้าร่วมคิวงาน <b>${notification.jobName}</b> ของคุณถูกปฏิเสธ`,
                isRead: false,
                createdAt: serverTimestamp()
            });

            alert('ปฏิเสธคำขอเรียบร้อยแล้ว');
        }

        /**
         * Populate the month and year select inputs on the withholding view
         */
        function populateWhtMonthYearSelect() {
            const monthSelect = document.getElementById('wht-month');
            const yearSelect = document.getElementById('wht-year');
            if (!monthSelect || !yearSelect) return;
            // Clear existing options
            monthSelect.innerHTML = '';
            yearSelect.innerHTML = '';
            // Month names in Thai short form
            const monthNames = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
            monthNames.forEach((name, index) => {
                const opt = document.createElement('option');
                opt.value = index + 1;
                opt.textContent = name;
                monthSelect.appendChild(opt);
            });
            // Collect years from allJobs startDate; fallback to current year
            const yearsSet = new Set();
            if (Array.isArray(allJobs)) {
                allJobs.forEach(job => {
                    if (job.startDate) {
                        const d = new Date(job.startDate);
                        if (!isNaN(d)) yearsSet.add(d.getFullYear());
                    }
                });
            }
            if (yearsSet.size === 0) yearsSet.add(new Date().getFullYear());
            const years = Array.from(yearsSet).sort((a, b) => b - a);
            years.forEach(year => {
                const opt = document.createElement('option');
                opt.value = year;
                opt.textContent = year;
                yearSelect.appendChild(opt);
            });
            // Default to current month/year
            const now = new Date();
            monthSelect.value = now.getMonth() + 1;
            yearSelect.value = now.getFullYear();
        }

        /**
         * Show the withholding tax view and generate the report
         */
        function showWithholdingView() {
            // If the withholding view is not present (it has been removed), do nothing
            const whtViewEl = document.getElementById('withholding-view');
            if (!whtViewEl) {
                return;
            }
            // Hide other views
            document.getElementById('financial-summary-view').classList.add('hidden');
            const taxView = document.getElementById('tax-management-view');
            if (taxView) taxView.classList.add('hidden');
            // Populate month/year selects and generate report
            populateWhtMonthYearSelect();
            generateWithholdingReport();
            // Show the withholding view
            whtViewEl.classList.remove('hidden');
        }

        /**
         * Generate the withholding tax report for the current user
         * Displays a limited number of rows (20) initially and provides an expand button
         */
        function generateWithholdingReport() {
            const bodyEl = document.getElementById('wht-report-body');
            const expandBtn = document.getElementById('wht-expand-btn');
            if (!bodyEl) return;
            bodyEl.innerHTML = '';
            // Get selected month/year values; convert to integers
            const monthSel = document.getElementById('wht-month');
            const yearSel = document.getElementById('wht-year');
            const selectedMonth = monthSel ? parseInt(monthSel.value) : NaN;
            const selectedYear = yearSel ? parseInt(yearSel.value) : NaN;
            // Filter jobs where current user is on the team
            const memberJobs = Array.isArray(allJobs) ? allJobs.filter(job => job.team && job.team.some(m => m.userId === currentUser.uid)) : [];
            // Determine if the user has selected a specific month/year; if not, we'll default to the last 6 months
            const defaultNoFilter = isNaN(selectedMonth) && isNaN(selectedYear);
            const now = new Date();
            // Group rows by month label and accumulate totals for each month
            const groups = {};
            memberJobs.forEach(job => {
                if (!job.startDate) return;
                const date = new Date(job.startDate);
                if (isNaN(date)) return;
                let include = false;
                if (defaultNoFilter) {
                    // Show only jobs within the last 6 months (inclusive of current month) when no filter is selected
                    const monthsDiff = (now.getFullYear() - date.getFullYear()) * 12 + (now.getMonth() - date.getMonth());
                    include = monthsDiff < 6;
                } else {
                    const monthOk = isNaN(selectedMonth) || (date.getMonth() + 1) === selectedMonth;
                    const yearOk = isNaN(selectedYear) || date.getFullYear() === selectedYear;
                    include = monthOk && yearOk;
                }
                if (!include) return;
                const myTeam = job.team.find(m => m.userId === currentUser.uid);
                if (!myTeam) return;
                const wage = calculateTeamCostForMember(myTeam, job.workdays);
                const whtPercentValue = job.whtPercent === undefined ? appSettings.whtPercent : job.whtPercent;
                const whtAmount = myTeam.whtEnabled ? (wage * (whtPercentValue / 100)) : 0;
                const net = wage - whtAmount;
                // Month label in Thai (short month name with year)
                const monthLabel = date.toLocaleDateString('th-TH', { month: 'short', year: 'numeric' });
                // Create job row with month label appended to job name for clarity
                const rowHTML = `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">${job.name} <span class="text-xs text-gray-400">(${monthLabel})</span></td>
                                <td class="px-6 py-4 whitespace-nowrap text-right">${wage.toLocaleString()}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right">${whtAmount > 0 ? whtAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right">${net.toLocaleString()}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-center"><i class="ph ph-download-simple cursor-pointer text-blue-500"></i></td>
                            </tr>
                        `;
                // Initialize group if not exists
                if (!groups[monthLabel]) {
                    groups[monthLabel] = { rows: [], totals: { wage: 0, wht: 0, net: 0 } };
                }
                groups[monthLabel].rows.push(rowHTML);
                groups[monthLabel].totals.wage += wage;
                groups[monthLabel].totals.wht += whtAmount;
                groups[monthLabel].totals.net += net;
            });
            const monthKeys = Object.keys(groups);
            // If no data groups, show a friendly message instead of an empty table
            if (monthKeys.length === 0) {
                bodyEl.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">ไม่มีข้อมูล</td></tr>`;
                if (expandBtn) expandBtn.classList.add('hidden');
                return;
            }
            // Sort month keys in descending order (most recent first)
            monthKeys.sort((a, b) => {
                const [aMonthStr, aYearStr] = a.split(' ');
                const [bMonthStr, bYearStr] = b.split(' ');
                // Convert Thai short month names to month numbers for sorting
                const thaiMonths = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
                const aMonth = thaiMonths.indexOf(aMonthStr);
                const bMonth = thaiMonths.indexOf(bMonthStr);
                const aYear = parseInt(aYearStr);
                const bYear = parseInt(bYearStr);
                if (aYear === bYear) {
                    return bMonth - aMonth;
                }
                return bYear - aYear;
            });
            // Build final row list with summary rows for each month
            const finalRows = [];
            monthKeys.forEach(key => {
                const group = groups[key];
                // Append each job row
                group.rows.forEach(r => finalRows.push(r));
                // Append summary row for the month
                finalRows.push(`
                    <tr class="bg-gray-50 font-semibold">
                        <td class="px-6 py-4 whitespace-nowrap">รวมเดือน ${key}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${group.totals.wage.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${group.totals.wht > 0 ? group.totals.wht.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${group.totals.net.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap"></td>
                    </tr>
                `);
            });
            // Determine if we need to limit rows and show expand button
            if (finalRows.length > 20) {
                bodyEl.innerHTML = finalRows.slice(0, 20).join('');
                if (expandBtn) {
                    expandBtn.classList.remove('hidden');
                    expandBtn.onclick = () => {
                        bodyEl.innerHTML = finalRows.join('');
                        expandBtn.classList.add('hidden');
                    };
                }
            } else {
                bodyEl.innerHTML = finalRows.join('');
                if (expandBtn) expandBtn.classList.add('hidden');
            }
        }

        // Export financial summary (admin) to PDF
        const exportSummaryBtn = document.getElementById('export-summary-pdf-button');
        if (exportSummaryBtn) {
            exportSummaryBtn.addEventListener('click', async () => {
                // Build PDF from the financial summary view, excluding filters, navigation and profile image.
                const summaryContainer = document.getElementById('financial-summary-view');
                if (!summaryContainer) return;
                // Disable the button while exporting
                exportSummaryBtn.disabled = true;
                try {
                    const { jsPDF } = window.jspdf || {};
                    if (!jsPDF) {
                        alert('ไม่พบไลบรารี jsPDF');
                        exportSummaryBtn.disabled = false;
                        return;
                    }
                    // Determine month label based on current filter and selections
                    let monthLabel = '';
                    try {
                        const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
                        if (typeof financialFilter !== 'undefined' && financialFilter === '1m') {
                            const monthIndex = parseInt(document.getElementById('summary-month').value);
                            const yearValue = parseInt(document.getElementById('summary-year').value);
                            monthLabel = `${months[monthIndex]} ${yearValue + 543}`;
                        } else if (typeof financialFilter !== 'undefined') {
                            switch (financialFilter) {
                                case '2m': monthLabel = 'ย้อนหลัง 2 เดือน'; break;
                                case '3m': monthLabel = 'ย้อนหลัง 3 เดือน'; break;
                                case '6m': monthLabel = 'ย้อนหลัง 6 เดือน'; break;
                                case '1y': monthLabel = 'ย้อนหลัง 1 ปี'; break;
                                case 'all':
                                    // For a custom date range, display the start and end dates (Thai format)
                                    {
                                        const startInput = document.getElementById('summary-start-date').value;
                                        const endInput = document.getElementById('summary-end-date').value;
                                        if (startInput && endInput) {
                                            const startDateObj = new Date(startInput);
                                            const endDateObj = new Date(endInput);
                                            const startLabel = startDateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
                                            const endLabel = endDateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
                                            monthLabel = `จาก ${startLabel} ถึง ${endLabel}`;
                                        } else {
                                            monthLabel = 'ช่วงเวลา';
                                        }
                                    }
                                    break;
                                default: monthLabel = '';
                            }
                        } else {
                            const monthIndex = parseInt(document.getElementById('summary-month').value);
                            const yearValue = parseInt(document.getElementById('summary-year').value);
                            monthLabel = `${months[monthIndex]} ${yearValue + 543}`;
                        }
                    } catch (err) {
                        monthLabel = '';
                    }
                    // Temporarily update the header text to include the web app name and selected month
                    const headerTitleEl = summaryContainer.querySelector('h1');
                    // Extract the app name from the page title (before the dash)
                    const appName = (document.title || '').split(' - ')[0] || '';
                    // Save the original header HTML and text content for later restoration
                    const originalHeaderHTML = headerTitleEl ? headerTitleEl.innerHTML : '';
                    const originalHeaderText = headerTitleEl ? headerTitleEl.textContent : '';
                    if (headerTitleEl) {
                        // Build the new header for the PDF: app name on its own line and page title on the next line
                        // Combine the original header text with the month label if present
                        let secondLine = originalHeaderText ? originalHeaderText.trim() : '';
                        if (monthLabel) {
                            secondLine = secondLine ? `${secondLine} - ${monthLabel.trim()}` : monthLabel.trim();
                        }
                        // Do not apply any gradient/color classes to the app name; use plain text
                        headerTitleEl.innerHTML = `${appName}<br>${secondLine}`;
                    }
                    // Hide elements that shouldn't appear in the PDF
                    const backBtn = document.getElementById('back-to-main-app-btn');
                    const filterSection = summaryContainer.querySelector('section');
                    const originalBackDisplay = backBtn ? backBtn.style.display : '';
                    const originalFilterDisplay = filterSection ? filterSection.style.display : '';
                    if (backBtn) backBtn.style.display = 'none';
                    if (filterSection) filterSection.style.display = 'none';
                    // Hide the first column (selection checkbox) in the job summary table before capturing
                    const jobSummaryTable = document.getElementById('job-summary-table-body')?.closest('table');
                    const firstColCells = [];
                    const firstColDisplays = [];
                    if (jobSummaryTable) {
                        jobSummaryTable.querySelectorAll('thead tr th:first-child, tbody tr td:first-child, tfoot tr td:first-child').forEach((cell) => {
                            firstColCells.push(cell);
                            firstColDisplays.push(cell.style.display);
                            cell.style.display = 'none';
                        });

                    }
                    // Hide the export button itself if it is inside the summary
                    const originalExportDisplay = exportSummaryBtn.style.display;
                    exportSummaryBtn.style.display = 'none';
                    // Capture the view as canvas
                    const canvas = await html2canvas(summaryContainer, { useCORS: true, scale: 2 , useCORS: true });
                    const imgData = canvas.toDataURL('image/png');
                    // Restore hidden elements before creating the PDF
                    if (filterSection) filterSection.style.display = originalFilterDisplay;
                    if (backBtn) backBtn.style.display = originalBackDisplay;
                    if (headerTitleEl) headerTitleEl.innerHTML = originalHeaderHTML;
                    exportSummaryBtn.style.display = originalExportDisplay;
                    // Restore the first column cells
                    if (firstColCells.length) {
                        firstColCells.forEach((cell, idx) => {
                            cell.style.display = firstColDisplays[idx];
                        });
                    }
                    // Create the PDF without header/profile image
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const margin = 10;
                    let imgWidth = pageWidth - 2 * margin;
                    let imgHeight = (canvas.height * imgWidth) / canvas.width;
                    const maxHeight = pageHeight - 2 * margin;
                    if (imgHeight > maxHeight) {
                        imgHeight = maxHeight;
                        imgWidth = (canvas.width * imgHeight) / canvas.height;
                    }
                    const imgX = margin + ((pageWidth - 2 * margin - imgWidth) / 2);
                    const imgY = margin;
                    pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth, imgHeight);
                    pdf.save('financial-summary.pdf');
                } catch (err) {
                    console.error('Error exporting PDF:', err);
                } finally {
                    exportSummaryBtn.disabled = false;
                }
            });
        }
    </script>

    <script>
        // Function to toggle password visibility on inputs in the settings page
        function setupToggleVisibility() {
            const toggles = document.querySelectorAll('.toggle-visibility');
            toggles.forEach((btn) => {
                btn.addEventListener('click', () => {
                    const targetId = btn.dataset.target;
                    const inputEl = document.getElementById(targetId);
                    if (!inputEl) return;
                    const icon = btn.querySelector('i');
                    if (inputEl.type === 'password') {
                        inputEl.type = 'text';
                        if (icon) {
                            icon.classList.remove('ph-eye');
                            icon.classList.add('ph-eye-slash');
                        }
                    } else {
                        inputEl.type = 'password';
                        if (icon) {
                            icon.classList.remove('ph-eye-slash');
                            icon.classList.add('ph-eye');
                        }
                    }
                });
            });
        }
        // Attach once the DOM is fully loaded so that all .toggle-visibility buttons are present
        document.addEventListener('DOMContentLoaded', setupToggleVisibility);

        // Attach real-time search listener after DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            const searchInputEl = document.getElementById('job-search-input');
            if (searchInputEl) {
                searchInputEl.addEventListener('input', () => {
                    // When typing in the search box, reapply filters and rerender jobs
                    applyFiltersAndRenderJobs();
                });
            }
        });
    </script>
    <!-- Loading overlay shown during uploads/downloads -->
    <div id="loading-overlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center hidden bg-black bg-opacity-50">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-red-600"></div>
        <p class="mt-3 text-white">กำลังโหลด...</p>
    </div>
</body>
</html>
